---
title: 使用活頁簿建立適用於 VM 的 Azure 監視器互動式報表
description: 使用針對 VM 的 Azure 監視器的預定義和自訂參數化活頁簿簡化複雜報告。
ms.subservice: ''
ms.topic: conceptual
author: bwren
ms.author: bwren
ms.date: 03/12/2020
ms.openlocfilehash: a6ab126c3a5b0d2a82b17fac42dcc9e20f6aba3f
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/28/2020
ms.locfileid: "79480448"
---
# <a name="create-interactive-reports-azure-monitor-for-vms-with-workbooks"></a>使用活頁簿建立適用於 VM 的 Azure 監視器互動式報表

活頁簿將文本、 [日誌查詢](../log-query/query-language.md)、指標和參數合併為豐富的互動式報表。 活頁簿可以由具有相同 Azure 資源存取權的其他小組成員編輯。

活頁簿適用于以下方案：

* 當您事先不知道感興趣的指標時，探索虛擬機器的使用：CPU 利用率、磁碟空間、記憶體、網路依賴關係等。與其他使用方式分析工具不同，活頁簿允許您組合多種視覺化和分析，使其成為這種自由形式的探索的絕佳去。
* 通過顯示關鍵計數器和其他日誌事件的指標，向您的團隊解釋最近預配的 VM 的性能。
* 與團隊的其他成員共用 VM 大小調整實驗的結果。 您可以使用文本解釋實驗的目標，然後顯示用於評估實驗的每個使用指標和分析查詢，以及每個指標是否高於或低於目標的明確呼出。
* 報告中斷對 VM 使用的影響，將資料、文本說明和討論防止將來停機的後續步驟結合起來。

下表總結了 Azure 監視器為 VM 提供的活頁簿，以便開始。

| 活頁簿 | 描述 | 影響範圍 |
|----------|-------------|-------|
| 效能 | 在單個活頁簿中提供我們 Top N 清單和圖表視圖的可自訂版本，該活頁簿利用了您啟用的所有日誌分析效能計數器。| 大規模 |
| 效能計數器 | 跨一組效能計數器的 Top N 圖表視圖。 | 大規模 |
| 連接 | 連接提供來自受監視 VM 的入站和出站連接的深度視圖。 | 大規模 |
| 使用中的連接埠 | 提供綁定到受監視 VM 上的埠的進程的清單及其在所選時間範圍內的活動。 | 大規模 |
| 開放連接埠 | 提供受監視 VM 上打開的埠數以及這些打開端口的詳細資訊。 | 大規模 |
| 失敗的連線 | 顯示受監視 VM 上失敗連接的計數、故障趨勢以及故障百分比是否隨時間而增加。 | 大規模 |
| 安全性和稽核 | 分析您的 TCP/IP 流量，用於報告 IP 終結點在全球駐留在全域的總體連接、惡意連接。  要啟用所有功能，您需要啟用安全檢測。 | 大規模 |
| TCP 流量 | 監控的 VM 及其在網格中的發送、接收和總網路流量的排名報告，並顯示為趨勢線。 | 大規模 |
| 流量比較 | 此活頁簿允許您比較一台電腦或一組電腦的網路流量趨勢。 | 大規模 |
| 效能 | 提供可自訂版本的效能檢視，利用您啟用的所有日誌分析效能計數器。 | 單一 VM | 
| 連接 | 連接提供來自 VM 的入站和出站連接的深度視圖。 | 單一 VM |
 
## <a name="creating-a-new-workbook"></a>創建新活頁簿

活頁簿由獨立可編輯的圖表、表格、文字及輸入控制項之區段組成。 為了更好地瞭解活頁簿，讓我們從打開範本開始，然後演練創建自訂活頁簿。 

1. 登錄到 Azure[門戶](https://portal.azure.com)。

2. 選取 [虛擬機器]****。

3. 從清單中選取 VM。

4. 在 VM 頁上，在 **"監視**"部分中，選擇 **"見解**"。

5. 在 VM 見解頁上，選擇 **"性能**"或 **"地圖"** 選項卡，然後從頁面上的連結中選擇 **"查看活頁簿**"。 從下拉清單中，選擇 **"轉到庫**"。

    ![活頁簿下拉清單的螢幕截圖](media/vminsights-workbooks/workbook-dropdown-gallery-01.png)

    這將啟動活頁簿庫與一些預構建的活頁簿，以説明您入門。

7. 通過選擇 **"新建**"創建新活頁簿。

    ![活頁簿資源庫螢幕擷取畫面](media/vminsights-workbooks/workbook-gallery-01.png)

## <a name="editing-workbook-sections"></a>編輯活頁簿區段

活頁簿有兩種模式：**編輯模式**和**閱讀模式**。 初次開機新活頁簿時，它將在**編輯模式下**打開。 它顯示活頁簿的所有內容，包括隱藏的任何步驟和參數。 **閱讀模式**呈現簡化的報告樣式檢視畫面。 讀取模式允許您抽象創建報表的複雜性，同時在需要修改時，底層機制只需點擊幾下即可。

![VM 活頁簿的 Azure 監視器部分編輯控制項](media/vminsights-workbooks/workbook-new-workbook-editor-01.png)

1. 編輯完某個分區後，按一下該節左下角的 **"完成編輯**"。

2. 若要建立區段的複本，按一下 [複製此區段]**** 圖示。 建立重複的區段是逐一查看查詢而不會遺失先前反覆項目的絕佳方式。

3. 若要在活頁簿中將區段上移，按一下 [上移]**** 或 [下移]**** 圖示。

4. 若要永久移除區段，按一下 [移除]**** 圖示。

## <a name="adding-text-and-markdown-sections"></a>新增文字和 Markdown 區段

將標題、說明及註解新增至您的活頁簿，可協助將一組資料表和圖表變成敘述。 活頁簿中的文字區段支援 [Markdown 語法](https://daringfireball.net/projects/markdown/)以進行文字格式設定，例如標題、粗體、斜體和項目符號清單。

若要將文字區段新增至您的活頁簿，請使用活頁部底端或任何區段底端的 [新增文字]**** 按鈕。

## <a name="adding-query-sections"></a>加入查詢區段

![活頁簿中的查詢區段](media/vminsights-workbooks/005-workbook-query-section.png)

若要將查詢區段新增至您的活頁簿，請使用活頁部底端或任何區段底端的 [新增查詢]**** 按鈕。

查詢區段十分有彈性，可以用以回答下述問題：

* 在網路流量增加的同一時間段內，我的 CPU 利用率如何？
* 上個月可用磁碟空間的趨勢是什麼？
* 在過去兩周內，我的 VM 經歷了多少次網路連接故障？ 

您還僅限於從啟動活頁簿的虛擬機器的上下文中進行查詢。 只要您有權訪問這些資源，就可以跨多個虛擬機器以及日誌分析工作區進行查詢。

使用**工作區**識別碼包括來自其他日誌分析工作區或特定應用程式見解應用的資料。 要瞭解有關跨資源查詢的詳細資訊，請參閱[官方指南](../log-query/cross-workspace-query.md)。

### <a name="advanced-analytic-query-settings"></a>進階分析查詢設定

每個部分都有自己的高級設置，可通過"**添加參數"** 按鈕右側的!["活頁簿"部分](media/vminsights-workbooks/006-settings.png)編輯控制項圖示進行訪問。

![VM 活頁簿的 Azure 監視器部分編輯控制項](media/vminsights-workbooks/007-settings-expanded.png)

|         |          |
| ---------------- |:-----|
| **自訂寬度**    | 使專案具有任意大小，因此您可以在一行中容納許多專案，從而更好地將圖表和表組織到豐富的互動式報表中。  |
| **依條件顯示** | 指定以在讀取模式下根據參數隱藏步驟。 |
| **匯出參數**| 允許網格或圖表中的選定行導致後續步驟更改值或變為可見值。  |
| **在未編輯時顯示查詢** | 即使在讀取模式下，也會在圖表或表格上方顯示查詢。
| **在未進行編輯時顯示 [在分析中開啟] 按鈕** | 將藍色 Analytics"分析"圖示添加到圖表的右側角，以便一鍵訪問。|

大部分的設定項目都很直覺，但要了解**匯出參數**，最好檢視使用此一功能之活頁簿。

預構建的活頁簿之一 - **TCP 流量**，提供有關來自 VM 的連接指標的資訊。

活頁簿的第一部分基於日誌查詢資料。 第二部分也基於日誌查詢資料，但在第一個表中選擇一行將互動式更新圖表的內容：

![VM 活頁簿的 Azure 監視器部分編輯控制項](media/vminsights-workbooks/008-workbook-tcp-traffic.png)

通過使用 **"選擇專案時，匯出在**表的日誌查詢中啟用的參數高級設置"可以執行此操作。

![VM 活頁簿的 Azure 監視器部分編輯控制項](media/vminsights-workbooks/009-settings-export.png)

然後，第二個日誌查詢在選擇行時利用匯出的值創建一組值，然後由節標題和圖表使用。 如果未選擇任何行，則隱藏節標題和圖表。 

例如，第二節中的隱藏參數使用網格中選擇的行中的以下引用：

```
VMConnection
| where TimeGenerated {TimeRange}
| where Computer in ("{ComputerName}") or '*' in ("{ComputerName}") 
| summarize Sent = sum(BytesSent), Received = sum(BytesReceived) by bin(TimeGenerated, {TimeRange:grain})
```

## <a name="adding-metrics-sections"></a>新增計量區段

計量區段讓您能存取所有 Azure 監視器計量資料，納入您的互動式報表中。 在 VM 的 Azure 監視器中，預構建的活頁簿通常包含分析查詢資料，而不是指標資料。  您可以選擇使用指標資料創建活頁簿，從而充分利用這兩種功能的最佳功能。 您也可以從任何可存取之訂閱的資源，提取計量資料。

下面是將虛擬機器資料拉入活頁簿以提供 CPU 性能網格視覺化的示例：

![VM 活頁簿的 Azure 監視器部分編輯控制項](media/vminsights-workbooks/010-metrics-grid.png)

## <a name="adding-parameter-sections"></a>新增參數區段

活頁簿參數讓您不需要手動編輯查詢或文字區段，便能改變活頁簿的值。 這樣便不需要了解其中分析查詢的語言，大幅拓展以活頁簿為基礎之報表潛在的觀眾。

將參數的名稱放在括弧中，像是 ``{parameterName}``，來取代查詢、文字、或其他參數區段中參數的值。 參數名稱僅限於與 JavaScript 識別碼、字母字元或底線類似的規則，後跟字母數位字元或底線。 舉例來說，**a1** 是可用的名稱，但 **1a** 則不被允許。

參數是線性的，從活頁簿最頂端往後面的步驟移動。  在活頁簿中稍後聲明的參數可以覆蓋前面聲明的參數。 這還允許使用查詢從前面定義的參數訪問值的參數。 在單一參數步驟中，參數也是線性的，順序從左到右，右邊的參數可以仰賴同一步驟中已經宣告的參數。
 
當前支援四種不同類型的參數：

|                  |      |
| ---------------- |:-----|
| **Text**    | 允許使用者編輯文字方塊，您可以選擇提供查詢以填充預設值。 |
| **下拉式清單** | 允許使用者從一組值中進行選擇。 |
| **時間範圍選擇器**| 允許使用者從預定義的時間範圍值集中進行選擇，或從自訂時間範圍中進行選擇。|
| **資源選取器** | 允許使用者從為活頁簿選擇的資源中進行選擇。|

### <a name="using-a-text-parameter"></a>使用文字參數

文字方塊中的使用者類型的值直接在查詢中替換，沒有轉義或報價。 如果您需要的值為字串，查詢中必須在參數前後加上引號 (像是 **'{parameter}'**)。

文本參數允許文字方塊中的值在任何地方使用。 它可以是表名、列名、函數名稱、運算子等。 文本參數類型具有一個設置 **"從分析查詢獲取預設值**"，它允許活頁簿作者使用查詢填充該文字方塊的預設值。

使用日誌查詢中的預設值時，僅將第一行的第一個值（行 0 行、列 0）用作預設值。 因此建議您將查詢限制為只傳回一行一列。 查詢所傳回的任何其他資料會被忽略。 

查詢傳回的任何值都將會直接被取代為不含逃脫字元或引號的版本。 若查詢未傳回任何資料列，參數之結果將為空白字串 (若參數並非必須) 或未定義 (若參數為必須)。

### <a name="using-a-drop-down"></a>使用下拉清單

下拉參數類型允許您創建下拉控制項，從而允許選擇一個或多個值。

下拉清單由日誌查詢或 JSON 填充。 如果查詢返回一列，則該列中的值既是下拉控制項中的值，也是下拉控制項中的標籤。 如果查詢返回兩列，則第一列是值，第二列是下拉顯示的標籤。 如果查詢返回三列，則第三列用於指示該下拉清單中的預設選擇。 此一資料行可以為任何型別，最簡單的方式是使用布林或數字型別，0 為 false，1 為 true。

若資料行為字串型別，Null/空白字串將被視為 false，其他任何值都視為 true。 對於單個選擇下拉清單，第一個具有真實值的值用作預設選擇。  對於多個選擇下拉清單，所有具有真實值的值都用作預設選擇集。 下拉清單中的項以查詢返回行的任何順序顯示。 

讓我們看一下連接概述報告中的參數。 按一下**方向**旁邊的編輯符號。

![VM 活頁簿的 Azure 監視器部分編輯控制項](media/vminsights-workbooks/011-workbook-using-dropdown.png)

這將啟動 **"編輯參數"** 功能表項目。

![VM 活頁簿的 Azure 監視器部分編輯控制項](media/vminsights-workbooks/012-workbook-edit-parameter.png)

JSON 允許您生成一個填充內容的任意表。 例如，以下 JSON 在下拉清單中生成兩個值：

```
[
    { "value": "inbound", "label": "Inbound"},
    { "value": "outbound", "label": "Outbound"}
]
```

更適用的示例是使用下拉清單按名稱從一組效能計數器中選取：

```
Perf
| summarize by CounterName, ObjectName
| order by ObjectName asc, CounterName asc
| project Counter = pack('counter', CounterName, 'object', ObjectName), CounterName, group = ObjectName
```

查詢如下顯示結果：

![佩爾夫計數器下拉](media/vminsights-workbooks/013-workbook-edit-parameter-perf-counters.png)

下拉清單是自訂和創建互動式報表的非常強大的工具。

### <a name="time-range-parameters"></a>時間範圍參數

雖然您可以使用下拉式參數型別來建立您自己自訂的時間範圍參數，若您不需要自訂參數所提供的彈性，您也可以使用已經建立好的時間範圍參數型別。 

時間範圍參數型別有 15 種預設範圍，短至五分鐘，長至 90 天。 您還可以選擇允許自訂時間範圍選取，讓報表的操作者能指定時間範圍的起始值及終止值。

### <a name="resource-picker"></a>資源選擇器

資源選擇器參數型別讓您能根據特定資源類型設定報表範圍。 利用資源選取器類型的預構建活頁簿的一個示例是**性能**活頁簿。

![工作區下拉清單](media/vminsights-workbooks/014-workbook-edit-parameter-workspaces.png)

## <a name="saving-and-sharing-workbooks-with-your-team"></a>儲存活頁簿並且與小組共用

活頁簿保存在日誌分析工作區或虛擬機器資源中，具體取決於您訪問活頁簿庫的方式。 活頁簿可以保存到您專用的"**我的報告"** 部分或有權訪問資源的每個人都可以訪問的 **"共用報告**"部分中。 若要檢視資源中的所有活頁簿，請按一下動作列中的 [開啟]**** 按鈕。

若要共用目前在 [我的報表]**** 的活頁簿：

1. 按一下動作列中的 [開啟]****
2. 按一下您想要共用之活頁簿旁邊的 [...] 按鈕
3. 按一下 [移至共用報表]****。

若要使用連結或透過電子郵件共用活頁簿，請按一下動作列中的 [共用]****。 請注意，連結的收件者需要在 Azure 入口網站中存取此資源的存取權，才能檢視活頁簿。 若要進行編輯，收件者至少需要資源的參與者權限。

若要將活頁簿的連結釘選到 Azure 儀表板：

1. 按一下動作列中的 [開啟]****
2. 按一下您想要釘選之活頁簿旁邊的 [...] 按鈕
3. 按一下 [釘選到儀表板]****。

## <a name="next-steps"></a>後續步驟

- 要確定限制和整體 VM 性能，請參閱[查看 Azure VM 性能](vminsights-performance.md)。

- 要瞭解已發現的應用程式依賴項，請參閱[查看 VM 映射的 Azure 監視器](vminsights-maps.md)。
