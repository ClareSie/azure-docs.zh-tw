---
title: 在 Azure 應用程式閘道上啟用端到端 TLS
description: 本文概述了應用程式閘道端到端 TLS 支援。
services: application-gateway
author: amsriva
ms.service: application-gateway
ms.topic: article
ms.date: 3/19/2019
ms.author: victorh
ms.openlocfilehash: ae80b49c3bfb40743665768622d3f4a8a6990c12
ms.sourcegitcommit: 7e04a51363de29322de08d2c5024d97506937a60
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 04/14/2020
ms.locfileid: "81311855"
---
# <a name="overview-of-tls-termination-and-end-to-end-tls-with-application-gateway"></a>使用應用程式閘道 TLS 連接端與端 TLS 概述

傳輸層安全 (TLS)以前稱為安全套接字層 (SSL),是建立 Web 伺服器和瀏覽器之間加密連結的標準安全技術。 此連結可確保在 Web 伺服器和瀏覽器之間傳遞的所有數據都保持私有和加密。 應用程式閘道支援閘道的 TLS 端接以及端到端 TLS 加密。

## <a name="tls-termination"></a>TLS 終止

應用程式閘道支援在閘道處終止 TLS,之後流量通常未加密地流向後端伺服器。 在應用程式閘道執行 TLS 端接有許多優點:

- **改進的性能**– 執行 TLS 解密時的最大性能衝擊是初始握手。 為了提高性能,執行解密的伺服器緩存 TLS 會話 I 並管理 TLS 作業階段票證。 如果在應用程式閘道完成此操作,則來自同一用戶端的所有請求都可以使用緩存的值。 如果在後端伺服器上完成,則每次用戶端的請求轉到其他伺服器時,客戶端必須重新進行身份驗證。 使用 TLS 票證有助於緩解此問題,但並非所有用戶端都支援它們,並且可能難以配置和管理。
- **更好地利用後端伺服器**– SSL/TLS 處理非常需要 CPU,並且隨著密鑰大小的增加而變得更加密集。 從後端伺服器中刪除此工作,使他們能夠專注於他們最高效的內容,交付內容。
- **智慧路由**– 通過解密流量,應用程式閘道可以造訪請求內容(如標頭、URI等),並可以使用此資料路由請求。
- **憑證管理**– 證書只需在應用程式閘道上購買和安裝,而不需要在所有後端伺服器上安裝。 這節省了時間和金錢。

要配置 TLS 端接,需要向偵聽器添加 TLS/SSL 證書,以使應用程式閘道能夠按照 TLS/SSL 協定規範派生對稱密鑰。 然後,對稱密鑰用於加密和解密發送到閘道的流量。 TLS/SSL 憑證需要以個人資訊交換 (PFX) 格式使用。 此檔案格式可允許將私密金鑰匯出，而應用程式閘道需要這個匯出的金鑰來執行流量的加密和解密。

> [!NOTE] 
>
> 應用程式閘道不提供創建新證書或向證書頒發機構發送證書請求的任何功能。

對於 TLS 連線正常工作,您需要確保 TLS/SSL 憑證滿足以下條件:

- 當前日期和時間在證書上的"有效從"和"有效到"日期範圍內。
- 憑證的「一般名稱」(CN) 符合要求中的主機標頭。 例如，如果用戶端提出 `https://www.contoso.com/` 要求，則 CN 必須是 `www.contoso.com`。

### <a name="certificates-supported-for-tls-termination"></a>TLS 取消支援的憑證

應用程式閘道支援以下類型的憑證:

- CA(憑證授權機構)證書:CA 憑證是由憑證頒發機構 (CA) 頒發的數位憑證
- EV(擴展驗證)證書:EV 證書是符合行業標準證書準則的證書。 這將將瀏覽器定位器欄變為綠色,併發佈公司名稱。
- 通配符證書:此證書支援基於 *.site.com的任意數量的子域,您的子域將在此替換 *。 但是,它不支援site.com,因此,如果使用者在不鍵入領先"www"的情況下訪問您的網站,通配符證書將不涵蓋該功能。
- 自簽名證書:客戶端瀏覽器不信任這些證書,並將警告使用者虛擬服務的證書不是信任鏈的一部分。 自簽名證書適用於管理員控制用戶端並可以安全地繞過瀏覽器安全警報的測試或環境。 生產工作負載絕不應使用自簽名證書。

有關詳細資訊,請參閱[使用應用程式閘道設定 TLS 端接](https://docs.microsoft.com/azure/application-gateway/create-ssl-portal)。

### <a name="size-of-the-certificate"></a>憑證的大小
檢查[應用程式閘道限制](https://docs.microsoft.com/azure/azure-resource-manager/management/azure-subscription-service-limits#application-gateway-limits)部分,瞭解支援的最大 TLS/SSL 憑證大小。

## <a name="end-to-end-tls-encryption"></a>端到端 TLS 加密

某些客戶可能不希望與後端伺服器進行未加密的通信。 可能是因為安全性需求、合規性需求，或應用程式可能只接受安全連線。 對於此類應用程式,應用程式閘道支援端到端 TLS 加密。

端到端 TLS 允許您安全地將敏感數據傳輸到加密的後端,同時仍利用應用程式閘道提供的第 7 層負載平衡功能的優勢。 部分功能為 cookie 型工作階段親和性、URL 型路由、支援根據站台或能注入 X-Forwarded-* 標頭的路由。

當配置端到端 TLS 通信模式時,應用程式閘道將終止閘道上的 TLS 工作階段並解密使用者流量。 然後，它會套用所設定的規則來選取要將流量路由傳送到的適當後端集區執行個體。 然後,應用程式閘道啟動到後端伺服器的新 TLS 連接,並使用後端伺服器的公開金鑰證書重新加密資料,然後再將請求傳輸到後端。 任何來自 Web 伺服器的回應都會經歷相同的程序而回到使用者端。 通過在[後端 HTTP 設定](https://docs.microsoft.com/azure/application-gateway/configuration-overview#http-settings)中設定協定設定到 HTTPS,從而啟用端到端 TLS,然後應用於後端池。

TLS 策略適用於前端和後端流量。 在前端,應用程式閘道充當伺服器並強制執行策略。 在後端介面,應用程式閘道充當用戶端,並在 TLS 握手期間將協定/密碼資訊作為首選項發送。

應用程式閘道僅與已將其證書與應用程式閘道進行白名單的後端實例通訊,或者其證書由眾所周知的 CA 頒發機構簽名,其中證書 CN 與 HTTP 後端設置中的主機名匹配。 這些服務包括受信任的 Azure 服務,如 Azure 應用服務 Web 應用和 Azure API 管理。

如果後端介面中成員的證書未由眾所周知的 CA 頒發機構簽名,則必須使用證書配置後端池中啟用端到端 TLS 的每個實例以允許安全通訊。 新增憑證可確保應用程式閘道只會與已知的後端執行個體通訊。 這會進而保護端對端通訊。

> [!NOTE] 
>
> 受信任的 Azure 服務(如 Azure 應用服務 Web 應用和 Azure API 管理)不需要身份驗證證書設置。

> [!NOTE] 
>
> 添加到**後端介面 HTTP 設定**以對後端伺服器進行身份驗證的憑證可以與在應用程式閘道為 TLS 終止而添加到**偵聽器**的證書相同,也可以為增強安全性而不同。

![端到端 tls 專案][1]

在此範例中,使用 TLS1.2 的請求使用端到端 TLS 路由到池 1 中的後端伺服器。

## <a name="end-to-end-tls-and-whitelisting-of-certificates"></a>端到端 TLS 和憑證白名單

應用程式閘道只會與已知的後端執行個體通訊，後者已將其憑證加入到應用程式閘道的允許清單。 若要啟用憑證允許清單，您必須將後端伺服器憑證的公開金鑰上傳至應用程式閘道 (不是根憑證)。 於是，只允許連接至已知和允許清單中的後端。 其餘的後端會導致閘道錯誤。 自我簽署憑證僅供測試之用，並不建議用於生產工作負載。 這類憑證必須如先前步驟所述，加入應用程式閘道的允許清單之中，才能使用。

> [!NOTE]
> 受信任的 Azure 服務 (例如 Azure App Service) 不需進行驗證憑證設定。

## <a name="end-to-end-tls-with-the-v2-sku"></a>使用 v2 SKU 連接到端 TLS

在「應用程式閘道 v2 SKU」中，「驗證憑證」已被淘汰且被「受信任的根憑證」取代。 它們的功能與「驗證憑證」類似，但有幾個主要差異：

- 由眾所周知的 CA 頒發機構簽名的證書,其 CN 與 HTTP 後端設置中的主機名匹配,不需要任何額外的步驟才能端到端 TLS 工作。 

   例如，如果後端憑證是由已知 CA 所簽發且 CN 為 contoso.com，而後端 HTTP 設定的主機欄位也設定為 contoso.com，便無須執行任何其他步驟。 您可以將後端 HTTP 設定協定設定為 HTTPS,並且執行狀況探測和資料路徑都將啟用 TLS。 如果使用 Azure 應用服務或其他 Azure Web 服務作為後端,則這些服務也隱式受信任,並且不需要執行端到端 TLS 的進一步步驟。
   
> [!NOTE] 
>
> 為了使 TLS/SSL 憑證受信任, 後端伺服器的憑證必須由包含在應用程式閘道的受信任儲存中的 CA 頒發。 如果憑證不是由受信任的 CA 頒發的,則應用程式閘道將檢查頒發 CA 的證書是否由受信任的 CA 頒發,等等,直到找到受信任的 CA(此時將建立受信任的安全連線)或找不到受信任的 CA(此時應用程式閘道將標記後端)。 因此,建議後端伺服器證書同時包含根和中間的 C。

- 如果證書是自簽名的,或者由未知仲介簽名,那麼要在 v2 SKU 中啟用端到端 TLS,必須定義受信任的根證書。 「應用程式閘道」只會與符合下列條件的後端進行通訊：其伺服器憑證的根憑證符合與集區相關之後端 HTTP 設定中受信任根憑證清單內的其中一個憑證。

> [!NOTE] 
>
> 自簽名證書必須是證書鏈的一部分。 V2 SKU 不支援單個沒有鏈的自簽名證書。

- 除了根證書匹配之外,應用程式閘道還驗證後端 HTTP 設定中指定的主機設定是否與後端伺服器 TLS/SSL 憑證提供的常見名稱 (CN) 的主機設置匹配。 嘗試建立後端的 TLS 連接時,應用程式閘道將伺服器名稱指示 (SNI) 延伸設定為後端 http 設定中指定的主機。
- 如果**從後端位址選擇主機名**而不是後端 HTTP 設定中的主機欄位,則 SNI 標頭始終設置為後端池 FQDN,後端伺服器 TLS/SSL 憑證上的 CN 必須與其 FQDN 匹配。 此方案中不支援具有 IP 的後端池成員。
- 根憑證是一個來自後端伺服器憑證的 Base64 編碼根憑證。

## <a name="next-steps"></a>後續步驟

瞭解端到端 TLS 後,[使用 PowerShell 的應用程式閘道使用 PowerShell](application-gateway-end-to-end-ssl-powershell.md)建立使用端到端 TLS 的應用程式閘道,從而轉到端到端 TLS 配置。

<!--Image references-->

[1]: ./media/ssl-overview/scenario.png
