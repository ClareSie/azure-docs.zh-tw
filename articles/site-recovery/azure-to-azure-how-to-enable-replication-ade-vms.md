---
title: 在 Azure 網站回復中為加密的 Azure VM 啟用複製
description: 本文介紹如何使用網站恢復配置啟用 Azure 磁碟加密的 VM 的複製,從一個 Azure 區域到另一個 Azure 區域。
author: asgang
manager: rochakm
ms.service: site-recovery
ms.topic: article
ms.date: 08/08/2019
ms.author: sutalasi
ms.openlocfilehash: 2bbb02df782439d934e96e7c16f28b9c11cc01fe
ms.sourcegitcommit: b80aafd2c71d7366838811e92bd234ddbab507b6
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 04/16/2020
ms.locfileid: "81408628"
---
# <a name="replicate-azure-disk-encryption-enabled-virtual-machines-to-another-azure-region"></a>將啟用 Azure 磁碟加密的虛擬機器複製到其他 Azure 區域

本文介紹如何在啟用 Azure 磁碟加密 (ADE) 後,將 Azure VM 從一個 Azure 區域複製到另一個 Azure 區域。

>[!NOTE]
> 網站恢復目前支援 ADE,並且沒有運行 Windows 作業系統的 VM 的 Azure 活動目錄 (AAD)。 對於 Linux 作業系統,我們僅支援沒有 AAD 的 ADE。 此外,對於運行 ADE 1.1(沒有 AAD)的計算機,VM 必須使用託管磁碟。 不支援具有非託管磁碟的 VM。 如果從 ADE 0.1(使用 AAD)切換到 1.1 ,則需要在啟用 1.1 後禁用複製並啟用 VM 的複製。


## <a name="required-user-permissions"></a><a id="required-user-permissions"></a>必要的使用者權限
網站恢復要求使用者具有在目標區域中創建密鑰保管庫的許可權,並將密鑰從源區域密鑰保管庫複製到目標區域密鑰保管庫。

要從 Azure 門戶啟用啟用磁碟加密的 VM,使用者需要對**來源區域和目標區域**金鑰保管庫具有以下許可權。

- 金鑰保存庫權限
    - 列出、建立與取得
    
- 金鑰保存庫祕密權限
    - 秘密管理操作
        - 取得、欄出與設定
    
- 金鑰保存金鑰權限 (僅當 VM 使用金鑰加密金鑰加密磁碟加密金鑰時才需要)
    - 關鍵管理運營
        - 取得、欄出與建立
    - 加密動作
        - 解密及加密

要管理許可權,請訪問門戶中的密鑰保管庫資源。 為使用者添加所需的許可權。 下面的範例展示如何對金鑰保管庫*ContosoWeb2Keyvault*(在來源區域中)啟用許可權。

1. 跳到**主頁** > **金鑰庫** > **ContosoWeb2KeyVault >访问策略**。

   ![金鑰保存權限視窗](./media/azure-to-azure-how-to-enable-replication-ade-vms/key-vault-permission-1.png)

2. 您可以看到沒有用戶許可權。 選取 [新增]****。 輸入使用者和許可權資訊。

   ![金鑰庫權限](./media/azure-to-azure-how-to-enable-replication-ade-vms/key-vault-permission-2.png)

如果啟用災難恢復 (DR) 的使用者沒有複製金鑰的許可權,則具有適當許可權的安全管理員可以使用以下文本將加密機密和密鑰複製到目標區域。

要排除權限,請參閱本文後面的[金鑰保管庫權限問題](#trusted-root-certificates-error-code-151066)。

>[!NOTE]
>要啟用從門戶複製啟用磁碟加密的 VM,至少需要密鑰保管庫、機密和密鑰上的"清單"許可權。

## <a name="copy-disk-encryption-keys-to-the-dr-region-by-using-the-powershell-script"></a>使用 PowerShell 文稿將磁碟加密金鑰複製到 DR 區域

1. [開啟複製金鑰的原始文稿程式](https://aka.ms/ade-asr-copy-keys-code)。
2. 將文稿複製到檔案,並將其命名為**Copy-keys.ps1**。
3. 打開 Windows PowerShell 應用程式,然後轉到保存檔案的資料夾。
4. 執行複製金鑰。
5. 提供要登錄的 Azure 認證。
6. 選取您 VM 的 **Azure 訂用帳戶**。
7. 等待載入資源群組,然後選擇 VM**的資源群組**。
8. 從顯示的清單中選擇 VM。 清單中只有啟用磁碟加密的 VM。
9. 選擇**目標位置**。

    - **磁碟加密金鑰保存庫**
    - **金鑰加密金鑰保存庫**

   根據預設，Site Recovery 會在目標區域中建立新的金鑰保存庫。 保存庫的名稱具有基於源 VM 磁碟加密金鑰的「asr」後綴。 如果網站恢復創建的密鑰保管庫已存在,則重新使用它。 如有必要,從清單中選擇其他密鑰保管庫。

## <a name="enable-replication"></a>啟用複寫

在此示例中,主要 Azure 區域是東亞,輔助區域是東南亞。

1. 在保管庫中,選擇 **+複製**。
2. 請注意以下欄位。
    - **來源**：VM 的起點，在此案例中為 **Azure**。
    - **源位置**:要保護虛擬機器的 Azure 區域。 在此示例中,源位置為「東亞」。。
    - **部署模型**:源電腦的 Azure 部署模型。
    - **來源訂用帳戶**：來源虛擬機器所屬的訂用帳戶。 它可以是與恢復服務保管庫位於同一 Azure 活動目錄租戶中的任何訂閱。
    - **資源群組**：來源虛擬機器所屬的資源群組。 所選資源組中的所有 VM 都列出,在下一步中進行保護。

3. 在**虛擬機** > **中選擇虛擬機器**,選擇要複製的每個 VM。 您只能選取可以啟用複寫的機器。 然後,選擇 **"確定**"。

4. 在 **「設置」** 中,可以配置以下目標網站設定。

    - **目標位置**:將複製源虛擬機器的位置。 網站恢復根據所選計算機的位置提供合適的目標區域的清單。 我們建議您使用與恢復服務保管庫位置相同的位置。
    - **目標訂閱**:用於災難恢復的目標訂閱。 根據預設，目標訂用帳戶會與來源訂用帳戶相同。
    - **目標資源群組**：所有已複寫虛擬機器所屬的資源群組。 預設情況下,網站恢復會在目標區域中創建新的資源組。 名稱獲取"asr"後綴。 如果 Azure 網站恢復建立的資源組已存在,則重新使用它。 您還可以選擇自定義它,如下節所示。 目標資源組的位置可以是除承載源虛擬機的區域以外的任何 Azure 區域。
    - **目標虛擬網路**:默認情況下,網站恢復在目標區域中創建新的虛擬網路。 名稱獲取"asr"後綴。 它已映射到源網路,並用於任何將來的保護。 [深入了解](site-recovery-network-mapping-azure-to-azure.md)網路對應。
    - **目標儲存帳戶(如果源 VM 不使用託管磁碟):** 預設情況下,網站恢復透過類比來源 VM 儲存配置創建新的目標存儲帳戶。 如果存儲帳戶已存在,則將其重用。
    - **複製託管磁碟(如果源 VM 使用託管磁碟):** 站點恢復在目標區域中創建新的複製管理磁碟,以鏡像來源 VM 的託管磁碟,這些磁碟的儲存類型(標準或高級)與源 VM 的託管磁碟相同。
    - **快取儲存帳戶**:網站恢復需要在源區域中稱為*快存存儲*的額外存儲帳戶。 跟蹤來源 VM 上的所有更改並將其發送到快取儲存帳戶。 然後,它們被複製到目標位置。
    - **可用性集**:默認情況下,網站恢復會在目標區域中創建新的可用性集。 名稱具有"asr"後綴。 如果網站恢復創建的可用性集已存在,則重複使用。
    - **磁碟加密金鑰保管庫**:默認情況下,網站恢復會在目標區域中創建新的密鑰保管庫。 它有一個基於源 VM 磁碟加密密鑰的"asr"後綴。 如果 Azure 網站恢復創建的密鑰保管庫已存在,則重新使用它。
    - **金鑰加密金鑰保存庫**：根據預設，Site Recovery 會在目標區域中建立新的金鑰保存庫。 該名稱具有基於源 VM 金鑰加密金鑰的「asr」後綴。 如果 Azure 網站恢復創建的密鑰保管庫已存在,則重新使用它。
    - **複製策略**:定義恢復點保留歷史記錄和應用一致的快照頻率的設置。 預設情況下,網站恢復會創建一個新的複製策略,預設設置為*24 小時*,用於恢復點保留 *,60 分鐘*用於應用一致的快照頻率。

## <a name="customize-target-resources"></a>自訂目標資源

按照以下步驟修改網站恢復預設目標設置。

1. 選擇「目標訂閱」旁邊的 **「自訂**」以修改預設目標訂閱。 從 Azure AD 租戶中可用的訂閱清單中選擇訂閱。

2. 選擇「資源群組、網路、儲存和可用性集」旁邊的 **「自訂**」以修改以下預設設定:
    - 對於**目標資源組**,從訂閱的目標位置的資源組列表中選擇資源組。
    - 對於**目標虛擬網路**,從目標位置的虛擬網路清單中選擇網路。
    - 對於**可用性集**,您可以將可用性集設置添加到 VM(如果它們是源區域中的可用性集的一部分)。
    - 對於**目標存儲帳戶**,選擇要使用的帳戶。

2. 選擇 **「加密**設定」旁邊的「自訂」以修改以下預設設定:
   - 對於**目標磁碟加密密鑰保管庫**,從訂閱的目標位置的密鑰保管庫清單中選擇目標磁碟加密密鑰保管庫。
   - 對於**目標金鑰加密金鑰保管庫**,從訂閱目標位置的密鑰保管庫清單中選擇目標密鑰加密金鑰保管庫。

3. 選擇 **「創建目標資源** > **啟用複製**」。
4. 開啟 VM 進行複製後,您可以在 **「複製項目**」下檢查 VM 的執行狀況。

>[!NOTE]
>在初始複製期間,狀態可能需要一些時間刷新,而不會有明顯進展。 按下 **「刷新**」獲取最新狀態。

## <a name="update-target-vm-encryption-settings"></a>更新目標 VM 加密設定
在以下機制中,您需要更新目標 VM 加密設定:
  - 您在 VM 上啟用了網站恢復複製。 稍後,您在源 VM 上啟用了磁碟加密。
  - 您在 VM 上啟用了網站恢復複製。 稍後,您更改了源 VM 上的磁碟加密密鑰或密鑰加密金鑰。

您可以使用[文稿](#copy-disk-encryption-keys-to-the-dr-region-by-using-the-powershell-script)將加密密鑰複製到目標區域,然後在**恢復服務保管庫** > *複製的專案* > **屬性** > **計算和網路**中更新目標加密設置。

![更新 ADE 設定對話框視窗](./media/azure-to-azure-how-to-enable-replication-ade-vms/update-ade-settings.png)

## <a name="troubleshoot-key-vault-permission-issues-during--azure-to-azure-vm-replication"></a><a id="trusted-root-certificates-error-code-151066"></a>在 Azure 到 Azure VM 複製期間解決金鑰保管庫權限問題

Azure 網站恢復至少需要對源區域金鑰保管庫的讀取許可權,並在目標區域密鑰保管庫上寫入許可權才能讀取機密並將其複製到目標區域密鑰保管庫。 

**原因 1:** 來源**區域「金鑰庫**」上沒有讀取金鑰的「GET」許可權。 </br>
**如何修復:** 無論您是訂閱管理員,都必須獲得密鑰保管庫的許可權。

1. 跳到來源區域金鑰保管庫,在此範例中為「ContososourceKeyvault」>**存取策略** 
2. 在 **"選擇主體"** 下添加您的使用者名dradmin@contoso.com,例如 :""
3. 在 **「金鑰權限」** 選擇 GET 
4. 在 **「機密權限」** 選擇 GET 
5. 儲存存取原則

**原因 2:** 您不需要**對目標區域金鑰保管庫**進行寫入金鑰的許可權。 </br>

*例如*:您嘗試複製在源區域上具有密鑰保管庫*ContososourceKeyvault*的 VM。
您擁有源區域金鑰保管庫的所有許可權。 但在保護期間,您可以選擇已創建的關鍵保管庫 ContosotargetKeyvault,該金鑰庫沒有許可權。 發生錯誤。

[目的金鑰保存庫](#required-user-permissions)需要的權限

**如何修復:** 轉到**主頁** > **金鑰保管庫** > **ContosotargetKeyvault** > **訪問策略**並添加相應的許可權。

## <a name="next-steps"></a>後續步驟

[深入了解](site-recovery-test-failover-to-azure.md)執行測試容錯移轉。
