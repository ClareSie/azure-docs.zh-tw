---
title: 使用 MABS 備份 Hyper-v 虛擬機器
description: 本文包含使用 Microsoft Azure 備份 Server (MABS) 來備份和復原虛擬機器的程式。
ms.topic: conceptual
ms.date: 07/18/2019
ms.openlocfilehash: fc4e34e11e2474521082b1c23f600e9a5ca7a9fe
ms.sourcegitcommit: 3246e278d094f0ae435c2393ebf278914ec7b97b
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/02/2020
ms.locfileid: "89377993"
---
# <a name="back-up-hyper-v-virtual-machines-with-azure-backup-server"></a>使用 Azure 備份伺服器備份 Hyper-v 虛擬機器

本文說明如何使用 Microsoft Azure 備份 Server (MABS) 來備份 Hyper-v 虛擬機器。

## <a name="supported-scenarios"></a>支援的案例

在下列情況下，MABS 可以備份在 Hyper-v 主機伺服器上執行的虛擬機器：

- **具有本機或直接儲存空間的虛擬機器**：備份裝載在 Hyper-V 主機獨立伺服器上具有本機或直接連接儲存空間的虛擬機器。 例如：硬碟、存放區域網路 (SAN) 裝置，或連接到網路的存放裝置 (NAS) 裝置。 MABS 保護代理程式必須安裝在所有主機上。

- **具有 CSV 儲存空間之叢集中的虛擬機器**：備份裝載在 Hyper-V 叢集上具有叢集共用磁碟區 (CSV) 儲存空間的虛擬機器。 MABS 保護代理程式會安裝在每個叢集節點上。

## <a name="host-versus-guest-backup"></a>主機與來賓備份

MABS 可以進行 Hyper-v Vm 的主機或來賓層級備份。 在主機層級，MABS 保護代理程式會安裝在 Hyper-v 主機伺服器或叢集上，並保護在該主機上執行的整個 Vm 和資料檔案。   在來賓層級上，代理程式會安裝在每部虛擬機器上，並保護該電腦上的工作負載。

兩種方法各有其優缺點︰

- 主機層級備份很有彈性，因為無論來賓電腦上執行的作業系統類型為何，都能運作，而且不需要在每部 VM 上安裝 MABS 保護代理程式。 如果您部署主機層級備份，您可以復原整個虛擬機器，或是 (專案層級復原) 的檔案和資料夾。

- 如果您想要保護在虛擬機器上執行的特定工作負載，來賓層級備份會很有用。 在主機層級中，您可以復原整個 VM 或特定檔案，但不會在特定應用程式的內容中提供復原。 例如，若要從備份的 VM 復原特定的 SharePoint 專案，您應該進行該 VM 的來賓層級備份。 如果您想要保護傳遞磁片上儲存的資料，請使用來賓層級備份。 傳遞允許虛擬機器直接存取存放裝置，而不會將虛擬磁片區資料儲存在 VHD 檔案中。

## <a name="how-the-backup-process-works"></a>備份程式的運作方式

MABS 會以 VSS 執行備份，如下所示。 為了清楚呈現，這項描述中的步驟會依號碼列示。

1. MABS 區塊型同步處理引擎會建立受保護虛擬機器的初始複本，並確保虛擬機器的複本完整且一致。

2. 進行初始複製並驗證之後，MABS 會使用 Hyper-v VSS 寫入器來捕獲備份。 VSS 寫入器會提供一組與 MABS 伺服器同步的資料一致的磁片區塊。 這種方法可提供 MABS 伺服器「完整備份」的優點，同時將必須透過網路傳輸的備份資料降到最低。

3. 執行 Hyper-v 之伺服器上的 MABS 保護代理程式會使用現有的 Hyper-v Api，判斷受保護的虛擬機器是否也支援 VSS。

   - 如果虛擬機器符合線上備份的需求，而且已安裝 Hyper-V 整合服務元件，則 Hyper-V VSS 寫入器會以遞迴方式將 VSS 要求轉送到虛擬機器上的所有 VSS 感知處理程序。 若未在虛擬機器上安裝 MABS 保護代理程式，就會發生這種操作。 這種遞迴的 VSS 要求可讓 Hyper-V VSS 寫入器確保磁碟寫入操作保持同步，以避免擷取 VSS 快照集時遺失資料。

     Hyper-V 整合服務元件會在虛擬機器上叫用磁碟區陰影複製服務 (VSS) 中的 Hyper-V VSS 寫入器，確保其應用程式資料處於一致的狀態。

   - 如果虛擬機器不符合線上備份需求，MABS 會自動使用 Hyper-v Api 暫停虛擬機器，然後再捕捉到資料檔案。

4. 虛擬機器的初始基準複本與 MABS 伺服器進行同步處理之後，就會在新的復原點中捕捉對虛擬機器資源進行的所有變更。 復原點代表虛擬機器在特定時間的一致狀態。 擷取復原點的操作一天可能至少會執行一次。 建立新的復原點時，MABS 會使用區塊層級的複寫搭配 Hyper-v VSS 寫入器，以判斷在上次建立復原點之後，哪些區塊在執行 Hyper-v 的伺服器上已經改變。 接著這些資料區塊會傳輸到 MABS 伺服器，並套用至受保護資料的複本。

5. MABS 伺服器會在裝載修復資料的磁片區上使用 VSS，以便提供多個陰影複製。 這些陰影複本各自提供一次個別的復原。 VSS 復原點會儲存在 MABS 伺服器上。 在執行 Hyper-v 的伺服器上製作的暫存複本，只會在 MABS 同步處理期間儲存。

>[!NOTE]
>
>從 Windows Server 2016 開始，Hyper-v 虛擬硬碟內建的變更追蹤稱為復原變更追蹤， (.RCT) 。 MABS 會使用 .RCT (Hyper-v) 中的原生變更追蹤，如此可減少在 VM 損毀的情況下，耗用耗時一致性檢查的需求。 RCT 提供的復原優於 VSS 快照集備份提供的變更追蹤。 在任何一致性檢查期間，MABS V3 只會傳送變更的資料，藉此進一步最佳化網路和儲存體耗用量。

## <a name="backup-prerequisites"></a>備份的必要條件

以下是使用 MABS 備份 Hyper-v 虛擬機器的必要條件：

|必要條件|詳細資料|
|------------|-------|
|MABS 必要條件|-如果您想要執行虛擬機器的專案層級復原 (復原檔案、資料夾、磁片區) ，您必須在 MABS 伺服器上安裝 Hyper-v 角色。  如果您只想要復原虛擬機器而非專案層級，則不需要此角色。<br />-您可以在單一 MABS 伺服器上保護多達800部 100 GB 的虛擬機器，並允許多部支援較大型叢集的 MABS 伺服器。<br />-MABS 會將分頁檔從增量備份中排除，以改善虛擬機器備份效能。<br />-MABS 可以在與 MABS 伺服器相同的網域中，或在子系或受信任的網域中，備份 Hyper-v 伺服器或叢集。 如果您想要在工作組或不受信任的網域中備份 Hyper-v，您將需要設定驗證。 若為單一 Hyper-v 伺服器，您可以使用 NTLM 或憑證驗證。 針對叢集，您只能使用憑證驗證。<br />-   不支援在傳遞磁碟上使用主機層級備份來備份虛擬機器資料。 在此案例中，建議您使用主機層級備份來備份 VHD 檔案和來賓層級備份，以備份主機上看不到的其他資料。<br />   -您可以備份儲存在重復資料刪除磁片區上的 Vm。|
|Hyper-V VM 的必要條件|-在虛擬機器上執行的整合元件版本應該與 Hyper-v 主機的版本相同。 <br />-   針對每個虛擬機器備份，裝載虛擬硬碟檔案的磁碟區上需有可用空間，以允許 Hyper-V 在備份過程中為差異磁碟 (AVHD) 保留足夠的空間。 此空間大小必須至少等於計算結果：**初始磁碟大小\*變換率\*備份**間隔時間。 如果您在叢集上執行多個備份，透過這個計算方式，您需要足夠的儲存容量來容納每個虛擬機器的 AVHD。<br />-若要備份位於執行 Windows Server 2012 R2 的 Hyper-v 主機伺服器上的虛擬機器，虛擬機器應該已指定 SCSI 控制器，即使該控制器未連接到任何網路。  (在 Windows Server 2012 R2 線上備份中，Hyper-v 主機會在 VM 中裝載新的 VHD，之後再將它卸載。 只有 SCSI 控制器可以支援此功能，因此，虛擬機器的線上備份需要此控制器。  若未設定此設定，當您嘗試備份虛擬機器時，將會發出事件識別碼10103。 ) |
|Linux 必要條件|-您可以使用 MABS 來備份 Linux 虛擬機器。 僅支援檔案一致的快照集。|
|使用 CSV 儲存空間備份 VM|-   若是 CSV 儲存空間，請在 Hyper-V 伺服器上安裝磁碟區陰影複製服務 (VSS) 硬體提供者。 如需 VSS 硬體提供者的資訊，請連絡您的存放區域網路 (SAN) 廠商。<br />-如果 CSV 叢集中的單一節點意外關閉，MABS 就會針對該節點上執行的虛擬機器執行一致性檢查。<br />-   如果您需要重新啟動已啟用 BitLocker 磁碟區加密的 Hyper-V 伺服器，就必須為 Hyper-V 虛擬機器執行一致性檢查。|
|使用 SMB 儲存空間備份 VM|-在執行 Hyper-v 的伺服器上開啟自動掛接，以啟用虛擬機器保護。<br />   -   停用 TCP Chimney 卸載。<br />-   確認所有的 Hyper-V machine$ 帳戶對於特定遠端 SMB 檔案共用皆具有完整權限。<br />-確認復原至替代位置期間，所有虛擬機器元件的檔案路徑都少於260個字元。 如果沒有，復原可能會成功，但 Hyper-v 將無法掛接虛擬機器。<br />-不支援下列案例：<br />     虛擬機器的某些元件在本機磁片區上，而某些元件位於遠端磁片區的部署;儲存位置檔案伺服器的 IPv4 或 IPv6 位址，以及將虛擬機器復原到使用遠端 SMB 共用的電腦。<br />-您必須在每部 SMB 伺服器上啟用檔案伺服器 VSS 代理程式服務-請在 [**新增角色及功能**] 中將它新增至 [  >  **選取伺服器角色**檔案  >  **和儲存服務**檔案服務檔  >  **File Services**  >  **File Service**  >  **伺服器 VSS 代理程式服務**]。|

## <a name="back-up-virtual-machines"></a>備份虛擬機器

1. 設定您的 [MABS 伺服器](backup-azure-microsoft-azure-backup.md) 和 [儲存體](backup-mabs-add-storage.md)。 設定您的存放裝置時，請使用這些存放裝置容量指導方針。
   - 平均虛擬機器大小 - 100 GB
   - 每個 MABS 伺服器的虛擬機器數目-800
   - 800 部 VM 的總大小 - 80 TB
   - 備份存放裝置需要的空間 - 80 TB

2. 在 Hyper-v 伺服器或 Hyper-v 叢集節點上設定 MABS 保護代理程式。 如果您正在執行來賓層級備份，您將會在您想要在來賓層級備份的 Vm 上安裝代理程式。

3. 在 MABS 系統管理員主控台中，選取 [**保護**  >  **建立保護群組**] 以開啟 [**建立新保護組**嚮導]。

4. 在 [選擇群組成員]**** 頁面中，從 VM 所在的 Hyper-V 主機伺服器中選取您要保護的 VM。 建議將擁有相同保護原則的 VM 都放入一個保護群組。 您可以啟用共置以有效利用空間。 共置可讓您在同一個磁碟或磁帶儲存空間找到不同保護群組的資料，讓多個資料來源只有一個複本和復原點磁碟區。

5. 在 [選擇資料保護方式]**** 頁面上，指定保護群組名稱。 選取 [我想要使用磁碟執行短期保護] **** ；如果您想要使用 Azure 備份服務將資料備份到 Azure，請選取 [我要執行線上保護] **** 。

6. 在 [**指定短期目標**  >  **保留範圍**] 中，指定您要保留磁片資料的時間長度。 在 **[同步處理頻率**] 中，指定應執行增量備份資料的頻率。 或者，不要選取增量備份間隔，而是改為啟用 [恰好在復原點之前] ****。 啟用此設定後，MABS 就會在每個排程的復原點之前執行快速完整備份。

    > [!NOTE]
    >
    >如果您要保護應用程式工作負載，會根據 [同步處理頻率] 建立復原點 (如果應用程式支援增量備份)。 如果沒有，則 MABS 會執行快速完整備份，而不是增量備份，並根據快速備份排程建立復原點。

7. 在 [檢閱磁碟配置] 頁面中，檢閱針對此保護群組配置的存放集區磁碟空間。

   [資料大小總計] 是您想要備份的資料大小，[要在 MABS 上佈建的磁碟空間] 是 MABS 建議給保護群組的空間。 MABS 會根據設定來選擇理想的備份磁碟區。 不過，您也可以在 [磁碟配置詳細資料] 中編輯備份磁碟區選擇。 對於工作負載，請在下拉式功能表中選取慣用的存放裝置。 您的編輯內容會變更 [可用磁碟儲存體] 窗格中 [儲存體總計] 和 [可用儲存體] 的值。 佈建不足的空間是指 MABS 建議為磁碟區新增的儲存體數量，以便未來繼續順暢地備份。

8. 在 [選擇複本的建立方式]**** 頁面上，指定將執行如何保護群組中的資料初始複寫。 如果您選擇透過 **網路自動**複寫，我們建議您選擇離峰時間。 對於大量資料或低於最佳的網路狀況，請考慮 **手動**選取，這需要使用卸載式媒體來離線複寫資料。

9. 在 [一致性檢查選項]**** 頁面上，選取要自動執行一致性檢查的方式。 只有當複本資料變得不一致，或是排程指示時，您才能執行檢查。 如果不想設定自動一致性檢查，您可以滑鼠右鍵按一下保護群組，然後選取 [執行一致性檢查]****，以手動方式隨時執行檢查。

    建立保護群組後，就會依您選取的方法執行資料的初始複寫。 初始複寫後，便會依照保護群組的設定開始每個備份。 如果您需要復原已備份的資料，請注意下列事項：

## <a name="back-up-replica-virtual-machines"></a>備份複本虛擬機器

如果 MABS 是在 Windows Server 2012 R2 或更新版本上執行，則您可以備份複本虛擬機器。 基於下列幾個理由，這樣做會很有用︰

**減少備份對於執行中工作負載的影響**：進行虛擬機器的備份會在建立快照時產生額外負荷。 將備份程式卸載至次要遠端網站後，執行中工作負載就不再受備份作業的影響。 這僅適用於備份複本存放在遠端站台上的部署。 例如，您可以進行每日備份並將資料儲存放在本機，以確保快速還原時間，但從存放在遠端以供長期保存的複本虛擬機器進行每月或每季備份。

**節省頻寬**：在典型的遠端分公司/總部部署中，您需要適當的已佈建頻寬量，以便在站台間傳輸備份資料。 除了資料備份策略，如果您還建立複寫和容錯移轉策略，您可以減少透過網路傳送的冗餘資料量。 備份複本虛擬機器資料，而不是主要複本，可節省透過網路傳送備份資料的額外負荷。

**提供主機服務提供者備份**：您可以使用裝載的資料中心做為複本網站，不需要次要資料中心。 在此情況下，主機服務提供者 SLA 需要複本虛擬機器的一致備份。

在容錯移轉起始之前，複本虛擬機器會關閉，而 VSS 無法保證複本虛擬機器的應用程式一致備份。 因此，複本虛擬機器的備份只會處於損毀一致的狀態。 如果無法保證絕對一致性，備份就會失敗，下列幾種情況可能會發生這個問題：

- 複本虛擬機器的狀況不良，且情況極為嚴重。

- 複本虛擬機器正在重新同步處理 (處於重新同步處理進行中，或需要重新同步處理的狀態)。

- 主要和次要站台之間虛擬機器的初始複寫正在進行中或擱置中。

- . 正在將 hrl 記錄套用至複本虛擬機器，或使用先前的動作在虛擬磁片上套用 hrl 記錄檔失敗，或已取消或中斷。

- 複本虛擬機器的移轉或容錯移轉正在進行中

## <a name="recover-backed-up-virtual-machines"></a>復原已備份的虛擬機器

當您可以復原備份的虛擬機器時，您可以使用 [復原精靈] 選取虛擬機器和特定的復原點。 若要開啟 [復原精靈] 以復原虛擬機器：

1. 在 MABS 系統管理員主控台中，輸入 VM 的名稱，或展開受保護的專案清單，然後選取您想要復原的 VM。

2. 在 [ **復原點** ] 窗格的 [行事曆] 上，選取任何日期以查看可用的復原點。 接著在 [路徑]**** 窗格中，選取要在 [復原精靈] 中使用的復原點。

3. 從 [ **動作** ] 功能表中選取 [復原]，以開啟 [ **復原** 嚮導]。

    您所選取的 VM 和復原點會出現在 [檢閱復原選項]**** 畫面。 選取 [下一步] 。

4. 在 [ **選取復原類型** ] 畫面上，選取您要還原資料的位置，然後選取 **[下一步]**。

    - **復原到原始執行個體**︰當您復原到原始執行個體時，會刪除原始的 VHD。 MABS 會使用 Hyper-v VSS 寫入器，將 VHD 和其他設定檔復原到原始位置。 在復原程序結束時，虛擬機器仍然具有高度可用性。
        資源群組必須存在才能復原。 如果沒有可用的資源群組，請復原至替代位置，然後讓虛擬機器具有高度可用性。

    - **將虛擬機器復原到任何主機**： MABS 支援替代位置復原 (ALR) ，可將受保護的 hyper-v 虛擬機器順暢地復原到不同的 hyper-v 主機，而與處理器架構無關。 復原到叢集節點的 hyper-v 虛擬機器將不會有高可用性。 如果您選擇此選項，[復原精靈] 會顯示用於識別目的地和目的地路徑的其他畫面。

    - **複製到網路資料夾**： MABS 支援專案層級復原 (ILR) ，可讓您進行檔案、資料夾、磁片區和虛擬硬碟的專案層級復原 (vhd) 從 hyper-v 虛擬機器的主機層級備份復原到網路共用或 MABS 保護伺服器上的磁片區。 MABS 保護代理程式不必安裝在來賓內，就能執行專案層級復原。 如果您選擇此選項，[復原精靈] 會顯示用於識別目的地和目的地路徑的其他畫面。

5. 在 [ **指定復原選項** ] 中，設定修復選項，然後選取 **[下一步]**：

    - 如果您要透過低頻寬來復原 VM，請選取 [ **修改** ] 以啟用 **網路頻寬使用節流**設定。 開啟節流設定選項之後，您可以指定您想要使用的頻寬量和頻寬可用時間。
    - 如果您已設定網路，請選取 [ **使用硬體快照集啟用 SAN** 型復原]。
    - 如果您希望復原程序完成時傳送電子郵件通知，請選取 [此復原完成時傳送電子郵件]****，然後提供電子郵件地址。

6. 在 [摘要] 畫面中，確定所有詳細資料正確無誤。 如果詳細資料不正確，或您想要進行變更，請選取 [ **上一步**]。 如果您對設定感到滿意，請選取 [復原] 以開始 **復原** 程式。

7. [復原狀態]**** 畫面會提供有關復原工作的資訊。

## <a name="next-steps"></a>接下來的步驟

[從 Azure 備份伺服器復原資料](./backup-azure-alternate-dpm-server.md)
