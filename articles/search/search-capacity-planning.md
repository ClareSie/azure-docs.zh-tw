---
title: 調整查詢與索引工作負載的容量
titleSuffix: Azure Cognitive Search
description: 調整 Azure 認知搜索中的分區和副本計算機資源,其中每個資源以計費搜索單位定價。
manager: nitinme
author: HeidiSteen
ms.author: heidist
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 03/30/2020
ms.openlocfilehash: 270ff3c3e8e4cffbb1f4b1987ee497530d0c0982
ms.sourcegitcommit: 980c3d827cc0f25b94b1eb93fd3d9041f3593036
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 04/02/2020
ms.locfileid: "80546253"
---
# <a name="adjust-capacity-in-azure-cognitive-search"></a>調整 Azure 認知搜尋的容量

[在預配搜索服務和](search-create-service-portal.md)鎖定特定定價層之前,請花幾分鐘時間瞭解服務中副本和分區的角色,以及如何調整服務以適應資源需求的峰值和下降。

容量是[您選擇的層](search-sku-tier.md)(層確定硬體特徵)和投影工作負載所需的副本和分區組合的函數。 根據層和調整的大小,添加或減少容量可能需要 15 分鐘到幾個小時。 

修改副本和分區的分配時,建議使用 Azure 門戶。 門戶對低於層的最大限制的允許組合實施限制。 但是,如果需要基於腳本或基於代碼的預配方法[,Azure PowerShell](search-manage-powershell.md)或[管理 REST API](https://docs.microsoft.com/rest/api/searchmanagement/services)是替代解決方案。

## <a name="terminology-replicas-and-partitions"></a>術語:副本和分區

|||
|-|-|
|*資料分割* | 為讀寫作業 (例如，在重建或重新整理索引時) 提供索引儲存體和 I/O。 每個分區都有總索引的一個共用。 如果分配三個分區,則索引分為三個分區。 |
|*複本* | 搜尋服務的執行個體，主要用來讓查詢作業達到負載平衡。 每個副本都是索引的一個副本。 如果分配了三個副本,則將有三個索引副本可用於服務查詢請求。|

## <a name="when-to-add-nodes"></a>何時新增節點

最初,服務被分配了由一個分區和一個副本組成的最小級別的資源。 

單一服務必須具有足夠的資源，才能處理所有工作負載 (編製索引和查詢)。 兩個工作負載都沒有在後台運行。 您可以安排查詢請求自然不太頻繁的時間編製索引,但服務不會將一個任務優先於另一個任務。 此外,當內部更新服務或節點時,一定量的冗餘會平滑查詢性能。

通常,搜索應用程式需要比分區更多的副本,尤其是當服務操作偏向查詢工作負載時。 [高可用性](#HA) 一節將會說明原因。

> [!NOTE]
> 添加更多副本或分區會增加運行服務的成本,並且可能會引入對結果排序方式的細微變化。 請務必查看[定價計算機](https://azure.microsoft.com/pricing/calculator/)以瞭解添加更多節點的計費影響。 [下圖](#chart)可以説明您交叉引用特定配置所需的搜索單元數。 有關其他副本如何影響查詢處理的詳細資訊,請參閱[排序結果](search-pagination-page-layout.md#ordering-results)。

## <a name="how-to-allocate-replicas-and-partitions"></a>如何配置複本和分割區

1. 登入 [Azure 入口網站](https://portal.azure.com/)，然後選取搜尋服務。

1. 在 **「設定」** 中,打開 **「縮放」** 頁以修改複本和分區。 

   以下螢幕截圖顯示了使用一個副本和分區預配的標準服務。 底部的公式指示正在使用的搜索單位數 (1)。 如果單價為 100 美元(不是實際價格),則每月運行此服務的成本平均為 100 美元。

   ![顯示目前的值的縮放頁面](media/search-capacity-planning/1-initial-values.png "顯示目前的值的縮放頁面")

1. 使用滑塊增加或減少分區數。 底部的公式指示正在使用的搜索單位數。

   本示例將容量加倍,每個副本和分區各有兩個副本和分區。 請注意搜索單位計數;它現在是四,因為計費公式是副本乘以分區 (2 x 2)。 將容量翻倍超過運行服務成本的兩倍。 如果搜索單位的成本是 100 美元,那麼新的每月帳單將是 400 美元。

   有關每個層的目前的單位成本,請存[取定價頁面](https://azure.microsoft.com/pricing/details/search/)。

   ![新增複本與分割區](media/search-capacity-planning/2-add-2-each.png "新增複本與分割區")

1. 按下 **「儲存**」以確認更改。

   ![確認對規模和計費的變更](media/search-capacity-planning/3-save-confirm.png "確認對規模和計費的變更")

   容量更改需要幾個小時才能完成。 進程啟動後,無法取消,並且對副本和分區調整沒有實時監視。 但是,在進行更改時,以下消息仍然可見。

   ![門戶中的狀態訊息](media/search-capacity-planning/4-updating.png "門戶中的狀態訊息")

> [!NOTE]
> 預配服務后,無法將其升級到更高層。 您必須在新層中建立搜尋服務，然後重新載入您的索引。 有關服務預配的説明[,請參閱在門戶中創建 Azure 認知搜索服務](search-create-service-portal.md)。
>
> 此外,分區和副本由服務在內部進行獨佔管理。 沒有處理器相關性的概念,也沒有將工作負載分配給特定節點的概念。
>

<a id="chart"></a>

## <a name="partition-and-replica-combinations"></a>資料分割與複本組合

「基本」服務可以有不多不少 1 個分割區及最多 3 個複本，上限為 3 個 SU。 唯一可調整的資源是複本。 您至少需要 2 個複本，才能在查詢上達到高可用性。

所有標準和存儲優化搜索服務都可以假定副本和分區的以下組合,但受 36-SU 限制限制。 

|   | **1 個分割區** | **2 個分割區** | **3 個資料分割** | **4 個資料分割** | **6 個分割區** | **12 個資料分割** |
| --- | --- | --- | --- | --- | --- | --- |
| **1 個複本** |1 SU |2 SU |3 SU |4 SU |6 SU |12 SU |
| **2 個複本** |2 SU |4 SU |6 SU |8 SU |12 SU |24 SU |
| **3 個複本** |3 SU |6 SU |9 SU |12 SU |18 SU |36 SU |
| **4 個複本** |4 SU |8 SU |12 SU |16 SU |24 SU |N/A |
| **5 個複本** |5 SU |10 SU |15 SU |20 SU |30 SU |N/A |
| **6 個複本** |6 SU |12 SU |18 SU |24 SU |36 SU |N/A |
| **12 個複本** |12 SU |24 SU |36 SU |N/A |N/A |N/A |

SU、定價和容量會在 Azure 網站上詳細說明。 如需詳細資訊，請參閱[定價詳細資料](https://azure.microsoft.com/pricing/details/search/)。

> [!NOTE]
> 複本數和資料分割數可整除 12 (明確來說就是 1、2、3、4、6、12)。 這是因為 Azure 認知搜索將每個索引預先劃分為 12 個分片,以便它可以在所有分區之間以相等的部分分佈。 例如，如果您的服務有三個資料分割，而您建立了索引，則每個資料分割將會包含 4 個該索引的分區。 Azure 認知搜索如何分片索引是實現詳細資訊,但可能會在未來版本中更改。 雖然現在分區數為 12，但您不應預期未來該數字永遠都會是 12。
>

<a id="HA"></a>

## <a name="high-availability"></a>高可用性

由於相應增加非常快速簡單，我們通常建議您從一個資料分割和一或兩個複本開始，然後於查詢量增長時再相應增加。 查詢工作負載主要是在複本上執行。 如果您需要更多的輸送量或高可用性，可能會需要額外的複本。

針對高可用性的一般建議為：

* 針對唯讀工作負載 (查詢)，需有 2 個複本才能達到高可用性

* 針對讀寫工作負載 (查詢再加上新增、更新或刪除個別文件時的索引編製)，需有 3 個或更多個複本才能達到高可用性

Azure 認知搜索的服務等級協定 (SLA) 面向查詢操作和索引更新,其中包括添加、更新或刪除文檔。

基本層最多一個分割區和三個複本。 如果想要具備立即回應檢索和查詢輸送量需求波動的彈性，請考慮標準層的其中一個。  如果您發現存儲需求的增長速度比查詢輸送量快得多,請考慮存儲優化層之一。

## <a name="disaster-recovery"></a>災害復原

目前沒有任何內建的機制可進行災害復原。 因此新增資料分割或複本並不是達成災害復原目標的正確選擇。 最常見的方法是在其他區域中設定第二個搜尋服務，來新增服務等級的備援。 與索引重建期間的可用性一樣，重新導向或容錯移轉邏輯必須來自您的程式碼。

## <a name="estimate-replicas"></a>估計複本

在生產服務上,應為 SLA 目的分配三個副本。 如果查詢性能降低,可以添加副本,以便將索引的其他副本聯機,以支援更大的查詢工作負荷,並在多個副本上載入平衡請求。

我們不提供有關需要多少副本來容納查詢負載的指南。 查詢性能取決於查詢和競爭工作負載的複雜性。 雖然新增複本會明顯獲得更好的效能，但是最終結果並不會完全地呈線性關係：新增 3 個複本並不保證有 3 倍的輸送量。

有關估計解決方案的 QPS 的指導,請參閱[「縮放」以瞭解性能和](search-performance-optimization.md)[監視器查詢](search-monitor-queries.md)

## <a name="estimate-partitions"></a>估計分區

[您選擇的層](search-sku-tier.md)決定了分區大小和速度,並且每個層都圍繞一組適合各種方案的特徵進行了優化。 如果選擇更高端的層,則可能需要的分區可能比使用 S1 時要少。 通過自定向測試需要回答的一個問題是,更大、更昂貴的分區是否比在較低層預配的服務上提供兩個更便宜的分區產生更好的性能。

要求近乎即時資料重新整理的搜尋應用程式，按比例需要比複本更多的資料分割數。 新增資料分割可將讀取/寫入作業分配到更大量的計算資源。 它也提供更多磁碟空間來儲存額外的索引和文件。

索引越大，查詢所需的時間就越長。 這麼一來，您可能會發現每個資料分割中每個累加式的增加在複本中都需要有較小但按比例的增加。 要將查詢執行速度提高到何種程度，需將您的查詢和查詢磁碟區複雜性納入考量。

## <a name="next-steps"></a>後續步驟

> [!div class="nextstepaction"]
> [為 Azure 認知搜尋選擇定價層](search-sku-tier.md)