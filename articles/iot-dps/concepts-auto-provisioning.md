---
title: IoT 中樞裝置佈建服務 - 自動佈建概念
description: 本文提供使用 IoT 裝置布建服務（DPS）、IoT 中樞和用戶端 Sdk 的裝置自動布建階段的概念總覽。
author: wesmc7777
ms.author: wesmc
ms.date: 04/04/2019
ms.topic: conceptual
ms.service: iot-dps
services: iot-dps
manager: timlt
ms.openlocfilehash: 4755d3ac30a4f6fdc0568dd88fa0e362d7d140a9
ms.sourcegitcommit: 3d79f737ff34708b48dd2ae45100e2516af9ed78
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 07/23/2020
ms.locfileid: "87066565"
---
# <a name="auto-provisioning-concepts"></a>自動佈建概念

如[概觀](about-iot-dps.md)中所述，「裝置佈建服務」是一項協助程式服務，可將裝置以 Just-In-Time 方式佈建到 IoT 中樞，而不需要人為介入。 在成功佈建之後，裝置會直接與指定的「IoT 中樞」連線。 此程序稱為自動佈建，可為裝置提供一個現成的登錄和初始設定體驗。

## <a name="overview"></a>概觀

Azure IoT 自動佈建可分成三個階段：

1. **服務設定** -「Azure IoT 中樞」和「IoT 中樞裝置佈建服務」執行個體的一次性設定，可建立這些執行個體並在它們之間建立連結。

   > [!NOTE]
   > 不論您的 IoT 解決方案規模為何，即使您打算支援數百萬個裝置，這仍然是**一次性設定**。

2. **裝置註冊** - 讓「裝置佈建服務」執行個體知道未來會嘗試註冊之裝置的程序。 [註冊](concepts-service.md#enrollment)的完成方式是在布建服務中設定裝置身分識別資訊，例如單一裝置的「個別註冊」，或多個裝置的「群組註冊」。 身分識別會根據已指定裝置使用的[證明機制](concepts-security.md#attestation-mechanism)，這可讓佈建服務在登錄期間證明裝置的真確性：

   - **TPM**：以「個別註冊」的形式設定，裝置身分識別會根據 TPM 註冊識別碼和公開簽署金鑰。 由於 TPM 是一個[規格](https://trustedcomputinggroup.org/work-groups/trusted-platform-module/)，因此不論 TPM 實作 (硬體或軟體) 為何，服務只會依據此規格來證明。 如需有關 TPM 型證明的詳細資料，請參閱[裝置佈建：使用 TPM 進行身分識別證明](https://azure.microsoft.com/blog/device-provisioning-identity-attestation-with-tpm/) \(英文\)。 

   - **X509**：以「個別註冊」或「群組註冊」的形式設定，裝置身分識別會根據 X.509 數位憑證 (以 .pem 或 .cer 檔案的形式上傳至註冊)。

   > [!IMPORTANT]  
   > 雖然「硬體安全模組」(HSM) 不是使用「裝置佈建服務」的先決條件，但強烈建議您的裝置使用該模組來儲存敏感性裝置身分識別資訊，例如金鑰和 X.509 憑證。

3. **裝置登錄與設定** - 由登錄軟體在開機時所起始，此軟體是使用適合裝置和證明機制的「裝置佈建服務」用戶端 SDK 來建置的軟體。 此軟體會與佈建服務建立連線來驗證裝置，以及在「IoT 中樞」中進行後續的登錄。 登錄成功之後，系統會為裝置提供其「IoT 中樞」唯一裝置識別碼和連線資訊，讓它能夠提取其初始設定並開始遙測程序。 在生產環境中，此階段可能會在前兩個階段後的數周或數月才會發生。

## <a name="roles-and-operations"></a>角色和作業

上一節所討論的階段可能會跨越數周或數個月，因為生產環境現實（例如製造時間、出貨、海關程式等）。此外，它們可以跨多個角色跨越活動，並指定涉及的各種實體。 本節將深入探討與每個階段相關的各種角色和作業，然後以循序圖說明流程。 

自動佈建也針對啟用證明機制方面，為裝置製造商設下需求。 製造作業的進行也可能不受自動佈建階段的時機影響，特別是在已經建立自動佈建之後才購得新裝置的情況下。

左邊目錄中提供了一系列快速入門，可透過實際操作體驗來協助說明自動佈建。 為了協助/簡化學習程序，會使用軟體來模擬實體裝置以進行註冊和登錄。 由於快速入門的模擬本質緣故，有些快速入門會要求您執行多個角色的作業，包括不存在之角色的作業。

| 角色 | 作業 | 描述 |
|------| --------- | ------------|
| 製造商 | 將身分識別和登錄 URL 編碼 | 根據所使用的證明機制，製造商需負責將裝置身分識別資訊及「裝置佈建服務」登錄 URL 編碼。<br><br>**快速入門**：由於裝置是模擬裝置，因此沒有「製造商」角色。 如需有關如何取得此資訊的詳細資料，請參閱「開發人員」角色，撰寫範例登錄應用程式的程式碼時會使用此角色。 |
| | 提供裝置身分識別 | 作為裝置身分識別資訊的來源，製造商需負責向操作員 (或指定的代理人) 傳達此資訊，或透過 API 將直接向「裝置佈建服務」註冊此資訊。<br><br>**快速入門**：由於裝置是模擬裝置，因此沒有「製造商」角色。 如需有關如何取得裝置身分識別的詳細資料，請參閱「操作員」角色，在於「裝置佈建服務」執行個體中註冊模擬裝置時會使用此角色。 |
| 運算子 | 設定自動佈建 | 此作業與自動佈建的第一個階段對應。<br><br>**快速入門**：您需執行「操作員」角色，在您的 Azure 訂用帳戶中設定「裝置佈建服務」和「IoT 中樞」執行個體。 |
|  | 註冊裝置身分識別 | 此作業與自動佈建的第二個階段對應。<br><br>**快速入門**：您需執行「操作員」角色，在您的「裝置佈建服務」執行個體中註冊模擬裝置。 裝置身分識別取決於快速入門中所模擬的證明方法 (TPM 或 X.509)。 如需了解證明詳細資料，請參閱「開發人員」角色。 |
| 裝置佈建服務、<br>IoT 中樞 | \<all operations\> | 不論是使用實體裝置進行的生產環境實作，還是使用模擬裝置進行的快速入門，都是透過您在 Azure 訂用帳戶中所設定的 IoT 服務來執行這些角色。 這些角色/作業完全相同，因為 IoT 服務並不在乎佈建的是實體裝置還是模擬裝置。 |
| 開發人員 | 建置/部署登錄軟體 | 此作業與自動佈建的第三個階段對應。 「開發人員」需負責使用適當的 SDK 來建置登錄軟體並部署至裝置。<br><br>**快速入門**：您所建置的範例登錄應用程式會針對您選擇的平台/語言來模擬真實裝置，此應用程式會在您的工作站上執行 (而不會部署至實體裝置)。 此登錄應用程式所執行的作業，會與部署至實體裝置之應用程式所執行的作業相同。 您需指定證明方法 (TPM 或 X.509 憑證)，再加上「裝置佈建服務」執行個體的登錄 URL 及「識別碼範圍」。 裝置身分識別取決於執行階段的 SDK 證明邏輯，根據的是您所指定的方法： <ul><li>**TPM 證明** - 您的開發工作站會執行 [TPM 模擬器應用程式](how-to-use-sdk-tools.md#trusted-platform-module-tpm-simulator)。 一旦執行，就會使用個別的應用程式來擷取 TPM 的「簽署金鑰」和「註冊識別碼」，以用於註冊和裝置識別碼。 SDK 證明邏輯也會在登錄期間使用模擬器，以針對驗證和註冊驗證出示已簽署的 SAS 權杖。</li><li>**X509 證明** - 您需使用工具來[產生憑證](how-to-use-sdk-tools.md#x509-certificate-generator)。 產生憑證之後，您需建立要在註冊作業中使用的必要憑證檔。 SDK 證明邏輯也會在登錄期間使用憑證，以針對驗證和註冊驗證出示憑證。</li></ul> |
| 裝置 | 開機和註冊 | 此作業與自動佈建的第三個階段對應，會由「開發人員」所建置的裝置登錄軟體來執行。 如需詳細資料，請參閱「開發人員」角色。 第一次開機時： <ol><li>應用程式會依據在開發期間所指定的全域 URL 和服務「識別碼範圍」，與「裝置佈建服務」執行個體連線。</li><li>連線之後，會依據在註冊期間所指定的證明方法和身分識別來驗證裝置。</li><li>驗證之後，就會向佈建服務執行個體所指定的「IoT 中樞」執行個體註冊裝置。</li><li>登錄成功時，會將唯一裝置識別碼和「IoT 中樞」端點傳回給登錄應用程式，以與「IoT 中樞」進行通訊。</li><li> 裝置可以從該處下拉其初始[裝置對應項](~/articles/iot-hub/iot-hub-devguide-device-twins.md)狀態來進行設定，並開始回報遙測資料的程序。</li></ol>**快速入門**：由於裝置是模擬裝置，因此登錄軟體會在您的開發工作站上執行。|

下圖摘要說明裝置自動佈建期間的角色和作業順序：
<br><br>
[![裝置的自動布建順序](./media/concepts-auto-provisioning/sequence-auto-provision-device-vs.png)](./media/concepts-auto-provisioning/sequence-auto-provision-device-vs.png#lightbox) 

> [!NOTE]
> 製造商也可以視需要使用「裝置佈建服務 API」(而不透過「操作員」) 來執行「註冊裝置身分識別」作業。 如需此排序及更多的詳細討論，請觀看[向 Azure IoT 進行全自動裝置登錄](https://youtu.be/cSbDRNg72cU?t=2460)影片 (從 41:00 標記開始)

## <a name="roles-and-azure-accounts"></a>角色和 Azure 帳戶

每個角色對應至 Azure 帳戶的方式與案例相關，而且可能涉及相當多案例。 以下常見模式應有助於大致了解角色通常如何對應到 Azure 帳戶。

#### <a name="chip-manufacturer-provides-security-services"></a>晶片製造商提供安全性服務

在此案例中，製造商會管理第一級客戶的安全性。 這些第一級客戶可能偏好此個案例，因為他們不必管理詳細的安全性。 

製造商在硬體安全性模組 (HSM) 中引入安全性。 此安全性可包括製造商從已設定 DPS 執行個體和註冊群組的潛在客戶取得的金鑰、憑證等。 製造商也可為其客戶產生安全性資訊。

在此案例中，可能有涉及兩個 Azure 帳戶：

- **帳戶 #1**：可能會在不同的操作員和開發人員角色之間共用。 此合作對象可以向製造商購買 HSM 晶片。 這些晶片會指向與帳戶 #1 相關聯的 DPS 執行個體。 DPS 註冊，此合作對象可藉由在 DPS 中重新設定裝置註冊設定，將裝置租給第 2 級客戶。 此合作物件也可能已為使用者後端系統組態了 IoT 中樞，以存取裝置遙測等等。在這種情況下，可能不需要第二個帳戶。

- **帳戶 #2**：終端使用者、層級-兩個客戶可能會有自己的 IoT 中樞。 與帳戶 #1 相關聯的合作對象只是將租用裝置指向此帳戶中的正確中樞。 此組態需要跨 Azure 帳戶連結 DPS 和 IoT 中樞，這可透過 Azure Resource Manager 範本完成。

#### <a name="all-in-one-oem"></a>全方位 OEM

製造商可以是「全方位 OEM」，其只需要單一製造商帳戶。 製造商會處理端對端安全性和佈建。

製造商可以將雲端式應用程式提供給購買裝置的客戶。 此應用程式會與製造商所配置的 IoT 中樞聯繫。

販賣機或全自動咖啡機代表此案例的範例。




## <a name="next-steps"></a>後續步驟

隨著您逐步進行對應的自動佈建快速入門，您可能會發現將本文加入書籤以作為參考點相當有幫助。 

請從最適合您管理工具喜好設定的「設定自動佈建」快速入門開始著手，這會引導您完成「服務設定」階段：

- [使用 Azure CLI 來設定自動佈建](quick-setup-auto-provision-cli.md)
- [使用 Azure 入口網站設定自動布建](quick-setup-auto-provision.md)
- [使用 Resource Manager 範本來設定自動佈建](quick-setup-auto-provision-rm.md)

接著，繼續進行適合您裝置證明機制和「裝置佈建服務」SDK/語言喜好設定的「自動佈建模擬裝置」快速入門。 在此快速入門中，您將逐步完成「裝置註冊」和「裝置登錄與設定」階段： 

| 模擬裝置證明機制 | 快速入門 SDK/語言 |
| -------------------------------------- | ----------------------- |
| 信賴平台模組 (TPM) | [C](quick-create-simulated-device.md)<br>[Java](quick-create-simulated-device-tpm-java.md)<br>[C#](quick-create-simulated-device-tpm-csharp.md)<br>[Python](quick-create-simulated-device-tpm-python.md) |
| X.509 憑證 | [C](quick-create-simulated-device-x509.md)<br>[Java](quick-create-simulated-device-x509-java.md)<br>[C#](quick-create-simulated-device-x509-csharp.md)<br>[Node.js](quick-create-simulated-device-x509-node.md)<br>[Python](quick-create-simulated-device-x509-python.md) |




