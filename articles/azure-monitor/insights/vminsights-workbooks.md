---
title: 使用活頁簿建立適用於 VM 的 Azure 監視器互動式報表
description: 使用適用於 VM 的 Azure 監視器的預先定義和自訂參數化活頁簿來簡化複雜的報表。
ms.subservice: ''
ms.topic: conceptual
author: bwren
ms.author: bwren
ms.date: 03/12/2020
ms.openlocfilehash: a6ab126c3a5b0d2a82b17fac42dcc9e20f6aba3f
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.contentlocale: zh-TW
ms.lasthandoff: 07/02/2020
ms.locfileid: "79480448"
---
# <a name="create-interactive-reports-azure-monitor-for-vms-with-workbooks"></a>使用活頁簿建立適用於 VM 的 Azure 監視器互動式報表

活頁簿將文字、 [記錄查詢](../log-query/query-language.md)、計量和參數結合成豐富的互動式報表。 活頁簿可以由具有相同 Azure 資源存取權的其他小組成員編輯。

活頁簿有助於下列案例：

* 當您事先不知道感興趣的度量時，探索虛擬機器的使用量： CPU 使用率、磁碟空間、記憶體、網路相依性等等。不同于其他流量分析工具，活頁簿可讓您結合多種視覺效果和分析，使其更適合這種自由形式探索。
* 藉由顯示金鑰計數器和其他記錄事件的計量，向您的小組說明最近布建的 VM 的執行方式。
* 將 VM 調整大小實驗的結果與小組的其他成員共用。 您可以使用文字來說明實驗的目標，然後顯示用來評估實驗的每個使用計量和分析查詢，以及每個計量高於或低於目標的清除呼叫。
* 報告您的 VM 使用量中斷的影響、結合資料、文字說明，以及後續步驟的討論，以避免未來發生中斷。

下表摘要說明適用於 VM 的 Azure 監視器包含的活頁簿，以協助您開始著手。

| 活頁簿 | Description | 影響範圍 |
|----------|-------------|-------|
| 效能 | 在單一活頁簿中，提供一個可自訂的版本，其中包含您已啟用的所有 Log Analytics 效能計數器。| 大規模 |
| 效能計數器 | 橫跨一組廣泛效能計數器的前 N 個圖表視圖。 | 大規模 |
| 連接 | 連線可讓您深入瞭解來自受監視 Vm 的輸入和輸出連線。 | 大規模 |
| 使用中的連接埠 | 提供已系結至受監視 Vm 上端口的處理常式清單，以及在所選時間範圍內的活動。 | 大規模 |
| 開放連接埠 | 提供受監視 Vm 上開啟的埠數目，以及這些開放埠的詳細資料。 | 大規模 |
| 失敗的連線 | 顯示受監視 Vm 上失敗的連線計數、失敗趨勢，以及失敗百分比在一段時間內增加的情況。 | 大規模 |
| 安全性和稽核 | 一種 TCP/IP 流量的分析，它會報告整體連線、惡意連線（IP 端點在全球）的位置。  若要啟用所有功能，您將需要啟用安全性偵測。 | 大規模 |
| TCP 流量 | 受監視 Vm 的排名報表，以及其在方格中傳送、接收和總計的網路流量，並顯示為趨勢線。 | 大規模 |
| 流量比較 | 此活頁簿可讓您比較單一電腦或一組電腦的網路流量趨勢。 | 大規模 |
| 效能 | 提供我們的效能視圖可自訂版本，利用您已啟用的所有 Log Analytics 效能計數器。 | 單一 VM | 
| 連接 | 連線可讓您深入瞭解 VM 中的輸入和輸出連線。 | 單一 VM |
 
## <a name="creating-a-new-workbook"></a>建立新的活頁簿

活頁簿由獨立可編輯的圖表、表格、文字及輸入控制項之區段組成。 為了進一步瞭解活頁簿，讓我們先從開啟範本開始，然後逐步建立自訂活頁簿。 

1. 登入 [Azure 入口網站](https://portal.azure.com)。

2. 選取 [**虛擬機器**]。

3. 從清單中選取 VM。

4. 在 [VM] 頁面的 [**監視**] 區段中，選取 [**深入**解析]。

5. 在 [VM 深入解析] 頁面上，選取 [**效能**或**對應**] 索引標籤，然後從頁面上的連結選取 [**查看活頁簿**]。 從下拉式清單中，選取 [**移至資源庫**]。

    ![活頁簿下拉式清單的螢幕擷取畫面](media/vminsights-workbooks/workbook-dropdown-gallery-01.png)

    這會啟動含有數個預先建立活頁簿的活頁簿圖庫，協助您開始著手。

7. 選取 [**新增**] 來建立新的活頁簿。

    ![活頁簿資源庫螢幕擷取畫面](media/vminsights-workbooks/workbook-gallery-01.png)

## <a name="editing-workbook-sections"></a>編輯活頁簿區段

活頁簿有兩種模式：**編輯模式**和**閱讀模式**。 第一次啟動新的活頁簿時，它會在**編輯模式**中開啟。 它會顯示活頁簿的所有內容，包括其他隱藏的步驟和參數。 **閱讀模式**呈現簡化的報告樣式檢視畫面。 [讀取] 模式可讓您將建立報表的複雜性抽象化，而在需要修改時，只需按幾下滑鼠就能繼續進行基礎的機制。

![適用於 VM 的 Azure 監視器活頁簿區段編輯控制項](media/vminsights-workbooks/workbook-new-workbook-editor-01.png)

1. 編輯完區段之後，請按一下區段左下角的 [**完成編輯**]。

2. 若要建立區段的複本，按一下 [複製此區段]**** 圖示。 建立重複的區段是逐一查看查詢而不會遺失先前反覆項目的絕佳方式。

3. 若要在活頁簿中將區段上移，按一下 [上移]**** 或 [下移]**** 圖示。

4. 若要永久移除區段，按一下 [移除]**** 圖示。

## <a name="adding-text-and-markdown-sections"></a>新增文字和 Markdown 區段

將標題、說明及註解新增至您的活頁簿，可協助將一組資料表和圖表變成敘述。 活頁簿中的文字區段支援 [Markdown 語法](https://daringfireball.net/projects/markdown/)以進行文字格式設定，例如標題、粗體、斜體和項目符號清單。

若要將文字區段新增至您的活頁簿，請使用活頁部底端或任何區段底端的 [新增文字]**** 按鈕。

## <a name="adding-query-sections"></a>加入查詢區段

![活頁簿中的查詢區段](media/vminsights-workbooks/005-workbook-query-section.png)

若要將查詢區段新增至您的活頁簿，請使用活頁部底端或任何區段底端的 [新增查詢]**** 按鈕。

查詢區段十分有彈性，可以用以回答下述問題：

* 我在相同時間週期內的 CPU 使用率如何增加網路流量？
* 過去一個月內的可用磁碟空間有何趨勢？
* 過去兩周內我的 VM 體驗有多少網路連線失敗？ 

您也不只限於從啟動活頁簿的虛擬機器內容進行查詢。 只要您具有這些資源的存取權限，您就可以跨多部虛擬機器和 Log Analytics 工作區進行查詢。

使用**工作區**識別碼，從其他 Log Analytics 工作區或特定 Application Insights 應用程式中包含資料。 若要深入瞭解跨資源查詢，請參閱[官方指引](../log-query/cross-workspace-query.md)。

### <a name="advanced-analytic-query-settings"></a>進階分析查詢設定

每個區段都有自己的 advanced 設定，可透過 ![ ](media/vminsights-workbooks/006-settings.png) 位於 [**新增參數**] 按鈕右邊的 [設定] [活頁簿] 區段編輯控制項圖示來存取。

![適用於 VM 的 Azure 監視器活頁簿區段編輯控制項](media/vminsights-workbooks/007-settings-expanded.png)

|         |          |
| ---------------- |:-----|
| **自訂寬度**    | 讓專案成為任意大小，讓您可以將多個專案放在單一行上，讓您能夠將圖表和資料表更有效率地組織成豐富的互動式報表。  |
| **依條件顯示** | 指定在讀取模式時，根據參數隱藏步驟。 |
| **匯出參數**| 允許格線或圖表中選取的資料列，讓後續的步驟變更值或變成可見。  |
| **在未編輯時顯示查詢** | 即使在閱讀模式中，也會顯示圖表或資料表上方的查詢。
| **在未進行編輯時顯示 [在分析中開啟] 按鈕** | 將藍色分析圖示新增至圖表的右下角，以允許單鍵存取。|

大部分的設定項目都很直覺，但要了解**匯出參數**，最好檢視使用此一功能之活頁簿。

其中一個預先建立的活頁簿- **TCP 流量**，提供來自 VM 的連線計量資訊。

活頁簿的第一個區段是以記錄查詢資料為基礎。 第二個區段也是以記錄查詢資料為基礎，但是選取第一個資料表中的資料列會以互動方式更新圖表的內容：

![適用於 VM 的 Azure 監視器活頁簿區段編輯控制項](media/vminsights-workbooks/008-workbook-tcp-traffic.png)

您可以透過使用 [**當選取專案時]、[匯出參數**] [設定] （在資料表的記錄查詢中啟用）來執行此行為。

![適用於 VM 的 Azure 監視器活頁簿區段編輯控制項](media/vminsights-workbooks/009-settings-export.png)

第二個記錄查詢接著會在選取資料列時，利用匯出的值來建立一組可供區段標題和圖表使用的值。 如果未選取任何資料列，則會隱藏區段標題和圖表。 

例如，第二個區段中的 hidden 參數會使用方格中所選資料列的下列參考：

```
VMConnection
| where TimeGenerated {TimeRange}
| where Computer in ("{ComputerName}") or '*' in ("{ComputerName}") 
| summarize Sent = sum(BytesSent), Received = sum(BytesReceived) by bin(TimeGenerated, {TimeRange:grain})
```

## <a name="adding-metrics-sections"></a>新增計量區段

計量區段讓您能存取所有 Azure 監視器計量資料，納入您的互動式報表中。 在適用於 VM 的 Azure 監視器中，預先建立的活頁簿通常會包含分析查詢資料，而不是度量資料。  您可以選擇建立含有計量資料的活頁簿，讓您在同一個位置充分發揮這兩項功能的最大優勢。 您也可以從任何可存取之訂閱的資源，提取計量資料。

以下是提取到活頁簿中的虛擬機器資料範例，以提供 CPU 效能的方格視覺效果：

![適用於 VM 的 Azure 監視器活頁簿區段編輯控制項](media/vminsights-workbooks/010-metrics-grid.png)

## <a name="adding-parameter-sections"></a>新增參數區段

活頁簿參數讓您不需要手動編輯查詢或文字區段，便能改變活頁簿的值。 這樣便不需要了解其中分析查詢的語言，大幅拓展以活頁簿為基礎之報表潛在的觀眾。

將參數的名稱放在括弧中，像是 ``{parameterName}``，來取代查詢、文字、或其他參數區段中參數的值。 參數名稱僅限於 JavaScript 識別碼、字母字元或底線等類似規則，後面接著英數位元或底線。 舉例來說，**a1** 是可用的名稱，但 **1a** 則不被允許。

參數是線性的，從活頁簿最頂端往後面的步驟移動。  稍後在活頁簿中宣告的參數可以覆寫先前宣告的參數。 這也可讓使用查詢的參數從稍早定義的參數存取值。 在單一參數步驟中，參數也是線性的，順序從左到右，右邊的參數可以仰賴同一步驟中已經宣告的參數。
 
目前支援四種不同類型的參數：

|                  |      |
| ---------------- |:-----|
| **文字**    | 允許使用者編輯文字方塊，您可以選擇性地提供查詢來填入預設值。 |
| **下拉式清單** | 可讓使用者從一組值中進行選擇。 |
| **時間範圍選擇器**| 可讓使用者從一組預先定義的時間範圍值中進行選擇，或從自訂的時間範圍中挑選。|
| **資源選擇器** | 可讓使用者從為活頁簿選取的資源中進行選擇。|

### <a name="using-a-text-parameter"></a>使用文字參數

使用者在文字方塊中輸入的值，會直接在查詢中被取代，而不會進行任何轉義或加上引號。 如果您需要的值為字串，查詢中必須在參數前後加上引號 (像是 **'{parameter}'**)。

Text 參數可讓文字方塊中的值在任何地方使用。 它可以是資料表名稱、資料行名稱、函數名稱、運算子等。 文字參數類型具有 [**從分析查詢取得預設值**] 設定，可讓活頁簿作者使用查詢來填入該文字方塊的預設值。

使用記錄查詢的預設值時，只會使用第一個資料列的第一個值（資料列0、資料行0）做為預設值。 因此建議您將查詢限制為只傳回一行一列。 查詢所傳回的任何其他資料會被忽略。 

查詢傳回的任何值都將會直接被取代為不含逃脫字元或引號的版本。 若查詢未傳回任何資料列，參數之結果將為空白字串 (若參數並非必須) 或未定義 (若參數為必須)。

### <a name="using-a-drop-down"></a>使用下拉式

下拉式參數類型可讓您建立下拉式控制項，允許選取一個或多個值。

下拉式清單會填入記錄查詢或 JSON。 如果查詢傳回一個資料行，則該資料行中的值都是值和下拉式控制項中的標籤。 如果查詢傳回兩個數據行，第一個資料行是值，而第二個數據行是下拉式清單中所顯示的標籤。 如果查詢傳回三個數據行，則第三個數據行會用來表示該下拉式清單中的預設選項。 此一資料行可以為任何型別，最簡單的方式是使用布林或數字型別，0 為 false，1 為 true。

若資料行為字串型別，Null/空白字串將被視為 false，其他任何值都視為 true。 針對單一選取下拉式清單，會使用具有 true 值的第一個值做為預設選取專案。  針對多個選取下拉式清單，具有 true 值的所有值都會當做預設選取的集合使用。 下拉式選單中的專案會以查詢傳回資料列的任何順序顯示。 

讓我們查看 [連線總覽] 報告中的參數。 按一下 [**方向**] 旁的編輯符號。

![適用於 VM 的 Azure 監視器活頁簿區段編輯控制項](media/vminsights-workbooks/011-workbook-using-dropdown.png)

這會啟動 [**編輯參數**] 功能表項目。

![適用於 VM 的 Azure 監視器活頁簿區段編輯控制項](media/vminsights-workbooks/012-workbook-edit-parameter.png)

JSON 可讓您產生以內容填入的任意資料表。 例如，下列 JSON 會在下拉式記錄中產生兩個值：

```
[
    { "value": "inbound", "label": "Inbound"},
    { "value": "outbound", "label": "Outbound"}
]
```

更適用的範例是使用下拉式選來依名稱從一組效能計數器中挑選：

```
Perf
| summarize by CounterName, ObjectName
| order by ObjectName asc, CounterName asc
| project Counter = pack('counter', CounterName, 'object', ObjectName), CounterName, group = ObjectName
```

查詢如下顯示結果：

![效能計數器下拉式清單](media/vminsights-workbooks/013-workbook-edit-parameter-perf-counters.png)

下拉式清單是功能強大的工具，可用於自訂及建立互動式報表。

### <a name="time-range-parameters"></a>時間範圍參數

雖然您可以使用下拉式參數型別來建立您自己自訂的時間範圍參數，若您不需要自訂參數所提供的彈性，您也可以使用已經建立好的時間範圍參數型別。 

時間範圍參數型別有 15 種預設範圍，短至五分鐘，長至 90 天。 您還可以選擇允許自訂時間範圍選取，讓報表的操作者能指定時間範圍的起始值及終止值。

### <a name="resource-picker"></a>資源選擇器

資源選擇器參數型別讓您能根據特定資源類型設定報表範圍。 利用資源選擇器類型的預先建立活頁簿範例，就是**效能**活頁簿。

![工作區下拉式清單](media/vminsights-workbooks/014-workbook-edit-parameter-workspaces.png)

## <a name="saving-and-sharing-workbooks-with-your-team"></a>儲存活頁簿並且與小組共用

活頁簿會儲存在 Log Analytics 工作區或虛擬機器資源內，視您存取活頁簿資源庫的方式而定。 活頁簿可以儲存到您個人或 [**共用報表**] 區段中的 [**我的報表**] 區段中，可供每個人存取資源的人員存取。 若要檢視資源中的所有活頁簿，請按一下動作列中的 [開啟]**** 按鈕。

若要共用目前在 [我的報表]**** 的活頁簿：

1. 按一下動作列中的 [開啟]****
2. 按一下您想要共用之活頁簿旁邊的 [...] 按鈕
3. 按一下 [移至共用報表]****。

若要使用連結或透過電子郵件共用活頁簿，請按一下動作列中的 [共用]****。 請注意，連結的收件者需要在 Azure 入口網站中存取此資源的存取權，才能檢視活頁簿。 若要進行編輯，收件者至少需要資源的參與者權限。

若要將活頁簿的連結釘選到 Azure 儀表板：

1. 按一下動作列中的 [開啟]****
2. 按一下您想要釘選之活頁簿旁邊的 [...] 按鈕
3. 按一下 [釘選到儀表板]****。

## <a name="next-steps"></a>後續步驟

- 若要找出限制和整體 VM 效能，請參閱[查看 AZURE VM 效能](vminsights-performance.md)。

- 若要了解探索到的應用程式相依性，請參閱[檢視適用於 VM 的 Azure 監視器對應](vminsights-maps.md)。
