---
title: 關於 Azure 網站恢復中的容錯移轉和容錯移轉
description: 瞭解 Azure 網站恢復中的容錯移轉和容錯移轉。
ms.topic: conceptual
ms.date: 12/24/2019
ms.openlocfilehash: d9b54f3c452212e12419a5ffd67b116c8660308d
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/28/2020
ms.locfileid: "79281804"
---
# <a name="about-on-premises-disaster-recovery-failoverfailback"></a>關於本地災害復原容錯移轉/故障恢復

本文概述了在具有[Azure 網站恢復](site-recovery-overview.md)的本地電腦的災害復原期間容錯移轉和容錯移轉。

## <a name="recovery-stages"></a>恢復階段

網站恢復中的容錯移轉和容錯移轉分為四個階段：

- **階段 1：從本地容錯移轉**：為本地電腦設置複製到 Azure 後，當本地網站出現故障時，將這些電腦容錯移轉到 Azure。 容錯移轉之後，系統會從複寫的資料建立 Azure VM。
- **階段 2：重新保護 Azure VM：** 在 Azure 中，您可以重新保護 Azure VM，以便它們開始複製回本地網站。 在重新保護期間關閉本地 VM（如果可用），以説明確保資料一致性。
- **階段 3：從 Azure 容錯移轉**：當本地網站再次正常運行時，將運行另一個容錯移轉，這一次將 Azure VM 故障回本地網站。 您可以故障回容錯移轉的原始位置，也可以故障回備用位置。
- **階段 4：重新保護本地電腦**：失敗後，再次啟用將本地電腦複製到 Azure。

## <a name="failover"></a>容錯移轉

作為業務連續性和災害復原 （BCDR） 策略的一部分，您可以執行容錯移轉。

- 作為 BCDR 戰略的第一步，您可以持續將本地電腦複製到 Azure。 使用者訪問在本地源電腦上運行的工作負載和應用程式。
- 如果需要，例如，如果本地存在中斷，則複製電腦故障將轉移到 Azure。 使用複製的資料創建 Azure VM。
- 為了保持業務連續性，使用者可以繼續訪問 Azure VM 上的應用。

容錯移轉是兩階段活動：

- **容錯移轉**：使用選定的復原點創建並啟動 Azure VM 的容錯移轉。
- **提交**： 容錯移轉後，在 Azure 中驗證 VM：
    - 然後，您可以將容錯移轉提交到選定的復原點，或為提交選擇其他點。
    - 提交容錯移轉後，無法更改復原點。


## <a name="connect-to-azure-after-failover"></a>容錯移轉後連接到 Azure

要連接到使用 RDP/SSH 進行容錯移轉後創建的 Azure VM，有許多要求。

**故障** | **位置** | **動作**
--- | --- | ---
**Azure VM（Windows（** | 容錯移轉前的本地電腦上 | **通過互聯網訪問**：啟用 RDP。 確保為**公共**添加了 TCP 和 UDP 規則，並且允許 RDP 用於**Windows 防火牆** > **允許應用**中的所有設定檔。<br/><br/> **通過網站到網站 VPN 訪問**：在電腦上啟用 RDP。 檢查是否允許 RDP 進入適用于**域和專用**網路的**Windows 防火牆** -> **允許的應用和功能**。<br/><br/>  確定作業系統的 SAN 原則已設為 **OnlineAll**。 [深入了解](https://support.microsoft.com/kb/3031135)。<br/><br/> 觸發容錯移轉時，請確定 VM 上沒有任何暫止的 Windows 更新。 Windows 更新可能在容錯移轉時啟動，並且在更新完成之前您將無法登錄到 VM。
**執行 Windows 的 Azure VM** | 容錯移轉後在 Azure VM 上 |  [新增 VM 的公用 IP 位址](https://aka.ms/addpublicip)。<br/><br/> 通過 VM 故障的網路安全性群組規則（以及它連接到的 Azure 子網）必須允許傳入連接到 RDP 埠。<br/><br/> 勾選 [開機診斷]**** 以確認 VM 的螢幕擷取畫面。 如果無法連接，請檢查 VM 是否正在運行，並查看[故障排除提示](https://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx)。
**執行 Linux 的 Azure VM** | 容錯移轉前的本地電腦上 | 確定 VM 上的安全殼層服務已設定為在系統開機時自動啟動。<br/><br/> 請檢查防火牆規則是否允許 SSH 連線。
**執行 Linux 的 Azure VM** | 容錯移轉後在 Azure VM 上 | 已容錯移轉的 VM 上的網路安全性群組規則 (以及它所連線的 Azure 子網路) 必須允許 SSH 連接埠的連入連線。<br/><br/> [新增 VM 的公用 IP 位址](https://aka.ms/addpublicip)。<br/><br/> 勾選 [開機診斷]**** 以檢視 VM 的螢幕擷取畫面。<br/><br/>

## <a name="types-of-failover"></a>容錯移轉的類型

網站恢復提供了不同的容錯移轉選項。

**故障** | **詳細資料** | **復原** | **工作流程**
--- | --- | --- | ---
**測試容錯移轉** | 用於運行驗證 BCDR 策略的鑽頭，而不會丟失任何資料丟失或停機。| 在 Azure 中創建 VM 的副本，不會影響正在進行的複製或生產環境。 | 1. 在單個 VM 上運行測試容錯移轉，或在恢復計畫中的多個 VM 上運行測試容錯移轉。<br/><br/> 2. 選擇要用於測試容錯移轉的復原點。<br/><br/> 3. 選擇 Azure 網路，在容錯移轉後創建 Azure VM 時將位於該網路。 網路僅用於測試容錯移轉。<br/><br/> 4. 驗證鑽頭是否按預期工作。 網站恢復會自動清理在演練期間在 Azure 中創建的 VM。
**計畫容錯移轉-Hyper-V**  | 通常用於計畫停機時間。<br/><br/> 源 VM 已關閉。 在啟動容錯移轉之前，將同步最新的資料。 | 計畫工作流的零資料丟失。 | 1. 規劃停機維護時段並通知使用者。<br/><br/> 2. 使面向使用者的應用離線。<br/><br/> 3. 使用最新的復原點啟動計畫容錯移轉。 如果電腦未關閉，或者遇到錯誤，容錯移轉不會運行。<br/><br/> 4. 容錯移轉後，檢查副本 Azure VM 在 Azure 中是否處於活動狀態。<br/><br/> 5. 提交容錯移轉以完成。 提交操作將刪除所有復原點。
**容錯移轉-Hyper-V** | 如果計畫外停機或主網站不可用，則通常運行。<br/><br/> 可以選擇關閉 VM，並在啟動容錯移轉之前同步最終更改。  | 應用的資料丟失最小。 | 1. 啟動 BCDR 計畫。 <br/><br/> 2. 啟動容錯移轉。 指定網站恢復是否應關閉 VM 並在觸發容錯移轉之前同步/複製最新更改。<br/><br/> 3. 您可以容錯移轉到一些復原點選項，如下表總結。<br/><br/> 如果不啟用關閉 VM 的選項，或者如果網站恢復無法關閉它，則使用最新的復原點。<br/>即使無法關閉電腦，容錯移轉也會運行。<br/><br/> 4. 容錯移轉後，請檢查副本 Azure VM 在 Azure 中是否處於活動狀態。<br/> 如果需要，您可以從 24 小時的保留視窗中選擇不同的復原點。<br/><br/> 5. 提交容錯移轉以完成。 提交操作將刪除所有可用的復原點。
**容錯移轉-VMware** | 如果計畫外停機或主網站不可用，則通常運行。<br/><br/> 可選指定網站恢復應嘗試觸發 VM 的關閉，並在啟動容錯移轉之前同步和複製最終更改。  | 應用的資料丟失最小。 | 1. 啟動 BCDR 計畫。 <br/><br/> 2. 從網站恢復啟動容錯移轉。 指定網站恢復是否應嘗試觸發 VM 關機並在運行容錯移轉之前進行同步。<br/> 即使無法關閉電腦，容錯移轉也會運行。<br/><br/> 3. 容錯移轉後，檢查副本 Azure VM 在 Azure 中是否處於活動狀態。 <br/>如果需要，您可以從 72 小時的保留視窗中選擇不同的復原點。<br/><br/> 5. 提交容錯移轉以完成。 提交操作將刪除所有復原點。<br/> 對於 Windows VM，網站恢復在容錯移轉期間禁用 VMware 工具。

## <a name="failover-processing"></a>容錯移轉處理

在某些情況下，容錯移轉需要額外的處理，這大約需要 8 到 10 分鐘才會完成。 您可能會發現下列各項的測試容錯移轉時間比較久：

* 執行的行動服務版本早於 9.8 的 VMware VM。
* 實體伺服器。
* VMware Linux VM。
* 視同實體伺服器受到保護的 Hyper-V VM。
* 未啟用 DHCP 服務的 VMware VM。
* 沒有下列開機驅動程式的 VMware VM：storvsc、vmbus、storflt、intelide、atapi。

## <a name="recovery-point-options"></a>復原點選項

在容錯移轉期間，您可以選擇多個復原點選項。

**選項** | **詳細資料**
--- | ---
**最新（最低 RPO）** | 此選項提供最低復原點目標 （RPO）。 它首先處理發送到網站恢復服務的所有資料，為每個 VM 創建一個復原點，然後再容錯移轉到它。 此復原點具有在觸發容錯移轉時複製到網站恢復的所有資料。
**最新處理**  | 此選項通過 VM 故障到網站恢復處理的最新復原點。 要查看特定 VM 的最新復原點，請在 VM 設置中查看**最新復原點**。 此選項提供低 RTO (復原時間目標)，因為無須花費時間處理未處理的資料。
**最新的應用一致性** |  如果啟用了應用一致的復原點，則此選項將失敗通過 VM 到網站恢復處理的最新應用程式一致性復原點。 檢查 VM 設置中的最新復原點。
**最新的多 VM 處理** | 此選項適用於一或多部 VM 已啟用多部 VM 一致性的復原計劃。 啟用這項設定的 VM 會容錯移轉至最新的一般多部 VM 一致復原點。 計畫中的任何其他 VM 都容錯移轉到最新的已處理復原點。
**最新的多 VM 應用一致性** |  此選項適用於一或多部 VM 已啟用多部 VM 一致性的復原計劃。 屬於最新一般多部 VM 應用程式一致復原點的複寫群組容錯移轉一部分的 VM。 對於最新應用程式一致復原點進行的其他 VM 容錯移轉。
**自 定義** | 使用此選項可將特定 VM 容錯移轉到特定復原點的時間。 此選項不適用於恢復計畫。

> [!NOTE]
> 無法將復原點遷移到另一個恢復服務保存庫。

## <a name="reprotectionfailback"></a>重新保護/故障恢復

容錯移轉到 Azure 後，複製的 Azure VM 處於未受保護的狀態。

- 作為故障返回本地網站的第一步，您需要啟動複製到本地的 Azure VM。 重新保護過程取決於您故障過的電腦類型。
- 在電腦從 Azure 複製到本地後，可以運行從 Azure 到本地網站的容錯移轉。
- 電腦在本地再次運行後，可以啟用複製，以便它們複製到 Azure 以進行災害復原。

故障回退的工作原理如下：

- 要故障恢復，VM 至少需要一個復原點才能故障。 在恢復計畫中，計畫中的所有 VM 至少需要一個復原點。
- 我們建議您使用 **"最新**復原點"進行故障恢復（這是一個崩潰一致的點）。
    - 有一個應用一致的復原點選項。 在這種情況下，單個 VM 將恢復到其最新的可用應用一致性復原點。 對於具有複製組的恢復計畫，每個複製組將恢復到其公共可用復原點。
    - 應用一致的復原點可能及時落後，並且可能會遺失資料。
- 在從 Azure 容錯移轉到本地網站期間，網站恢復將關閉 Azure VM。 提交容錯移轉時，網站恢復將刪除 Azure 中失敗的 Azure VM。


## <a name="vmwarephysical-reprotectionfailback"></a>VMware/物理重新保護/故障恢復

要重新保護和故障將 VMware 電腦和物理伺服器從 Azure 備份到本地，您需要一個故障恢復基礎結構，並且存在許多要求。

- **Azure 中的暫時處理序伺服器**︰若要從 Azure 容錯回復，您可以設定 Azure VM 作為處理序伺服器，以處理來自 Azure 的複寫。 容錯回復完成後，您可以刪除此 VM。
- **VPN 連線**：若要容錯回復，您必須要有從 Azure 網路到內部部署網站的 VPN 連線 (或 ExpressRoute)。
- **個別的主要目標伺服器**︰根據預設，隨組態伺服器安裝的主要目標伺服器 (在內部部署 VMware VM 上) 會處理容錯回復。 如果您需要容錯回復大量流量，請針對此用途設定個別的內部部署主要目標伺服器。
- **容錯回復原則**︰若要複寫回到內部部署網站，您需要容錯回復原則。 當您建立從內部部署至 Azure 的複寫原則後，此原則會自動建立。
    - 此策略將自動與佈建服務器關聯。
    - 您無法編輯此策略。
    - 策略值：RPO 閾值 - 15 分鐘;復原點保留 - 24 小時;應用一致的快照頻率 - 60 分鐘。

瞭解有關 VMware/物理重新保護和故障恢復的更多詳細資訊：
- [查看](vmware-azure-reprotect.md#before-you-begin)重新保護和故障恢復的其他要求。
- [在](vmware-azure-prepare-failback.md#deploy-a-process-server-in-azure)Azure 中部署進程伺服器。
- [部署](vmware-azure-prepare-failback.md#deploy-a-separate-master-target-server)單獨的主目標伺服器。

將 Azure VM 重新保護到本地時，可以指定要故障回原始位置或備用位置。

- **原始位置恢復**：如果存在，則從 Azure 故障回同一源本地電腦。 在這種情況下，僅將更改複製回本地。
- **備用位置恢復**：如果本地電腦不存在，則可以從 Azure 故障回備用位置。 將 Azure VM 重新保護到本地時，將創建本地電腦。 從 Azure 到本地進行完全資料複製。 - [- 查看](concepts-types-of-failback.md)位置故障恢復的要求和限制。



## <a name="hyper-v-reprotectionfailback"></a>Hyper-V 重新保護/故障恢復

要重新保護和故障將超 VM 從 Azure 備份到本地：

- 您只能失敗返回使用存儲帳戶複製的超 VM。 不支援使用託管磁碟複製的超 VM 故障倒回。
- 本地超 V 主機（或系統中心 VMM（如果使用）應連接到 Azure。
- 從 Azure 運行計畫故障回退到本地。
- 無需為 Hyper-V VM 故障倒機設置特定的元件。
- 在計畫容錯移轉期間，您可以選擇在故障恢復之前同步資料的選項：
    - **容錯移轉前同步資料**：此選項在虛擬機器同步電腦時將停機時間降至最低，而不會關閉它們。
        - 第 1 階段：拍攝 Azure VM 的快照並將其複製到本地 Hyper-V 主機。 機器會繼續在 Azure 中執行。
        - 第 2 階段：關閉 Azure VM，以便那裡不發生新的更改。 最後一組增量更改將傳輸到本機伺服器，並啟動本地 VM。
    - **僅在容錯移轉期間同步資料**：此選項更快，因為我們預計大多數磁片已更改，因此不執行校驗和計算。 它會下載磁碟。 如果 VM 已在 Azure 中運行一段時間（一個月或更長時間），或者本地 VM 已被刪除，我們建議您使用此選項。

[瞭解有關](hyper-v-azure-failback.md)Hyper-V 重新保護和故障恢復的更多詳細資訊。

將 Azure VM 重新保護到本地時，可以指定要故障回原始位置或備用位置。

- **原始位置恢復**：如果存在，則從 Azure 故障回同一源本地電腦。 在這種情況下，您可以選擇上一過程中描述的同步選項之一。
- **備用位置恢復**：如果本地電腦不存在，則可以從 Azure 故障回備用位置。 將 Azure VM 重新保護到本地時，將創建本地電腦。 使用此選項，我們建議您選擇在容錯移轉之前同步資料的選項
- [查看](hyper-v-azure-failback.md)位置故障恢復的要求和限制。


故障返回本地網站後，啟用**反向複製**開始將 VM 複製到 Azure，從而完成該週期。




## <a name="next-steps"></a>後續步驟
- 容錯移轉[特定 VMware VM](vmware-azure-tutorial-failover-failback.md)
- 容錯移轉[特定超 VM](hyper-v-azure-failover-failback-tutorial.md)。
- [創建](site-recovery-create-recovery-plans.md)恢復計畫。
- 容錯移轉[恢復計畫中的 VM。](site-recovery-failover.md)
- [準備](vmware-azure-failback.md)VMware 重新保護和故障恢復。
- 故障恢復[超 VM](hyper-v-azure-failback.md)。

