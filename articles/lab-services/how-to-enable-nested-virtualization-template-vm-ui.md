---
title: 在 Azure 實驗室服務中的範本 VM 上啟用嵌套虛擬化 (UI) |Microsoft Docs
description: 了解如何建立內有多個 VM 的範本 VM。  換句話說，就是在 Azure 實驗室服務的範本 VM 上啟用巢狀虛擬化。
author: emaher
ms.topic: article
ms.date: 06/26/2020
ms.author: enewman
ms.openlocfilehash: f8135e11fb7b7ddb588ab3a8ed01227712072fd2
ms.sourcegitcommit: 8e7316bd4c4991de62ea485adca30065e5b86c67
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 11/17/2020
ms.locfileid: "94647914"
---
# <a name="enable-nested-virtualization-on-a-template-virtual-machine-in-azure-lab-services-manually"></a>以手動方式在 Azure 實驗室服務中的範本虛擬機器上啟用嵌套虛擬化

巢狀虛擬化可讓您在實驗室的範本虛擬機器內建立有多個 VM 的環境。 發佈範本會向實驗室中的每位使用者提供在其內部設定了多個 VM 的虛擬機器。  如需有關嵌套虛擬化和 Azure 實驗室服務的詳細資訊，請參閱 [在 Azure 實驗室服務中的範本虛擬機器上啟用嵌套虛擬化](how-to-enable-nested-virtualization-template-vm.md)。

本文說明如何直接使用 Windows 角色和工具，在 Azure 實驗室服務中設定範本電腦的嵌套虛擬化。  有幾件事需要讓類別使用嵌套的虛擬化。  下列步驟將說明如何使用 Hyper-v 手動設定實驗室服務電腦範本。  步驟適用于 Windows Server 2016 或 Windows Server 2019。  

>[!IMPORTANT]
>在建立實驗室時，請選取 [大型 (巢狀虛擬化)] 或 [中型 (巢狀虛擬化)] 作為虛擬機器大小。  否則，將無法使用巢狀虛擬化。  

## <a name="enable-hyper-v-role"></a>啟用 Hyper-v 角色

下列步驟說明使用伺服器管理員在 Windows Server 上啟用 Hyper-v 時所需採取的動作。  安裝成功之後，即可使用 Hyper-v 管理員來新增、修改和刪除用戶端虛擬機器。

1. 在 **伺服器管理員** 的 [儀表板] 頁面上，按一下 [ **新增角色及功能**]。
2. 在 [在您開始前]  頁面上，按一下 [下一步]  。
3. 在 [ **選取安裝類型** ] 頁面上，保留預設選取的 [以角色為基礎或以功能為基礎的安裝]，然後按 [ **下一步]**。
4. 在 [ **選取目的地伺服器** ] 頁面上，選取 [從伺服器集區選取伺服器]。   將會選取目前的伺服器。  按一下 [下一步]。
5. 在 [選取伺服器角色] 頁面上，選取 [Hyper-V]。  
6. [ **新增角色及功能] Wizard** 快顯視窗隨即出現。  如果適用) ，請選取 [ **包含管理工具 (**]。  按一下 [ **新增功能** ] 按鈕。
7. 在 [選取伺服器角色] 頁面上，按 [下一步]。
8. 在 [ **選取功能] 頁面** 上，按 **[下一步]**。
9. 在 [Hyper-V] 頁面上，按 [下一步]。
10. 在 [ **建立虛擬交換器** ] 頁面上，接受預設值，然後按 **[下一步]**。
11. 在 [ **虛擬機器遷移** ] 頁面上，接受預設值，然後按 **[下一步]**。
12. 在 [ **預設存放區** ] 頁面上，接受預設值，然後按 **[下一步]**。
13. 在 [ **確認安裝選項** ] 頁面上，選取 [ **必要時自動重新開機目的地伺服器**]。
14. 當 [ **新增角色及功能] Wizard** 快顯視窗出現時，請按一下 **[是]**。
15. 按一下 [安裝]。
16. 等候 [ **安裝進度** ] 頁面，指出 hyper-v 角色已完成。  電腦可能會在安裝過程中重新開機。
17. 按一下 [關閉]  。

## <a name="enable-dhcp-role"></a>啟用 DHCP 角色

任何建立的 Hyper-v 用戶端虛擬機器都需要 NAT 網路中的 IP 位址。  我們稍後會建立 NAT 網路。  指派 IP 位址的其中一種方式是將主機（在此案例中為實驗室虛擬機器範本）設定為 DHCP 伺服器。  以下是啟用 DHCP 角色所需的步驟。

1. 在 **伺服器管理員** 的 [ **儀表板** ] 頁面上，按一下 [ **新增角色及功能**]。
2. 在 [在您開始前]  頁面上，按一下 [下一步]  。
3. 在 [選取安裝類型] 頁面上，選取 [角色型或功能型安裝]，然後按 [下一步]。
4. 在 [ **選取目的地伺服器** ] 頁面上，從伺服器集區中選取目前的伺服器，然後按 **[下一步]**。
5. 在 [ **選取伺服器角色** ] 頁面上，選取 [ **DHCP 伺服器**]。  
6. [ **新增角色及功能] Wizard** 快顯視窗隨即出現。  如果適用) ，請選取 [ **包含管理工具 (**]。  按一下 **[新增功能]**。

    >[!NOTE]
    >您可能會看到驗證錯誤，指出找不到任何靜態 IP 位址。  在我們的案例中，可以忽略這個警告。

7. 在 [選取伺服器角色] 頁面上，按 [下一步]。
8. 在 [選取功能] 頁面上，按 [下一步]。
9. 在 [ **DHCP 伺服器** ] 頁面上，按 **[下一步]**。
10. 在 [確認安裝選項] 頁面上，按一下 [安裝]。
11. 等候 [ **安裝進度] 頁面** 指出 DHCP 角色已完成。
12. 按一下 [關閉]。

## <a name="enable-routing-and-remote-access-role"></a>啟用路由及遠端存取角色

1. 在 **伺服器管理員** 的 [ **儀表板** ] 頁面上，按一下 [ **新增角色及功能**]。
2. 在 [在您開始前]  頁面上，按一下 [下一步]  。
3. 在 [選取安裝類型] 頁面上，選取 [角色型或功能型安裝]，然後按 [下一步]。
4. 在 [ **選取目的地伺服器** ] 頁面上，從伺服器集區中選取目前的伺服器，然後按 **[下一步]**。
5. 在 [ **選取伺服器角色** ] 頁面上，選取 [ **遠端存取**]。 按一下 [確定]  。
6. 在 [選取功能] 頁面上，按 [下一步]。
7. 在 [ **遠端存取** ] 頁面上，按 **[下一步]**。
8. 在 [ **角色服務** ] 頁面上，選取 [ **路由**]。
9. [ **新增角色及功能] Wizard** 快顯視窗隨即出現。  如果適用) ，請選取 [ **包含管理工具 (**]。  按一下 **[新增功能]**。
10. 按 [下一步] 。
11. 在 [網頁伺服器 (IIS) 角色] 頁面上，按一下 [下一步]。
12. 在 [選取角色服務] 頁面上，按 [下一步]。
13. 在 [確認安裝選項] 頁面上，按一下 [安裝]。
14. 等候 [ **安裝進度** ] 頁面指出遠端存取角色已完成。  
15. 按一下 [關閉]  。

## <a name="create-virtual-nat-network"></a>建立虛擬 NAT 網路

現在已安裝所有必要的角色，現在可以開始建立 NAT 網路。  建立程式將牽涉到建立交換器和 NAT 網路本身。  NAT (網路位址轉譯) 網路會將公用 IP 位址指派給私人網路上的一組 Vm，以允許連線到網際網路。  在我們的案例中，私人 Vm 的群組將會是嵌套 Vm。  NAT 網路可讓嵌套的 Vm 彼此通訊。 交換器是一種網路裝置，可處理網路中的流量接收和路由傳送。

### <a name="create-a-new-virtual-switch"></a>建立新的虛擬交換器

1. 從 [Windows 系統管理工具] 開啟 [ **Hyper-v 管理員** ]。
2. 在左側導覽功能表中，選取目前的伺服器。
3. 按一下 [**虛擬交換器管理員**]。 從 **Hyper-v 管理員** 右手邊的 [**動作**] 功能表中。
4. 在 [ **虛擬交換器管理員** ] 快顯視窗上，選取要建立之交換器類型的 [ **內部** ]。  按一下 [建立虛擬交換器]。
5. 針對新建立的虛擬交換器，將名稱設定為可記住的名稱。  在此範例中，我們會使用 ' LabServicesSwitch '。  按一下 [確定]  。
6. 將會建立新的網路介面卡。  名稱將類似 ' vEthernet (LabServicesSwitch) '。  若要確認開啟 **主控台**，請按一下 [ **網路和網際網路**]，然後按一下 [ **View network status and tasks**]。  在左側按一下 [ **變更介面卡設定**]。

### <a name="create-a-nat-network"></a>建立 NAT 網路

1. 從 Windows 系統管理工具開啟 [ **路由及遠端存取** ] 工具。
2. 在左側導覽頁面中選取本機伺服器。
3. 選擇 **Action**[  ->  **設定並啟用路由及遠端存取**] 動作。
4. 當 [ **路由及遠端存取服務器安裝程式]** 出現時，請按 **[下一步**]。
5. **在 [設定**] 頁面上，選取 [**網路位址轉譯 (NAT)** 設定]。  按 [下一步] 。

    >[!WARNING]
    >請勿選擇 [虛擬私人網路 (VPN) 存取和 NAT] 選項。

6. 在 [ **NAT 網際網路連線** ] 頁面上，選擇 [乙太網路]。  請勿選擇我們在 Hyper-v 管理員中建立的「vEthernet (LabServicesSwitch) 」連接。 按 [下一步] 。
7. 在嚮導的最後一個頁面上，按一下 **[完成]** 。
8. 出現 [ **啟動服務** ] 對話方塊時，按一下 [ **啟動服務**]。
9. 等候服務啟動。

## <a name="update-network-adapter-settings"></a>更新網路介面卡設定

網路介面卡將與先前建立的 NAT 網路的預設閘道 IP 所用的 IP 相關聯。  在此範例中，我們會建立 IP 位址為192.168.0.1，子網路遮罩為255.255.255.0。  我們將使用稍早建立的虛擬交換器。

1. 開啟 **主控台**、按一下 [ **網路和網際網路**]， **然後按一下 [View network status and tasks**]。
2. 在左側按一下 [ **變更介面卡設定**]。  
3. 在 [ **網路** 連線] 視窗中，按兩下 [VEthernet (LabServicesSwitch) ]，以顯示 **vEthernet (LabServicesSwitch) 狀態** 詳細資料] 對話方塊。
4. 按一下 [ **屬性** ] 按鈕。
5. 選取 [ **網際網路通訊協定第4版 (TCP/IPv4)** 專案，然後按一下 [ **屬性** ] 按鈕。
6. 在 [ **網際網路通訊協定第4版 ([TCP/IPv4)** 內容] 對話方塊中，選取 **[使用下列的 IP 位址**]。  在 [ip 位址] 中輸入192.168.0.1。 在 [子網路遮罩] 中輸入255.255.255.0。  將 [預設閘道] 保留空白。  也讓 DNS 伺服器保持空白。

    >[!NOTE]
    > 我們的 NAT 網路範圍將會是 CIDR 標記法（192.168.0.0/24）。  這會建立一個範圍，從192.168.0.1 到192.168.0.254 的可用 IP 位址。  依照慣例，閘道的子網範圍中會有第一個 IP 位址。

7. 按一下 [確定]。

## <a name="create-dhcp-scope"></a>建立 DHCP 領域

下列步驟是新增 DHCP 領域的指示。  在本文中，NAT 網路的 CIDR 標記法為 192.168.0.0/24。  這會建立一個範圍，從192.168.0.1 到192.168.0.254 的可用 IP 位址。  所建立的範圍必須在可使用的位址範圍內，但不包括先前已建立的 IP 位址。

1. 開啟 [系統 **管理工具** ]，然後開啟 **DHCP** 系統管理工具。
2. 在 **DHCP** 工具中，展開目前伺服器的節點，然後選取 [ **IPv4**]。
3. 從 [動作] 功能表中，選擇 [**新增領域**]。
4. 當 **新的範圍 Wizard** 出現時，按一下 [**歡迎使用**] 頁面上的 **[下一步**]。
5. 在 [ **領域名稱** ] 頁面上，輸入 ' LabServicesDhcpScope ' 或其他易記的名稱。  按 [下一步] 。
6. 在 [ **IP 位址範圍** ] 頁面上，輸入下列值。

    - 起始 IP 位址的192.168.0.100
    - 結束 IP 位址的192.168.0.200
    - 長度為24
    - 子網路遮罩為255.255.255。0

7. 按 [下一步] 。
8. 在 [ **新增排除專案與延遲** ] 頁面上，按 **[下一步]**。
9. 在 [ **租用期間** ] 頁面上，按 **[下一步]**。
10. 在 [ **設定 DHCP 選項** ] 頁面上，選取 **[是，我要立即設定這些選項]**。 按 [下一步] 。
11. 在 **路由器 (預設閘道)**
12. 如果尚未這麼做，請新增192.168.0.1。 按 [下一步] 。
13. 在 [ **功能變數名稱和 DNS 伺服器** ] 頁面上，將168.63.129.16 新增為 DNS 伺服器 IP 位址（如果尚未這麼做）。  168.63.129.16 是 Azure 靜態 DNS 伺服器的 IP 位址。 按 [下一步] 。
14. 在 [ **WINS 伺服器** ] 頁面上，按 **[下一步]**。
15. 在 [ **啟用領域** ] 頁面上，選取 [ **是，我要立即啟用此領域]**。  按 [下一步] 。
16. 在 [ **完成新領域嚮導]** 頁面上，按一下 **[完成]**。

## <a name="conclusion"></a>結論

現在您的範本電腦已準備好建立 Hyper-v 虛擬機器。   如需有關如何建立 Hyper-v 虛擬機器的指示，請參閱 [在 hyper-v 中建立虛擬機器](/windows-server/virtualization/hyper-v/get-started/create-a-virtual-machine-in-hyper-v) 。  另請參閱 [Microsoft 評估中心](https://www.microsoft.com/evalcenter/) ，以查看可用的作業系統和軟體。

## <a name="next-steps"></a>後續步驟

下一步是設定任何實驗室的常見步驟。

- [新增使用者](tutorial-setup-classroom-lab.md#add-users-to-the-lab)
- [設定配額](how-to-configure-student-usage.md#set-quotas-for-users)
- [設定排程](tutorial-setup-classroom-lab.md#set-a-schedule-for-the-lab)
- [學生的電子郵件註冊連結](how-to-configure-student-usage.md#send-invitations-to-users)