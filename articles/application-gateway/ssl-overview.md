---
title: 在 Azure 應用程式閘道上啟用端對端 TLS
description: 本文概述應用程式閘道端對端 TLS 支援。
services: application-gateway
author: amsriva
ms.service: application-gateway
ms.topic: article
ms.date: 3/19/2019
ms.author: victorh
ms.openlocfilehash: 286c9329be38055808571d8d32c724d27a61cbf3
ms.sourcegitcommit: c535228f0b77eb7592697556b23c4e436ec29f96
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 05/06/2020
ms.locfileid: "82855869"
---
# <a name="overview-of-tls-termination-and-end-to-end-tls-with-application-gateway"></a>使用應用程式閘道的 TLS 終止和端對端 TLS 總覽

傳輸層安全性（TLS）（先前稱為安全通訊端層（SSL））是在網頁伺服器與瀏覽器之間建立加密連結的標準安全性技術。 此連結可確保在網頁伺服器和瀏覽器之間傳遞的所有資料都保持私用和加密。 應用程式閘道支援在閘道上的 TLS 終止，以及端對端 TLS 加密。

## <a name="tls-termination"></a>TLS 終止

應用程式閘道支援閘道上的 TLS 終止，之後流量通常會以未加密狀態流至後端伺服器。 在應用程式閘道上進行 TLS 終止有幾個優點：

- **改善的效能**–進行 TLS 解密時最大的效能影響是初始信號交換。 為了改善效能，進行解密的伺服器會快取 TLS 會話識別碼，並管理 TLS 會話票證。 如果這是在應用程式閘道上完成，來自相同用戶端的所有要求都可以使用快取的值。 如果是在後端伺服器上完成，則每次用戶端的要求移至不同的伺服器時，用戶端都必須重新驗證。 使用 TLS 票證有助於減輕這個問題，但並非所有用戶端都支援，而且可能很容易設定和管理。
- **較佳的後端伺服器使用率**– SSL/TLS 處理會耗用大量 CPU，而且隨著金鑰大小的增加，變得更密集。 從後端伺服器中移除此工作，可讓他們專注于最有效率的專案，並提供內容。
- **智慧型路由**–藉由解密流量，應用程式閘道可以存取要求內容，例如標頭、URI 等，並可使用此資料來路由傳送要求。
- **憑證管理**–憑證只需要在應用程式閘道上購買並安裝，而不是所有後端伺服器。 這可節省時間和金錢。

若要設定 TLS 終止，必須將 TLS/SSL 憑證新增至接聽程式，讓應用程式閘道能夠根據 TLS/SSL 通訊協定規格來衍生對稱金鑰。 接著會使用對稱金鑰來加密和解密傳送至閘道的流量。 TLS/SSL 憑證必須採用「個人資訊交換」（PFX）格式。 此檔案格式可允許將私密金鑰匯出，而應用程式閘道需要這個匯出的金鑰來執行流量的加密和解密。

> [!IMPORTANT] 
> 請注意，接聽程式上的憑證需要上傳整個憑證鏈。 


> [!NOTE] 
>
> 應用程式閘道不會提供建立新憑證或傳送憑證要求給憑證授權單位單位的任何功能。

若要讓 TLS 連線正常運作，您必須確定 TLS/SSL 憑證符合下列條件：

- 目前的日期和時間是在憑證的「有效來源」和「有效日期」範圍內。
- 憑證的「一般名稱」(CN) 符合要求中的主機標頭。 例如，如果用戶端提出 `https://www.contoso.com/` 要求，則 CN 必須是 `www.contoso.com`。

### <a name="certificates-supported-for-tls-termination"></a>TLS 終止支援的憑證

應用程式閘道支援下列類型的憑證：

- CA （憑證授權單位單位）憑證： CA 憑證是由憑證授權單位單位（CA）發行的數位憑證
- EV （擴充驗證）憑證： EV 憑證是符合業界標準憑證指導方針的憑證。 這會將瀏覽器定位器列變成綠色，並同時發佈公司名稱。
- 萬用字元憑證：此憑證支援以 *. site.com 為基礎的任意數目的子域，您的子域會在其中取代 *。 不過，它不支援 site.com，因此，如果使用者存取您的網站，而未輸入前置的 "www"，萬用字元憑證就不會涵蓋該內容。
- 自我簽署憑證：用戶端瀏覽器不會信任這些憑證，並且會警告使用者虛擬服務的憑證不是信任鏈的一部分。 自我簽署憑證適用于系統管理員控制用戶端的測試或環境，而且可以安全地略過瀏覽器的安全性警示。 生產工作負載應該永遠不會使用自我簽署憑證。

如需詳細資訊，請參閱[使用應用程式閘道設定 TLS 終止](https://docs.microsoft.com/azure/application-gateway/create-ssl-portal)。

### <a name="size-of-the-certificate"></a>憑證的大小
請檢查[應用程式閘道限制](https://docs.microsoft.com/azure/azure-resource-manager/management/azure-subscription-service-limits#application-gateway-limits)一節，以瞭解支援的 TLS/SSL 憑證大小上限。

## <a name="end-to-end-tls-encryption"></a>端對端 TLS 加密

某些客戶可能不會想要對後端伺服器進行未加密的通訊。 可能是因為安全性需求、合規性需求，或應用程式可能只接受安全連線。 針對這類應用程式，應用程式閘道支援端對端 TLS 加密。

端對端 TLS 可讓您將機密資料安全地傳輸到後端，同時仍能利用應用程式閘道所提供第7層負載平衡功能的優點。 部分功能為 cookie 型工作階段親和性、URL 型路由、支援根據站台或能注入 X-Forwarded-* 標頭的路由。

當設定端對端 TLS 通訊模式時，應用程式閘道會終止閘道上的 TLS 會話，並解密使用者流量。 然後，它會套用所設定的規則來選取要將流量路由傳送到的適當後端集區執行個體。 接著，應用程式閘道會起始與後端伺服器的新 TLS 連線，然後使用後端伺服器的公開金鑰憑證重新加密資料，再將要求傳輸至後端。 任何來自 Web 伺服器的回應都會經歷相同的程序而回到使用者端。 透過將[後端 HTTP 設定](https://docs.microsoft.com/azure/application-gateway/configuration-overview#http-settings)中的通訊協定設定設定為 HTTPS，然後套用至後端集區，即可啟用端對端 TLS。

TLS 原則會同時適用于前端和後端流量。 在前端，應用程式閘道會作為伺服器，並強制執行原則。 在後端，應用程式閘道會作為用戶端，並在 TLS 交握期間傳送通訊協定/密碼資訊做為喜好設定。

應用程式閘道只會與已將其憑證列入應用程式閘道的後端實例通訊，或由知名的 CA 授權單位簽署其憑證，其中憑證 CN 符合 HTTP 後端設定中的主機名稱。 其中包括受信任的 Azure 服務，例如 Azure App 服務 web 應用程式和 Azure API 管理。

如果後端集區中的成員憑證不是由知名的 CA 授權單位所簽署，則後端集區中已啟用端對端 TLS 的每個實例都必須以憑證設定，以允許安全通訊。 新增憑證可確保應用程式閘道只會與已知的後端執行個體通訊。 這會進而保護端對端通訊。

> [!NOTE] 
>
> 受信任的 Azure 服務（例如 Azure App 服務 web 應用程式和 Azure API 管理）不需要進行驗證憑證設定。

> [!NOTE] 
>
> 新增至後端**HTTP 設定**以驗證後端伺服器的憑證，可以與在應用程式網**關上針對 TLS 終止所新增**的憑證相同，或不同以增強安全性。

![端對端 tls 案例][1]

在此範例中，使用 TLS 1.2 的要求會使用端對端 TLS 路由至 Pool1 中的後端伺服器。

## <a name="end-to-end-tls-and-whitelisting-of-certificates"></a>端對端 TLS 和憑證允許清單

應用程式閘道只會與已知的後端執行個體通訊，後者已將其憑證加入到應用程式閘道的允許清單。 若要啟用憑證允許清單，您必須將後端伺服器憑證的公開金鑰上傳至應用程式閘道 (不是根憑證)。 於是，只允許連接至已知和允許清單中的後端。 其餘的後端會導致閘道錯誤。 自我簽署憑證僅供測試之用，並不建議用於生產工作負載。 這類憑證必須如先前步驟所述，加入應用程式閘道的允許清單之中，才能使用。

> [!NOTE]
> 受信任的 Azure 服務 (例如 Azure App Service) 不需進行驗證憑證設定。

## <a name="end-to-end-tls-with-the-v2-sku"></a>具有 v2 SKU 的端對端 TLS

在「應用程式閘道 v2 SKU」中，「驗證憑證」已被淘汰且被「受信任的根憑證」取代。 它們的功能與「驗證憑證」類似，但有幾個主要差異：

- 由知名 CA 授權單位簽署的憑證，其 CN 符合 HTTP 後端設定中的主機名稱，並不需要任何額外的步驟，端對端 TLS 就能運作。 

   例如，如果後端憑證是由已知 CA 所簽發且 CN 為 contoso.com，而後端 HTTP 設定的主機欄位也設定為 contoso.com，便無須執行任何其他步驟。 您可以將後端 HTTP 設定通訊協定設定為 HTTPS，且健康情況探查和資料路徑都會啟用 TLS。 如果您使用 Azure App Service 或其他 Azure web 服務作為後端，則這些也會隱含地受到信任，而且不需要針對端對端 TLS 進行進一步的步驟。
   
> [!NOTE] 
>
> 為了讓 TLS/SSL 憑證受到信任，該後端伺服器的憑證必須由應用程式閘道的受信任存放區中所包含的 CA 發行。如果憑證不是由受信任的 CA 所發行，則應用程式閘道接著會檢查發行 CA 的憑證是否由受信任的 CA 發出，依此類推，直到找到信任的 CA 為止（此時會建立受信任的安全連線），或找不到信任的 CA （此時，應用程式閘道會將後端標示為狀況不良）。 因此，建議後端伺服器憑證同時包含根和中繼 Ca。

- 如果憑證是自我簽署的，或由未知的媒介簽署，則若要在 v2 SKU 中啟用端對端 TLS，必須定義受信任的根憑證。 「應用程式閘道」只會與符合下列條件的後端進行通訊：其伺服器憑證的根憑證符合與集區相關之後端 HTTP 設定中受信任根憑證清單內的其中一個憑證。

> [!NOTE] 
>
> 自我簽署憑證必須是憑證鏈的一部分。 V2 SKU 不支援不具鏈的單一自我簽署憑證。

- 除了根憑證相符之外，應用程式閘道也會驗證後端 HTTP 設定中所指定的主機設定是否符合後端伺服器的 TLS/SSL 憑證所呈現的一般名稱（CN）。 嘗試建立與後端的 TLS 連線時，應用程式閘道會將伺服器名稱指示（SNI）延伸模組設定為後端 HTTP 設定中所指定的主機。
- 如果選擇**從後端位址挑選主機名稱**，而不是後端 HTTP 設定中的 [主機] 欄位，則 SNI 標頭一律會設定為後端集區 FQDN，而後端伺服器 TLS/SSL 憑證上的 CN 必須符合其 FQDN。 此案例中不支援具有 Ip 的後端集區成員。
- 根憑證是一個來自後端伺服器憑證的 Base64 編碼根憑證。

## <a name="next-steps"></a>後續步驟

瞭解端對端 TLS 之後，請移至使用[應用程式閘道搭配 PowerShell 來設定端對端 tls](application-gateway-end-to-end-ssl-powershell.md) ，以使用端對端 TLS 來建立應用程式閘道。

<!--Image references-->

[1]: ./media/ssl-overview/scenario.png
