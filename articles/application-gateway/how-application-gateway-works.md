---
title: 應用程式閘道的運作方式
description: 本文提供應用程式閘道如何接受連入要求並將其路由傳送至後端的相關資訊。
services: application-gateway
author: abshamsft
ms.service: application-gateway
ms.topic: conceptual
ms.date: 11/16/2019
ms.author: absha
ms.openlocfilehash: d33ec829e490ae45d38d33f5784126a71ae2d0aa
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 10/09/2020
ms.locfileid: "86506548"
---
# <a name="how-an-application-gateway-works"></a>應用程式閘道的運作方式

本文說明應用程式閘道如何接受連入要求，並將其路由傳送至後端。

![應用程式閘道如何接受要求](./media/how-application-gateway-works/how-application-gateway-works.png)

## <a name="how-an-application-gateway-accepts-a-request"></a>應用程式閘道如何接受要求

1. 在用戶端將要求傳送至應用程式閘道之前，它會使用網域名稱系統 (DNS) server 來解析應用程式閘道的功能變數名稱。 因為所有的應用程式閘道都在 azure.com 網域中，所以 Azure 會控制 DNS 專案。

2. Azure DNS 會將 IP 位址傳回給用戶端，也就是應用程式閘道的前端 IP 位址。

3. 應用程式閘道接受一或多個接聽程式上的連入流量。 接聽程式是一種邏輯實體，可檢查連接要求。 它會使用前端 IP 位址、通訊協定和埠號碼進行設定，以便從用戶端連線到應用程式閘道。

4. 如果 web 應用程式防火牆 (WAF) 正在使用中，則應用程式閘道會針對 WAF 規則檢查要求標頭和主體（如果有的話）。 此動作會判斷要求是否為有效要求或安全性威脅。 如果要求有效，則會路由傳送至後端。 如果要求無效，且 WAF 處於預防模式，則會被封鎖為安全性威脅。 如果處於偵測模式，則會評估並記錄要求，但仍會轉送到後端伺服器。

Azure 應用程式閘道可做為內部應用程式負載平衡器，或作為網際網路面向的應用程式負載平衡器。 網際網路面向的應用程式閘道會使用公用 IP 位址。 網際網路對向應用程式閘道的 DNS 名稱可公開解析為其公用 IP 位址。 因此，網際網路面向的應用程式閘道可以將用戶端要求路由傳送到網際網路。

內部應用程式閘道僅使用私人 IP 位址。 如果您使用自訂或 [私人 DNS 區域](https://docs.microsoft.com/azure/dns/private-dns-overview)，則功能變數名稱應可在內部解析為應用程式閘道的私人 IP 位址。 因此，內部負載平衡器只能從用戶端對應用程式閘道的虛擬網路具有存取權的用戶端路由傳送要求。

## <a name="how-an-application-gateway-routes-a-request"></a>應用程式閘道路由要求的方式

如果要求有效且未被 WAF 封鎖，應用程式閘道會評估與接聽程式相關聯的要求路由規則。 此動作會決定要將要求路由至哪個後端集區。

應用程式閘道會根據要求路由規則，決定是否要將接聽程式上的所有要求路由傳送至特定的後端集區、根據 URL 路徑將要求路由傳送至不同的後端集區，或將要求重新導向至另一個埠或外部網站。
>[!NOTE]
>規則會依其列于 v1 SKU 入口網站中的順序進行處理。 

當應用程式閘道選取後端集區時，它會將要求傳送至集區中的其中一個狀況良好的後端伺服器， (y. y) 。 伺服器的健康狀態是由健康情況探查所決定。 如果後端集區包含多部伺服器，則應用程式閘道會使用迴圈配置資源演算法，在狀況良好的伺服器之間路由傳送要求。 這會對伺服器上的要求進行負載平衡。

應用程式閘道決定後端伺服器之後，它會開啟新的 TCP 會話，並以 HTTP 設定為基礎的後端伺服器。 HTTP 設定會指定與後端伺服器建立新的會話所需的通訊協定、埠和其他路由相關的設定。

HTTP 設定中使用的埠和通訊協定會決定應用程式閘道與後端伺服器之間的流量是否經過加密 (因此會完成端對端 TLS) 或未加密。

當應用程式閘道將原始要求傳送至後端伺服器時，它會接受在與覆寫主機名稱、路徑和通訊協定相關的 HTTP 設定中所做的任何自訂設定。 此動作會維護以 cookie 為基礎的會話親和性、連線清空、來自後端的主機名稱選擇等等。

 >[!NOTE]
>如果後端集區：
> - **是公用端點**，應用程式閘道會使用其前端公用 IP 來連接伺服器。 如果沒有前端公用 IP 位址，則會為輸出外部連線指派一個。
> - **包含可內部解析的 FQDN 或私人 ip 位址**，應用程式閘道會使用其實例的私人 ip 位址，將要求路由傳送至後端伺服器。
> - **包含外部端點或外部可解析的 FQDN**，應用程式閘道會使用其前端公用 IP 位址，將要求路由傳送至後端伺服器。 DNS 解析是根據私人 DNS 區域或自訂 DNS 伺服器（如果已設定），或使用預設的 Azure 提供的 DNS。 如果沒有前端公用 IP 位址，則會為輸出外部連線指派一個。

### <a name="modifications-to-the-request"></a>要求的修改

應用程式閘道會在將要求轉送至後端之前，將四個額外的標頭插入至所有要求。 這些標頭是 x 轉送的，適用于、x 轉送的-proto、x 轉送的埠，以及 x 原始主機。 X 轉送的格式標頭的格式是以逗號分隔的 IP： port 清單。

X 轉送-proto 的有效值為 HTTP 或 HTTPS。 X 轉送的埠會指定要求到達應用程式閘道的埠。 X-原始主機標頭包含要求抵達的原始主機標頭。 此標頭適用于 Azure 網站整合，其中傳入的主機標頭會在流量路由傳送至後端之前先修改。 如果已啟用會話親和性，則會新增閘道管理的親和性 cookie。

您可以使用 [重寫 HTTP 標頭和 url](rewrite-http-headers-url.md) 來設定應用程式閘道，以修改要求和回應標頭和 url，或使用路徑-覆寫設定修改 URI 路徑。 不過，除非設定為這樣做，否則所有連入要求都會 proxy 處理至後端。

## <a name="next-steps"></a>接下來的步驟

[深入瞭解應用程式閘道元件](application-gateway-components.md)
