---
title: 容錯移轉和修補 - Azure Cache for Redis
description: 瞭解 Redis Azure 緩存的容錯移轉、修補和更新過程。
author: asasine
ms.service: cache
ms.topic: conceptual
ms.date: 10/18/2019
ms.author: adsasine
ms.openlocfilehash: 6ff33bd594181aabc4fd7d55ce33f780a0d06086
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/27/2020
ms.locfileid: "74122197"
---
# <a name="failover-and-patching-for-azure-cache-for-redis"></a>Redis Azure 緩存的容錯移轉和修補

要構建彈性且成功的用戶端應用程式，瞭解 Redis 服務的 Azure 緩存上下文中的容錯移轉至關重要。 容錯移轉可能是計畫管理操作的一部分，也可能由計畫外硬體或網路故障引起。 當管理服務修補 Redis 二進位檔案的 Azure 緩存時，將常見使用緩存容錯移轉。 本文介紹容錯移轉是什麼，在修補過程中如何發生容錯移轉，以及如何構建彈性用戶端應用程式。

## <a name="what-is-a-failover"></a>什麼是容錯移轉？

讓我們從 Redis Azure 緩存的容錯移轉概述開始。

### <a name="a-quick-summary-of-cache-architecture"></a>緩存體系結構的快速摘要

緩存由具有獨立私人 IP 位址的多個虛擬機器組成。 每個虛擬機器（也稱為節點）都連接到具有單個虛擬 IP 位址的共用負載等化器。 每個節點運行 Redis 伺服器進程，可通過主機名稱和 Redis 埠進行訪問。 每個節點都被視為主節點或副本節點。 當用戶端應用程式連接到緩存時，其流量將經過此負載等化器並自動路由到主節點。

在基本緩存中，單個節點始終是主節點。 在標準或高級緩存中，有兩個節點：一個選擇為主節點，另一個節點是副本。 由於標準緩存和高級緩存有多個節點，因此一個節點可能不可用，而另一個節點將繼續處理請求。 群集緩存由許多分片組成，每個分片都有不同的主節點和副本節點。 當其他分片保持可用時，一個分片可能會關閉。

> [!NOTE]
> 基本緩存沒有多個節點，並且不提供服務等級協定 （SLA） 的可用性。 建議僅出於開發和測試目的使用基本緩存。 對多節點部署使用標準或高級緩存以提高可用性。

### <a name="explanation-of-a-failover"></a>容錯移轉的解釋

當副本節點提升為主節點，而舊主節點關閉現有連接時，將發生容錯移轉。 主節點恢復後，它會注意到角色的變化，並降級自身成為副本。 然後，它連接到新的主控形狀並同步資料。 容錯移轉可能是計畫好的，也可以是計畫外的。

*計畫容錯移轉*在系統更新（如 Redis 修補或作業系統升級）和管理操作（如縮放和重新開機）期間發生。 由於節點收到更新的提前通知，因此它們可以協同交換角色並快速更新更改的負載等化器。 計畫容錯移轉通常在不到 1 秒內完成。

由於硬體故障、網路故障或其他主節點意外中斷，可能會發生*計畫外容錯移轉*。 副本節點將自己提升到主節點，但該過程需要更長的時間。 副本節點必須先檢測其主節點不可用，然後才能啟動容錯移轉過程。 副本節點還必須驗證此計畫外故障不是暫時故障還是本地故障，以避免不必要的容錯移轉。 檢測的延遲意味著計畫外容錯移轉通常在 10 到 15 秒內完成。

## <a name="how-does-patching-occur"></a>如何進行修補？

Redis 服務的 Azure 緩存會定期更新緩存，並採用最新的平臺功能和修補程式。 要修補緩存，服務遵循以下步驟：

1. 管理服務選擇要修補的節點。
1. 如果所選節點是主節點，則相應的副本節點協同升級。 此升級被視為計畫容錯移轉。
1. 所選節點將重新開機以執行新的更改，然後作為副本節點重新備份。
1. 副本節點連接到主節點並同步資料。
1. 資料同步完成後，修補過程將重複其餘節點。

由於修補是計畫容錯移轉，因此副本節點會快速提升自身為主伺服器並開始為請求和新連接提供服務。 基本緩存沒有副本節點，在更新完成之前不可用。 群集緩存的每個分片都單獨修補，不會關閉與另一個分片的連接。

> [!IMPORTANT]
> 節點一次修補一個，以防止資料丟失。 基本緩存將遺失資料。 群集緩存一次修補一個分片。

同一資源組和區域中的多個緩存也一次修補一個。  不同資源組或不同區域中的緩存可能同時修補。

由於完全資料同步發生在進程重複之前，因此在使用標準緩存或高級緩存時不太可能發生資料丟失。 您可以通過[匯出](cache-how-to-import-export-data.md#export)資料和啟用[持久性](cache-how-to-premium-persistence.md)來進一步防止資料丟失。

## <a name="additional-cache-load"></a>額外的緩存負載

每當發生容錯移轉時，標準和高級緩存都需要將資料從一個節點複製到另一個節點。 此複製會導致伺服器記憶體和 CPU 中的負載增加。 如果緩存實例已負載過重，則用戶端應用程式可能會遇到更高的延遲。 在極端情況下，用戶端應用程式可能會收到超時異常。 為了説明減輕此額外負載的影響，[請配置](cache-configure.md#memory-policies)緩存的`maxmemory-reserved`設置。

## <a name="how-does-a-failover-affect-my-client-application"></a>容錯移轉如何影響我的用戶端應用程式？

用戶端應用程式看到的錯誤數取決於容錯移轉時該連接上掛起的運算元。 通過關閉其連接的節點路由的任何連接都將看到錯誤。 當連接中斷時，許多用戶端庫可能會引發不同類型的錯誤，包括超時異常、連接異常或通訊端異常。 異常的數量和類型取決於緩存關閉其連接時請求在代碼路徑中的位置。 例如，在發生容錯移轉時發送請求但尚未收到回應的操作可能會收到超時異常。 關閉的連線物件上的新請求接收連接異常，直到重新連接成功發生。

如果用戶端庫配置為重新連接到緩存，則嘗試重新連接到緩存。 但是，不可預見的 Bug 有時會將庫物件置於不可恢復的狀態。 如果錯誤持續的時間超過預配置的時間，則應重新創建連線物件。 在Microsoft.NET和其他物件導向的語言中，無需重新開機應用程式即可使用[Lazy\<T\>模式](https://gist.github.com/JonCole/925630df72be1351b21440625ff2671f#reconnecting-with-lazyt-pattern)實現重新創建連接。

### <a name="how-do-i-make-my-application-resilient"></a>如何使應用程式具有彈性？

由於無法完全避免容錯移轉，因此請編寫用戶端應用程式以恢復連接中斷和失敗的請求。 儘管大多數用戶端庫會自動重新連接到緩存終結點，但很少用戶端庫嘗試重試失敗的請求。 根據應用程式方案，使用回退邏輯可能有意義。

要測試用戶端應用程式的恢復能力，請使用[重新開機](cache-administration.md#reboot)作為連接中斷的手動觸發器。 此外，我們建議您在緩存上[安排更新](cache-administration.md#schedule-updates)。 告訴管理服務在指定的每週視窗期間應用 Redis 運行時修補程式。 這些視窗通常是用戶端應用程式流量低的期間，以避免潛在的事件。

### <a name="client-network-configuration-changes"></a>用戶端網路設定更改

某些用戶端網路設定更改可能會觸發"無連接可用"錯誤。 此類更改可能包括：

- 在暫存和生產槽之間交換用戶端應用程式的虛擬 IP 位址。
- 縮放應用程式的大小或實例數。

此類更改可能會導致持續不到一分鐘的連接問題。 除了 Redis 服務的 Azure 緩存之外，用戶端應用程式可能會失去與其他外部網路資源的連接。

## <a name="next-steps"></a>後續步驟

- [計畫緩存的更新](cache-administration.md#schedule-updates)。
- 使用[重新開機](cache-administration.md#reboot)測試應用程式恢復能力。
- [配置](cache-configure.md#memory-policies)記憶體預留和策略。
