---
title: 透過 Azure Cosmos DB 全域散發 - 運作原理
description: 此文章提供有關 Azure Cosmos DB 全域散發的技術詳細資料
author: SnehaGunda
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 07/02/2020
ms.author: sngun
ms.reviewer: sngun
ms.openlocfilehash: c86207af51ebd1a9442afe6fa609598ec917bf15
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 10/09/2020
ms.locfileid: "91570441"
---
# <a name="global-data-distribution-with-azure-cosmos-db---under-the-hood"></a>透過 Azure Cosmos DB 全域資料散發 - 運作原理

Azure Cosmos DB 是 Azure 中的基礎服務，因此會部署在全球所有 Azure 區域，包括公共、主權、國防部 (DoD) 和政府雲端。 在資料中心內，我們會在大規模戳記的機器上部署及管理 Azure Cosmos DB，每部都有專屬的本機儲存體。 在資料中心內，Azure Cosmos DB 會跨許多叢集進行部署，每個可能都會執行多個世代的硬體。 叢集中的機器通常會分散到10-20 個容錯網域，以提供區域內的高可用性。 下圖顯示 Cosmos DB 全域散發系統拓撲：

:::image type="content" source="./media/global-dist-under-the-hood/distributed-system-topology.png" alt-text="系統拓撲" border="false":::

**Azure Cosmos DB 中的全域散發是全包式的：** 無論何時，只要按幾下，或以程式設計方式使用單一 API 呼叫，您就可以新增或移除與 Cosmos 資料庫相關聯的地理區域。 Cosmos 資料庫則是由一組 Cosmos 容器所組成。 在 Cosmos DB 中，容器可用來作為散發和延展性的邏輯單元。 您所建立的集合、資料表和圖形 (在內部) 只是 Cosmos 容器。 容器與架構完全無關，並提供查詢的範圍。 Cosmos 容器中的資料都會在擷取時自動編製索引。 自動編制索引可讓使用者查詢資料，而不會有架構或索引管理的麻煩，尤其是在全域散發的設定中。  

- 在指定的區域中，容器內的資料會使用您所提供的資料分割索引鍵來散發，並以透明方式管理 (*本機散發*) 的基礎實體資料分割。  

- 每個實體分割區也會跨地理區域複寫 (*全域散發*) 。 

當使用 Cosmos DB 彈性的應用程式調整 Cosmos 容器的輸送量或耗用更多儲存體時，Cosmos DB 以透明的方式處理分割區管理作業 (分割、複製、刪除所有區域) 。 不論是調整、散發或發生錯誤，Cosmos DB 都會繼續在容器內提供資料的單一系統映像，這些容器會跨任意數目的容器進行全域散發。  

如下圖所示，容器內的資料會以兩個維度分佈在全球區域內和跨區域：  

:::image type="content" source="./media/global-dist-under-the-hood/distribution-of-resource-partitions.png" alt-text="系統拓撲" border="false":::

實體分割區是由一組複本（稱為「 *複本集*」）所執行。 每部機器都會裝載數百個對應至一組固定進程內各種實體分割區的複本，如上圖所示。 對應到實體分割區的複本均會動態放置，並在區域中叢集和資料中心內的機器間進行負載平衡。  

一個複本只會屬於一個 Azure Cosmos DB 租用戶。 每個複本都會裝載 Cosmos DB [資料庫引擎](https://www.vldb.org/pvldb/vol8/p1668-shukla.pdf) \(英文\) 的執行個體，其會管理資源以及相關聯的索引。 Cosmos 資料庫引擎會在 atom 記錄序列 (ARS) 型類型系統上運作。 引擎與架構的概念無關，因此會模糊記錄結構和實例值之間的界限。 Cosmos DB 會以有效率的方式，在擷取時自動為每個項目編製索引，藉以達到完全不會區分結構描述的論點，讓使用者能夠查詢他們的全域散發資料，而不需處理結構描述或索引管理。

Cosmos 資料庫引擎是由元件所組成，包括實作為數個協調基本專案、語言執行時間、查詢處理器，以及分別負責交易式儲存和編制資料索引的儲存和索引子系統。 為了提供持久性和高可用性，資料庫引擎會在 SSD 上保存它的資料和索引，並且分別在複本集內的資料庫引擎執行個體之間複寫它。 較大的租使用者會對應至較高的輸送量和儲存體規模，並且擁有較大或更多的複本或兩者。 系統的每個元件都是完全非同步的，沒有任何執行緒會遭到封鎖，而且每個執行緒都會進行短暫存留的工作，而不會產生任何不必要的執行緒切換。 速率限制和背壓會在整個堆疊上，從許可控制連接到所有 I/O 路徑。 Cosmos 資料庫引擎的設計目的是要利用細微的平行存取，並在節省的系統資源數量內運作，以提供高輸送量。

Cosmos DB 的全域散發相依于兩個主要抽象概念： *複本集* 和資料 *分割集*。 複本集是可用於協調的模組化 Lego 區塊，而分割集是一或多個地理位置分散之實體分割區的動態重疊。 若要了解全域散發的運作方式，我們需要了解這兩個關鍵抽象概念。 

## <a name="replica-sets"></a>複本集

實體分割區會具體化為自我管理和動態負載平衡的複本群組，這些複本會分散到多個容錯網域，稱為複本集。 此集合會共同實作複寫的狀態機器通訊協定，以使實體分割區中的資料高度可用、耐久且一致。 複本集的成員資格 *N* 是動態的-它會根據失敗、系統管理作業，以及失敗複本重新產生/復原的時間，在 *n 每天下限* 和 *n 上限* 之間保持變動。 根據成員資格變更，複寫通訊協定也會重新設定讀取和寫入仲裁的大小。 為了一致地散發指派給指定實體分割區的輸送量，我們採用兩個構想： 

- 首先，處理領導者上的寫入要求的成本高於在該過程中套用更新的成本。 同樣地，前端項目預算的系統資源會比實行項目還要多。 

- 其次，盡可能地使指定一致性層級的讀取仲裁僅由實行項目複本所組成。 除非必要，否則我們會避免為前端項目提供讀取。 我們針對 Cosmos DB 支援的[五種一致性模型](consistency-levels.md)，從仲裁型系統中的[負載和容量](https://www.cs.utexas.edu/~lorenzo/corsi/cs395t/04S/notes/naor98load.pdf)關聯性所做的研究中，運用了許多想法。  

## <a name="partition-sets"></a>分割集

一組實體分割區（每個設定的 Cosmos 資料庫區域各一個），是為了管理在所有已設定區域上複寫的同一組索引鍵。 這個較高的協調基本類型稱為「 *分割集」（partition set* ），也就是管理一組指定索引鍵的實體分割區的地理分散動態重迭。 當指定的實體磁碟分割 (複本集) 範圍在叢集內時，分割集可以跨越叢集、資料中心和地理區域，如下圖所示：  

:::image type="content" source="./media/global-dist-under-the-hood/dynamic-overlay-of-resource-partitions.png" alt-text="系統拓撲" border="false":::

您可以將分割集想像為地理位置分散的「進階複本集」，其會由擁有相同索引鍵的多個複本集所組成。 類似于複本集，資料分割集的成員資格也是動態的-它會根據隱含的實體分割區管理作業，在指定的資料分割集 (中新增/移除新的資料分割，例如，當您在容器上相應放大輸送量、將區域新增/移除至 Cosmos 資料庫，或發生失敗時) 。 藉由將分割集的每個分割區 (，) 在它自己的複本集內管理分割集的成員資格，成員資格就是完全非集中式且高度可用。 重新設定分割集期間，也會建立在實體分割區之間重疊的拓撲。 拓撲會根據一致性層級、地理距離，以及來源與目標實體分割區之間的可用網路頻寬進行動態選取。  

此服務可讓您使用單一寫入區域或多個寫入區域來設定 Cosmos 資料庫，並根據選項，將分割集設定為只接受一個或接受所有區域中的寫入。 系統採用兩個層級的巢狀共識通訊協定，一個層級會在接受寫入之實體分割區複本集的複本內運作，而另一個層級會在分割集的層級上運作，以針對分割集內所有認可的寫入提供完整的順序保證。 這個多層式巢狀共識是實作嚴格 SLA 以提供高可用性，以及實作 Cosmos DB 提供給其客戶之一致性模型的關鍵。  

## <a name="conflict-resolution"></a>衝突解決

我們對於更新傳播、衝突解決和因果追蹤的設計靈感來自先前在 [epidemic 演算法](https://www.cs.utexas.edu/~lorenzo/corsi/cs395t/04S/notes/naor98load.pdf) \(英文\) 和 [Bayou](https://zoo.cs.yale.edu/classes/cs422/2013/bib/terry95managing.pdf) \(英文\) 系統上的工作。 儘管構想的核心已存留並提供方便參考的架構來與 Cosmos DB 系統設計溝通，但隨著我們將它們套用到 Cosmos DB 系統，它們也經歷了明顯的轉變。 這是必要的，因為先前的系統不是以資源管理或 Cosmos DB 需要操作的規模來設計，也不能提供 (例如，限定過期一致性) 以及 Cosmos DB 傳遞給客戶的嚴格和全面 Sla。  

回想一下，分割集分佈在多個區域，並遵循 Cosmos Db (多重區域寫入) 複寫通訊協定，在組成指定分割集的實體分割區之間複寫資料。 每個實體分割區 (屬於分割集) 都會接受寫入，而且通常可為該區域的區域用戶端提供讀取。 區域內實體分割區所接受的寫入會被永久認可，並在將它們認可到用戶端之前，使其可在實體分割區內高度可用。 這些都是暫時性寫入，並會使用反熵通道傳播到分割集內的其他實體分割區。 用戶端可以藉由傳遞要求標頭來要求暫時性或認可的寫入。 反熵傳播 (包括傳播頻率) 是動態的，會以分割集的拓撲、實體分割區的區域性近接，以及所設定的一致性層級為根據。 在分割集內，Cosmos DB 會遵循主要的認可配置，其中具有動態選取的仲裁程式分割區。 選取仲裁程式是動態的，而且是根據重疊拓撲重新設定分割集時不可或缺的一部分。 保證會將認可的寫入 (包括多列/批次更新) 進行排序。 

我們採用已編碼的向量時鐘 (包含區域識別碼，以及分別對應到複本集和分割集上每個共識層級的邏輯時鐘)，以進行因果追蹤和版本向量來偵測及解決更新衝突。 拓撲和對等選取演算法旨在確保固定且最基本的儲存體，以及版本向量的最小網路額外負荷。 此演算法會保證嚴格的聚合屬性。  

針對使用多個寫入區域設定的 Cosmos 資料庫，系統提供許多彈性自動衝突解決原則，讓開發人員可從中選擇，包括： 

- 「**最後寫入-獲勝」 (LWW) **，根據預設，它會使用系統定義的時間戳記屬性 (以時間同步處理時鐘通訊協定) 為基礎。 Cosmos DB 也可讓您指定任何其他自訂數值屬性以用來解決衝突。  
- **應用程式定義的 (自訂) 衝突解決原則** (透過「合併程式) 」表示，這是針對應用程式定義的衝突進行協調。 在伺服器端偵測到資料庫交易的支援下有寫入-寫入衝突時，就會叫用這些程序。 系統會提供剛好一次的保證，讓合併程式執行成為承諾協定的一部分。 有 [幾個衝突解決範例](how-to-manage-conflicts.md) 可供您用來玩。  

## <a name="consistency-models"></a>一致性模型

無論您是使用單一或多個寫入區域來設定 Cosmos 資料庫，都可以從五個定義完善的一致性模型中選擇。 使用多個寫入區域時，以下是一致性層級的幾個值得注意的層面：  

限定過期一致性可保證所有讀取都將在任何區域中最新寫入的 *K* 首碼或 *T* 秒內。 此外，具有限定過期一致性的讀取保證會單純，且具有一致的前置詞保證。 反熵通訊協定會以速率限制的方式運作，並確保前置詞不會累積，而且不必在寫入上套用背壓。 會話一致性可保證單純讀取、單純寫入、讀取您自己的寫入、寫入遵循讀取和一致的前置詞保證（全球）。 針對以強式一致性設定的資料庫，因為跨區域的同步複寫，所以不適用多個寫入區域 (低寫入延遲、高寫入可用性) 的優點。

[此處](consistency-levels.md)說明 Cosmos DB 五個一致性模型的語義，並以數學方式描述如何使用[這裡](https://github.com/Azure/azure-cosmos-tla)的高階 TLA + 規格。

## <a name="next-steps"></a>後續步驟

接下來，了解如何使用下列文章來設定全域散發：

* [在資料庫帳戶中新增/移除區域](how-to-manage-database-account.md#addremove-regions-from-your-database-account)
* [如何設定多路連接的用戶端](how-to-manage-database-account.md#configure-multiple-write-regions)
* [如何建立自訂衝突解決原則](how-to-manage-conflicts.md#create-a-custom-conflict-resolution-policy)
