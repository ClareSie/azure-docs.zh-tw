---
title: Azure AD Connect：將群組從一個樹系遷移至另一個樹系
description: 本文說明將群組從一個樹系成功遷移至另一個樹系以進行 Azure AD Connect 所需的步驟。
services: active-directory
author: billmath
manager: daveba
ms.service: active-directory
ms.topic: reference
ms.workload: identity
ms.date: 04/02/2020
ms.subservice: hybrid
ms.author: billmath
ms.collection: M365-identity-device-management
ms.openlocfilehash: da2328674fd601f2e04684e8a9af1ae242ff6106
ms.sourcegitcommit: 58faa9fcbd62f3ac37ff0a65ab9357a01051a64f
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 04/28/2020
ms.locfileid: "82229794"
---
# <a name="migrate-groups-from-one-forest-to-another-for-azure-ad-connect"></a>將群組從一個樹系遷移至另一個樹系以進行 Azure AD Connect

本文說明如何將群組從一個樹系遷移至另一個，讓遷移的群組物件符合雲端中的現有物件。

## <a name="prerequisites"></a>先決條件

- Azure AD Connect 1.5.18.0 或更新版本
- 來源錨點屬性設定為`mS-DS-ConsistencyGuid`

## <a name="migrate-groups"></a>遷移群組

從版本1.5.18.0 開始，Azure AD Connect 支援使用群組的`mS-DS-ConsistencyGuid`屬性。 如果您選擇`mS-DS-ConsistencyGuid`做為來源錨點屬性，並將值填入 Active Directory 中，Azure AD Connect 會使用的`mS-DS-ConsistencyGuid`值做`immutableId`為。 否則，它會改回使用`objectGUID`。 但請注意，Azure AD Connect 不會將值寫回`mS-DS-ConsistencyGuid` Active Directory 中的屬性。

跨樹系移動時，當群組物件從一個樹系（例如 F1）移至另一個樹系（例如 F2）時，您需要將`mS-DS-ConsistencyGuid`值（如果有的話）或樹系 F1 中`objectGUID`物件的值複製到 F2 中的物件`mS-DS-ConsistencyGuid`屬性。

使用下列腳本作為指南，以瞭解如何將單一群組從一個樹系遷移至另一個。 您也可以使用這些腳本作為遷移多個群組的指南。 這些腳本會針對來源樹系使用樹系名稱 F1，並針對目的地樹系使用 F2。

首先，我們會取得`objectGUID`樹`mS-DS-ConsistencyGuid`系 F1 中群組物件的和。 這些屬性會匯出至 CSV 檔案。
```
<#
DESCRIPTION
============
This script will take DN of a group as input.
It then copies the objectGUID and mS-DS-ConsistencyGuid values along with other attributes of the given group to a CSV file.

This CSV file can then be used as input to the Export-Group script.
#>
Param(
       [ValidateNotNullOrEmpty()]
       [string]
       $dn,

       [ValidateNotNullOrEmpty()]
       [string]
       $outputCsv
)

$defaultProperties = @('samAccountName', 'distinguishedName', 'objectGUID', 'mS-DS-ConsistencyGuid')
$group  = Get-ADGroup -Filter "DistinguishedName -eq '$dn'" -Properties $defaultProperties -ErrorAction Stop
$results = @()
if ($group -eq $null)
{
       Write-Error "Group not found"
}
else
{
       $objectGUIDValue = [GUID]$group.'objectGUID'
       $mSDSConsistencyGuidValue = "N/A"
       if ($group.'mS-DS-ConsistencyGuid' -ne $null)
       {
              $mSDSConsistencyGuidValue = [GUID]$group.'mS-DS-ConsistencyGuid'
       }
       $adgroup = New-Object -TypeName PSObject
       $adgroup | Add-Member -MemberType NoteProperty -Name samAccountName -Value $($group.'samAccountName')
       $adgroup | Add-Member -MemberType NoteProperty -Name distinguishedName -Value $($group.'distinguishedName')
       $adgroup | Add-Member -MemberType NoteProperty -Name objectGUID -Value $($objectGUIDValue)
       $adgroup | Add-Member -MemberType NoteProperty -Name mS-DS-ConsistencyGuid -Value $($mSDSConsistencyGuidValue)
       $results += $adgroup
}

Write-Host "Exporting group to output file"
$results | Export-Csv "$outputCsv" -NoTypeInformation

```

接下來，我們會使用產生的輸出 CSV 檔案， `mS-DS-ConsistencyGuid`對樹系 F2 中目標物件上的屬性進行戳記：


```
<#
DESCRIPTION
============
This script will take DN of a group as input and the CSV file that was generated by the Import-Group script.
It copies either the objectGUID or the mS-DS-ConsistencyGuid value from the CSV file to the given object.

#>
Param(
       [ValidateNotNullOrEmpty()]
       [string]
       $dn,

       [ValidateNotNullOrEmpty()]
       [string]
       $inputCsv
)

$group  = Get-ADGroup -Filter "DistinguishedName -eq '$dn'" -ErrorAction Stop
if ($group -eq $null)
{
       Write-Error "Group not found"
}

$csvFile = Import-Csv -Path $inputCsv -ErrorAction Stop
$msDSConsistencyGuid = $csvFile.'mS-DS-ConsistencyGuid'
$objectGuid = [GUID] $csvFile.'objectGUID'
$targetGuid = $msDSConsistencyGuid

if ($msDSConsistencyGuid -eq "N/A")
{
       $targetGuid = $objectGuid
}

Set-ADGroup -Identity $dn -Replace @{'mS-DS-ConsistencyGuid'=$targetGuid} -ErrorAction Stop

```

## <a name="next-steps"></a>後續步驟
深入瞭解如何[整合您的內部部署身分識別與 Azure Active Directory](whatis-hybrid-identity.md)。
