---
title: 加速資料庫復原
description: Azure SQL Database 有一項新功能，可針對 Azure SQL Database 中的單一與集區資料庫，以及 Azure SQL 資料倉儲中的資料庫，提供快速且一致的資料庫復原、瞬間完成的交易回復，以及主動式記錄截斷。
ms.service: sql-database
ms.subservice: high-availability
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: mashamsft
ms.author: mathoma
ms.reviewer: carlrab
ms.date: 03/24/2020
ms.openlocfilehash: 57ca594dd067d15009de5e3abf7276fae48720d2
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/28/2020
ms.locfileid: "80238667"
---
# <a name="accelerated-database-recovery"></a>加速資料庫復原

**加速資料庫恢復 （ADR）** 是一種 SQL 資料庫引擎功能，通過重新設計 SQL 資料庫引擎恢復過程，大大提高了資料庫可用性，尤其是在存在長時間運行的事務的情況下。 ADR 目前可用於 Azure SQL 資料庫的單個、彈性池和託管實例，以及 Azure SQL 資料倉儲中的資料庫（當前處於預覽狀態）。 ADR 的主要優點為：

- **快速且一致的資料庫復原**

  使用 ADR，長時間執行的交易便不會影響整體復原時間，可快速且一致地進行資料庫復原，不論系統內使用中的交易數或其大小為何。

- **瞬間交易回復**

  使用 ADR，交易回復會在瞬間完成，不論交易處於使用中狀態的時間長度，或是已執行的更新數為何。

- **積極性記錄截斷**

  使用 ADR 時，事務日誌會被大幅截斷，即使在存在活動長時間運行的事務時也是如此，從而防止事務日誌失去控制。

## <a name="the-current-database-recovery-process"></a>目前的資料庫復原處理序

SQL Server 中的資料庫復原會遵循 [ARIES](https://people.eecs.berkeley.edu/~brewer/cs262/Aries.pdf) \(英文\) 復原模式並包含下圖所示的三個階段，並且會在下圖後面進行更詳細的說明。

![目前的復原處理序](./media/sql-database-accelerated-database-recovery/current-recovery-process.png)

- **分析階段**

  從上次成功檢查點（或最早的髒頁 LSN）的開始到末尾的事務日誌的正向掃描，以確定 SQL Server 停止時每個事務的狀態。

- **重做階段**

  從最舊的未提交事務轉發掃描事務日誌，直到結束，通過重新執行所有已提交的操作，將資料庫帶到崩潰時的狀態。

- **復原階段**

  對於每個在發生毀損時處於作用中的交易，向後周遊記錄，以復原此交易所執行的作業。

根據此設計，SQL 資料庫引擎從非預期的重新啟動進行復原所花費的時間，(大約) 會與發生損毀時系統中最長的作用中交易大小成正比。 復原需要回復所有未完成的交易。 所需時間與交易執行的工作和其已使用時間成比例。 因此，SQL Server 恢復過程可能需要很長時間才能存在長時間運行的事務（例如針對大型表的大型批量插入操作或索引生成操作）。

同時，根據此設計來取消/回復大型交易也會花費很長的時間，因為它使用如前所述的相同復原階段。

此外，SQL 資料庫引擎無法截截事務日誌時，有長時間運行的事務，因為他們的相應日誌記錄是恢復和回滾過程所必需的。 由於 SQL 資料庫引擎的這種設計，一些客戶曾經面臨這樣的問題：事務日誌的大小會變大並消耗大量的磁碟機空間。

## <a name="the-accelerated-database-recovery-process"></a>加速資料庫復原程序

ADR 會透過完全重新設計 SQL 資料庫引擎復原程序來解決上述問題：

- 透過避免從最舊使用中交易的開頭進行掃描，或是掃描至開頭，來固定時間或使其能夠立即完成。 使用 ADR，事務日誌僅從上次成功的檢查點（或最早的髒頁日誌序號 （LSN））進行處理。 因此，復原時間不會受到長時間執行的交易影響。
- 將所需的交易記錄空間減至最小，因為不再需要處理整個交易的記錄。 因此，可在進行檢查點和備份時積極地截斷交易記錄。

在高級別上，ADR 通過版本控制所有物理資料庫修改，並且僅撤銷邏輯操作來實現快速的資料庫恢復，這些操作是有限的，幾乎可以立即撤銷。 任何在發生毀損時處於作用中的交易都會標記為已中止，因此，並行使用者查詢會忽略這些交易所產生的任何版本。

ADR 復原處理序與目前復原處理序具有相同的三個階段。 下圖說明這三個階段使用 ADR 運作的方式，並且會在下圖後面進行更詳細的說明。

![ADR 復原處理序](./media/sql-database-accelerated-database-recovery/adr-recovery-process.png)

- **分析階段**

  添加為非版本化操作的 sLog 和複製日誌記錄，該過程與以前相同。
  
- **重做**階段

  分成兩個階段 (P)
  - 階段 1

      從 sLog 重做 (最舊的未認可交易至最後一個檢查點)。 重做是快速的作業，因為它只需要處理來自 sLog 的幾個記錄。
      
  - 階段 2

     從交易記錄進行重做，會從最後一個檢查點 (而不是最舊的未認可交易) 開始
     
- **復原階段**

   使用 ADR 的復原階段可透過下列方式以幾乎瞬間的方式來完成：使用 sLog 來復原非版本控制的作業及具備邏輯還原的持續版本存放區 (PV)，來執行以版本為基礎的資料列層級復原。

## <a name="adr-recovery-components"></a>ADR 復原元件

ADR 的四個關鍵元件為：

- **持續版本存放區 (PV)**

  持續版本存放區是新的 SQL 資料庫引擎機制，可用來保存在資料庫本身而不是傳統 `tempdb` 版本存放區所產生的資料列版本。 PVS 會啟用資源隔離，以及改善可讀取之次要複本的可用性。

- **邏輯還原**

  邏輯還原是負責執行基於行級版本的撤銷的非同步過程 - 為所有版本化操作提供即時交易回復和撤銷。 邏輯還原通過以下功能完成：

  - 跟蹤所有中止的事務，並將其標記為其他事務不可見。 
  - 使用 PVS 對所有使用者事務執行回滾，而不是物理掃描事務日誌並撤銷一次更改一個。
  - 在事務中止後立即釋放所有鎖。 由於中止涉及在記憶體中標記更改，因此該過程非常有效，因此鎖不必長時間保持。

- **sLog**

  sLog 是一種次要的記憶體內部記錄串流，其儲存未建立版本作業的記錄檔記錄 (例如中繼資料快取無效判定、取得鎖定等)。 sLog 是：

  - 體積小並位於記憶體內部
  - 透過在檢查點處理序期間進行序列化來保存在磁碟上
  - 在交易認可時定期截斷
  - 透過只處理未建立版本的作業來加速重做和復原  
  - 透過只保留需要的記錄檔記錄來啟用積極性交易記錄截斷

- **清除工具**

  清除工具是一種非同步處理序，會定期喚醒並清理不需要的分頁版本。

## <a name="accelerated-database-recovery-patterns"></a>加速資料庫復原模式

以下類型的工作負載最受益于 ADR：

- 具有長時間運行事務的工作負載。
- 已看到活動事務導致事務日誌顯著增長的工作負載。  
- 由於 SQL Server 長時間運行恢復（如意外的 SQL Server 重新開機或手動交易回復），經歷了長時間資料庫不可用的工作負載。

