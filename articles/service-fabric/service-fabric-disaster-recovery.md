---
title: Azure 服務結構災害復原
description: Azure 服務結構提供了處理災難的功能。 本文說明可能會發生的災害類型以及如何加以處理。
author: masnider
ms.topic: conceptual
ms.date: 08/18/2017
ms.author: masnider
ms.openlocfilehash: b29985d40ae3a1bf582099e998e000fed83460f6
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/28/2020
ms.locfileid: "79371642"
---
# <a name="disaster-recovery-in-azure-service-fabric"></a>Azure Service Fabric 中的災害復原
提供高可用性的一個關鍵區段是確保服務能夠經受住所有不同類型的故障。 對於計畫外且無法控制的故障，這一點尤其重要。 

本文介紹了一些常見的故障模式，如果建模和管理不當，這些模式可能是災難。 它還討論了在發生災難時要採取的緩解措施和操作。 目標是在發生故障（計畫還是其他原因）時限制或消除停機或資料丟失的風險。

## <a name="avoiding-disaster"></a>避免災害
Azure Service Fabric 的主要目標是説明您對環境和服務建模，使常見故障類型不是災難。 

通常，有兩種類型的災難/失敗方案：
- 硬體和軟體錯誤
- 操作錯誤

### <a name="hardware-and-software-faults"></a>硬體和軟體錯誤
硬體和軟體錯誤是無法預期的。 生存故障的最簡單方法是跨硬體或軟體故障邊界運行更多的服務副本。 

例如，如果服務僅在一台電腦上運行，則該電腦的故障是該服務的災難。 避免此災難的簡單方法是確保服務在多台電腦上運行。 測試對於確保一台電腦的故障不會中斷正在運行的服務也是必需的。 容量規劃可確保可以在其他位置創建替換實例，並且容量減少不會使剩餘服務超載。 

無論您想避免的故障類型為何，相同的模式皆可發揮作用。 例如，如果您擔心 SAN 的失敗，則跨多個 SAN 運行。 如果您擔心伺服器機架損失，可跨多個機架執行。 如果您擔心資料中心丟失，則服務應跨多個 Azure 區域、多個 Azure 可用性區域或跨您自己的資料中心運行。 

當服務跨越多個物理實例（電腦、機架、資料中心、區域）時，您仍會同時發生故障。 但是，特定類型的單次甚至多次故障（例如，單個虛擬機器或網路鏈路失敗）將自動處理，因此不再是"災難"。 

Service Fabric 提供了擴展群集的機制，並處理將失敗的節點和服務帶回來。 Service Fabric 還允許運行服務的許多實例，以防止計畫外故障變成實際災難。

運行足夠大以跨越故障的部署可能有些原因不可行。 例如，相對於失敗的機會，它可能需要的硬體資源可能比您願意為之付出的要多。 處理分散式應用程式時，跨地理距離的其他通信躍點或狀態複製成本可能會導致不可接受的延遲。 每個應用程式繪製的此線條有所不同。 

對於軟體故障，故障可能位於您嘗試擴展的服務中。 在這種情況下，更多的副本無法預防災難，因為故障條件在所有實例中都相關。

### <a name="operational-faults"></a>操作錯誤
即使您的服務遍布全球，具備許多備援，仍可能會遇到災難性的事件。 例如，有人可能會意外重新佈建服務的 DNS 名稱，或將其徹底刪除。 

舉例來說，假設您的 Service Fabric 具狀態服務，而有人不小心刪除了該服務。 除非有其他緩解措施，否則該服務及其已有的所有狀態現在都消失了。 這些類型的操作災害 (「糟糕」情況) 恢復所需的緩解和步驟與一般未預期故障不同。 

避免這些類型的操作故障的最佳方法是：
- 限制對環境的操作訪問。
- 嚴格審核危險操作。
- 實施自動化，防止手動或帶外更改，並在實施之前針對環境驗證特定更改。
- 確保破壞性操作是"軟的"。 軟操作不會立即生效，或者可以在時間範圍內撤銷。

Service Fabric 提供了防止操作故障的機制，例如為群集操作提供[基於角色的](service-fabric-cluster-security-roles.md)存取控制。 不過，大部分的操作錯誤需要投入組織化的心力以及其他系統。 Service Fabric 確實為倖存的操作故障提供了機制，其中最引人注目的是[狀態服務的備份和恢復](service-fabric-backuprestoreservice-quickstart-azurecluster.md)。

## <a name="managing-failures"></a>管理故障
服務結構的目標是自動管理故障。 但是，要處理某些類型的故障，服務必須具有其他代碼。 出於安全和業務連續性原因，_不應_自動解決其他類型的故障。 

### <a name="handling-single-failures"></a>處理單一故障
單一機器可能鑒於各種原因而故障。 有時是硬體原因，如電源和網路硬體故障。 其他是軟體故障， 這些包括作業系統和服務本身的失敗。 Service Fabric 可自動檢測這些類型的故障，包括電腦由於網路問題而與其他電腦隔離的情況。

無論服務類型為何，如果程式碼的單一複本因故失敗，執行單一執行個體會造成該服務停機。 

要處理任何單個故障，最簡單的方法是確保服務預設在多個節點上運行。 對於無狀態服務，請確保`InstanceCount`大於 1。 對於有狀態服務，最低建議是 和`TargetReplicaSetSize``MinReplicaSetSize`都設置為 3。 執行服務程式碼的多個複本可確保您的服務可自動處理任何單一失敗。 

### <a name="handling-coordinated-failures"></a>處理協調失敗
群集中的協調故障可能是由於計畫內或計畫外基礎結構故障和更改，或計畫的軟體更改造成的。 Service Fabric 將遇到協調故障的基礎結構區域建模為*容錯域*。 將經歷協調軟體更改的區域建模為*升級域*。 有關容錯域、升級域和群集拓撲的詳細資訊，請參閱[使用群集資源管理器描述服務結構群集](service-fabric-cluster-resource-manager-cluster-description.md)。

預設情況下，在規劃服務應運行的位置時，Service Fabric 會考慮故障和升級域。 預設情況下，Service Fabric 會嘗試確保您的服務跨多個故障運行並升級域，以便在發生計畫內或計畫外更改時，服務保持可用狀態。 

例如，假設電源故障會導致機架上的所有電腦同時發生故障。 在運行多個服務副本時，故障域故障中許多電腦的丟失將變成服務單次故障的另一個示例。 這就是為什麼管理故障和升級域對於確保服務的高可用性至關重要。 

在 Azure 中運行服務結構時，將自動管理容錯域和升級域。 在其他環境中，它們可能不是。 如果要在本地構建自己的群集，請確保正確映射和規劃容錯域佈局。

升級域可用於同時升級軟體的建模區域。 因此，升級域還經常定義在計畫升級期間刪除軟體的邊界。 Service Fabric 和您的服務升級皆遵循相同的模型。 有關輪流升級、升級域和服務交換矩陣運行狀況模型的詳細資訊，這些模型有助於防止意外更改影響群集和服務，請參閱：

 - [應用程式升級](service-fabric-application-upgrade.md)
 - [應用程式升級教程](service-fabric-application-upgrade-tutorial.md)
 - [服務結構運行狀況模型](service-fabric-health-introduction.md)

您可以使用[服務結構資源管理器](service-fabric-visualizing-your-cluster.md)中提供的群集映射來視覺化群集的佈局：

<center>

![在服務結構資源管理器中跨容差域分佈的節點][sfx-cluster-map]
</center>

> [!NOTE]
> 建模故障區域、輪流升級、運行服務代碼和狀態的許多實例、確保服務跨故障和升級域運行的放置規則以及內置運行狀況監視只是 Service Fabric 為防止正常操作問題和故障演變為災難而提供的*一些*功能。 
>

### <a name="handling-simultaneous-hardware-or-software-failures"></a>處理同時發生的硬體或軟體故障
我們一直在談論單次失敗。 正如您所看到的，只需使更多的代碼（和狀態）副本跨容和升級域運行，就可以輕鬆處理無狀態和有狀態服務。 

也可能發生多個同時的隨機失敗。 這些更有可能導致停機或實際災難。


#### <a name="stateless-services"></a>無狀態服務
無狀態服務的實例計數指示需要運行的所需實例數。 當任何（或全部）實例失敗時，Service Fabric 會通過在其他節點上自動創建替換實例來回應。 Service Fabric 繼續創建替換，直到服務恢復其所需的實例計數。

例如，假設無狀態服務的值`InstanceCount`為 -1。 此值表示一個實例應在群集中的每個節點上運行。 如果其中一些實例失敗，Service Fabric 將檢測到服務未處於所需狀態，並將嘗試在缺少服務的節點上創建實例。

#### <a name="stateful-services"></a>有狀態的服務
有兩種類型的有狀態服務：
- 狀態與持久狀態。
- 狀態與非持久狀態。 （狀態存儲在記憶體中。

狀態服務故障的恢復取決於有狀態服務的類型、服務有多少副本以及有多少副本失敗。

在有狀態服務中，傳入資料在副本（主副本和任何活動輔助副本）之間複製。 如果大多數副本接收資料，則資料將被視為提交*仲裁*。 （對於五個副本，三個副本將是仲裁。這意味著在任何時候，至少有包含最新資料的複製副本的仲裁。 如果副本失敗（例如五分之二），我們可以使用仲裁值來計算是否可以恢復。 （由於五個副本中其餘三個副本仍然已打開，因此保證至少有一個副本具有完整的資料。

當副本的仲裁失敗時，分區將聲明為*仲裁丟失*狀態。 假設分區有五個副本，這意味著至少有三個副本保證具有完整的資料。 如果副本的仲裁（五分之三）失敗，Service Fabric 無法確定剩餘的副本（二分之五）是否有足夠的資料來還原分區。 在 Service Fabric 檢測到仲裁丟失的情況下，其預設行為是防止對分區進行其他寫入，聲明仲裁丟失，並等待還原副本的仲裁。

確定狀態服務是否發生災難，然後管理它遵循三個階段：

1. 確定是否存在仲裁損失。
   
   當狀態服務的大多數副本同時關閉時，將聲明仲裁丟失。
2. 確定仲裁損失是否永久。
   
   大多數時候，失敗是暫時性的。 進程重新開機，節點重新開機，虛擬機器重新開機，網路磁碟分割修復。 然而，有時失敗是永久性的。 故障是否永久取決於狀態服務是否保持其狀態，或者它是否僅保留在記憶體中： 
   
   - 對於非持續狀態的服務，單一仲裁或多個複本的失敗會_立即_導致永久性的仲裁遺失。 當 Service Fabric 偵測到具狀態非持續服務中的仲裁遺失時，會藉由宣告 (可能) 資料遺失，立即進行步驟 3。 繼續資料丟失是有道理的，因為 Service Fabric 知道等待副本回來沒有意義。 即使它們恢復，資料也會由於服務的非持久性而丟失。
   - 對於有狀態的持久服務，仲裁或更多副本的失敗會導致 Service Fabric 等待副本回來並還原仲裁。 這會導致任何_寫入_服務的受影響分割區 (複本集) 發生服務中斷。 但是，在降低一致性保證下，讀取可能仍是可能的。 Service Fabric 等待恢復仲裁的預設時間是*無限的*，因為繼續是（潛在）資料丟失事件，並會帶來其他風險。 這意味著，除非管理員採取措施聲明資料丟失，否則 Service Fabric 將不會繼續執行下一步。
3. 確定是否遺失資料，並從備份中還原。

   如果法定人數丟失已聲明（自動或通過管理操作），則 Service Fabric 和服務將繼續確定資料是否實際丟失。 此時，Service Fabric 也知道其他副本不會返回。 這是停止等待自行解決仲裁遺失時會作出的決定。 服務採用的最佳方法通常是凍結，並等待特定的管理介入處理。
   
   當 Service Fabric`OnDataLossAsync`調用 該方法時，總是因為_懷疑_資料丟失。 Service Fabric 可確保此呼叫會傳遞至_最佳_剩餘複本。 這是進度最多的複本。 
   
   我們總是說_可疑的_資料丟失的原因是，剩餘的副本可能具有與丟失仲裁時的主副本相同的狀態。 不過，如果沒有與其相比的狀態，Service Fabric 或運算子確實沒有好方法可用。     
   
   那麼，`OnDataLossAsync` 方法的典型做法是什麼？
   1. 已觸發的`OnDataLossAsync`實現日誌，並觸發任何必要的管理警報。
   1. 通常，實現會暫停並等待進一步決策和手動操作。 這是因為即使備份可用，它們也可能需要準備。 
   
      例如，如果兩個不同的服務協調資訊，則可能需要修改這些備份，以確保還原發生後，這兩個服務所關心的資訊是一致的。 
   1. 通常有一些其他遙測或耗盡的服務。 此中繼資料可能包含在其他服務或日誌中。 此資訊可以根據需要用於確定在主資料庫接收和處理的任何呼叫是否存在備份中或複製到此特定副本。 在還原可行之前，可能需要重播這些調用或添加到備份中。  
   1. 實現將剩餘副本的狀態與任何可用備份中包含的狀態進行比較。 如果您使用的是 Service Fabric 可靠的集合，則有可用於執行此操作[的工具和流程](service-fabric-reliable-services-backup-restore.md)。 目標是查看副本中的狀態是否足夠，並查看備份可能缺少的內容。
   1. 比較完成後，在還原完成後（如有必要），如果進行了任何狀態更改，服務代碼應返回**true。** 如果副本確定它是狀態的最佳可用副本，並且不進行任何更改，則代碼將返回**false**。 
   
      **值為 true**表示_任何其他_剩餘的副本現在可能與此副本不一致。 將會卸除這些複本，並從此複本重建。 **false**值表示未進行任何狀態更改，因此其他副本可以保留其擁有的內容。 

在將服務部署到生產中之前，服務作者必須練習潛在的資料丟失和失敗方案，這一點至關重要。 為了防止資料丟失的可能性，定期將任何有狀態服務[的狀態備份](service-fabric-reliable-services-backup-restore.md)到異地冗余存儲非常重要。 

您還必須確保能夠還原狀態。 由於許多不同的服務的備份是在不同時間進行的，因此您需要確保在還原後，服務具有彼此一致的視圖。 

例如，考慮一個服務生成數位並存儲它的情況，然後將其發送到另一個也存儲它的服務。 還原後，您可能會發現第二個服務具有編號，但第一個服務沒有，因為它的備份不包括該操作。

如果發現剩餘的副本不足以在資料丟失方案中繼續，並且無法從遙測或排氣中重建服務狀態，則備份頻率決定了最佳復原點目標 （RPO）。 Service Fabric 提供了許多用於測試各種故障方案的工具，包括需要從備份進行還原的永久仲裁和資料丟失。 這些方案包含在由故障分析服務管理的 Service Fabric 中可測試性工具的一部分。 有關這些工具和模式的詳細資訊，請參閱[故障分析服務簡介](service-fabric-testability-overview.md)。 

> [!NOTE]
> 系統服務也可能遭受仲裁損失。 影響特定于相關服務。 例如，命名服務中的仲裁丟失會影響名稱解析，而容錯移轉管理器 服務中的仲裁丟失會阻止新的服務創建和容錯移轉。 
> 
> Service Fabric 系統服務遵循與狀態管理服務相同的模式，但我們不建議您嘗試將它們從仲裁丟失中移出，並進入潛在的資料丟失。 相反，我們建議您[尋求支援](service-fabric-support.md)，以找到針對您情況的解決方案。 通常最好等到向下的副本返回。
>

#### <a name="troubleshooting-quorum-loss"></a>故障排除仲裁損失

副本可能會由於暫時性故障而間歇性地關閉。 等待一段時間，因為服務結構試圖提出他們。 如果副本已關閉超過預期持續時間，請按照以下故障排除操作操作操作：
- 副本可能正在崩潰。 檢查副本級運行狀況報告和應用程式日誌。 收集崩潰轉儲並採取必要的措施進行恢復。
- 副本進程可能已無回應。 檢查應用程式日誌以驗證此。 收集進程轉儲，然後停止無回應的進程。 Service Fabric 將創建一個替換過程，並嘗試將副本帶回來。
- 承載副本的節點可能已關閉。 重新開機基礎虛擬機器以啟動節點。

有時，可能無法恢復副本。 例如，磁碟機出現故障或電腦實際未回應。 在這些情況下，需要告訴 Service Fabric 不要等待副本恢復。

如果潛在的資料丟失是不可接受的，*請勿*使用這些方法使服務連線。 在這種情況下，應全力回收物理機器。

以下操作可能會導致資料丟失。 在跟隨它們之前，請檢查它們。
   
> [!NOTE]
> 使用這些方法_從來都不是_安全的，除了針對特定分區的定向方式。 
>

- 使用`Repair-ServiceFabricPartition -PartitionId`或`System.Fabric.FabricClient.ClusterManagementClient.RecoverPartitionAsync(Guid partitionId)`API。 此 API 允許指定分區的 ID 以擺脫仲裁損失並進入潛在的資料丟失。
- 如果您的群集經常遇到導致服務進入仲裁丟失狀態的故障，並且可能_遺失資料是可以接受的_，則指定適當的[仲裁LossWaitDuration值](https://docs.microsoft.com/powershell/module/servicefabric/update-servicefabricservice?view=azureservicefabricps)可以説明您的服務自動復原。 服務結構將等待提供`QuorumLossWaitDuration`的值（預設為無限），然後再執行恢復。 *我們不*推薦此方法，因為它可能會導致意外的資料丟失。

## <a name="availability-of-the-service-fabric-cluster"></a>Service Fabric 叢集的可用性
通常，Service Fabric 群集是一個高度分散式的環境，沒有單點故障。 任何一個節點的故障不會導致群集的可用性或可靠性問題，這主要是因為 Service Fabric 系統服務遵循了前面提供的相同準則。 也就是說，預設情況下，它們始終使用三個或更多副本運行，並且系統服務在所有節點上運行無狀態。 

基礎 Service Fabric 網路服務與失敗偵測層會完全分散。 大部分的系統服務可從叢集中的中繼資料重建，或了解如何從其他地方重新同步處理其狀態。 如果系統服務進入仲裁丟失情況，如前面所述的情況，群集的可用性可能會受到影響。 在這些情況下，可能無法對群集執行某些操作（如啟動升級或部署新服務），但群集本身仍處於打開。 

正在運行的群集上的服務將在這些條件下繼續運行，除非它們需要寫入系統服務才能繼續運行。 例如，如果容錯移轉管理器處於仲裁丟失狀態，則所有服務將繼續運行。 但是，任何失敗的服務都無法自動重新開機，因為這需要容錯移轉管理器的參與。 

### <a name="failures-of-a-datacenter-or-an-azure-region"></a>資料中心或 Azure 區域的失敗
在極少數情況下，物理資料中心可能會因斷電或網路連接中斷而暫時不可用。 在這些情況下，在資料中心或 Azure 區域中的 Service Fabric 叢集和服務將無法使用。 不過，_您的資料會保留下來_。 

對於在 Azure 中執行的叢集，您可以在 [Azure 狀態頁面][azure-status-dashboard]上檢視中斷的更新。 如果物理資料中心被部分或完全銷毀，則託管在那裡的任何 Service Fabric 群集或其中的服務可能會丟失。 此丟失包括未在該資料中心或區域外部備份的任何狀態。

在單個資料中心或區域的永久或持續故障中生存有兩種不同的策略： 

- 在多個這樣的區域中運行單獨的 Service Fabric 群集，並使用某些機制在這些環境之間進行容錯移轉和容錯移轉。 這種多群集主動/主動或主動/被動模型需要額外的管理和操作代碼。 此模型還需要協調來自一個資料中心或區域中的服務的備份，以便在發生故障時在其他資料中心或區域中提供備份。 
- 執行跨越多個資料中心或區域的單一 Service Fabric 叢集。 此策略受支援的最小配置是三個資料中心或區域。 建議的區域或資料中心數目為五個。 
  
  此模型需要更複雜的群集拓撲。 但是，好處是一個資料中心或區域的故障從災難轉換為正常故障。 可藉由在單一區域內為叢集運作的機制來處理這些失敗。 故障域、升級域和服務交換矩陣放置規則可確保分發工作負載，以便它們能夠容忍正常故障。 
  
  有關可説明在此類群集中操作服務的策略的詳細資訊，請參閱[服務交換矩陣服務的放置策略](service-fabric-cluster-resource-manager-advanced-placement-rules-placement-policies.md)。

### <a name="random-failures-that-lead-to-cluster-failures"></a>導致群集故障的隨機故障
服務結構具有*種子節點*的概念。 種子節點是維護基礎叢集可用性的節點。 

種子節點通過與其他節點建立租約並在某些類型的故障期間充當綁定中斷器，有助於確保群集保持保持狀態。 如果隨機故障刪除了群集中的大部分種子節點，並且它們未快速恢復，則群集將自動關閉。 群集然後失敗。 

在 Azure 中，服務結構資來源提供者管理服務結構群集配置。 預設情況下，資來源提供者在*主節點類型的*故障和升級域之間分發種子節點。 如果主節點類型標記為 Silver 或 Gold 持久性，則當您刪除種子節點（通過在主節點類型中縮放或手動刪除它），群集將嘗試從主節點類型的可用容量升級另一個非種子節點。 如果可用容量低於主節點類型所需的群集可靠性級別，則此嘗試將失敗。

在獨立的 Service Fabric 群集和 Azure 中，主節點類型是運行種子的節點類型。 定義主節點類型時，Service Fabric 將自動利用每個系統服務的最多 9 個種子節點和 7 個副本提供的節點數。 如果一組隨機故障同時獲取了這些副本中的大多數，則系統服務將進入仲裁丟失。 如果大多數種子節點遺失，叢集將在不久後關閉。

## <a name="next-steps"></a>後續步驟
- 瞭解如何使用[可測試性框架](service-fabric-testability-overview.md)類比各種故障。
- 閱讀其他災害復原和高可用性的資源。 Microsoft 已發佈大量有關這些主題的指引。 儘管其中一些資源是指用於其他產品的特定技術，但它們包含許多可在 Service Fabric 上下文中應用的一般最佳實踐：
  - [可用性檢查表](/azure/architecture/checklist/resiliency-per-service)
  - [執行災害復原演練](../sql-database/sql-database-disaster-recovery-drills.md)
  - [Azure 應用程式的災害復原和高可用性][dr-ha-guide]
- 了解 [Service Fabric 支援選項](service-fabric-support.md)。


<!-- External links -->

[repair-partition-ps]: https://msdn.microsoft.com/library/mt163522.aspx
[azure-status-dashboard]:https://azure.microsoft.com/status/
[azure-regions]: https://azure.microsoft.com/regions/
[dr-ha-guide]: https://msdn.microsoft.com/library/azure/dn251004.aspx


<!-- Images -->

[sfx-cluster-map]: ./media/service-fabric-disaster-recovery/sfx-clustermap.png
