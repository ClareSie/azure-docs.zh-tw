---
title: 應用程式閘道的 Azure 監視器計量
description: 瞭解如何使用計量來監視應用程式閘道的效能
services: application-gateway
author: surajmb
ms.service: application-gateway
ms.topic: article
ms.date: 06/06/2020
ms.author: surmb
ms.openlocfilehash: be629d9f8441ad40fe15f005f4aeb0ec5565a7ec
ms.sourcegitcommit: 5e5a0abe60803704cf8afd407784a1c9469e545f
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 12/01/2020
ms.locfileid: "96437060"
---
# <a name="metrics-for-application-gateway"></a>應用程式閘道的計量

應用程式閘道會將資料點（稱為計量）發佈至 [Azure 監視器](../azure-monitor/overview.md) ，以取得應用程式閘道和後端實例的效能。 這些計量是時間序列資料的排序集合中的數值，可在特定時間描述應用程式閘道的某個方面。 如果有要求流經應用程式閘道，則會以60秒的間隔來測量和傳送其度量。 如果沒有任何要求流經應用程式閘道，或沒有計量的資料，則不會報告度量。 如需詳細資訊，請參閱 [Azure 監視器計量](../azure-monitor/platform/data-platform-metrics.md)。

## <a name="metrics-supported-by-application-gateway-v2-sku"></a>應用程式閘道 V2 SKU 支援的計量

### <a name="timing-metrics"></a>計時計量

應用程式閘道提供數個與要求和回應相關的內建計時計量，這些計量全都以毫秒為單位來測量。 

![應用程式閘道的計時計量圖表。](./media/application-gateway-metrics/application-gateway-metrics.png)

> [!NOTE]
>
> 如果應用程式閘道中有一個以上的接聽程式，則在比較不同 *的延遲* 計量時，一律會依接聽程式維度篩選，以便取得有意義的推斷。

- **後端連線時間**

  建立與後端應用程式的連接所花費的時間。 

  這包括網路延遲，以及後端伺服器的 TCP 堆疊建立新連線所花費的時間。 如果是 TLS，則會包含交握時所花費的時間。 

- **後端第一個位元組回應時間**

  開始建立與後端伺服器之間的連接，以及接收回應標頭的第一個位元組之間的時間間隔。 

  這大約是 *後端連線時間* 的總和，要求從應用程式閘道抵達後端所花費的時間、後端應用程式回應 (伺服器花在產生內容的時間、可能會提取資料庫查詢) ，以及從後端到達應用程式閘道的回應第一個位元組所花的時間。

- **後端最後一個位元組回應時間**

  開始建立與後端伺服器之間的連線，並接收回應主體的最後一個位元組之間的時間間隔。 

  這近似於下列時間的總和：「後端第一個位元組回應時間」和資料傳輸時間 (因為所要求的物件大小和伺服器網路的延遲不同，此數目可能會有極大的差異)。

- **應用程式閘道總時間**

  接收、處理要求以及傳送回應所需的平均時間。 

  這是來自應用程式閘道接收 HTTP 要求的第一個位元組到最後一個回應位元組傳送給用戶端的時間的間隔。 這包括應用程式閘道所花費的處理時間、 *後端最後位元組回應時間*、應用程式閘道傳送所有回應和 *用戶端 RTT* 所花費的時間。

- **用戶端 RTT**

  用戶端與應用程式閘道之間的平均來回行程時間。



您可以使用這些計量來判斷觀察到的速度是否因用戶端網路、應用程式閘道效能、後端網路和後端伺服器 TCP 堆疊飽和、後端應用程式效能或大型檔案大小所造成。

例如，如果 *後端第一個位元組回應時間* 趨勢的尖峰，但 *後端連線時間* 趨勢穩定，則可以推斷出應用程式閘道到後端的延遲，以及建立連線所需的時間是穩定的，且尖峰是因為後端應用程式的回應時間增加所造成。 另一方面，如果 *後端第一個位元組回應時間* 的尖峰與 *後端連線時間* 的相對應尖峰相關聯，則可以推算出應用程式閘道與後端伺服器之間的網路或後端伺服器 TCP 堆疊之間有飽和。 

如果您注意到 *後端最後一個位元組回應時間* 突然增加，但 *後端第一個位元組回應時間* 是穩定的，則可以推算尖峰原因是要求的檔案較大。

同樣地，如果 *應用程式閘道總時間* 具有尖峰，但 *後端最後一個位元組回應時間* 是穩定的，則可能是應用程式閘道上的效能瓶頸，或用戶端與應用程式閘道之間的網路瓶頸。 此外，如果 *用戶端 RTT* 也有對應的尖峰，則表示效能降低的原因是用戶端與應用程式閘道之間的網路。

### <a name="application-gateway-metrics"></a>應用程式閘道計量

應用程式閘道可使用下列計量：

- **接收的位元組數**

   應用程式閘道從用戶端接收的位元組計數

- **傳送位元組數**

   應用程式閘道傳送給用戶端的位元組計數

- **用戶端 TLS 通訊協定**

   建立與應用程式閘道連線的用戶端所起始的 TLS 和非 TLS 要求計數。 若要查看 TLS 通訊協定分佈，請依維度 TLS 通訊協定篩選。

- **目前的容量單位**

   對流量進行負載平衡所耗用的容量單位元數目。 容量單位有三個強硬-計算單位、持續連線和輸送量。 每個容量單位最多包含：1 個「計算單位」或 2500 個「持續連線數」，或 2.22-Mbps 的「輸送量」。

- **目前的計算單位**

   耗用的處理器容量計數。 影響計算單位的因素包括 TLS 連線數/秒、URL 重寫計算，以及 WAF 規則處理。 

- **目前的連線數**

   從用戶端到應用程式閘道的並行連接總數
   
- **預估計費容量單位**

  若使用 v2 SKU，則計價模式會以耗用量來驅動。 容量單位會測量固定成本和以耗用量計費的成本。 *預估的計費容量單位* 表示用來預估計費的容量單位數目。 這會以「目前容量單位數」(對流量進行負載平衡所需的容量單位) 和「固定計費容量單位」(持續佈建的最小容量單位) 之間的較大值進行計算。

- **失敗的要求**

  應用程式閘道提供5xx 伺服器錯誤碼的要求數目。 這包括從應用程式閘道產生的5xx 程式碼，以及從後端產生的5xx 代碼。 您可以進一步篩選要求計數，以顯示每個/特定後端集區的計數-HTTP 設定組合。
   
- **固定計費容量單位**

  持續佈建的最小容量單位數目，其以應用程式閘道組態中 *最小縮放單位* 設定 (一個執行個體轉譯為 10 個容量單位) 為依據。
   
 - **每秒新的連接數**

   每秒從用戶端至應用程式閘道，以及從應用程式閘道到後端成員建立的平均新 TCP 連線數。


- **回應狀態**

   應用程式閘道傳回的 HTTP 回應狀態。 回應狀態碼發佈可以進一步分類，以顯示回應 2xx、3xx、4xx 和 5xx 分類中的回應。

- **輸送量**

   應用程式閘道每秒已服務的位元組數目

- **要求總數**

   應用程式閘道已提供成功要求的計數。 您可以進一步篩選要求計數，以顯示每個/特定後端集區的計數-HTTP 設定組合。

### <a name="backend-metrics"></a>後端計量

應用程式閘道可使用下列計量：

- **後端回應狀態**

  後端傳回的 HTTP 回應狀態碼的計數。 這不包括應用程式閘道所產生的任何回應碼。 回應狀態碼發佈可以進一步分類，以顯示回應 2xx、3xx、4xx 和 5xx 分類中的回應。

- **狀況良好的主機計數**

  健康情況探查所判斷狀況良好的後端數目。 您可以篩選每個後端集區，以顯示特定後端集區中狀況良好的主機數目。

- **狀況不良的主機計數**

  健康情況探查所判斷狀況不良的後端數目。 您可以篩選每個後端集區，以顯示特定後端集區中狀況不良的主機數目。
  
- **每個健康情況主機每分鐘的要求**

  後端集區中每個狀況良好成員接收的平均要求數（以分鐘為單位）。 您必須使用 *BackendPool HTTPsettings)* 維度來指定後端集區。  
  

## <a name="metrics-supported-by-application-gateway-v1-sku"></a>應用程式閘道 V1 SKU 支援的計量

### <a name="application-gateway-metrics"></a>應用程式閘道計量

應用程式閘道可使用下列計量：

- **CPU 使用率**

  顯示配置給應用程式閘道的 CPU 使用率。  在正常情況下，CPU 使用量不應經常超過 90%，因為這可能會導致應用程式閘道背後的網站中出現延遲，並且會中斷用戶端體驗。 您可以藉由增加執行個體計數或移至較大的 SKU 大小 (或同時執行這兩種方式) 來修改應用程式閘道的設定，以間接控制或改善 CPU 使用率。

- **目前的連接**

  目前與應用程式閘道建立的連線計數

- **失敗的要求**

  由於連接問題而失敗的要求數目。 此計數包含因為超過「要求超時」 HTTP 設定和因為應用程式閘道與後端之間的連線問題而失敗的要求而失敗的要求。 因為沒有狀況良好的後端可用，所以此計數不包括失敗。 來自後端的4xx 和5xx 回應也不會被視為此計量的一部分。

- **回應狀態**

  應用程式閘道傳回的 HTTP 回應狀態。 回應狀態碼發佈可以進一步分類，以顯示回應 2xx、3xx、4xx 和 5xx 分類中的回應。

- **輸送量**

  應用程式閘道每秒已服務的位元組數目

- **要求總數**

  應用程式閘道已提供成功要求的計數。 您可以進一步篩選要求計數，以顯示每個/特定後端集區的計數-HTTP 設定組合。

- **Web 應用程式防火牆封鎖的要求計數**
- **Web 應用程式防火牆封鎖的要求散發**
- **Web 應用程式防火牆的規則散發總計**

### <a name="backend-metrics"></a>後端計量

應用程式閘道可使用下列計量：

- **狀況良好的主機計數**

  健康情況探查所判斷狀況良好的後端數目。 您可以篩選每個後端集區，以顯示特定後端集區中狀況良好的主機數目。

- **狀況不良的主機計數**

  健康情況探查所判斷狀況不良的後端數目。 您可以篩選每個後端集區，以顯示特定後端集區中狀況不良的主機數目。

## <a name="metrics-visualization"></a>計量視覺效果

流覽至應用程式閘道，在 [ **監視** 選取的 **計量**] 底下。 若要檢視可用的值，請選取 [計量] 下拉式清單。

下圖中的範例顯示了最近 30 分鐘內的三項計量：

:::image type="content" source="media/application-gateway-diagnostics/figure5.png" alt-text="度量視圖。" lightbox="media/application-gateway-diagnostics/figure5-lb.png":::

若要查看最新的度量清單，請參閱[支援 Azure Monitor 的計量](../azure-monitor/platform/metrics-supported.md)。

### <a name="alert-rules-on-metrics"></a>計量的警示規則

您可以根據資源的計量來啟動警示規則。 例如，如果應用程式閘道的輸送量高於、低於或等於臨界值達到一段指定時間，警示便可以呼叫 Webhook 或寄送電子郵件給系統管理員。

下列範例會逐步引導您建立警示規則，以在輸送量達到臨界值之後傳送電子郵件給系統管理員：

1. 選取 [ **新增度量警示** ] 以開啟 [ **新增規則** ] 頁面。 您也可以從 [計量] 頁面連接到此頁面。

   ![新增計量警示按鈕][6]

2. 在 [ **新增規則** ] 頁面上，填寫 [名稱]、[條件] 和 [通知] 區段，然後選取 **[確定]**。

   * 在 [條件] 選取器中，選取這 4 個值之一：[大於]、[大於或等於]、[小於] 或 [小於或等於]。

   * 在 [期間] 選取器中，選取 5 分鐘到 6 小時的期間。

   * 如果選取 [傳送電子郵件給擁有者、參與者和讀者]，便可根據可存取該資源的使用者動態傳送電子郵件。 否則，您可以在 [其他系統管理員電子郵件] 方塊中提供以逗號分隔的使用者清單。

   ![新增規則頁面][7]

如果達到臨界值，送達的電子郵件會類似下圖︰

![違反臨界值的電子郵件][8]

建立計量警示之後，就會出現警示的清單， 其中提供所有警示規則的概觀。

![警示和規則的清單][9]

若要深入了解警示通知，請參閱[接收警示通知](../azure-monitor/platform/alerts-overview.md)。

若要深入瞭解 webhook 以及如何將其與警示搭配使用，請造訪 [設定 Azure 計量警示的 webhook](../azure-monitor/platform/alerts-webhooks.md)。

## <a name="next-steps"></a>後續步驟

* 利用 [Azure 監視器記錄](../azure-monitor/insights/azure-networking-analytics.md)將計數器和事件記錄視覺化。
* [將您的 Azure 活動記錄檔視覺化 Power BI 的](https://powerbi.microsoft.com/blog/monitor-azure-audit-logs-with-power-bi/) blog 文章。
* [在 Power BI 和其他工具中檢視和分析 Azure 活動記錄](https://azure.microsoft.com/blog/analyze-azure-audit-logs-in-powerbi-more/)部落格文章。

[1]: ./media/application-gateway-diagnostics/figure1.png
[2]: ./media/application-gateway-diagnostics/figure2.png
[3]: ./media/application-gateway-diagnostics/figure3.png
[4]: ./media/application-gateway-diagnostics/figure4.png
[5]: ./media/application-gateway-diagnostics/figure5.png
[6]: ./media/application-gateway-diagnostics/figure6.png
[7]: ./media/application-gateway-diagnostics/figure7.png
[8]: ./media/application-gateway-diagnostics/figure8.png
[9]: ./media/application-gateway-diagnostics/figure9.png
[10]: ./media/application-gateway-diagnostics/figure10.png