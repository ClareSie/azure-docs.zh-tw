---
title: 使用 Azure 流分析進行地理圍欄和地理空間聚合
description: 本文介紹如何使用 Azure 流分析進行地理圍欄和地理空間聚合。
author: mamccrea
ms.author: mamccrea
ms.service: stream-analytics
ms.topic: conceptual
ms.date: 04/02/2019
ms.openlocfilehash: 5a3aa3786469c3df37b53cb82bdd396871689297
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/27/2020
ms.locfileid: "75443647"
---
# <a name="geofencing-and-geospatial-aggregation-scenarios-with-azure-stream-analytics"></a>使用 Azure 流分析進行地理圍欄和地理空間聚合方案

借助內置的地理空間功能，可以使用 Azure 流分析為車隊管理、行駛共用、互聯汽車和資產跟蹤等方案構建應用程式。

## <a name="geofencing"></a>地理柵欄

Azure 流分析支援雲和 IoT Edge 運行時的低延遲即時地理圍欄計算。

### <a name="geofencing-scenario"></a>地理圍欄方案

製造公司需要跟蹤其建築物上的資產。 他們為每個設備配備 GPS，並希望接收通知，如果設備離開某個區域。

此示例中使用的參考資料具有建築物和每個建築物中允許的設備的地理圍欄資訊。 請記住，參考資料可以是靜態的，也可以是緩慢更改。 靜態參考資料用於此方案。 資料流程持續發出裝置識別碼 及其當前位置。

### <a name="define-geofences-in-reference-data"></a>在參考資料中定義地理圍欄

可以使用 GeoJSON 物件定義地理圍欄。 對於相容性版本 1.2 和更高的作業，也可以使用已知文本 （WKT） 將地理圍欄定義為`NVARCHAR(MAX)`。 WKT 是開放地理空間聯盟 （OGC） 標準，用於以文本格式表示空間資料。

內置地理空間函數可以使用定義的地理圍欄來找出元素是進入還是退出特定的地理圍欄多邊形。

下表是可存儲在 Azure Blob 存儲或 Azure SQL 表中的地理圍欄參考資料的示例。 每個網站都由地理空間多邊形表示，並且每個設備都與允許的網站 ID 相關聯。

|網站 ID|SiteName|地理圍欄|允許的設備ID|
|------|--------|--------|---------------|
|1|"雷德蒙德大廈 41"|"POLYGON（122.133757922017 47.63782993298329433042778369 47634777935，122.1334677771300233447.63764 2022530954，-122.13348902897235 47.637508280806806806，-122.13361775006 47.6375082808066806，122.133612058703030647.63732393354484,-122.13265754417773 47.63730947490855,-122.13266290859576 47.637519124743164,-122.13302232460376 47.637515510097955,-122.13301696018573 47.63764925180358,-122.13272728161212 47.63764925180358,-122.1327487392842447.63784082716388,-122.13373579220172 47.63782998329432))"|"B"|
|2|"雷德蒙德大廈 40"|"POLYGON（（-122.133615507967 47.636745947009，-122.133610086378677 47.636483015064535，122.13349206918201 47.636477 9400347675，-122.13349743360004 47.63636372927573，-122.13372810357532 47.636363729275733333547.63617576323771,-122.13263912671528 47.63616491902258,-122.13264985555134 47.63635649982525,-122.13304682248554 47.636367344000604,-122.13305218690357 47.63650831807564,-122.13276250832996 47.636497473929516,-122.1327732371660247.63668543881025,-122.1336154507967 47.6366745947009))"|"A"|
|3|"雷德蒙德大廈22號"|"POLYGON（（122.13611660248233 47.6375554469854，-122.13635263687564 47.6374083293018，-122.13622389084293 47.637333347.637333 3603619712，-122.13622389084293 47.63717699101473，-122.1358161919507266 47.6369275827657，12.13559625334447.637046862778135,-122.13569281345798 47.637144458985965,-122.13570890671207 47.637314348246214,-122.13611660248233 47.63758544698554))"|"C"|

### <a name="generate-alerts-with-geofence"></a>使用地理圍欄生成警報

設備每分鐘可以通過稱為`DeviceStreamInput`的流發出其 ID 和位置。 下表是輸入流。

|裝置識別碼|地理位置|
|--------|-----------|
|"A"|"點（-122.13292341559497 47.636318374032726）"|
|"B"|"點（-122.13338475554553 47.63743531308874）|
|"C"|"點（-122.13354001095752 47.6362762250507）"|

可以編寫一個查詢，將設備流與地理圍欄參考資料聯接，並在設備位於允許的建築物之外時生成警報。

```SQL
SELECT DeviceStreamInput.DeviceID, SiteReferenceInput.SiteID, SiteReferenceInput.SiteName 
INTO Output
FROM DeviceStreamInput 
JOIN SiteReferenceInput
ON st_within(DeviceStreamInput.GeoPosition, SiteReferenceInput.Geofence) = 0
WHERE DeviceStreamInput.DeviceID = SiteReferenceInput.AllowedDeviceID
```

下圖表示地理圍欄。 您可以看到設備與流資料輸入的一致位置。

![建築地理圍欄](./media/geospatial-scenarios/building-geofences.png)

設備"C"位於建築 ID 2 內，根據參考資料不允許使用。 此設備應位於大樓 ID 3 內。 運行此作業將針對此特定衝突生成警報。

### <a name="site-with-multiple-allowed-devices"></a>具有多個允許設備的網站

如果網站允許多個設備，則可以在 中`AllowedDeviceID`定義裝置識別碼 陣列，並且可以在`WHERE`子句上使用使用者定義的函數來驗證流裝置識別碼 是否與該清單中的任何裝置識別碼 匹配。 有關詳細資訊，請查看雲作業的[JAVAscript UDF](stream-analytics-javascript-user-defined-functions.md)教程和邊緣作業的[C# UDF](stream-analytics-edge-csharp-udf.md)教程。

## <a name="geospatial-aggregation"></a>地理空間聚合

Azure 流分析支援雲中的低延遲即時地理空間聚合和 IoT 邊緣運行時。

### <a name="geospatial-aggregation-scenario"></a>地理空間聚合方案

一家計程車公司希望構建一個即時應用程式，以指導其計程車司機向目前需求較高的城市方向乘車。

公司將城市的邏輯區域存儲為參考資料。 每個區域由區域 ID、區功能變數名稱稱和地理圍欄定義。

### <a name="define-the-geofences"></a>定義地理圍欄

下表是可存儲在 Azure Blob 存儲或 Azure SQL 表中的地理圍欄參考資料的示例。 每個區域都由地理空間多邊形表示，該面用於與來自流資料的請求相關聯。

這些多邊形僅供參考，不表示實際的城市邏輯或物理分離。

|RegionID|RegionName|地理圍欄|
|--------|----------|--------|
|1|"SoHo"|"POLYGON（-74.00279525078275 40.7283625216264，-74.0054774597 9765 40.721929158663244，-74.00125029839018 40.71893680218 994，-73.9957785919998 40.72521409075776，-73.997277137039 40.72557184584898，-74.00279525078275 40.72833625216264）)"|
|2|"唐人街"|"POLYGON（-73.99712367114876 40.71281582267133，-73.990170123658 40.713368819936，-73.9902355583951 40.71452 359088633，-73.98976368961189 40.71554823078944，-73.99551444573982 40.71337726783735，-73.9948062422559940.718491949759304,-73.99652285632942 40.719109951574,-73.99776740131233 40.7168005470334,-73.99903340396736 40.71727219249899,-74.00193018970344 40.71938642421256,-74.00409741458748 40.71688186545551,-74.0005139833435840.71517415773184,-74.0004281526551 40.714377212470005,-73.99849696216438 40.713450141693166,-73.99748845157478 40.71405192594819,-73.99712367114876 40.71281582267133))"|
|3|"特裡貝卡"|"POLYGON（-74.0109161815208 40.7258312006787，-74.01338405044578 40.714365636362705，-74.01370591552757 40.71336 17702123415，-74.00862044723533 40.71130810708107235，-74.00194711228 40.7194238654018，74.010916164181520840.72583120006787))"|

### <a name="aggregate-data-over-a-window-of-time"></a>在時間視窗聚合資料

下表包含"rides"的流資料。

|UserID|從位置|ToLocation|行程請求時間|
|------|------------|----------|-----------------|
|"A"|"點（-74.00726861389182 40.71610611981975）"|"點（-73.98615095917779 40.703107386025835）"|"2019-03-12T07：00：00Z"|
|"B"|"點（-74.00249841021645 40.7238223895666）"|"點（-74.0116069942085 40.71378884930115）|"2019-03-12T07：01：00Z"|
|"C"|"點（-73.99680120565864 40.71643988624024）"|"點（-73.98289663412544 40.72582343969828）"|"2019-03-12T07：02：00Z"|
|"D"|"點（-74.00741090068288 40.7161562675086）|"點（-73.97999843120539 40.73477895807408）|"2019-03-12T07：03：00Z"|

以下查詢將設備流與地理圍欄參考資料聯接，並計算每分鐘 15 分鐘的時間視窗上每個區域的請求數。

```SQL
SELECT count(*) as NumberOfRequests, RegionsRefDataInput.RegionName 
FROM UserRequestStreamDataInput
JOIN RegionsRefDataInput 
ON st_within(UserRequestStreamDataInput.FromLocation, RegionsRefDataInput.Geofence) = 1
GROUP BY RegionsRefDataInput.RegionName, hoppingwindow(minute, 1, 15)
```

此查詢按城市內每個區域的最後 15 分鐘每分鐘輸出一個請求計數。 此資訊可通過 Power BI 儀表板輕鬆顯示，或者通過與 Azure 函數等服務集成，作為 SMS 文本消息廣播給所有驅動程式。

下圖說明瞭對 Power BI 儀表板的查詢輸出。 

![Power BI 儀表板上的結果輸出](./media/geospatial-scenarios/power-bi-output.png)


## <a name="next-steps"></a>後續步驟

* [串流分析地理空間函式簡介](stream-analytics-geospatial-functions.md)
* [地理空間功能（Azure 流分析）](https://docs.microsoft.com/stream-analytics-query/geospatial-functions)
