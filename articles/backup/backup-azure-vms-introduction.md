---
title: 關於 Azure VM 備份
description: 在本文中，瞭解 Azure 備份服務如何備份 Azure 虛擬機器，以及如何遵循最佳做法。
ms.topic: conceptual
ms.date: 09/13/2019
ms.openlocfilehash: f4b36f57362607a13c09896cd7109596aba0a852
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/28/2020
ms.locfileid: "79415971"
---
# <a name="an-overview-of-azure-vm-backup"></a>Azure VM 備份概述

本文介紹 Azure[備份服務](backup-introduction-to-azure-backup.md)如何備份 Azure 虛擬機器 （VM）。

Azure 備份提供獨立和隔離的備份，以防止 VM 上資料的意外破壞。 備份會儲存在復原服務保存庫中，並進行內建的復原點管理。 配置和縮放非常簡單，備份經過優化，您可以根據需要輕鬆進行還原。

作為備份過程的一部分，[將拍攝快照](#snapshot-creation)，並將資料傳輸到恢復服務保存庫，不會影響生產工作負載。 快照提供不同級別的一致性，[如下所述](#snapshot-consistency)。

Azure 備份還為資料庫工作負載（如[SQL Server](backup-azure-sql-database.md)和[SAP HANA）](sap-hana-db-about.md)提供專用產品，這些工作負載具有工作負載感知性，提供 15 分鐘的 RPO（復原點目標），並允許備份和還原各個資料庫。

## <a name="backup-process"></a>備份程序

以下是 Azure 備份如何完成 Azure VM 的備份：

1. 對於選擇備份的 Azure VM，Azure 備份會根據指定的備份計畫啟動備份作業。
1. 在第一次備份期間，如果 VM 正在運行，則 VM 上將安裝備份擴展。
    - 對於 Windows VM，將安裝[VMSnapshot 擴展](https://docs.microsoft.com/azure/virtual-machines/extensions/vmsnapshot-windows)。
    - 對於 Linux VM，將安裝[VMSnapshotLinux 擴展](https://docs.microsoft.com/azure/virtual-machines/extensions/vmsnapshot-linux)。
1. 對於正在運行的 Windows VM，備份與 Windows 卷卷卷卷複製服務 （VSS） 協調以獲取 VM 的應用一致的快照。
    - 預設情況下，備份需要完整的 VSS 備份。
    - 如果 Backup 無法獲取應用一致的快照，則它會獲取基礎存儲的檔一致性快照（因為在停止 VM 時不會執行任何應用程式寫入）。
1. 對於 Linux VM，備份需要檔一致的備份。 對於應用一致的快照，您需要手動自訂預/後腳本。
1. 備份拍攝快照後，它將資料傳輸到保存庫。
    - 通過並行備份每個 VM 磁片，優化備份。
    - 對於正在備份的每個磁片，Azure 備份讀取磁片上的塊，僅標識和傳輸自上次備份以來更改的資料塊（增量）。
    - 快照集資料可能不會立即複製到保存庫。 這在尖峰時間可能需耗費數小時。 對於每日備份策略，VM 的總備份時間將少於 24 小時。
1. 啟用 Azure 備份後對 Windows VM 所做的更改包括：
    - Microsoft Visual C++ 2013 可分發 （x64） - 12.0.40660 安裝在 VM 中
    - 卷影影複製服務 （VSS） 的啟動類型從手動更改為自動
    - 添加了 IaaSVm 提供程式視窗服務

1. 資料傳輸完成後，將刪除快照，並創建復原點。

![Azure 虛擬機器備份架構](./media/backup-azure-vms-introduction/vmbackup-architecture.png)

## <a name="encryption-of-azure-vm-backups"></a>Azure VM 備份的加密

當您使用 Azure 備份來備份 Azure VM 時，VM 會透過儲存體服務加密 (SSE) 來執行待用加密。 Azure 備份還可以備份使用 Azure 磁片加密加密的 Azure VM。

[加密]**** | **詳細資料** | **支援**
--- | --- | ---
**Azure 磁片加密** | Azure 磁片加密對 Azure VM 的作業系統和資料磁片進行加密。<br/><br/> Azure 磁片加密與 BitLocker 加密金鑰 （BEK） 集成，這些金鑰在金鑰保存庫中作為機密進行保護。 Azure 磁片加密還與 Azure 金鑰保存庫金鑰加密金鑰 （KEK） 集成。 | Azure 備份支援僅使用 BEK 加密的託管和非託管 Azure VM 的備份，或使用貝克與 KE 一起備份。<br/><br/> 貝克和KEK都得到備份和加密。<br/><br/> 由於 KEK 和 BEK 已備份，因此具有必要許可權的使用者可以根據需要將金鑰和機密還原回金鑰保存庫。 這些使用者還可以恢復加密的 VM。<br/><br/> 未經授權的使用者或 Azure 無法讀取加密金鑰和機密。
**SSE** | 使用 SSE，Azure 存儲通過在存儲資料之前自動加密資料來提供靜態加密。 Azure 存儲還會在檢索資料之前解密資料。 | Azure 備份使用 SSE 對 Azure VM 進行靜態加密。

對於託管和非託管 Azure VM，備份支援僅使用 BEK 加密的 VM，或使用 KS 與 KE 一起加密的 VM。

備份的 BEK（機密）和 KEK（金鑰）已加密。 僅當授權使用者將其還原回金鑰保存庫時，才能讀取和使用它們。 未經授權的使用者或 Azure 都不能讀取或使用備份金鑰或機密。

BEK 也得到備份。 因此，如果 BEK 丟失，授權使用者可以將 BEK 還原到金鑰保存庫並恢復加密的 VM。 只有具有必要權限等級的使用者可以備份和還原加密的 VM 或金鑰和機密。

## <a name="snapshot-creation"></a>建立快照集

Azure 備份根據備份計畫拍攝快照。

- **Windows VM：** 對於 Windows VM，備份服務與 VSS 協調，以拍攝 VM 磁片的應用一致的快照。  預設情況下，Azure 備份需要完整的 VSS 備份（它在備份時會截取應用程式日誌，如 SQL Server，以獲得應用程式級別的一致備份）。  如果在 Azure VM 備份上使用 SQL Server 資料庫，則可以修改設置以執行 VSS 複本備份（以保留日誌）。 如需詳細資訊，請參閱 [本篇文章](https://docs.microsoft.com/azure/backup/backup-azure-vms-troubleshoot#troubleshoot-vm-snapshot-issues)。

- **Linux VM：** 要獲取 Linux VM 的應用一致性快照，請使用 Linux 預腳本和腳本後框架編寫您自己的自訂腳本以確保一致性。

  - Azure 備份僅調用您編寫的預/後腳本。
  - 如果預腳本和腳本後成功執行，Azure 備份將復原點標記為應用程式一致性。 但是，當您使用自訂腳本時，您最終要負責應用程式一致性。
  - [詳細瞭解如何](backup-azure-linux-app-consistent.md)配置腳本。

## <a name="snapshot-consistency"></a>快照集一致性

下表解釋了不同類型的快照一致性：

**快照** | **詳細資料** | **復原** | **考量**
--- | --- | --- | ---
**應用程式一致** | 應用程式一致的備份會擷取記憶體內容和擱置 I/O 作業。 應用一致的快照使用 VSS 編寫器（或 Linux 的預/後腳本）來確保應用資料在備份發生前的一致性。 | 當您使用應用一致的快照恢復 VM 時，VM 將啟動。 沒有任何資料損毀或遺失。 應用程式會以一致的狀態開始。 | 視窗：所有 VSS 編寫器都成功<br/><br/> Linux：預/後腳本已配置並成功
**檔案系統一致** | 檔案系統一致性備份通過同時拍攝所有檔的快照來提供一致性。<br/><br/> | 當您使用檔案系統一致的快照恢復 VM 時，VM 將啟動。 沒有任何資料損毀或遺失。 應用程式必須實作自己的「修正」機制，以確保還原的資料一致。 | 視窗：某些 VSS 編寫器失敗 <br/><br/> Linux：預設值（如果預/後腳本未配置或失敗）
**絕對一致** | 如果 Azure VM 在備份時關閉，通常會發生崩潰一致的快照。 只會擷取備份時已存在磁碟上的資料，並加以備份。 | 從 VM 啟動過程開始，然後進行磁片檢查以修復損壞錯誤。 崩潰前未傳輸到磁片的任何記憶體中資料或寫入操作都丟失。 應用程式會實作本身的資料驗證。 例如，資料庫應用可以使用其事務日誌進行驗證。 如果事務日誌具有不在資料庫中的條目，則資料庫軟體將交易回復，直到資料保持一致。 | VM 處於關閉（已停止/已點位）狀態。

## <a name="backup-and-restore-considerations"></a>備份和恢復注意事項

**考量** | **詳細資料**
--- | ---
**磁碟** | VM 磁片的備份是並行的。 例如，如果 VM 有四個磁片，備份服務將嘗試並行備份所有四個磁片。 備份是累進的 (僅備份已變更的資料)。
**調度** |  要減少備份流量，請在白天的不同時間備份不同的 VM，並確保時間不會重疊。 同時間備份多個 VM 會導致流量壅塞。
**準備備份** | 請記住準備備份所需的時間。 準備時間包括安裝或更新備份擴展，並根據備份計畫觸發快照。
**資料傳輸** | 考慮 Azure 備份確定上次備份的增量更改所需的時間。<br/><br/> 在增量備份中，Azure 備份通過計算塊的校驗和來確定更改。 如果塊已更改，則將其標記為傳輸到保存庫。 該服務分析標識的塊，以嘗試進一步最小化要傳輸的資料量。 計算所有更改的塊後，Azure 備份會將更改傳輸到保存庫。<br/><br/> 擷取快照集和將其複製到保存庫之間可能會有延遲。<br/><br/> 在尖峰時間，處理備份最多可能需要 8 小時。 若每日備份，則 VM 的備份時間會小於 24 小時。
**初始備份** | 儘管增量備份的總備份時間少於 24 小時，但第一次備份可能不是這種情況。 初始備份所需的時間取決於資料的大小和處理備份的時間。
**還原佇列** | Azure 備份同時處理從多個存儲帳戶還原作業的過程，並將還原請求放入佇列中。
**還原複本** | 進行還原時，資料會從保存庫複製到儲存體帳戶。<br/><br/> 總還原時間取決於每秒 I/O 操作 （IOPS） 和存儲帳戶的輸送量。<br/><br/> 若要減少複製時間，請選取未使用其他應用程式寫入或讀取載入的儲存體帳戶。

### <a name="backup-performance"></a>備份效能

這些常見方案可能會影響總備份時間：

- **將新磁片添加到受保護的 Azure VM：** 如果 VM 正在進行增量備份並添加新磁片，則備份時間將增加。 由於新磁片的初始複製以及現有磁片的增量複製，總備份時間可能會持續超過 24 小時。
- **碎片磁片：** 當磁片更改是連續的時，備份操作會更快。 如果變更分散在磁碟中，則備份會必較慢。
- **磁片攪動：** 如果正在進行增量備份的受保護磁片的每日改動量超過 200 GB，則備份可能需要很長時間（超過 8 小時）才能完成。
- **備份版本：** 最新版本的備份（稱為即時還原版本）使用比校驗和比較更優化的過程來識別更改。 但是，如果您使用的是即時還原並刪除了備份快照，則備份將切換以校驗和比較。 在這種情況下，備份操作將超過 24 小時（或失敗）。

## <a name="best-practices"></a>最佳作法

在配置 VM 備份時，我們建議遵循以下實踐：

- 修改策略中設置的預設計畫時間。 例如，如果策略中的預設時間為 12：00 AM，則將計時增加幾分鐘，以便最佳使用資源。
- 如果要從單個保存庫還原 VM，我們強烈建議您使用不同的[通用 v2 存儲帳戶](https://docs.microsoft.com/azure/storage/common/storage-account-upgrade)，以確保目標存儲帳戶不會受到限制。 例如，每個 VM 必須具有不同的存儲帳戶。 例如，如果還原了 10 個 VM，請使用 10 個不同的存儲帳戶。
- 對於使用高級存儲的 VM 的備份，我們建議分配總分配的存儲空間的*50%* 可用空間，**而僅**第一次備份才需要這樣做。 完成第一個備份後，50% 的可用空間不是備份的要求
- 每個存儲帳戶的磁片數限制與在基礎架構作為服務 （IaaS） VM 上運行的應用程式訪問磁片的量度有關。 通常，如果單個存儲帳戶上存在 5 到 10 個磁片或更多，則通過將某些磁片移動到單獨的存儲帳戶來平衡負載。

## <a name="backup-costs"></a>備份成本

使用 Azure 備份所備份的 Azure VM 適用 [Azure 備份定價](https://azure.microsoft.com/pricing/details/backup/)。

計費不會在第一次成功備份完成之前開始。 儲存體和受保護的 VM 也會在此同時開始計費。 只要 VM 的任何備份資料存儲在保存庫中，計費就繼續。 如果您停止保護 VM，但 VM 的備份資料仍在保存庫中，則還是會繼續計費。

只有在停止保護且刪除全部備份資料時，才會對指定的虛擬機器停止計費。 當保護停止且沒有任何作用中的備份作業時，最後一個成功 VM 備份的大小會成為每月帳單所使用的受保護執行個體大小。

受保護實例大小計算基於 VM*的實際*大小。 VM 的大小是 VM 中所有資料的總和，不包括臨時存儲。 定價基於存儲在資料磁片上的實際資料，而不是基於附加到 VM 的每個資料磁片的最大受支援大小。

同樣，備份存儲帳單基於 Azure 備份中存儲的資料量，即每個復原點中實際資料的總和。

例如，以 A2 標準大小的 VM 為例，該 VM 具有兩個附加資料磁片，每個磁片的最大大小為 32 TB。 下表顯示了存儲在每個磁片上的實際資料：

**磁碟** | **大小上限** | **實際儲存的資料**
--- | --- | ---
作業系統磁碟 | 32 TB | 17 GB
本機/暫存磁碟 | 135 GB | 5 GB (未包含備份)
資料磁碟 1 | 32 TB| 30 GB
資料磁碟 2 | 32 TB | 0 GB

在此案例中，VM 的實際容量為 17 GB + 30 GB + 0 GB = 47 GB。 此受保護實例大小 （47 GB） 成為每月帳單的基礎。 隨著 VM 中資料量的增長，用於計費的受保護實例大小將更改為匹配。

## <a name="next-steps"></a>後續步驟

現在，[準備 Azure VM 備份](backup-azure-arm-vms-prepare.md)。
