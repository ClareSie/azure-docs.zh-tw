---
title: 信任如何為 Azure AD 域服務工作 |微軟文檔
description: 詳細瞭解林信任如何與 Azure AD 域服務一起工作
services: active-directory-ds
author: iainfoulds
manager: daveba
ms.service: active-directory
ms.subservice: domain-services
ms.workload: identity
ms.topic: conceptual
ms.date: 11/19/2019
ms.author: iainfou
ms.openlocfilehash: 8b79e0fb24c15d2e9f16640e90d62f7df5c21f32
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/27/2020
ms.locfileid: "74233697"
---
# <a name="how-trust-relationships-work-for-resource-forests-in-azure-active-directory-domain-services"></a>信任關係如何適用于 Azure 活動目錄域服務中的資源林

活動目錄域服務 （AD DS） 通過域和林信任關係跨多個域或林提供安全。 在跨信任進行身份驗證之前，Windows 必須首先檢查使用者、電腦或服務請求的域是否與請求帳戶的域具有信任關係。

為了檢查此信任關係，Windows 安全系統計算接收請求的伺服器的網域控制站 （DC） 與請求帳戶網域中的 DC 之間的信任路徑。

AD DS 和 Windows 分散式安全模型提供的存取控制機制為域和林信任的操作提供了環境。 要使這些信任正常工作，每個資源或電腦都必須具有到其所在的域中的 DC 的直接信任路徑。

信任路徑由 Net Logon 服務使用經過身份驗證的遠端程序呼叫 （RPC） 連接到受信任的域頒發機構實現。 安全通道還通過域間信任關係擴展到其他 AD DS 域。 此安全通道用於獲取和驗證安全資訊，包括使用者和組的安全識別碼 （SI）。

## <a name="trust-relationship-flows"></a>信任關係流

通過信託進行安全通信的流動決定了信任的彈性。 如何創建或配置信任確定通信在林內或跨林延伸的範圍。

信託的溝通流由信任的方向決定。 信任可以是單向的，也可以是雙向的，也可以是傳遞的，也可以是非傳遞的。

下圖顯示*樹 1*和*樹 2*中的所有域預設情況下都具有傳遞信任關係。 因此，*樹 1*中的使用者可以訪問*樹 2*中的域中的資源，樹*1*中的使用者可以訪問*樹 2*中的資源，在資源處分配適當的許可權時。

![兩個林之間的信任關係圖](./media/concepts-forest-trust/trust-relationships.png)

### <a name="one-way-and-two-way-trusts"></a>單向和雙向信任

支援訪問資源的信任關係可以是單向的，也可以是雙向的。

單向信任是在兩個域之間創建的單向身份驗證路徑。 在*域 A*和*域 B*之間的單向信任中，*域 A*中的使用者可以訪問域*B*中的資源。但是，域*B*中的使用者無法訪問*域 A*中的資源。

某些單向信任可以是非傳遞的，也可以是傳遞的，具體取決於所創建的信任類型。

在雙向信任中，域*A*信任*域 B*和*域 B*信任域*A*。此配置意味著身份驗證請求可以在兩個方向的兩個域之間傳遞。 某些雙向關係可以是非傳遞關係，也可以是傳遞關係，具體取決於所創建的信任類型。

AD DS 林中的所有域信任都是雙向的傳遞信任。 建立新的子網域時，會在新的子網域和父系網域之間自動建立雙向、可轉移信任。

### <a name="transitive-and-non-transitive-trusts"></a>過境和非過境信託

傳遞性決定了信任是否可以擴展到其形成的兩個域之外。

* 傳遞信任可用於擴展與其他域的信任關係。
* 非傳遞信任可用於拒絕與其他域的信任關係。

每次在林中創建新域時，新域及其父系網域之間都會自動創建雙向傳遞信任關係。 如果將子域添加到新域中，則信任路徑通過域層次結構向上流動，從而擴展在新域及其父系網域之間創建的初始信任路徑。 可轉移的信任會沿著其形成的網域樹系上溯，在網域樹系中所有網域之間建立可轉移的信任。

身份驗證請求遵循這些信任路徑，因此林中的任何域中的帳戶都可以由林中的任何其他域進行身份驗證。 透過單一登入程序，具有適當權限的帳戶可以存取樹系中任何網域內的資源。

## <a name="forest-trusts"></a>樹系信任

林信任可説明您管理分段的 AD DS 基礎結構，並支援跨多個林訪問資源和其他物件。 林信任對於服務提供者、進行合併或收購的公司、協作業務外聯網以及尋求管理自治解決方案的公司非常有用。

使用林信任，可以連結兩個不同的林以形成單向或雙向傳遞信任關係。 林信任允許管理員將兩個 AD DS 林與單個信任關係連接，從而在整個林中提供無縫的身份驗證和授權體驗。

林信任只能在一個林中的林根域和另一個林中的林根域之間創建。 林信任只能在兩個林之間創建，不能隱式擴展到第三個林。 此行為意味著，如果在*林 1*和*林 2*之間創建了林信任，並且在*林 2*和林*3*之間創建了另一個林信任，*則林 1*對*林 3*沒有隱式信任。

下圖顯示了單個組織中三個 AD DS 林之間的兩個單獨的林信任關係。

![單個組織內林信任關係圖](./media/concepts-forest-trust/forest-trusts.png)

此示例配置提供以下訪問：

* 林*2*中的使用者可以訪問*林 1*或*林 3*中的任何域中的資源
* 林*3*中的使用者可以訪問*林 2*中的任何域中的資源
* 林*1*中的使用者可以訪問*林 2*中的任何域中的資源

此配置不允許*林 1*中的使用者訪問*林 3*中的資源，反之亦然。 為了允許*林 1*和*林 3*中的使用者共用資源，必須在兩個林之間創建雙向傳遞信任。

如果在兩個林之間創建單向林信任，則受信任的林的成員可以利用位於信任林中的資源。 但是，信任只能單方向運作。

例如，當單向時，*在林 1（* 受信任的林）和*林 2（* 信任林）之間創建林信任：

* 林*1*的成員可以訪問*位於林 2*中的資源。
* 林*2*的成員無法使用相同的信任訪問林*1*中的資源。

> [!IMPORTANT]
> Azure AD 域服務資源林僅支援對本地活動目錄的單向林信任。

### <a name="forest-trust-requirements"></a>林信任要求

在創建林信任之前，您需要驗證是否具備了正確的網域名稱系統 （DNS） 基礎結構。 僅當以下 DNS 配置之一可用時，才能創建林信任：

* 單個根 DNS 伺服器是兩個林 DNS 命名空間的根 DNS 伺服器 - 根區域包含每個 DNS 命名空間的委派，所有 DNS 伺服器的根提示包括根 DNS 伺服器。
* 如果沒有共用根 DNS 伺服器，並且每個林 DNS 命名空間的根 DNS 伺服器使用每個 DNS 命名空間的 DNS 條件轉寄站來路由其他命名空間中的名稱查詢。

    > [!IMPORTANT]
    > Azure AD 域服務資源林必須使用此 DNS 配置。 託管資源林 DNS 命名空間以外的 DNS 命名空間不是 Azure AD 域服務的一項功能。 條件轉寄站是適當的配置。

* 如果沒有共用的根 DNS 伺服器，並且每個林 DNS 命名空間的根 DNS 伺服器使用 DNS 次要區域在每個 DNS 命名空間中配置，以路由查詢其他命名空間中的名稱。

要創建林信任，您必須是域管理員組（在林根域中）或活動目錄中的企業管理員組的成員。 為每個信任分配了兩個林中的管理員必須知道的密碼。 兩個林中的企業管理員成員可以同時創建兩個林中的信任，在這種情況下，將自動生成密碼，並同時為兩個林寫入加密隨機的密碼。

Azure AD 域服務的出站林信任在 Azure 門戶中創建。 您不會手動使用託管域本身創建信任。 傳入林信任必須由具有以前在本地活動目錄中注明的許可權的使用者配置。

## <a name="trust-processes-and-interactions"></a>信任流程和交互

許多域間和林間事務依賴于域或林信任來完成各種任務。 本節介紹在跨信任訪問資源和評估身份驗證引用時發生的過程和交互。

### <a name="overview-of-authentication-referral-processing"></a>身份驗證引用處理概述

當身份驗證請求被引用到域時，該域中的網域控制站必須確定是否存在與來自請求的域存在信任關係。 在驗證使用者訪問域中的資源之前，還必須確定信任的方向以及信任是傳遞的還是非傳遞的。 受信任域之間發生的身份驗證過程因正在使用的身份驗證協定而異。 Kerberos V5 和 NTLM 協定以不同的方式處理對域進行身份驗證的引用

### <a name="kerberos-v5-referral-processing"></a>Kerberos V5 轉介處理

Kerberos V5 驗證通訊協定依賴于網域控制站上的 Net Logon 服務，用於用戶端身份驗證和授權資訊。 Kerberos 協定連接到連線金鑰分發中心 （KDC） 和活動目錄帳戶存儲，用於會話票證。

Kerberos 協定還使用信任進行跨域票證授予服務 （TGS）和跨安全通道驗證特權屬性證書 （PAC）。 Kerberos 協定僅對非 Windows 品牌作業系統 Kerberos 領域（如 MIT Kerberos 領域）執行跨域身份驗證，無需與 Net Logon 服務進行交互。

如果用戶端使用 Kerberos V5 進行身份驗證，它將從其帳戶網域中的網域控制站向目標域中的伺服器請求票證。 Kerberos KDC 充當用戶端和伺服器之間的可信仲介，並提供工作階段金鑰，使雙方能夠相互進行身份驗證。 如果目標域與當前域不同，KDC 將遵循一個邏輯過程來確定是否可以引用身份驗證請求：

1. 當前域是否直接受請求伺服器域信任？
    * 如果是，請向用戶端發送對請求域的引用。
    * 如果沒有，則轉到下一步。

2. 當前域與信任路徑上的下一個域之間是否存在傳遞信任關係？
    * 如果是，則將引用發送到信任路徑上的下一個域。
    * 如果沒有，請向用戶端發送拒絕登錄的消息。

### <a name="ntlm-referral-processing"></a>NTLM 轉介處理

NTLM 身份驗證協定依賴于網域控制站上的 Net Logon 服務，用於用戶端身份驗證和授權資訊。 此協定對不使用 Kerberos 身份驗證的用戶端進行身份驗證。 NTLM 使用信任在域之間傳遞身份驗證請求。

如果用戶端使用 NTLM 進行身份驗證，則初始身份驗證請求直接從用戶端轉到目標域中的資源伺服器。 此伺服器會創建用戶端回應的挑戰。 然後，伺服器將使用者的回應發送到其電腦帳戶網域中的網域控制站。 此網域控制站根據其安全帳戶資料庫檢查使用者帳戶。

如果資料庫中不存在該帳戶，網域控制站將確定是使用以下邏輯執行直通身份驗證、轉發請求還是拒絕請求：

1. 當前域是否與使用者的域有直接的信任關係？
    * 如果是，網域控制站會將用戶端的憑據發送到使用者域中的網域控制站進行傳遞身份驗證。
    * 如果沒有，則轉到下一步。

2. 當前域是否與使用者的域具有傳遞信任關係？
    * 如果是，將身份驗證請求傳遞到信任路徑中的下一個域。 此網域控制站通過檢查使用者對自己的安全帳戶資料庫的憑據來重複此過程。
    * 如果沒有，請向用戶端發送拒絕登錄的消息。

### <a name="kerberos-based-processing-of-authentication-requests-over-forest-trusts"></a>基於 Kerberos 的通過林信任的身份驗證請求的處理

當兩個林由林信任連接時，使用 Kerberos V5 或 NTLM 協定進行的身份驗證請求可以在林之間路由，以提供對兩個林中的資源的訪問。

首次建立林信任時，每個林都會收集其夥伴林中的所有受信任命名空間，並將資訊存儲在[受信任的域物件](#trusted-domain-object)中。 受信任的命名空間包括域樹名、使用者主體名稱 （UPN） 尾碼、服務主體名稱 （SPN） 尾碼以及其他林中使用的安全 ID （SID） 命名空間。 TDO 物件將複製到全域目錄。

在身份驗證協定可以遵循林信任路徑之前，必須將資源電腦的服務主體名稱 （SPN） 解析為其他林中的位置。 SPN 可以是以下原因之一：

* 主機的 DNS 名稱。
* 域的 DNS 名稱。
* 服務連接點物件的可分辨名稱。

當一個林中的工作站嘗試訪問另一個林中的資源電腦上的資料時，Kerberos 身份驗證過程會與網域控制站聯繫，獲取服務票證到資源電腦的 SPN。 一旦網域控制站查詢全域目錄並確定 SPN 與網域控制站不在相同的林中，網域控制站就會將其父系網域的引用發送回工作站。 此時，工作站會查詢服務票證的父系網域，並繼續遵循引用鏈，直到到達資源所在的域。

以下關系圖和步驟詳細介紹了運行 Windows 的電腦嘗試從位於另一個林中的電腦訪問資源時使用的 Kerberos 身份驗證過程。

![林信任上的 Kerberos 過程圖](media/concepts-forest-trust/kerberos-over-forest-trust-process.png)

1. *使用者 1*使用*europe.tailspintoys.com*域中的憑據登錄到*工作站1。* 然後，使用者嘗試訪問位於*usa.wingtiptoys.com*林的*FileServer1*上的共用資源。

2. *工作站1*在其域*ChildDC1*的網域控制站上與 Kerberos KDC 聯繫，並請求*FileServer1* SPN 的服務票證。

3. *子DC1*在其域資料庫中找不到 SPN，並查詢通用類別目錄以查看*tailspintoys.com*林中是否有任何域包含此 SPN。 由於全域目錄僅限於其自己的林，因此找不到 SPN。

    然後，通用類別目錄檢查其資料庫，以獲取有關與其林建立的任何林信任的資訊。 如果找到，它將林信任受信任域物件 （TDO） 中列出的名稱尾碼與目標 SPN 的尾碼進行比較，以查找匹配項。 找到匹配項後，通用類別目錄將提供回*子DC1*的路由提示。

    路由提示有助於將身份驗證請求定向到目標林。 僅當所有傳統身份驗證通道（如本地網域控制站和全域目錄）都找不到 SPN 時，才會使用提示。

4. *子DC1*將其父系網域的引用發送回*工作站1*。

5. *工作站1*與*ForestRootDC1（* 其父系網域）中的網域控制站聯繫，以將其引用到*wingtiptoys.com*林林根域中的網域控制站 *（ForestRootDC2）。*

6. *工作站1*在*wingtiptoys.com*林中聯繫*ForestRootDC2，* 以獲得請求的服務票證。

7. *ForestRootDC2*與其全域目錄聯繫以查找 SPN，全域目錄查找 SPN 的匹配項並將其發送回*ForestRootDC2*。

8. *然後，ForestRootDC2*將推薦發送到*usa.wingtiptoys.com*回*工作站1。*

9. *工作站1*與*ChildDC2*上的 KDC 聯繫，並協商*使用者 1*的票證以訪問*FileServer1*。

10. *一旦工作站1*有服務票證，它將服務票證發送到*FileServer1，* 該檔案伺服器讀取*User1*的安全憑據並相應地構造訪問權杖。

## <a name="trusted-domain-object"></a>受信任的域物件

組織中的每個域或林信任都由存儲在其域中的*系統*容器中的受信任域物件 （TDO） 表示。

### <a name="tdo-contents"></a>TDO 內容

TDO 中包含的資訊因是由域信任還是林信任創建的 TDO 而異。

創建域信任時，TDO 中會表示 DNS 功能變數名稱、域 SID、信任類型、信任傳遞性和互惠功能變數名稱等屬性。 林信任 TDO 存儲其他屬性，以標識合作夥伴林中的所有受信任的命名空間。 這些屬性包括域樹名、使用者主體名稱 （UPN） 尾碼、服務主體名稱 （SPN） 尾碼和安全 ID （SID） 命名空間。

由於信任作為 TDO 存儲在活動目錄中，因此林中的所有域都瞭解整個林中已存在的信任關係。 同樣，當兩個或多個林通過林信任聯接在一起時，每個林中的林根域都瞭解信任關係，這些關係在受信任的林中的所有域中都存在。

### <a name="tdo-password-changes"></a>TDO 密碼更改

信任關係中的兩個域共用一個密碼，該密碼存儲在活動目錄中的 TDO 物件中。 作為帳戶維護過程的一部分，信任網域控制站每 30 天更改存儲在 TDO 中的密碼。 由於所有雙向信任實際上是兩個雙向信任，因此雙向信任的過程會發生兩次。

信任具有信任和可信任的一面。 在受信任的方面，任何可寫網域控制站都可用於該過程。 在信任端，PDC 模擬器執行密碼更改。

要更改密碼，網域控制站完成以下過程：

1. 信任域中的網域主控站 （PDC） 模擬程式創建新密碼。 受信任域中的網域控制站永遠不會啟動密碼更改。 它總是由信任域 PDC 模擬器啟動。

2. 信任域中的 PDC 模擬器將 TDO 物件的*舊密碼*欄位設置為當前 *"新密碼"* 欄位。

3. 信任域中的 PDC 模擬器將 TDO 物件的 *"新密碼"* 欄位設置為新密碼。 如果受信任域中的網域控制站無法接收更改，或者在發出使用新信任密碼的請求之前未複製更改，則保留以前密碼的副本可以還原到舊密碼。

4. 信任域中的 PDC 模擬程式對受信任域中的網域控制站進行遠端調用，要求其將信任帳戶上的密碼設置為新密碼。

5. 受信任域中的網域控制站將信任密碼更改為新密碼。

6. 在信任的每一側，更新將複製到域中的其他網域控制站。 在信任域中，更改觸發受信任域物件的緊急複製。

現在，兩個網域控制站上的密碼都已更改。 正常複製將 TDO 物件分發到域中的其他網域控制站。 但是，信任域中的網域控制站可以在不成功更新受信任域中的網域控制站的情況下更改密碼。 由於無法建立處理密碼更改所需的安全通道，可能會發生此情況。 受信任域中的網域控制站也可能在此過程中的某個時間點不可用，並且可能無法接收更新的密碼。

為了處理密碼更改未成功傳達的情況，信任域中的網域控制站永遠不會更改新密碼，除非它已使用新密碼成功進行身份驗證（設置安全通道）。 此行為是新舊密碼都保存在信任域的 TDO 物件中的原因。

在使用密碼的身份驗證成功之前，密碼更改不會完成。 舊的存儲密碼可以在安全通道上使用，直到受信任域中的網域控制站收到新密碼，從而實現不間斷的服務。

如果使用新密碼的身份驗證失敗，因為密碼無效，則信任網域控制站會嘗試使用舊密碼進行身份驗證。 如果使用舊密碼成功進行身份驗證，它將在 15 分鐘內恢復密碼更改過程。

信任密碼更新需要在 30 天內複製到信任雙方的網域控制站。 如果信任密碼在 30 天后更改，並且網域控制站只有 N-2 密碼，則它不能使用信任端的信任，也不能在受信任的端創建安全通道。

## <a name="network-ports-used-by-trusts"></a>信託使用的網路埠

由於信任必須跨各種網路邊界部署，因此它們可能必須跨越一個或多個防火牆。 在這種情況下，您可以跨防火牆隧道信任流量，也可以打開防火牆中的特定埠，以允許流量通過。

> [!IMPORTANT]
> 活動目錄域服務不支援將活動目錄 RPC 流量限制為特定埠。

閱讀 Microsoft 支援文章的**Windows Server 2008 和更高版本**部分[，如何為 Active Directory 域和信任配置防火牆](https://support.microsoft.com/help/179442/how-to-configure-a-firewall-for-domains-and-trusts)，以瞭解林信任所需的埠。

## <a name="supporting-services-and-tools"></a>支援服務和工具

為了支援信任和身份驗證，使用了一些附加功能和管理工具。

### <a name="net-logon"></a>Net Logon

Net 登錄服務維護從基於 Windows 的電腦到 DC 的安全通道。 它還用於以下信任相關流程：

* 信任設置和管理 - Net Logon 通過與 LSA 流程和 TDO 交互，説明維護信任密碼、收集信任資訊並驗證信任。

    對於林信任，信任資訊包括林信任資訊 （*FTInfo*） 記錄，其中包括信任樹系聲明要管理的命名空間集，用指示每個聲明是否信任樹系信任的欄位進行批帶。

* 身份驗證 – 通過安全通道向網域控制站提供使用者憑據，並為使用者返回域 SI 和使用者許可權。

* 網域控制站位置 – 有助於查找或定位域或域中的網域控制站。

* 直通驗證 – 其他域中的使用者的憑據由 Net Logon 處理。 當信任域需要驗證使用者的標識時，它會通過 Net Logon 將使用者的憑據傳遞到受信任的域進行驗證。

* 特權屬性證書 （PAC） 驗證 - 當使用 Kerberos 協定進行身份驗證的伺服器需要在服務票證中驗證 PAC 時，它將通過安全通道將 PAC 發送到其網域控制站進行驗證。

### <a name="local-security-authority"></a>本機安全性授權

本地安全機構 （LSA） 是一個受保護的子系統，用於維護有關系統上本地安全的所有方面的資訊。 LSA 統稱為本地安全性原則，提供各種服務，用於在名稱和識別碼之間進行轉換。

LSA 安全子系統在核心模式和使用者模式下提供服務，以驗證對物件的訪問、檢查使用者許可權和生成審核消息。 LSA 負責檢查受信任或不受信任的域中的服務提供的所有會話票證的有效性。

### <a name="management-tools"></a>管理工具

管理員可以使用*活動目錄域和信任**、Netdom*和*Nltest*公開、創建、刪除或修改信任。

* *活動目錄域和信託*是 Microsoft 管理主控台 （MMC），用於管理域信任、域和林功能級別以及使用者主體名稱尾碼。
* *Netdom*和*Nltest*命令列工具可用於查找、顯示、創建和管理信任。 這些工具直接與網域控制站上的 LSA 許可權通信。

## <a name="next-steps"></a>後續步驟

要瞭解有關資源林的更多資訊，請參閱[林信任如何在 Azure AD DS 中工作？][concepts-trust]

要開始使用資源林創建 Azure AD DS 託管域，請參閱[創建和配置 Azure AD DS 託管域][tutorial-create-advanced]。 然後，您可以[創建到本地域的出站林信任（預覽）。][create-forest-trust]

<!-- LINKS - INTERNAL -->
[concepts-trust]: concepts-forest-trust.md
[tutorial-create-advanced]: tutorial-create-instance-advanced.md
[create-forest-trust]: tutorial-create-forest-trust.md
