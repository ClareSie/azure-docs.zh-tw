---
title: 使用 MABS 備份超 V 虛擬機器
description: 本文包含使用 Microsoft Azure 備份伺服器 (MABS) 備份和恢復虛擬機器的過程。
ms.topic: conceptual
ms.date: 07/18/2019
ms.openlocfilehash: 71cf446472ef0cf4f50bf64e47d359ea08ccc087
ms.sourcegitcommit: 7581df526837b1484de136cf6ae1560c21bf7e73
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/31/2020
ms.locfileid: "80420409"
---
# <a name="back-up-hyper-v-virtual-machines-with-azure-backup-server"></a>使用 Azure 備份伺服器備份超 V 虛擬機器

本文介紹如何使用 Microsoft Azure 備份伺服器 (MABS) 備份 Hyper-V 虛擬機器。

## <a name="supported-scenarios"></a>支援的案例

MABS 可以在以下情況下備份在 Hyper-V 主機伺服器上執行的虛擬機器:

- **具有本機或直接儲存空間的虛擬機器**：備份裝載在 Hyper-V 主機獨立伺服器上具有本機或直接連接儲存空間的虛擬機器。 例如:硬碟驅動器、儲存區域網路 (SAN) 設備或網路連接存儲 (NAS) 設備。 必須在所有主機上安裝 MABS 保護代理。

- **具有 CSV 儲存空間之叢集中的虛擬機器**：備份裝載在 Hyper-V 叢集上具有叢集共用磁碟區 (CSV) 儲存空間的虛擬機器。 MABS 保護代理安裝在每個群集節點上。

## <a name="host-versus-guest-backup"></a>主機與來賓備份

MABS 可以執行超VVM的主機或來賓級備份。 在主機等級,MABS 保護代理安裝在 Hyper-V 主機伺服器或群集上,並保護該主機上運行的整個 VM 和數據檔。   在來賓級別,代理安裝在每台虛擬機上,並保護該計算機上存在的工作負載。

兩種方法各有其優缺點︰

- 主機級備份是靈活的,因為它們工作,無論來賓電腦上運行的作業系統類型如何,並且不需要在每個 VM 上安裝 MABS 保護代理。 如果部署主機級備份,則可以恢復整個虛擬機或檔和資料夾(專案級恢復)。

- 如果要保護在虛擬機上運行的特定工作負載,來賓級備份非常有用。 在主機級別,您可以恢復整個 VM 或特定檔,但它不會在特定應用程式的上下文中提供恢復。 例如,要從備份的 VM 恢復特定的 SharePoint 項,應執行該 VM 的來賓級備份。 如果要保護存儲在直通磁碟上的數據,請使用來賓級備份。 傳遞允許虛擬機直接存取存放裝置,並且不會將虛擬卷資料存儲在 VHD 檔中。

## <a name="how-the-backup-process-works"></a>備份過程的工作原理

MABS 使用 VSS 執行備份,如下所示。 為了清楚呈現，這項描述中的步驟會依號碼列示。

1. 基於 MABS 塊的同步引擎是受保護虛擬機器的初始副本,並確保虛擬機器的副本完整且一致。

2. 製作和驗證初始複本後,MABS 使用超 V VSS 編寫器擷取備份。 VSS 編寫器提供與 MABS 伺服器同步的數據一致的磁碟塊集。 此方法提供了 MABS 伺服器「完全備份」的好處,同時最大限度地減少了必須通過網路傳輸的備份數據。

3. 運行 Hyper-V 的伺服器上的 MABS 保護代理使用現有的 Hyper-V API 來確定受保護的虛擬機器是否也支援 VSS。

   - 如果虛擬機器符合線上備份的需求，而且已安裝 Hyper-V 整合服務元件，則 Hyper-V VSS 寫入器會以遞迴方式將 VSS 要求轉送到虛擬機器上的所有 VSS 感知處理程序。 此操作無需在虛擬機器上安裝 MABS 保護代理。 這種遞迴的 VSS 要求可讓 Hyper-V VSS 寫入器確保磁碟寫入操作保持同步，以避免擷取 VSS 快照集時遺失資料。

     Hyper-V 整合服務元件會在虛擬機器上叫用磁碟區陰影複製服務 (VSS) 中的 Hyper-V VSS 寫入器，確保其應用程式資料處於一致的狀態。

   - 如果虛擬機不符合連線備份要求,MABS 會自動使用 Hyper-V API 在虛擬機器擷取資料檔之前暫停虛擬機器。

4. 在虛擬機的初始基線副本與 MABS 伺服器同步後,對虛擬機器資源所做的所有更改都擷取到新的復原點中。 復原點代表虛擬機器在特定時間的一致狀態。 擷取復原點的操作一天可能至少會執行一次。 創建新復原點時,MABS 與 Hyper-V VSS 編寫器一起使用區塊級複製,以確定在創建最後一個復原點後,伺服器上已更改了哪些區列執行 Hyper-V。 然後,這些資料塊將傳輸到 MABS 伺服器,並應用於受保護數據的副本。

5. MABS 伺服器在承載復原資料的卷上使用 VSS,以便有多個捲影副本可用。 這些陰影複本各自提供一次個別的復原。 VSS 恢復點存儲在 MABS 伺服器上。 在運行 Hyper-V 的伺服器上製作的臨時副本僅在 MABS 同步期間存儲。

>[!NOTE]
>
>從 Windows Server 2016 開始,Hyper-V 虛擬硬碟具有稱為彈性更改追蹤 (RCT) 的內置更改追蹤。 MABS 使用 RCT(Hyper-V 中的本機更改追蹤),這減少了在 VM 崩潰等方案中耗時的一致性檢查的需要。 比起 VSS 快照集式備份提供的變更追蹤，RCT 提供更好的復原力。 在任何一致性檢查期間，MABS V3 只會傳送變更的資料，藉此進一步最佳化網路和儲存體耗用量。

## <a name="backup-prerequisites"></a>備份的必要條件

以下是使用 MABS 備份超 V 虛擬機器的先決條件:

|必要條件|詳細資料|
|------------|-------|
|MABS 先決條件|- 如果要對虛擬機器執行專案級恢復(恢復檔案、資料夾、卷),則需要在 MABS 伺服器上安裝 Hyper-V 角色。  如果只想恢復虛擬機,而不是專案級別,則不需要該角色。<br />- 您可以在一台 MABS 伺服器上保護多達 800 台 100 GB 的虛擬機,並允許支援更大群集的多個 MABS 伺服器。<br />- MABS 將頁面檔從增量備份中排除,以提高虛擬機備份性能。<br />- MABS 可以備份 Hyper-V 伺服器或群集與 MABS 伺服器位於同一域中,也可以備份在子域或受信任網域中。 如果要在工作組或不受信任的域中備份 Hyper-V,則需要設置身份驗證。 對於單個 Hyper-V 伺服器,可以使用 NTLM 或憑證身份驗證。 對於群集,只能使用證書身份驗證。<br />-   不支援在傳遞磁碟上使用主機層級備份來備份虛擬機器資料。 在這種情況下,我們建議您使用主機級備份來備份 VHD 檔和來賓級備份,以備份主機上不可見的其他數據。<br />   -您可以備份存儲在重複資料消除卷上的 VM。|
|Hyper-V VM 的必要條件|- 在虛擬機上運行的整合元件版本應與 Hyper-V 主機的版本相同。 <br />-   針對每個虛擬機器備份，裝載虛擬硬碟檔案的磁碟區上需有可用空間，以允許 Hyper-V 在備份過程中為差異磁碟 (AVHD) 保留足夠的空間。 此空間大小必須至少等於計算結果：**初始磁碟大小\*變換率\*備份**間隔時間。 如果您在叢集上執行多個備份，透過這個計算方式，您需要足夠的儲存容量來容納每個虛擬機器的 AVHD。<br />- 要備份位於運行 Windows Server 2012 R2 的 Hyper-V 主機伺服器上的虛擬機器,虛擬機器應指定 SCSI 控制器,即使它未連接到任何內容。 (在 Windows Server 2012 R2 線上備份中,Hyper-V 主機在 VM 中裝載新的 VHD,然後將其卸載。 只有 SCSI 控制器可以支援此功能,因此虛擬機器的線上備份是必需的。  如果沒有此設置,當您嘗試備份虛擬機時,將發出事件 ID 10103。|
|Linux 必要條件|- 您可以使用 MABS 備份 Linux 虛擬機器。 僅支援檔案一致的快照集。|
|使用 CSV 儲存空間備份 VM|-   若是 CSV 儲存空間，請在 Hyper-V 伺服器上安裝磁碟區陰影複製服務 (VSS) 硬體提供者。 如需 VSS 硬體提供者的資訊，請連絡您的存放區域網路 (SAN) 廠商。<br />- 如果單個節點在 CSV 群集中意外關閉,MABS 將對該節點上運行的虛擬機執行一致性檢查。<br />-   如果您需要重新啟動已啟用 BitLocker 磁碟區加密的 Hyper-V 伺服器，就必須為 Hyper-V 虛擬機器執行一致性檢查。|
|使用 SMB 儲存空間備份 VM|-   在執行 Hyper-V 的伺服器上開啟自動掛接，以啟用虛擬機器保護。<br />   -   停用 TCP Chimney 卸載。<br />-   確認所有的 Hyper-V machine$ 帳戶對於特定遠端 SMB 檔案共用皆具有完整權限。<br />- 確保所有虛擬機組件在恢復到備用位置期間的檔路徑小於 260 個字元。 如果沒有,恢復可能會成功,但 Hyper-V 將無法裝載虛擬機。<br />- 不支援以下機制:<br />     虛擬機的某些元件位於本地卷上且某些元件位於遠端卷上的部署;用於儲存位置檔案伺服器的 IPv4 或 IPv6 位址,以及將虛擬機恢復到使用遠端 SMB 共用的電腦。<br />- 您需要在每個 SMB 伺服器開啟檔案伺服器 VSS 代理伺服器 - 將新增**角色與功能** > **選擇伺服器角色** > **檔案和儲存服務** > **檔案服務** > **檔案服務** > 伺服器**VSS 代理伺服器**。|

## <a name="back-up-virtual-machines"></a>備份虛擬機器

1. 設定[MABS 伺服器](backup-azure-microsoft-azure-backup.md)與[儲存](backup-mabs-add-storage.md)。 設定您的存放裝置時，請使用這些存放裝置容量指導方針。
   - 平均虛擬機器大小 - 100 GB
   - 每個 MABS 伺服器的虛擬機器數 - 800
   - 800 部 VM 的總大小 - 80 TB
   - 備份存放裝置需要的空間 - 80 TB

2. 在 Hyper-V 伺服器或 Hyper-V 群集節點上設置 MABS 保護代理。 如果您正在執行來賓級備份,您將在要在來賓級別備份的 VM 上安裝代理。

3. 在 MABS 管理員控制台中,按一下 **「保護** > **創建保護組**」以打開 **「創建新保護組**」嚮導。

4. 在 [選擇群組成員]**** 頁面中，從 VM 所在的 Hyper-V 主機伺服器中選取您要保護的 VM。 建議將擁有相同保護原則的 VM 都放入一個保護群組。 您可以啟用共置以有效利用空間。 共置可讓您在同一個磁碟或磁帶儲存空間找到不同保護群組的資料，讓多個資料來源只有一個複本和復原點磁碟區。

5. 在 [選擇資料保護方式]**** 頁面上，指定保護群組名稱。 選取 [我想要使用磁碟執行短期保護] **** ；如果您想要使用 Azure 備份服務將資料備份到 Azure，請選取 [我要執行線上保護] **** 。

6. 在 **「指定短期目標** > **保留範圍**」中,指定要保留磁碟資料的時間。 在**同步頻率**中,指定應運行資料的增量備份的頻率。 或者，不要選取增量備份間隔，而是改為啟用 [恰好在復原點之前] ****。 啟用此設置後,MABS將在每個計劃恢復點之前運行快速完整備份。

    > [!NOTE]
    >
    >如果您要保護應用程式工作負載，會根據 [同步處理頻率] 建立復原點 (如果應用程式支援增量備份)。 如果沒有,則 MABS 運行快速完整備份,而不是增量備份,並根據快速備份計劃創建恢復點。

7. 在 **「查看磁碟分配**」頁中,查看為保護組分配的存儲池磁碟空間。

   **總資料大小**是要備份的數據的大小,在**MABS 上預配的磁碟空間是 MABS**建議保護組的空間。 MABS 根據設置選擇理想的備份卷。 但是,您可以在**磁碟分配詳細資訊**中編輯備份卷選項。 針對工作負載，請在下拉式功能表中選取您偏好的儲存體。 您的編輯內容會變更 [可用磁碟儲存體]**** 窗格中 [儲存體總計]**** 和 [可用儲存體]**** 的值。 預配不足的空間是 MABS 建議您添加到卷中的儲存量,以便將來順利繼續備份。

8. 在 [選擇複本的建立方式]**** 頁面上，指定將執行如何保護群組中的資料初始複寫。 如果您選擇**通過網路自動複製**,我們建議您選擇非高峰時間。 對於大量數據或低於最佳網路條件,請考慮選擇**手動**,這需要使用可移動媒體脫機複製數據。

9. 在 [一致性檢查選項]**** 頁面上，選取要自動執行一致性檢查的方式。 只有當複本資料變得不一致，或是排程指示時，您才能執行檢查。 如果不想設定自動一致性檢查，您可以滑鼠右鍵按一下保護群組，然後選取 [執行一致性檢查]****，以手動方式隨時執行檢查。

    建立保護群組後，就會依您選取的方法執行資料的初始複寫。 初始複寫後，便會依照保護群組的設定開始每個備份。 如果需要恢復備份的數據,請注意以下事項:

## <a name="back-up-replica-virtual-machines"></a>備份複本虛擬機器

如果 MABS 在 Windows Server 2012 R2 或更高版本上運行,則可以備份副本虛擬機器。 基於下列幾個理由，這樣做會很有用︰

**減少備份對於執行中工作負載的影響**：進行虛擬機器的備份會在建立快照時產生額外負荷。 通過將備份過程卸載到輔助遠端網站,正在運行的工作負載不再受備份操作的影響。 這僅適用於備份複本存放在遠端站台上的部署。 例如，您可以進行每日備份並將資料儲存放在本機，以確保快速還原時間，但從存放在遠端以供長期保存的複本虛擬機器進行每月或每季備份。

**節省頻寬**：在典型的遠端分公司/總部部署中，您需要適當的已佈建頻寬量，以便在站台間傳輸備份資料。 除了資料備份策略，如果您還建立複寫和容錯移轉策略，您可以減少透過網路傳送的冗餘資料量。 通過備份副本虛擬機數據而不是主副本,可以節省通過網路發送備份數據的開銷。

**提供主機服務提供者備份**：您可以使用裝載的資料中心做為複本網站，不需要次要資料中心。 在這種情況下,主機 SLA 需要一致地備份副本虛擬機。

在容錯移轉起始之前，複本虛擬機器會關閉，而 VSS 無法保證複本虛擬機器的應用程式一致備份。 因此，複本虛擬機器的備份只會處於絕對一致的狀態。 如果無法保證絕對一致性，備份就會失敗，下列幾種情況可能會發生這個問題：

- 複本虛擬機器的狀況不良，且情況極為嚴重。

- 複本虛擬機器正在重新同步處理 (處於重新同步處理進行中，或需要重新同步處理的狀態)。

- 主要和次要站台之間虛擬機器的初始複寫正在進行中或擱置中。

- .hrl 日誌正在應用於副本虛擬機,或者以前應用於虛擬磁碟上的 .hrl 日誌的操作失敗或已取消或中斷。

- 複本虛擬機器的移轉或容錯移轉正在進行中

## <a name="recover-backed-up-virtual-machines"></a>復原已備份的虛擬機器

當您可以復原備份的虛擬機器時，您可以使用 [復原精靈] 選取虛擬機器和特定的復原點。 若要開啟 [復原精靈] 以復原虛擬機器：

1. 在 MABS 管理員控制台中,鍵入 VM 的名稱,或展開受保護項的清單,然後選擇要恢復的 VM。

2. 在 [下列項目的復原點]**** 窗格中，按一下行事曆上的任一日期以查看可用的復原點。 接著在 [路徑]**** 窗格中，選取要在 [復原精靈] 中使用的復原點。

3. 從 [動作]**** 功能表按一下 [復原]**** 以開啟 [復原精靈]。

    您所選取的 VM 和復原點會出現在 [檢閱復原選項]**** 畫面。 按 [下一步]  。

4. 在 [選取復原類型]**** 畫面中，選取用於還原資料的位置，然後按一下 [下一步]****。

    - **復原到原始執行個體**︰當您復原到原始執行個體時，會刪除原始的 VHD。 MABS 使用超 V VSS 編寫器將 VHD 和其他設定檔恢復到原始位置。 在復原程序結束時，虛擬機器仍然具有高度可用性。
        資源群組必須存在才能復原。 如果沒有可用的資源群組，請復原至替代位置，然後讓虛擬機器具有高度可用性。

    - **作為虛擬機恢復到任何主機**:MABS 支援備用位置恢復 (ALR),它提供受保護 Hyper-V 虛擬機器的無縫恢復到不同的 Hyper-V 主機,而不受處理器架構的影響。 復原到叢集節點的 Hyper-V 虛擬機器無法具有高度可用性。 如果您選擇此選項，[復原精靈] 會顯示用於識別目的地和目的地路徑的其他畫面。

    - **複製到網路資料夾**:MABS 支援專案級恢復 (ILR),這允許您對檔案、資料夾、卷和虛擬硬碟 (VHD) 進行專案級恢復,從 Hyper-V 虛擬機器的主機級備份到受 MABS 保護的伺服器上的網路共享或卷。 MABS 保護代理不必安裝在來賓內部才能執行專案級恢復。 如果您選擇此選項，[復原精靈] 會顯示用於識別目的地和目的地路徑的其他畫面。

5. 在 [指定復原選項]**** 中設定復原選項，按一下 [下一步]****：

    - 如果您透過低頻寬復原 VM，請按一下 [修改]**** 以啟用 [網路頻寬使用節流設定]****。 開啟節流設定選項之後，您可以指定您想要使用的頻寬量和頻寬可用時間。
    - 如果您已設定網路，請選取 [使用硬體快照集啟用 SAN 型復原]****。
    - 如果您希望復原程序完成時傳送電子郵件通知，請選取 [此復原完成時傳送電子郵件]****，然後提供電子郵件地址。

6. 在 [摘要] 畫面中，確定所有詳細資料正確無誤。 如果詳細資料不正確或您想要變更，請按一下 [上一步]****。 如果您設定完成，請按一下 [復原]**** 以開始復原程序。

7. [復原狀態]**** 畫面會提供有關復原工作的資訊。

## <a name="next-steps"></a>後續步驟

[從 Azure 備份伺服器復原資料](https://docs.microsoft.com/azure/backup/backup-azure-alternate-dpm-server)
