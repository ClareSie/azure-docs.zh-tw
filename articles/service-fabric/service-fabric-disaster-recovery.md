---
title: Azure Service Fabric 嚴重損壞修復
description: Azure Service Fabric 提供處理災難的功能。 本文說明可能會發生的災害類型以及如何加以處理。
author: masnider
ms.topic: conceptual
ms.date: 08/18/2017
ms.author: masnider
ms.openlocfilehash: b29985d40ae3a1bf582099e998e000fed83460f6
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.contentlocale: zh-TW
ms.lasthandoff: 07/02/2020
ms.locfileid: "79371642"
---
# <a name="disaster-recovery-in-azure-service-fabric"></a>Azure Service Fabric 中的災害復原
提供高可用性的重要部分是確保服務可以存留所有不同類型的失敗。 對於未規劃且不在您的控制之外的失敗而言，這一點特別重要。 

本文說明一些常見的失敗模式，如果未正確地進行模型化和管理，可能會造成嚴重損壞。 它也會討論萬一發生嚴重損壞時，應採取的緩和措施和動作。 其目標是要在發生失敗、已規劃或其他情況時，限制或消除停機或資料遺失的風險。

## <a name="avoiding-disaster"></a>避免災害
Azure Service Fabric 的主要目標是協助您建立環境和服務的模型，這種方式可讓您以常見的失敗類型不會造成災難。 

一般來說，發生兩種類型的嚴重損壞/失敗案例：
- 硬體和軟體錯誤
- 操作錯誤

### <a name="hardware-and-software-faults"></a>硬體和軟體錯誤
硬體和軟體錯誤是無法預期的。 最簡單的錯誤處理方式是跨硬體或軟體錯誤界限執行更多的服務複本。 

例如，如果您的服務只在一部電腦上執行，該一部機器的失敗就是該服務的嚴重損壞。 避免這種嚴重損壞的簡單方法，是確保服務在多部電腦上執行。 您也必須進行測試，以確保一部電腦的失敗不會中斷執行中的服務。 容量規劃可確保可在其他地方建立替代實例，而降低容量並不會多載其餘的服務。 

無論您想避免的故障類型為何，相同的模式皆可發揮作用。 例如，如果您擔心 SAN 失敗，您可以跨多個 San 執行。 如果您擔心伺服器機架損失，可跨多個機架執行。 如果您擔心資料中心遺失的情況，您的服務應跨多個 Azure 區域、跨多個 Azure 可用性區域，或在您自己的資料中心之間執行。 

當服務跨越多個實體實例（機器、機架、資料中心、區域）時，您仍會受限於某些類型的同時失敗。 但是特定類型的單一甚至多個失敗（例如，單一虛擬機器或網路連結失敗）會自動處理，因此不再是「嚴重損壞」。 

Service Fabric 提供擴充叢集的機制，並處理將失敗的節點和服務重新上線。 Service Fabric 也允許執行服務的許多實例，以避免未預期的失敗進入實際的災難。

可能的原因是執行的部署夠大，而無法跨越失敗。 例如，它可能會佔用更多的硬體資源，而不是您願意支付失敗的機率。 當您處理分散式應用程式時，跨地理距離的額外通訊躍點或狀態複寫成本可能會導致無法接受的延遲。 每個應用程式繪製的此線條有所不同。 

特別針對軟體錯誤，錯誤可能是在您嘗試調整的服務中。 在此情況下，更多複本並不會阻礙嚴重損壞，因為失敗狀況會在所有實例之間相互關聯。

### <a name="operational-faults"></a>操作錯誤
即使您的服務遍布全球，具備許多備援，仍可能會遇到災難性的事件。 例如，有人可能會不小心重新設定服務的 DNS 名稱，或將其直接刪除。 

舉例來說，假設您的 Service Fabric 具狀態服務，而有人不小心刪除了該服務。 除非有其他的緩和措施，否則該服務及其所有狀態現在都會消失。 這些類型的操作災害 (「糟糕」情況) 恢復所需的緩解和步驟與一般未預期故障不同。 

避免這些操作錯誤類型的最佳方式是：
- 限制對環境的操作存取。
- 嚴格地審查危險作業。
- 強制執行自動化，防止手動或頻外變更，並在進行架構的變更之前，先對環境進行驗證。
- 確定破壞性作業為「軟」。 軟體作業不會立即生效，或可在某個時間範圍內復原。

Service Fabric 提供防止操作錯誤的機制，例如為叢集作業提供[角色型](service-fabric-cluster-security-roles.md)存取控制。 不過，大部分的操作錯誤需要投入組織化的心力以及其他系統。 Service Fabric 會提供存活作業錯誤的機制，最值得注意的是可設定[狀態服務的備份與還原](service-fabric-backuprestoreservice-quickstart-azurecluster.md)。

## <a name="managing-failures"></a>管理故障
Service Fabric 的目標是自動管理失敗。 但是，若要處理某些類型的失敗，服務必須有額外的程式碼。 基於安全和商務持續性的理由，_不_應自動解決其他類型的失敗。 

### <a name="handling-single-failures"></a>處理單一故障
單一機器可能鑒於各種原因而故障。 有時候它是硬體的原因，例如電源供應器和網路硬體故障。 其他是軟體故障， 這些包括作業系統和服務本身的失敗。 Service Fabric 會自動偵測這些類型的失敗，包括機器因網路問題而與其他電腦隔離的情況。

無論服務類型為何，如果程式碼的單一複本因故失敗，執行單一執行個體會造成該服務停機。 

若要處理任何單一失敗，最簡單的方法就是確保您的服務預設會在多個節點上執行。 針對無狀態服務，請確定 `InstanceCount` 大於1。 對於具狀態服務，最小的建議是 `TargetReplicaSetSize` 和都 `MinReplicaSetSize` 設定為3。 執行服務程式碼的多個複本可確保您的服務可自動處理任何單一失敗。 

### <a name="handling-coordinated-failures"></a>處理協調失敗
叢集中的協調失敗可能是因為計畫或非計畫的基礎結構失敗和變更，或已規劃的軟體變更所造成。 Service Fabric 會將發生協調失敗的基礎結構區域模型視為*容錯網域*。 將會遇到協調軟體變更的區域會模型化為「*升級網域*」。 如需容錯網域、升級網域和叢集拓撲的詳細資訊，請參閱[使用叢集 Resource Manager 描述 Service Fabric](service-fabric-cluster-resource-manager-cluster-description.md)叢集。

根據預設，在規劃應執行服務的位置時，Service Fabric 會考慮容錯和升級網域。 根據預設，Service Fabric 會嘗試確保您的服務會跨數個容錯和升級網域執行，因此如果發生計畫或非計畫的變更，您的服務仍可供使用。 

例如，假設電源故障導致機架上的所有機器都同時失敗。 在執行多個服務複本的情況下，容錯網域失敗中的許多電腦就會變成服務單一失敗的另一個範例。 這就是為什麼管理容錯和升級網域對於確保服務的高可用性而言非常重要。 

當您在 Azure 中執行 Service Fabric 時，系統會自動管理容錯網域和升級網域。 在其他環境中，則可能不是。 如果您要在內部部署環境中建立自己的叢集，請務必正確對應並規劃您的容錯網域配置。

升級網域適用于將同時升級軟體的模型化區域。 因此，升級網域通常也會定義在規劃的升級過程中，軟體被降低的界限。 Service Fabric 和您的服務升級皆遵循相同的模型。 如需有關輪流升級、升級網域和 Service Fabric 健全狀況模型的詳細資訊，以協助防止非預期的變更影響叢集和您的服務，請參閱：

 - [應用程式升級](service-fabric-application-upgrade.md)
 - [應用程式升級教學課程](service-fabric-application-upgrade-tutorial.md)
 - [Service Fabric 健全狀況模型](service-fabric-health-introduction.md)

您可以使用[Service Fabric Explorer](service-fabric-visualizing-your-cluster.md)中提供的叢集對應，以視覺化方式呈現叢集的版面配置：

<center>

![跨容錯網域散佈 Service Fabric Explorer 的節點][sfx-cluster-map]
</center>

> [!NOTE]
> 模型化失敗、輪流升級、執行服務程式代碼和狀態的多個實例、放置規則以確保您的服務在容錯和升級網域中執行，而內建的健全狀況監視只是 Service Fabric 提供的*一些*功能，可讓一般操作問題和失敗變成嚴重損壞。 
>

### <a name="handling-simultaneous-hardware-or-software-failures"></a>處理同時發生的硬體或軟體故障
我們已討論過單一失敗。 如您所見，只要在容錯和升級網域之間保留更多的程式碼（和狀態）複本，就能輕鬆處理無狀態和具狀態服務。 

也可能發生多個同時的隨機失敗。 這些可能會導致停機或發生實際的嚴重損壞。


#### <a name="stateless-services"></a>無狀態服務
無狀態服務的實例計數會指出需要執行的實例數目。 當任何（或所有）實例失敗時，Service Fabric 會在其他節點上自動建立取代實例來進行回應。 Service Fabric 會繼續建立取代，直到服務回到所需的實例計數為止。

例如，假設無狀態服務的 `InstanceCount` 值為-1。 此值表示一個實例應該在叢集中的每個節點上執行。 如果其中一些實例失敗，Service Fabric 會偵測到該服務不是處於預期的狀態，而且會嘗試在其遺失的節點上建立實例。

#### <a name="stateful-services"></a>具狀態服務
有兩種類型的具狀態服務：
- 具有保存狀態的具狀態。
- 具有非保存狀態的具狀態。 （狀態會儲存在記憶體中）。

從具狀態服務的失敗復原取決於具狀態服務的類型、服務擁有多少複本，以及有多少複本失敗。

在具狀態服務中，會在複本之間複寫傳入的資料（主要和任何作用中的次要資料庫）。 如果大部分複本都會收到資料，則會將資料視為*仲裁*已認可。 （針對五個複本，三個將是仲裁）。這表示在任何時間點，至少會有具有最新資料的複本仲裁。 如果複本失敗（如5中的兩個），我們可以使用仲裁值來計算是否可以復原。 （由於五個複本中剩餘的三個仍在執行中，因此保證至少有一個複本會有完整的資料）。

當複本的仲裁失敗時，資料分割會宣告為處於*仲裁遺失*狀態。 假設某個分割區有五個複本，這表示至少有三個會保證具有完整資料。 如果仲裁（三個共五個）複本失敗，Service Fabric 無法判斷剩餘的複本（二出五個）是否有足夠的資料可復原磁碟分區。 在 Service Fabric 偵測到仲裁遺失的情況下，其預設行為是防止其他寫入分割區、宣告仲裁遺失，並等候複本仲裁遭到還原。

判斷具狀態服務是否發生災難，然後進行管理，會遵循三個階段：

1. 判斷是否有仲裁遺失。
   
   當具狀態服務的大部分複本同時關閉時，會宣告仲裁遺失。
2. 判斷仲裁是否永久遺失。
   
   大多數時候，失敗是暫時性的。 系統會重新開機進程、重新開機節點、relaunched 虛擬機器，以及修復網路磁碟分割。 不過，有時失敗是永久性的。 失敗是否為永久性，取決於具狀態服務是否會保存其狀態，或是否只將其保留在記憶體中： 
   
   - 對於非持續狀態的服務，單一仲裁或多個複本的失敗會_立即_導致永久性的仲裁遺失。 當 Service Fabric 偵測到具狀態非持續服務中的仲裁遺失時，會藉由宣告 (可能) 資料遺失，立即進行步驟 3。 繼續進行資料遺失是很合理的，因為 Service Fabric 知道在等候複本返回時沒有點。 即使它們復原，資料也會因為服務的非保存性質而遺失。
   - 對於具狀態的持續性服務，仲裁或更多複本的失敗會導致 Service Fabric 等候複本返回並還原仲裁。 這會導致任何_寫入_服務的受影響分割區 (複本集) 發生服務中斷。 不過，仍然可能會有較低的一致性保證來進行讀取。 Service Fabric 等待還原仲裁的預設時間量是*無限*的，因為繼續是（潛在）資料遺失事件，並承擔其他風險。 這表示除非系統管理員採取動作來宣告資料遺失，否則 Service Fabric 不會繼續進行下一個步驟。
3. 判斷資料是否遺失，並從備份還原。

   如果已宣告仲裁遺失（自動或透過系統管理動作），則 Service Fabric 和服務會繼續判斷資料是否真的遺失。 此時，Service Fabric 也知道其他複本不會回傳。 這是停止等待自行解決仲裁遺失時會作出的決定。 服務採用的最佳方法通常是凍結，並等待特定的管理介入處理。
   
   當 Service Fabric 呼叫 `OnDataLossAsync` 方法時，它一律是因為_可疑_的資料遺失。 Service Fabric 可確保此呼叫會傳遞至_最佳_剩餘複本。 這是進度最多的複本。 
   
   我們總是說出_可疑_的資料遺失的原因是，當仲裁遺失時，其餘複本可能會有相同的狀態。 不過，如果沒有與其相比的狀態，Service Fabric 或運算子確實沒有好方法可用。     
   
   那麼，`OnDataLossAsync` 方法的典型做法是什麼？
   1. 已觸發的執行記錄 `OnDataLossAsync` ，並會引發任何必要的系統管理警示。
   1. 通常，此實作為會暫停並等候進一步的決策，以及採取手動動作。 這是因為即使備份可供使用，也可能需要備妥。 
   
      例如，如果兩個不同的服務協調資訊，則可能需要修改這些備份，以確保在進行還原之後，這兩個服務關心的資訊是一致的。 
   1. 通常會有一些其他遙測或來自服務的耗盡。 此中繼資料可能包含在其他服務或記錄中。 您可以視需要使用這項資訊來判斷在主要複本上是否有任何呼叫未出現在備份中，或複寫到此特定複本。 這些呼叫可能需要重新執行或新增至備份，才能進行還原。  
   1. 此執行會將剩餘複本的狀態與任何可用備份中所包含的狀態進行比較。 如果您使用 Service Fabric 可靠的集合，則有一些[工具和](service-fabric-reliable-services-backup-restore.md)程式可用來執行此作業。 其目標是要查看複本內的狀態是否足夠，以及查看備份可能遺失的情況。
   1. 完成比較之後，在完成還原（如有必要）之後，如果發生任何狀態變更，服務程式代碼應傳回**true** 。 如果複本判斷它是狀態的最佳可用複本，而且沒有任何變更，則程式碼會傳回**false**。 
   
      值為**true**時，表示任何_其他_剩餘複本現在可能與此不一致。 將會卸除這些複本，並從此複本重建。 值為**false**表示未進行任何狀態變更，因此其他複本可以保留其擁有的內容。 

在生產環境中部署服務之前，服務作者必須先實務可能的資料遺失和失敗案例。 若要防止資料遺失的可能性，請務必定期將任何具狀態服務的[狀態備份](service-fabric-reliable-services-backup-restore.md)到異地多餘的存放區。 

您也必須確定您能夠還原狀態。 因為許多不同服務的備份是在不同的時間進行，所以您必須確保在還原之後，您的服務會有彼此一致的觀點。 

例如，假設某個服務產生一個數位並加以儲存，然後將它傳送給另一個也儲存它的服務。 還原之後，您可能會發現第二個服務具有該號碼，但第一個沒有這麼做，因為它的備份並未包含該作業。

如果您發現剩餘複本不足以在資料遺失案例中繼續進行，而且您無法從遙測或耗盡中重建服務狀態，則備份的頻率會決定您的最佳可能復原點目標（RPO）。 Service Fabric 提供許多用來測試各種失敗案例的工具，包括需要從備份還原的永久仲裁和資料遺失。 這些案例是由錯誤分析服務所管理之 Service Fabric 中的可測試性工具所包含的一部分。 如需這些工具和模式的詳細資訊，請參閱[錯誤分析服務簡介](service-fabric-testability-overview.md)。 

> [!NOTE]
> 系統服務也可能會降低仲裁遺失。 這項影響是針對有問題的服務所造成。 例如，命名服務中的仲裁遺失會影響名稱解析，而容錯移轉管理員服務中的仲裁遺失會封鎖新服務的建立和容錯移轉。 
> 
> Service Fabric 系統服務會遵循與服務相同的模式來進行狀態管理，但我們不建議您嘗試將其移出仲裁遺失，並可能會遺失資料。 相反地，我們建議您[搜尋支援](service-fabric-support.md)以尋找以您的情況為目標的解決方案。 通常最好是等到關閉的複本返回為止。
>

#### <a name="troubleshooting-quorum-loss"></a>針對仲裁遺失進行疑難排解

複本可能會因為暫時性失敗而間歇性地關閉。 請等候一段時間，Service Fabric 嘗試讓它們啟動。 如果複本已關閉超過預期的持續時間，請遵循下列疑難排解動作：
- 複本可能會損毀。 檢查複本層級的健康情況報告和您的應用程式記錄。 收集損毀傾印，並採取必要動作來進行復原。
- 複本進程可能沒有回應。 檢查您的應用程式記錄以確認這一點。 收集進程傾印，然後停止沒有回應的進程。 Service Fabric 將會建立取代程式，並嘗試將複本帶回。
- 裝載複本的節點可能會關閉。 重新開機基礎虛擬機器，使節點上線。

有時候，可能無法復原複本。 例如，磁片磁碟機失敗，或電腦實際沒有回應。 在這些情況下，Service Fabric 需要告訴不等待複本復原。

如果*無法*接受可能的資料遺失，使服務上線，請勿使用這些方法。 在此情況下，您應該在復原實體機器時進行所有工作。

下列動作可能會導致資料遺失。 請先進行檢查，再繼續進行。
   
> [!NOTE]
> 針對特定的分割區，以目標方式來使用這些方法並_不_安全。 
>

- 使用 `Repair-ServiceFabricPartition -PartitionId` 或 `System.Fabric.FabricClient.ClusterManagementClient.RecoverPartitionAsync(Guid partitionId)` API。 此 API 可讓您指定分割區的識別碼，以移出仲裁遺失並導致資料遺失。
- 如果您的叢集經常遇到導致服務進入仲裁遺失狀態的失敗，而且可能_會有資料遺失，則_指定適當的[QuorumLossWaitDuration](https://docs.microsoft.com/powershell/module/servicefabric/update-servicefabricservice?view=azureservicefabricps)值可協助您的服務自動復原。 Service Fabric 在執行復原之前，會等待提供的 `QuorumLossWaitDuration` 值（預設值為無限）。 我們*不*建議這種方法，因為它可能會導致非預期的資料遺失。

## <a name="availability-of-the-service-fabric-cluster"></a>Service Fabric 叢集的可用性
一般來說，Service Fabric 叢集是高度分散的環境，不會有單一失敗點。 任何一個節點的失敗都不會造成叢集的可用性或可靠性問題，主要是因為 Service Fabric 系統服務遵循先前所提供的相同指導方針。 也就是說，它們一律會根據預設執行三個或多個複本，而在所有節點上執行無狀態的系統服務。 

基礎 Service Fabric 網路服務與失敗偵測層會完全分散。 大部分的系統服務可從叢集中的中繼資料重建，或了解如何從其他地方重新同步處理其狀態。 如果系統服務進入仲裁遺失的情況（如稍早所述），叢集的可用性可能會遭到入侵。 在這些情況下，您可能無法在叢集上執行特定作業（例如開始升級或部署新服務），但是叢集本身仍然啟動。 

在執行中的叢集上，服務會繼續在這些情況中執行，除非它們需要寫入系統服務才能繼續運作。 例如，如果容錯移轉管理員處於仲裁遺失的情況，所有服務都會繼續執行。 但任何失敗的服務都將無法自動重新開機，因為這需要容錯移轉管理員的參與。 

### <a name="failures-of-a-datacenter-or-an-azure-region"></a>資料中心或 Azure 區域的失敗
在罕見的情況下，實體資料中心可能會暫時無法使用，而無法失去電源或網路連線能力。 在這些情況下，在資料中心或 Azure 區域中的 Service Fabric 叢集和服務將無法使用。 不過，_您的資料會保留下來_。 

對於在 Azure 中執行的叢集，您可以在 [Azure 狀態頁面][azure-status-dashboard]上檢視中斷的更新。 在極不可能的情況下，實體資料中心已部分或完全終結，任何裝載于該處的 Service Fabric 叢集，或其中的服務可能會遺失。 這種遺失包括任何未在該資料中心或區域之外備份的狀態。

有兩個不同的策略可在單一資料中心或區域的永久或持續性失敗後存活： 

- 在多個這類區域中執行不同的 Service Fabric 叢集，並使用一些機制來進行這些環境之間的容錯移轉和容錯回復。 這類多叢集主動/主動或主動/被動模型需要額外的管理和操作程式碼。 此模型也需要協調單一資料中心或區域中服務的備份，使其在其他資料中心或區域失敗時可供使用。 
- 執行跨越多個資料中心或區域的單一 Service Fabric 叢集。 此策略的最低支援設定為三個資料中心或區域。 建議的區域或資料中心數目為五個。 
  
  此模型需要更複雜的叢集拓撲。 不過，優點是一個資料中心或區域的失敗會從嚴重損壞轉換成正常失敗。 可藉由在單一區域內為叢集運作的機制來處理這些失敗。 容錯網域、升級網域和 Service Fabric 放置規則可確保工作負載已散發，使其容許正常失敗。 
  
  如需可協助在這種類型的叢集中操作服務之原則的詳細資訊，請參閱[Service Fabric 服務的放置原則](service-fabric-cluster-resource-manager-advanced-placement-rules-placement-policies.md)。

### <a name="random-failures-that-lead-to-cluster-failures"></a>導致叢集失敗的隨機失敗
Service Fabric 具有*種子節點*的概念。 種子節點是維護基礎叢集可用性的節點。 

種子節點有助於確保叢集會藉由建立與其他節點的租用，並在特定類型的失敗期間做為決勝局而保持運作。 如果隨機失敗會移除叢集中大部分的種子節點，而且它們不會快速恢復，您的叢集就會自動關閉。 然後叢集就會失敗。 

在 Azure 中，Service Fabric 資源提供者會管理 Service Fabric 叢集設定。 根據預設，資源提供者會在*主要節點類型*的容錯和升級網域之間散發種子節點。 如果主要節點類型標示為銀級或金級持久性，則當您移除種子節點（藉由在主要節點類型中調整或手動移除它）時，叢集會嘗試從主要節點類型的可用容量升級另一個非種子節點。 如果您的主要節點類型所需的容量低於叢集可靠性層級，則此嘗試會失敗。

在獨立 Service Fabric 叢集和 Azure 中，主要節點類型是執行種子的節點。 當您定義主要節點類型時，Service Fabric 會自動利用最多9個種子節點和每個系統服務的七個複本所提供的節點數目。 如果一組隨機失敗同時耗用大部分的複本，系統服務將會進入仲裁遺失。 如果大多數種子節點遺失，叢集將在不久後關閉。

## <a name="next-steps"></a>後續步驟
- 瞭解如何使用可[測試性架構](service-fabric-testability-overview.md)來模擬各種失敗。
- 閱讀其他災害復原和高可用性的資源。 Microsoft 已發佈大量有關這些主題的指引。 雖然其中一些資源是指在其他產品中使用的特定技術，但它們包含許多您可以在 Service Fabric 內容中套用的一般最佳作法：
  - [可用性檢查清單](/azure/architecture/checklist/resiliency-per-service)
  - [執行災害復原演練](../sql-database/sql-database-disaster-recovery-drills.md)
  - [Azure 應用程式的災害復原和高可用性][dr-ha-guide]
- 了解 [Service Fabric 支援選項](service-fabric-support.md)。


<!-- External links -->

[repair-partition-ps]: https://msdn.microsoft.com/library/mt163522.aspx
[azure-status-dashboard]:https://azure.microsoft.com/status/
[azure-regions]: https://azure.microsoft.com/regions/
[dr-ha-guide]: https://msdn.microsoft.com/library/azure/dn251004.aspx


<!-- Images -->

[sfx-cluster-map]: ./media/service-fabric-disaster-recovery/sfx-clustermap.png
