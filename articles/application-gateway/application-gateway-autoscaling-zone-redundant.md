---
title: 自動調整規模和區域備援應用程式閘道 v2
description: 本文介紹 Azure 應用程式 Standard_v2 和 WAF_v2 SKU，其中包括自動調整和區域多餘的功能。
services: application-gateway
author: vhorne
ms.service: application-gateway
ms.topic: article
ms.date: 03/24/2020
ms.author: victorh
ms.custom: fasttrack-edit
ms.openlocfilehash: 74af3d14512018abc216b288a27dc54ed806d8c9
ms.sourcegitcommit: a8ee9717531050115916dfe427f84bd531a92341
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 05/12/2020
ms.locfileid: "83125225"
---
# <a name="autoscaling-and-zone-redundant-application-gateway-v2"></a>自動調整規模和區域備援應用程式閘道 v2 

應用程式閘道和 Web 應用程式防火牆（WAF）也適用于 Standard_v2 和 WAF_v2 SKU。 V2 SKU 提供效能增強功能，並新增對靜態 Vip 的自動調整、區域冗余和支援等重要新功能的支援。 標準和 WAF SKU 下的現有功能會繼續在新的 v2 SKU 中受到支援，但[比較](#differences-with-v1-sku)一節中會列出一些例外狀況。

新的 v2 SKU 包含下列增強功能：

- **自動調整規模**：自動調整規模 SKU 下的「應用程式閘道」或 WAF 部署可以根據變動的流量負載模式來調升或調降規模。 自動調整規模也可讓您在佈建時，無須選擇部署大小或執行個體計數。 此 SKU 提供真正的彈性。 在 Standard_v2 和 WAF_v2 SKU 中，應用程式閘道可在固定容量（停用自動調整）和自動調整啟用模式中運作。 固定容量模式適用於工作負載一致且可預測的案例。 自動調整模式對於在應用程式流量中看到變異數的應用程式很有説明。
- **區域冗余**：應用程式閘道或 WAF 部署可以跨越多個可用性區域，而不需要在每個區域中使用流量管理員布建個別的應用程式閘道實例。 您可以選擇一個區域或多個區域，其中部署了應用程式閘道實例，讓區域失敗更有彈性。 應用程式的後端集區可以均等分散在可用性區域間。

  區域冗余僅適用于可使用 Azure 區域的位置。 在其他區域中，則支援所有其他功能。 如需詳細資訊，請參閱[Azure 中的區域和可用性區域](../availability-zones/az-overview.md)
- **靜態 vip**：應用程式閘道 v2 SKU 僅支援靜態 vip 類型。 這可確保與應用程式閘道相關聯的 VIP 不會在部署的生命週期內變更，即使在重新開機之後也一樣。  V1 中沒有靜態 VIP，因此您必須使用應用程式閘道 URL，而不是功能變數名稱路由的 IP 位址，以透過應用程式閘道應用程式服務。
- **標頭重寫**：應用程式閘道可讓您使用 v2 SKU 來新增、移除或更新 HTTP 要求和回應標頭。 如需詳細資訊，請參閱[使用應用程式閘道重寫 HTTP 標頭](rewrite-http-headers.md)
- **Key Vault 整合**：應用程式閘道 v2 針對附加至啟用 HTTPS 之接聽程式的伺服器憑證，支援與 Key Vault 的整合。 如需詳細資訊，請參閱[使用 Key Vault 憑證的 TLS 終止](key-vault-certs.md)。
- **Azure Kubernetes Service 輸入控制器**：應用程式閘道 V2 輸入控制器可讓 Azure 應用程式閘道作為 AZURE KUBERNETES SERVICE （AKS）的輸入，稱為 AKS 叢集。 如需詳細資訊，請參閱[什麼是應用程式閘道輸入控制器？](ingress-controller-overview.md)。
- **效能增強**：相較于標準/WAF sku，v2 SKU 提供最多5倍的 TLS 卸載效能。
- **更快速的部署和更新時間**相較于標準/WAF SKU，v2 SKU 可提供更快速的部署和更新時間。 這也包括 WAF 設定變更。

![](./media/application-gateway-autoscaling-zone-redundant/application-gateway-autoscaling-zone-redundant.png)

## <a name="supported-regions"></a>支援區域

Standard_v2 和 WAF_v2 SKU 適用于下欄區域：美國中北部、美國中南部、美國西部、美國西部2、美國東部、美國東部2、美國中部、北歐、西歐、東南亞、法國中部、英國西部、日本東部、日本西部、澳大利亞東部、澳大利亞東南部、巴西南部、加拿大中部、加拿大東部、東亞、韓國中部、南韓南部、英國南部、印度中部、印度西部、印度南部。

## <a name="pricing"></a>定價

使用 v2 SKU，計價模式會以耗用量來驅動，不再附加至實例計數或大小。 V2 SKU 定價有兩個元件：

- **固定價格**-這是布建 Standard_v2 或 WAF_v2 閘道的每小時（或部分小時）價格。 請注意，0個額外的最低實例仍會確保服務的高可用性，一律包含固定價格。
- **容量單位價格**-這是以耗用量為基礎的成本，除了固定成本之外，也會收取費用。 容量單位費用也會每小時或每小時計算一次。 容量單位有三個維度：計算單位、持續連線和輸送量。 「計算單位」是已耗用多少處理器容量的量值。 影響計算單位的因素包括 TLS 連線數/秒、URL 重寫計算，以及 WAF 規則處理。 持續連線是在給定的計費間隔中，針對應用程式閘道建立的 TCP 連線量值。 輸送量是系統在指定計費間隔中處理的平均每秒 Mb 數。  計費是針對保留實例計數以上的任何專案，在容量單位層級上完成。

每個容量單位最多包含：1個計算單位，或2500持續連線，或 2.22-Mbps 輸送量。

計算單位指引：

- **Standard_v2** -每個計算單位能夠使用 RSA 2048 位金鑰 TLS 憑證，每秒大約有50個連線。
- **WAF_v2** -每個計算單位每秒可支援大約10個並行要求，適用于70-30% 的流量混合，其70% 要求小於 2 KB 的 GET/POST，而剩餘的則較高。 目前的回應大小不會影響 WAF 效能。

> [!NOTE]
> 每個實例目前可支援大約10個容量單位。
> 計算單位可以處理的要求數目取決於各種準則，例如 TLS 憑證金鑰大小、金鑰交換演算法、標頭重寫，以及 WAF 傳入要求大小。 我們建議您執行應用程式測試，以判斷每個計算單位的要求率。 在計費開始之前，容量單位和計算單位都會以度量的形式提供。

下表顯示範例價格，僅供說明之用。

**美國東部的價格**：

|              SKU 名稱                             | 固定價格（$/小時）  | 容量單位價格（$/CU-hr）   |
| ------------------------------------------------- | ------------------- | ------------------------------- |
| Standard_v2                                       |    0.20             | 0.0080                          |
| WAF_v2                                            |    0.36             | 0.0144                          |

如需更多定價資訊，請參閱[定價頁面](https://azure.microsoft.com/pricing/details/application-gateway/)。 

**範例 1**

應用程式閘道 Standard_v2 是在手動調整模式下布建，但有5個實例的固定容量。

固定價格 = 744 （小時） * $0.20 = $148。8 <br>
容量單位 = 744 （小時） * 每個實例10個容量單位 * 5 個實例 * $0.008 每個容量單位小時 = $297。6

總價格 = $148.8 + $297.6 = $446。4

**範例 2**

應用程式閘道 standard_v2 是針對一個月布建，最少個實例，而在這段期間內，它會收到25個新的 TLS 連線/秒，平均 8.88-Mbps 的資料傳輸。 假設連線的存留期很短，您的價格將會是：

固定價格 = 744 （小時） * $0.20 = $148。8

容量單位價格 = 744 （小時） * 最大值（25/50 每秒的計算單位數，8.88/2.22 的輸送量單位） * $0.008 = 744 * 4 * 0.008 = $23.81

總價 = $ 148.8 + 23.81 = $172.61

如您所見，您只需支付四個容量單位，而不是整個實例的費用。 

> [!NOTE]
> Max 函數會傳回一對值中的最大值。


**範例 3**

應用程式閘道 standard_v2 會布建一個月，最少五個實例。 假設沒有任何流量和連線短暫，您的價格將會是：

固定價格 = 744 （小時） * $0.20 = $148。8

容量單位價格 = 744 （小時） * Max （每秒連線的0/50 計算單位數，0/2.22 容量單位，輸送量） * $0.008 = 744 * 50 * 0.008 = $297.60

總價 = $ 148.80 + 297.60 = $446。4

在此情況下，即使沒有流量，您仍需支付五個實例的整體費用。

**範例 4**

應用程式閘道 standard_v2 會布建一個月，最少五個實例，但這次平均為 125-mbps 資料傳輸，每秒25個 TLS 連線。 假設沒有任何流量和連線短暫，您的價格將會是：

固定價格 = 744 （小時） * $0.20 = $148。8

容量單位價格 = 744 （小時） * 最大值（每秒連線的25/50 計算單位數，125/2.22 容量單位，輸送量） * $0.008 = 744 * 57 * 0.008 = $339.26

總價 = $ 148.80 + 339.26 = $488.06

在此情況下，系統會向您收取完整的五個實例費用，加上7個容量單位（實例的7/10）。  

**範例 5**

一個月會布建一個應用程式閘道 WAF_v2。 在這段期間，它會收到25個新的 TLS 連線/秒，平均 8.88-Mbps 的資料傳輸，每秒80個要求。 假設連線很短，且應用程式的計算單位計算支援每個計算單位10個 RPS，則您的價格會是：

固定價格 = 744 （小時） * $0.36 = $267.84

容量單位價格 = 744 （小時） * 最大值（每秒的計算單位數上限（25/50 個）、80/10 WAF RPS）、8.88/2.22 容量單位（輸送量） * $0.0144 = 744 * 8 * 0.0144 = $85.71

總價格 = $267.84 + $85.71 = $353.55

> [!NOTE]
> Max 函數會傳回一對值中的最大值。

## <a name="scaling-application-gateway-and-waf-v2"></a>調整應用程式閘道和 WAF v2

應用程式閘道和 WAF 可設定為以兩種模式進行調整：

- 自動**調整-啟用**自動調整後，應用程式閘道和 WAF v2 sku 會根據應用程式流量需求相應增加或減少。 此模式可為您的應用程式提供更好的彈性，並讓您不必猜測應用程式閘道大小或實例計數。 此模式也可讓您節省成本，而不需要閘道以尖峰布建容量執行，以達到預期的最大流量負載。 您必須指定最小和選擇性的最大實例計數。 最小容量可確保應用程式閘道和 WAF v2 不會低於所指定的最小實例計數（即使在沒有流量的情況下）。 每個實例大約等於10個額外的保留容量單位。 零表示沒有保留容量，而且在本質上純粹是自動調整。 您也可以選擇性地指定 [最大實例計數]，以確保應用程式閘道不會擴展超過指定的實例數目。 您只需支付閘道所服務的流量。 實例計數的範圍可以從0到125。 如果未指定，則 [最大實例計數] 的預設值為20。
- **手動**-您也可以選擇 [手動模式]，閘道不會自動調整。 在此模式中，如果流量超過應用程式閘道或 WAF 可處理的流量，可能會導致流量遺失。 使用手動模式時，必須指定實例計數。 實例計數可能會因1到125實例而異。

## <a name="autoscaling-and-high-availability"></a>自動調整和高可用性

Azure 應用程式閘道一律會以高可用性的方式部署。 此服務是由多個實例所建立（如果已停用自動調整），或應用程式負載所需（如果已啟用自動調整）。 請注意，從使用者的觀點來看，您不一定會看到個別的實例，而只是放入應用程式閘道服務整體。 如果某個實例發生問題並停止運作，Azure 應用程式閘道將會以透明的方式建立新的實例。

請注意，即使您以零個最小實例設定自動調整，服務仍會是高可用性，這一律會包含在固定價格中。

不過，建立新的實例可能需要一些時間（大約六到七分鐘）。 因此，如果您不想要處理此停機時間，您可以將最小實例計數設定為2，最好是可用性區域支援。 如此一來，在正常情況下，您的 Azure 應用程式閘道內至少會有兩個實例，因此如果其中一個發生問題，則會在建立新實例時，嘗試處理流量。 請注意，Azure 應用程式閘道實例可支援大約10個容量單位，因此，根據您通常會想要將最小實例自動調整設定值設為高於2的流量而定，您可能會有多少個流量。

## <a name="feature-comparison-between-v1-sku-and-v2-sku"></a>V1 SKU 和 v2 SKU 之間的功能比較

下表比較每個 SKU 可用的功能。

|                                                   | v1 SKU   | v2 SKU   |
| ------------------------------------------------- | -------- | -------- |
| 自動調整                                       |          | &#x2713; |
| 區域備援                                   |          | &#x2713; |
| 靜態 VIP                                        |          | &#x2713; |
| Azure Kubernetes Service （AKS）輸入控制器 |          | &#x2713; |
| Azure 金鑰保存庫整合                       |          | &#x2713; |
| 重寫 HTTP （S）標頭                           |          | &#x2713; |
| URL 型路由                                 | &#x2713; | &#x2713; |
| 多網站裝載                             | &#x2713; | &#x2713; |
| 流量重新導向                               | &#x2713; | &#x2713; |
| Web 應用程式防火牆 (WAF)                    | &#x2713; | &#x2713; |
| WAF 自訂規則                                  |          | &#x2713; |
| 傳輸層安全性（TLS）/Secure 通訊端層（SSL）終止            | &#x2713; | &#x2713; |
| 端對端 TLS 加密                         | &#x2713; | &#x2713; |
| 工作階段親和性                                  | &#x2713; | &#x2713; |
| 自訂錯誤頁面                                | &#x2713; | &#x2713; |
| WebSocket 支援                                 | &#x2713; | &#x2713; |
| HTTP/2 支援                                    | &#x2713; | &#x2713; |
| 清空連線                               | &#x2713; | &#x2713; |

> [!NOTE]
> 自動調整 v2 SKU 現在支援[預設健康情況探查](application-gateway-probe-overview.md#default-health-probe)，以自動監視其後端集區中所有資源的健全狀況，並反白顯示視為狀況不良的後端成員。 預設健全狀況探查會針對沒有任何自訂探查設定的後端自動設定。 若要深入瞭解，請參閱[應用程式閘道中的健康情況探查](application-gateway-probe-overview.md)。

## <a name="differences-with-v1-sku"></a>V1 SKU 的差異

|差異|詳細資料|
|--|--|
|驗證憑證|不支援。<br>如需詳細資訊，請參閱[使用應用程式閘道的端對端 TLS 總覽](ssl-overview.md#end-to-end-tls-with-the-v2-sku)。|
|在相同子網路上混合使用 Standard_v2 和標準應用程式閘道|不支援|
|應用程式閘道子網上的使用者定義路由（UDR）|支援（特定案例）。 處於預覽狀態。<br> 如需有關支援案例的詳細資訊，請參閱[應用程式閘道設定總覽](configuration-overview.md#user-defined-routes-supported-on-the-application-gateway-subnet)。|
|輸入連接埠範圍的 NSG| - Standard_v2 SKU 適用 65200 至 65535<br>- 標準 SKU 適用 65503 至 65534<br>如需詳細資訊，請參閱[常見問題集](application-gateway-faq.md#are-network-security-groups-supported-on-the-application-gateway-subnet)。|
|Azure 診斷中的效能記錄|不支援。<br>應該使用 Azure 計量。|
|計費|排程于2019年7月1日開始計費。|
|FIPS 模式|目前不支援。|
|純 ILB 模式|目前不支援。 支援將公用與 ILB 模式搭配使用。|
|網路監看員整合|不支援。|
|Azure 資訊安全中心整合|尚未提供。

## <a name="migrate-from-v1-to-v2"></a>從 v1 遷移至 v2

PowerShell 資源庫中有提供 Azure PowerShell 腳本，可協助您從 v1 應用程式閘道/WAF 遷移至 v2 自動調整 SKU。 此腳本可協助您從 v1 閘道複製設定。 流量遷移仍是您的責任。 如需詳細資訊，請參閱[將 Azure 應用程式閘道從 V1 遷移至 v2](migrate-v1-v2.md)。

## <a name="next-steps"></a>後續步驟

- [快速入門：使用 Azure 應用程式閘道引導網路流量 - Azure 入口網站](quick-create-portal.md)
- [使用 Azure PowerShell 建立具有保留虛擬 IP 位址的自動調整規模、區域備援應用程式閘道](tutorial-autoscale-ps.md)
- 深入了解[應用程式閘道](overview.md)。
- 深入了解 [Azure 防火牆](../firewall/overview.md)。
