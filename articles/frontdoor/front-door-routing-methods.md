---
title: Azure Front Door 流量路由方法 |Microsoft Docs
description: 本文將協助您了解 Front Door 所使用的不同流量路由方法
services: front-door
documentationcenter: ''
author: duongau
ms.service: frontdoor
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 09/28/2020
ms.author: duau
ms.openlocfilehash: 2bc056620ff964747dfd83e7525cb5bfd2eb8e52
ms.sourcegitcommit: 3792cf7efc12e357f0e3b65638ea7673651db6e1
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/29/2020
ms.locfileid: "91449142"
---
# <a name="front-door-routing-methods"></a>Front Door 路由方法

Azure Front Door 支援不同類型的流量路由方法，以決定如何將 HTTP/HTTPS 流量路由傳送至不同的服務端點。 當您的用戶端要求到達 Front Door 時，會套用設定的路由方法，以確保將要求轉送至最佳的後端實例。 

Front Door 中提供四種流量路由方法：

* **[延遲](#latency)：** 延遲式路由會確保將要求傳送至敏感度範圍中可接受的最低延遲後端。 基本上，您的使用者要求會根據網路延遲，傳送至「最靠近」的後端集。
* **[優先順序](#priority)：** 當您想要設定主要後端來服務所有流量時，您可以將優先順序指派給您的後端。 次要後端可以是備份，以防主要後端變成無法使用。
* **[加權](#weighted)：** 當您想要將流量分散到一組後端時，可以將加權指派給後端。 您是否想要平均分配或根據加權係數。
* **[會話親和性](#affinity)：** 您可以為前端主機或網域設定會話親和性，以確保來自相同終端使用者的要求會傳送至相同的後端。

所有 Front Door 設定皆包含後端健康狀態監視及自動化的即時全域容錯移轉。 如需詳細資訊，請參閱 [Front Door 後端監視](front-door-health-probes.md)。 您的 Front Door 可以根據單一路由方法運作。 但視您的應用程式需求而定，您也可以結合多個路由方法來建立最佳的路由拓撲。

## <a name="lowest-latencies-based-traffic-routing"></a><a name = "latency"></a>最低延遲式流量路由

將後端部署到全球的兩個或更多個位置，可以藉由將流量路由傳送至最接近使用者的目的地，來改善應用程式的回應能力。 Front Door 設定的預設流量路由方法會將要求從終端使用者轉送到最近收到要求的 Front Door 環境的後端。 這種方法結合了 Azure Front Door 的任意傳播架構，可確保每位使用者都能根據其位置來取得最大的效能。

「最靠近」的後端不一定是地理距離測量的最接近。 相反的，Front Door 會透過測量網路延遲來決定最靠近的後端。 深入了解 [Front Door 的路由架構](front-door-routing-architecture.md)。 

以下是整體的決策流程：

| 可用後端 | 優先順序 | 延遲訊號 (以健康狀態探查為基礎) | 加權 |
|-------------| ----------- | ----------- | ----------- |
| 首先，選取已啟用的所有後端，並傳回健全狀況探查的健康 (200 OK) 。 如果有六個後端 A、B、C、D、E 和 F，其中 C 是狀況不良且 E 已停用。 可用後端的清單為 A、B、D 和 F。  | 接下來，會選取可用專案之間的最高優先順序後端。 如果後端 A、B 和 D 的優先順序為1，且後端 F 的優先順序為2。 然後，選取的後端會是 A、B 和 D。| 選取具有延遲範圍的後端 (以毫秒指定最低延遲及延遲敏感度)。 如果後端 A 為15毫秒，B 為30毫秒，而 D 是60毫秒離開要求進入的 Front Door 環境，而延遲敏感度為30毫秒，則最低延遲集區是由後端 A 和 B 所組成，因為 D 超出離最接近的後端的30毫秒。 | 最後，Front Door 會在最終選取的後端集區中，根據指定權數比例循環配置流量。 假設後端 A 的權數為 5，後端 B 的權數為 8，則流量會在 A 和 B 間以 5:8 的比例進行分散。 |

>[!NOTE]
> 根據預設，延遲敏感度屬性會設為 0 毫秒，表示一律將要求轉送至最快的可用後端。

## <a name="priority-based-traffic-routing"></a><a name = "priority"></a>優先順序式流量路由

組織通常會想要藉由部署多個備份服務來為其服務提供高可用性，以防主要複本停止運作。 在業界中，此拓撲也稱為拓撲「使用中/待命」或「主動/被動」部署拓撲。 「優先順序」流量路由方法可讓 Azure 客戶輕鬆實作此容錯移轉模式。

您的預設 Front Door 包含後端清單，其中每個後端都具有相同的優先順序。 根據預設，Front Door 只會將流量傳送到優先順序最高的後端 (優先順序值最低)，即後端的主要集合。 如果無法使用主要後端，Front Door 會將流量路由至次要後端集 (第二個最低值，以進行優先順序) 。 如果主要和次要後端都無法使用，流量會移至第三個，依此類推。 後端的可用性是以設定狀態 (啟用或停用) 及健康狀態探查判斷的進行中後端健康狀態為基礎。

### <a name="configuring-priority-for-backends"></a>設定後端優先順序

Front Door 設定的後端集區中的每個後端都有一個稱為「Priority」的屬性，它可以是介於1到5之間的數位。 使用 Azure Front Door，您可以為每個後端明確地使用這個屬性來設定後端優先順序。 此屬性的值介於 1 到 5 之間。 值越低代表優先順序越高。 後端可以共用優先順序值。

## <a name="weighted-traffic-routing-method"></a><a name = "weighted"></a>加權流量路由方法
「加權」流量路由方法可讓您平均分散流量，或使用預先定義的權數。

在加權流量路由方法中，您需要在您後端集區的 Front Door 設定中為每個後端指派權數。 權數是從 1 到 1000 的整數。 此參數使用預設權數 '50'。

使用具有可接受之延遲敏感度的可用後端清單時，會使用指定的權數比例，以迴圈配置資源機制來散發流量。 如果延遲敏感度設定為0毫秒，則除非有兩個具有相同網路延遲的後端，否則此屬性不會生效。 

加權方法支援一些實用的案例︰

* **漸進式應用程式升級**：提供路由傳送到新後端的流量百分比，並隨時間逐漸增加流量，以使其與其他後端。
* **應用程式移轉至 Azure**︰建立具有 Azure 和外部後端的後端集區。 調整後端的權數來優先使用新的後端。 您可以從停用新後端，再將最低權數指派給它們，並緩慢增加到使其接收最多流量的層級，來逐漸設定。 接著最後再停用較不慣用的後端，並從集區移除它們。  
* **額外容量的雲端高載**：透過將其放在 Front Door 之後，使內部部署快速展開至雲端。 當您需要在雲端中增加額外容量時，您可以新增或啟用更多後端並指定進入每個後端的流量比例。

## <a name="session-affinity"></a><a name = "affinity"></a>會話親和性
依預設，如果沒有會話親和性，Front Door 會將源自相同用戶端的要求轉送至不同的後端。 某些具狀態應用程式或在某些情況下，來自相同使用者的要求會優先于處理初始要求的相同後端。 當您想要在同一個後端保留使用者工作階段時，以 Cookie 為基礎的工作階段親和性非常有用。 Azure Front Door 可以使用受控 cookie，將來自使用者會話的後續流量導向至相同的後端進行處理。

工作階段親和性可在每個您設定網域 (或子網域) 的前端主機層級中啟用。 啟用之後，Front Door 便會將 Cookie 新增到使用者的工作階段。 根據 Cookie 的工作階段親和性可讓 Front Door 識別不同使用者 (即使使用者位於相同 IP 位址之後)，在您的不同後端間進行更平均的流量分散。

Cookie 的存留期與使用者工作階段相同，因為 Front Door 目前僅支援工作階段 Cookie。 

> [!NOTE]
> 公用 Proxy 可能會影響工作階段親和性。 這是因為建立工作階段需要 Front Door 將工作階段親和性 Cookie 新增至回應，因此若可針對回應進行快取，便會中斷要求相同資源的其他用戶端 Cookie。 為了避免此問題，工作階段親和性**不會**在後端嘗試傳送可快取的回應時建立。 若工作階段已建立，則無論來自後端的回應是否可進行快取，皆不會造成影響。
> **除非**回應具備 HTTP 304 狀態代碼，否則工作階段親和性便會在下列情況下建立：
> - 回應具有針對標頭設定的特定值，以防止快取 ```Cache-Control``` ，例如「私用」或「非存放區」。
> - 回應包含尚未過期的 ```Authorization``` 標頭。
> - 回應具備 HTTP 302 狀態代碼。

## <a name="next-steps"></a>後續步驟

- 了解如何[建立 Front Door](quickstart-create-front-door.md)。
- 了解 [Front Door 的運作方式](front-door-routing-architecture.md)。
