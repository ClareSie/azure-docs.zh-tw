---
title: 最佳實作 - Azure 批次處理
description: 瞭解開發 Azure Batch 解決方案的最佳做法和有用提示。
author: LauraBrenner
ms.author: labrenne
ms.date: 11/22/2019
ms.service: batch
ms.topic: article
manager: evansma
ms.openlocfilehash: ea5cd8012324cc0727a46308f4d5621f2ce40727
ms.sourcegitcommit: 632e7ed5449f85ca502ad216be8ec5dd7cd093cb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/30/2020
ms.locfileid: "80397934"
---
# <a name="azure-batch-best-practices"></a>Azure 批次處理最佳實作

本文討論了有效和高效地使用 Azure Batch 服務的最佳做法的集合。 這些最佳實務源自我們在 Batch 方面的經驗和 Batch 客戶的經驗。 請務必瞭解本文,以避免在為 Batch 開發和使用 Batch 時設計缺陷、潛在的性能問題和反模式。

在本文中，您將了解：

> [!div class="checklist"]
> - 最佳實踐是什麼?
> - 為什麼要使用最佳實務
> - 如果您未能遵循最佳實踐,會發生什麼情況
> - 如何遵循最佳實踐

## <a name="pools"></a>集區

批次處理池是用於在批次處理服務上執行作業的計算資源。 以下各節提供有關使用 Batch 池時應遵循的頂級最佳實踐的指導。

### <a name="pool-configuration-and-naming"></a>池設定與命名

- **池分配模式**  
    建立 Batch 帳號時,可以選擇兩種池分配模式:**批次管理或****使用者訂閱**。 在大多數情況下,應使用預設 Batch 服務模式,其中池在批處理託管訂閱中後台分配。 在其他使用者訂用帳戶模式中，在建立集區時，會直接在您的訂用帳戶中建立 Batch VM 和其他資源。 使用者訂閱帳戶主要用於啟用重要但很小的方案子集。 您可以在[使用者訂閱模式的其他配置中閱讀更多有關使用者訂閱模式](batch-account-create-portal.md#additional-configuration-for-user-subscription-mode)的訂閱模式。

- **在確定作業到池映射時,請考慮作業和任務運行時間。**  
    如果作業主要由短運行任務組成,並且預期的總任務計較小,因此作業的總體預期運行時間不長,請不要為每個作業分配新池。 節點的分配時間將減少作業的運行時。

- **池應具有多個計算節點。**  
    不能保證單個節點始終可用。 硬體故障、操作系統更新和許多其他問題都會導致單個節點脫機,雖然這種情況並不常見。 如果 Batch 工作負荷需要確定性、有保證的進度,則應分配具有多個節點的池。

- **不要重用資源名稱。**  
    批次處理資源(作業、池等)經常隨時間推來往往。 例如,您可以在星期一創建池,在星期二刪除它,然後在星期四創建另一個池。 您創建的每個新資源都應獲得以前未使用的唯一名稱。 這可以通過使用 GUID(作為整個資源名稱,或作為資源的一部分)或嵌入在資源名稱中創建資源的時間來實現。 Batch 支援[DisplayName](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.jobspecification.displayname?view=azure-dotnet),它可用於為資源指定一個可讀的可讀名稱,即使實際資源 ID 不是對人類友好的東西。 使用唯一名稱可以更輕鬆地區分哪些特定資源在日誌和指標中做了某些操作。 如果您必須為資源提交支援案例,它還會消除歧義。

- **池維護和故障期間的連續性。**  
    最好讓作業動態使用池。 如果您的作業對一切使用相同的池,則如果池出現問題,您的作業很可能不會運行。 這對時間敏感的工作負載尤其重要。 要解決此問題,請在計劃每個作業時動態選擇或創建池,或者有一種方法來覆蓋池名稱,以便繞過不正常的池。

- **池維護和故障期間的業務連續性**  
    有許多可能的原因可能阻止池增長到所需的大小,例如內部錯誤、容量限制等。因此,您應該準備好在不同的池中重新置放作業(可能具有不同的 VM 大小 - Batch 在必要時透過[UpdateJob](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.protocol.joboperationsextensions.update?view=azure-dotnet)支援此功能)。 避免使用靜態池 ID,希望它永遠不會被刪除,永遠不會更改。

### <a name="pool-lifetime-and-billing"></a>池存留期和計費

池存留期可能因分配方法和應用於池配置的選項而異。 池可以具有任意存留期和池中任何時間點中數量不同的計算節點。 您有責任顯式或通過服務(自動縮放或自動池)提供的功能管理池中的計算節點。

- **保持池新鮮。**  
    應每隔幾個月將池大小調整到零,以確保獲得最新的節點代理更新和錯誤修復。 池不會接收節點代理更新,除非重新創建,或調整為 0 個計算節點。 在重新建立或調整池大小之前,建議下載任何節點代理日誌以進行調試,如[「節點」](#nodes)部分所述。

- **池重新建立**  
    同樣,不建議每天刪除和重新創建池。 相反,請創建新池,更新現有作業以指向新池。 將所有任務移動到新池后,刪除舊池。

- **池效率和計費**  
    批次不會產生額外費用,但您確實會為所使用的計算資源產生費用。 無論池中的每個計算節點處於何種狀態,您都會按該節點計費。 這包括節點運行所需的任何費用,如存儲和網路成本。 要瞭解更多最佳做法,請參閱[Azure 批次處理的成本分析和預算](budget.md)。

### <a name="pool-allocation-failures"></a>池分配失敗

在第一次分配或後續調整調整期間,池分配失敗隨時可能發生。 這可能是由於區域中臨時耗盡的容量或 Batch 所依賴的其他 Azure 服務中的故障。 您的核心配額不是保證,而是限制。

### <a name="unplanned-downtime"></a>非計劃性停機

批次處理池在 Azure 中可能會遇到停機事件。 在為 Batch 規劃和開發方案或工作流時,請務必記住這一點。

如果節點發生故障,Batch 會自動嘗試代表您恢復這些計算節點。 這可能會觸發重新安排恢復的節點上的任何正在運行的任務。 請參閱[設計重試](#designing-for-retries-and-re-execution)以瞭解有關中斷任務的更多詳細資訊。

- **Azure 區域相依項**  
    如果您有時間敏感或生產工作負荷,建議不要依賴於單個 Azure 區域。 雖然很少,但有些問題可能會影響整個區域。 例如,如果處理需要在特定時間開始,請考慮*在開始時間之前*擴展主區域中的池。 如果該池規模失敗,您可以回落到向上擴展備份區域(或區域)中的池。 跨不同區域的多個帳戶的池提供了一個現成的、易於訪問的備份,如果另一個池出現問題。 有關詳細資訊,請參閱[為高可用性設計應用程式](high-availability-disaster-recovery.md)。

## <a name="jobs"></a>工作

作業是一個容器,旨在包含數百、數千甚至數百萬個任務。

- **將許多工作放入工作中**  
    使用作業運行單個任務的效率很低。 例如,使用包含 1000 個任務的單個作業比創建包含 10 個作業的作業更有效。 運行 1000 個作業(每個作業都有一個任務)將是效率最低、最慢、成本最高的方法。  

    不要設計需要同時數千個活動作業的 Batch 解決方案。 沒有工作的配額,因此在盡可能少的工作下執行盡可能多的任務,可以有效地使用[工作和作業計劃配額](batch-quota-limit.md#resource-quotas)。

- **工作生命週期**  
    Batch 作業具有無限期的存留期,直到從系統中刪除為止。 作業的狀態指定是否可以接受更多用於計劃的任務。 除非顯式終止,否則作業不會自動移動到已完成狀態。 這可以通過[onAllTasks 完成](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.common.onalltaskscomplete?view=azure-dotnet)屬性或[maxWallClockTime](https://docs.microsoft.com/rest/api/batchservice/job/add#jobconstraints)自動觸發。

存在預設[的活動工作和工作計劃配額](batch-quota-limit.md#resource-quotas)。 已完成狀態的作業和作業計劃不計入此配額。

## <a name="tasks"></a>工作

任務是構成工作的單個工作單元。 任務由使用者提交,Batch 計劃到計算節點。 創建和執行任務時需要考慮幾個設計注意事項。 以下各節介紹常見方案以及如何設計任務以處理問題並高效執行。

- **將任務數據保存為任務的一部分。**  
    計算節點本質上是短暫的。 Batch 中有許多功能,如自動池和自動縮放,使節點很容易消失。 當節點離開池(由於調整大小或刪除池)時,這些節點上的所有檔也會被刪除。 因此,建議在任務完成之前,它將其輸出從正在運行的節點移動到持久存儲,同樣,如果任務失敗,應將診斷故障所需的日誌移動到持久存儲。 Batch 整合了支援 Azure 儲存,以便透過[OutputFiles](batch-task-output-files.md)以及各種共用檔案系統上傳數據,或者您可以在任務中自行執行上載。

### <a name="task-lifetime"></a>工作存留期

- **任務完成後刪除它們。**  
    在不再需要任務時刪除任務,或設置[保留時間](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.taskconstraints.retentiontime?view=azure-dotnet)任務約束。 如果設置了`retentionTime`,Batch`retentionTime`會在 過期時自動清理任務使用的磁碟空間。  

    刪除任務可以完成兩件事。 它確保您沒有作業中的任務堆積,從而使查詢/查找您感興趣的任務變得更加困難(因為您必須篩選完成的任務)。 它還清理節點上的相應任務數據(提供`retentionTime`尚未命中)。 這可確保節點不會填滿任務數據並耗盡磁碟空間。

### <a name="task-submission"></a>工作提交

- **在集合中提交大量任務。**  
    任務可以單獨提交,也可以在集合中提交。 在批量提交任務時,一次最多提交 100 個[集合](https://docs.microsoft.com/rest/api/batchservice/task/addcollection)中的任務,以減少開銷和提交時間。

### <a name="task-execution"></a>工作執行

- **選擇每個節點的最大工作**  
    Batch 支援在節點上過度訂閱任務(運行的任務多於節點具有內核的任務)。 由您確保任務「適合」到池中的節點中。 例如,如果您嘗試將 8 個任務(每個任務消耗 25% 的 CPU 使用率)安排`maxTasksPerNode = 8`到一個節點上( 在具有的池中),則可能會經歷降級。

### <a name="designing-for-retries-and-re-execution"></a>重新執行設計

批次處理可以自動重試任務。 有兩種類型的重試:使用者控制和內部重試。 使用者控制的重試由任務的[maxTaskRetryCount](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.taskconstraints.maxtaskretrycount?view=azure-dotnet)指定。 當工作中指定的程式離開具有非零退出代碼時,將重試該工作,最多達到的值`maxTaskRetryCount`。

儘管很少,但由於計算節點上的故障(如無法在任務運行時更新內部狀態或節點上故障),可以在內部重試任務。 如果可能,任務將在同一計算節點上重試,最多達到內部限制,然後再放棄任務,並將任務推遲到 Batch 重新安排,可能在不同的計算節點上。

- **產生持久工作**  
    任務應設計為能夠承受故障並適應重試。 這對長時間運行的任務尤其重要。 為此,請確保任務生成相同的單一結果,即使它們運行多次也是如此。 實現這一目標的一個方法是使您的任務」。尋求目標」。 另一種方法是確保任務是冪等的(任務無論運行多少次,都將具有相同的結果)。

    常見範例是將檔案複製到計算節點的任務。 一個簡單的方法是每次運行時複製所有指定檔的任務,它效率低,無法承受故障。 相反,創建一個任務以確保檔位於計算節點上;不重新複製已存在的檔案的任務。 這樣,如果任務被中斷,任務將從中斷的位置開始。

- **低優先權節點**  
    在專用或低優先順序節點上執行任務時,沒有設計差異。 無論任務是在低優先順序節點上運行時搶佔的,還是由於專用節點上的故障而中斷,通過設計任務以承受故障來緩解這兩種情況。

- **工作執行時間**  
    避免執行時間短的任務。 只運行一到兩秒鐘的任務並不理想。 您應該嘗試在單個任務中執行大量工作(最少10秒,最多時或數天)。 如果每個任務執行一分鐘(或更多),則作為總體計算時間一小部分的調度開銷很小。

## <a name="nodes"></a>節點

- **啟動任務應具有冪等**  
    與其他任務類似,節點啟動任務應具有冪等性,因為它將在每次節點啟動時重新運行。 冪等任務只是在多次運行時產生一致結果的任務。

- **通過操作系統服務介面管理長時間運行的服務。**  
    有時,需要在節點中的 Batch 代理旁邊運行另一個代理,例如,從節點收集數據並報告數據。 我們建議將這些代理部署為作業系統服務,如 Windows 服務或`systemd`Linux 服務。  

    運行這些服務時,它們不得對節點上的 Batch 託管目錄中的任何檔執行檔鎖,否則 Batch 將無法刪除這些目錄,因為檔鎖。 例如,如果在啟動任務中安裝 Windows 服務,而不是直接從啟動任務工作目錄中啟動該服務,請將檔案複製到其他位置(如果檔存在,則僅跳過副本)。 從該位置安裝服務。 當 Batch 重新執行您的開始任務時,它將刪除開始任務工作目錄並再次創建它。 這之所以有效,是因為服務在其他目錄上具有檔鎖,而不是啟動任務工作目錄。

- **避免在 Windows 中建立目錄連線**  
    目錄連接(有時稱為目錄硬連結)在任務和作業清理過程中難以處理。 使用符號連結(軟連結),而不是硬連結。

- **如果出現問題,收集批處理代理日誌**  
    如果您發現涉及節點或在節點上運行的任務的行為問題,建議在取消分配相關節點之前收集 Batch 代理日誌。 可以使用上載批處理服務日誌 API 收集批處理代理日誌。 這些日誌可以作為 Microsoft 支援票證的一部分提供,並有助於解決問題。

## <a name="security"></a>安全性

### <a name="security-isolation"></a>安全性隔離：

出於隔離的目的,如果方案需要將作業彼此隔離,則應通過將作業隔離到單獨的池中來隔離這些作業。 池是 Batch 中的安全隔離邊界,默認情況下,兩個池不可見或無法相互通信。 避免使用單獨的批處理帳戶作為隔離方法。

## <a name="moving"></a>移動

### <a name="move-batch-account-across-regions"></a>跨區域移動批次處理帳戶 

在各種方案中,您希望將現有的 Batch 帳戶從一個區域移動到另一個區域。 例如,您可能希望移動到其他區域,作為災難恢復規劃的一部分。

Azure 批處理帳戶不能從一個區域移動到另一個區域。 但是,可以使用 Azure 資源管理器範本匯出 Batch 帳戶的現有配置。  然後,您可以通過將 Batch 帳戶匯出到範本、修改參數以匹配目標區域,然後將範本部署到新區域,在另一個區域中暫占資源。 將範本上載到新區域後,必須重新創建證書、作業計劃和應用程式包。 要提交更改並完成批處理帳戶的移動,請記住刪除原始 Batch 帳戶或資源組。  

有關資源管理員和範本的詳細資訊,請參閱[快速入門:使用 Azure 門戶建立和部署 Azure 資源管理員樣本](https://docs.microsoft.com/azure/azure-resource-manager/resource-manager-quickstart-create-templates-use-the-portal)。


