---
title: 容錯移轉和修補 - Azure Cache for Redis
description: 瞭解 Azure Cache for Redis 的容錯移轉、修補和更新程式。
author: yegu-ms
ms.author: yegu
ms.service: cache
ms.topic: conceptual
ms.date: 10/18/2019
ms.openlocfilehash: 7cfa7257e64421c30c359bb34044988bbb5af1dd
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 10/09/2020
ms.locfileid: "87093080"
---
# <a name="failover-and-patching-for-azure-cache-for-redis"></a>Azure Cache for Redis 的容錯移轉和修補

若要建立具有復原能力和成功的用戶端應用程式，請務必瞭解 Azure Cache for Redis 服務內容中的容錯移轉。 容錯移轉可以是規劃管理作業的一部分，也可能是因為未規劃的硬體或網路故障所造成。 當管理服務修補 Azure Cache for Redis 二進位檔時，快取容錯移轉的常見用法。 本文涵蓋什麼是容錯移轉、在修補期間發生的狀況，以及如何建立具復原功能的用戶端應用程式。

## <a name="what-is-a-failover"></a>什麼是容錯移轉？

讓我們從 Azure Cache for Redis 的容錯移轉總覽開始著手。

### <a name="a-quick-summary-of-cache-architecture"></a>快取架構的快速摘要

快取是使用不同的私人 IP 位址來建立多部虛擬機器。 每個虛擬機器（也稱為節點）都會連接到具有單一虛擬 IP 位址的共用負載平衡器。 每個節點都會執行 Redis 伺服器進程，而且可透過主機名稱和 Redis 埠來存取。 每個節點都會被視為主要或複本節點。 當用戶端應用程式連線到快取時，它的流量會通過此負載平衡器，並自動路由到主要節點。

在基本的快取中，單一節點一律是主要節點。 在標準或高階快取中，有兩個節點：一個是選擇作為主要節點，另一個則是複本。 因為 Standard 和 Premium 快取具有多個節點，所以一個節點可能無法使用，而另一個節點則繼續處理要求。 叢集快取是由許多分區所組成，每個都有不同的主要和複本節點。 其中一個分區可能會關閉，而其他則保持可用。

> [!NOTE]
> 基本快取不會有多個節點，也不會提供服務等級協定 (SLA) 來提供其可用性。 基本快取只建議用於開發和測試用途。 使用標準或高階快取進行多重節點部署，以增加可用性。

### <a name="explanation-of-a-failover"></a>容錯移轉的說明

當複本節點將本身升級成為主要節點，而舊的主要節點關閉現有的連接時，就會發生容錯移轉。 在主要節點恢復運作之後，它會注意角色的變更，並將本身降級為複本。 然後，它會連接到新的主要複本，並同步處理資料。 可能會有規劃或未規劃的容錯移轉。

*規劃的容錯移轉*會在系統更新（例如 Redis 修補或 OS 升級，以及管理作業，例如調整和重新開機）期間進行。 由於節點會提前通知更新，因此可以以合作方式交換角色並快速更新變更的負載平衡器。 規劃的容錯移轉通常會在1秒內完成。

未 *計畫的容錯移轉* 可能是因為硬體故障、網路失敗或主要節點的其他意外中斷所造成。 複本節點將本身升級為主要複本，但進程需要較長的時間。 複本節點在可以起始容錯移轉程式之前，必須先偵測到它的主要節點無法使用。 複本節點也必須確認這個未規劃的失敗不是暫時性或本機，以避免不必要的容錯移轉。 此偵測延遲表示未計畫的容錯移轉通常會在10到15秒內完成。

## <a name="how-does-patching-occur"></a>修補如何進行？

Azure Cache for Redis 服務會定期以最新的平臺功能和修正程式來更新您的快取。 若要修補快取，服務會遵循下列步驟：

1. 管理服務會選取要修補的一個節點。
1. 如果選取的節點是主要節點，對應的複本節點會以合作方式自我升級。 這項促銷活動被視為規劃的容錯移轉。
1. 選取的節點會重新開機以進行新的變更，並回到複本節點。
1. 複本節點會連接到主要節點，並同步處理資料。
1. 當資料同步處理完成時，會針對其餘節點重複進行修補程式。

因為修補是規劃的容錯移轉，所以複本節點會快速地將本身升級為主要複本，並開始服務要求和新的連接。 基本快取沒有複本節點，而且在更新完成之前無法使用。 叢集快取的每個分區都是分開修補的，且不會關閉與另一個分區的連接。

> [!IMPORTANT]
> 一次只會修補一個節點，以防止資料遺失。 基本快取將會遺失資料。 叢集快取一次會修補一個分區。

相同資源群組和區域中的多個快取一次也會進行修補。  位於不同資源群組或不同區域的快取可能會同時修補。

由於完整資料同步處理會在程式重複之前進行，因此當您使用標準或高階快取時，不太可能發生資料遺失。 您可以藉由 [匯出](cache-how-to-import-export-data.md#export) 資料並啟用 [持續](cache-how-to-premium-persistence.md)性來防止資料遺失。

## <a name="additional-cache-load"></a>額外的快取負載

當發生容錯移轉時，Standard 和 Premium 快取需要將資料從一個節點複寫到另一個節點。 這項複寫會導致伺服器記憶體和 CPU 的負載增加。 如果快取實例已大量載入，用戶端應用程式可能會遇到延遲增加。 在極端情況下，用戶端應用程式可能會收到超時例外狀況。 為了有助於減輕此額外負載的影響 [，請設定](cache-configure.md#memory-policies) 快取的 `maxmemory-reserved` 設定。

## <a name="how-does-a-failover-affect-my-client-application"></a>容錯移轉如何影響我的用戶端應用程式？

用戶端應用程式所看到的錯誤數目，取決於容錯移轉時該連接上暫止的作業數目。 透過關閉其連線的節點路由傳送的任何連接都會看到錯誤。 當連線中斷時，許多用戶端程式庫可能會擲回不同類型的錯誤，包括超時例外狀況、連接例外狀況或通訊端例外狀況。 例外狀況的數目和類型取決於程式碼路徑中的要求在快取關閉其連接時的位置。 比方說，當容錯移轉發生時，傳送要求但未收到回應的作業，可能會收到超時例外狀況。 在關閉的連線物件上，新的要求會收到連接例外狀況，直到重新連線成功為止。

大部分的用戶端程式庫會嘗試重新連線至快取（如果有設定的話）。 不過，未預期的錯誤有時可能會將程式庫物件放入無法復原的狀態。 如果錯誤保存超過預先設定的時間長度，則應該重新建立連線物件。 在 Microsoft.NET 和其他物件導向的語言中，您可以使用 [延遲 \<T\> 模式](https://gist.github.com/JonCole/925630df72be1351b21440625ff2671f#reconnecting-with-lazyt-pattern)來重建連接，而不需要重新開機應用程式。

### <a name="how-do-i-make-my-application-resilient"></a>如何? 讓我的應用程式具有復原能力？

因為您無法完全避免容錯移轉，所以請撰寫用戶端應用程式以復原連接中斷和失敗的要求。 雖然大部分的用戶端程式庫會自動重新連線至快取端點，但其中少數會嘗試重試失敗的要求。 視應用程式案例而定，使用重試邏輯搭配輪詢可能是合理的。

若要測試用戶端應用程式的復原能力，請使用 [重新開機](cache-administration.md#reboot) 做為連接中斷的手動觸發程式。 此外，我們建議您在快取上 [排程更新](cache-administration.md#schedule-updates) 。 告知管理服務在指定的每週時段套用 Redis 執行時間修補程式。 這些視窗通常是用戶端應用程式流量較低的期間，以避免可能發生的事件。

### <a name="client-network-configuration-changes"></a>用戶端網路-設定變更

某些用戶端網路設定變更可能會觸發「沒有可用的連線」錯誤。 這類變更可能包括：

- 在預備與生產位置之間交換用戶端應用程式的虛擬 IP 位址。
- 調整應用程式的實例大小或數目。

這類變更可能會導致連線問題持續不到一分鐘。 除了 Azure Cache for Redis 服務之外，您的用戶端應用程式可能會失去與其他外部網路資源的連線。

## <a name="next-steps"></a>接下來的步驟

- [排程](cache-administration.md#schedule-updates) 快取的更新。
- 使用 [重新開機](cache-administration.md#reboot)來測試應用程式復原。
- [設定](cache-configure.md#memory-policies) 記憶體保留和原則。
