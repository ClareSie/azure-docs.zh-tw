---
title: 適用於 PostgreSQL 的 Azure 資料庫-彈性伺服器中的備份與還原
description: 瞭解適用於 PostgreSQL 的 Azure 資料庫彈性伺服器的備份與還原概念
author: sr-msft
ms.author: srranga
ms.service: postgresql
ms.topic: conceptual
ms.date: 09/22/2020
ms.openlocfilehash: bed196d1be101ffa75affc389d390ec0fa764b05
ms.sourcegitcommit: 53acd9895a4a395efa6d7cd41d7f78e392b9cfbe
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/22/2020
ms.locfileid: "90933859"
---
# <a name="backup-and-restore-in-azure-database-for-postgresql---flexible-server"></a>適用於 PostgreSQL 的 Azure 資料庫-彈性伺服器中的備份與還原

> [!IMPORTANT]
> 適用於 PostgreSQL 的 Azure 資料庫 - 彈性伺服器為預覽狀態

備份會構成任何商務持續性策略的重要部分。 它們可協助保護資料免于遭到意外損毀或刪除。 適用於 PostgreSQL 的 Azure 資料庫彈性的伺服器會自動備份您的伺服器，並在最多35天的期間內保留備份。 還原時，您可以指定要在保留期限內還原的日期和時間。 還原和復原的整體時間取決於資料庫檔案的大小以及要執行的復原量。 

### <a name="backup-process-in-flexible-server"></a>彈性伺服器中的備份進程
建立彈性伺服器之後，系統會立即排程第一次快照集備份。 接著，會執行資料檔案的每日快照集備份。 備份會儲存在區域內的區域冗余儲存體中。 交易記錄 (預先寫入記錄檔-WAL) 也會持續保存，如此您就能夠還原到上次認可的交易。 在您設定的備份保留期內，這些資料和記錄備份可讓您將伺服器還原至任何時間點。 所有備份皆會使用 AES 256 位元加密進行加密。

如果資料庫設定為具有高可用性，則會從主要複本執行每日快照集，並從待命執行連續記錄備份。

> [!IMPORTANT]
>備份不會在已停止的伺服器上執行。 不過，當資料庫會在7天后自動啟動或由使用者啟動時，就會繼續執行備份。

備份只能用於彈性伺服器內的還原作業。 如果您想要將資料匯出或匯入至有彈性的伺服器，您可以使用傾印 [和還原](https://docs.microsoft.com/azure/postgresql/howto-migrate-using-dump-and-restore)   方法。


### <a name="backup-retention"></a>備份保留

系統會根據伺服器的備份保留期限設定來保留備份。 您可以選取介於7到35天的保留期限。 預設保留期間為七天。 您可以在伺服器建立期間設定保留期限，也可以稍後再更新。 即使已停止的伺服器仍會保留備份。

備份保留期限會控制可取回時間點還原的時間，因為它是以 \' 可用的備份為基礎。 您也可以從還原的觀點，將備份保留期限視為修復時段。 在備份保留期限內執行時間點還原所需的所有備份都會保留在備份儲存體中。 例如-如果備份保留期限設定為七天，則會將修復視窗視為過去七天。 在此案例中，會保留過去七天內還原和復原伺服器所需的所有資料和記錄。 


### <a name="backup-storage-cost"></a>備份儲存體成本

彈性伺服器可提供高達100% 的已布建伺服器儲存體作為備份儲存體，且不會產生額外費用。 使用的任何額外備份儲存體都會依每月 GB 收費。 例如，如果您布建的伺服器具有 250 GiB 的儲存體，則您會有 250 GiB 的備份儲存體容量，且不會產生額外費用。 如果每日備份使用量為 25 GiB，則您最多可以有10天的免費備份儲存體。 超過 250 GiB 的備份儲存體耗用量會依據 [定價模型](https://azure.microsoft.com/pricing/details/postgresql/)收費。

您可以使用 Azure 入口網站中的 [ [備份儲存體使用](https://docs.microsoft.com/azure/postgresql/concepts-monitoring)的計量]   來監視伺服器所耗用的備份儲存體。 使用的備份儲存體計量代表根據為伺服器設定的備份保留期間，保留的所有資料庫備份和記錄備份所耗用的儲存空間總和。  不論資料庫大小總計，伺服器上頻繁的交易活動可能會導致備份儲存體使用量增加。

控制備份儲存體成本的主要方法是設定適當的備份保留期限，然後選擇適當的備份冗余選項，以符合您所需的復原目標。

> [!IMPORTANT]
> 彈性的伺服器目前不支援地理區域冗余備份。

## <a name="point-in-time-restore-overview"></a>時間點還原總覽

在彈性的伺服器中，執行還原時間點會在與 \' 來源伺服器相同的區域中，從彈性的伺服器備份建立新的伺服器。 它會以來源伺服器的定價層設定、計算世代、虛擬核心數目、儲存體大小、備份保留期限和備份冗余選項來建立。 此外，也會從來源伺服器繼承 VNET 和防火牆設定等標記和設定。 

 > [!IMPORTANT]
> 如果您要還原以區域冗余高可用性設定的彈性伺服器，還原的伺服器將不會設定為具有高可用性，而是在與主伺服器相同的區域中進行設定。 

 ### <a name="restore-process"></a>還原程序

實體資料庫檔案會先從快照集備份還原到伺服器的資料位置。 系統會自動選擇並還原先前在所需時間點之前所做的適當備份。 接著會使用 WAL 檔來起始復原程式，以使資料庫維持一致的狀態。 

 例如，讓我們假設每晚在晚上11點執行備份。 如果還原點是在2020年8月15日上午10:00，則會還原2020年8月14日的每日備份。 在2020年8月25日之前，將會復原資料庫，直到年8月25日10am 為止，直到8月25日為止，晚上11點到10am。 

 請參閱 [下列步驟](./how-to-restore-server-portal.md) 來還原您的資料庫伺服器。

> [!IMPORTANT]
> 彈性伺服器的還原作業會建立新的資料庫伺服器，且不會覆寫現有的資料庫伺服器。

時間點還原適用於多種案例。 例如，使用者不小心刪除資料、卸除重要的資料表或資料庫，或是因為應用程式缺失，使應用程式不小心用不正確的資料覆寫正確資料。 因為交易記錄的連續備份，您將能夠還原到最後一個交易。

您可以選擇最早的還原點和自訂還原點。

-   **最早的還原點**：取決於您的保留期間，這會是您可以還原的最早時間。 將會自動選取最舊的備份時間，並顯示在入口網站上。 如果您想要調查或從該時間點開始進行某些測試，這會很有用。

-   **自訂還原點**：此選項可讓您選擇為此彈性伺服器定義的保留週期內的任何時間點。 根據預設，UTC 時間的最新時間是自動選取的，如果您想要還原到上次認可的交易以供測試之用，則會很有用。 您可以選擇性地選擇其他日期和時間。 

預估的復原時間取決於數個因素，包括資料庫大小、要處理的交易記錄量、網路頻寬，以及在相同區域中同時復原的資料庫總數。 整體復原時間通常需要幾分鐘的時間才能完成。


> [!IMPORTANT]
>  **無法**   還原已刪除的伺服器。 如果您刪除伺服器，所有屬於該伺服器的資料庫也會一併刪除，且無法復原。 為了保護伺服器資源、部署後、意外刪除或非預期的變更，系統管理員可以利用 [管理鎖定](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-lock-resources)。

## <a name="perform-post-restore-tasks"></a>執行還原之後的工作

還原資料庫之後，您可以執行下列工作，讓您的使用者和應用程式恢復運作：

-   如果新伺服器的目的是要取代源伺服器，請將用戶端和用戶端應用程式重新導向至新的伺服器。

-   確定有適當的伺服器層級防火牆和 VNet 規則可供使用者連接。 這些規則不會從源伺服器複製。
  
-   您可以視需要相應增加/減少還原的伺服器計算。

-   確定已備妥適當的登入和資料庫層級許可權。

-   適當地設定警示。
  
-  如果您已還原設定為高可用性的資料庫，而且您想要設定具有高可用性的還原伺服器，則可以遵循下列 [步驟](./how-to-manage-high-availability-portal.md)。


## <a name="next-steps"></a>下一步

-   瞭解 [商務持續性](./concepts-business-continuity.md)
-   深入瞭解 [區域冗余高可用性](./concepts-high-availability.md)
-   瞭解 [如何還原](./how-to-restore-server-portal.md)

