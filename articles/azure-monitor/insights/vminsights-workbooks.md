---
title: 使用活頁簿建立適用於 VM 的 Azure 監視器互動式報表
description: 使用預先定義和自訂的參數化活頁簿進行適用於 VM 的 Azure 監視器，簡化複雜的報告。
ms.subservice: ''
ms.topic: conceptual
author: bwren
ms.author: bwren
ms.date: 03/12/2020
ms.openlocfilehash: 8ae8c633bdfca72d6e383715cac9b1bcdddd9d17
ms.sourcegitcommit: 3792cf7efc12e357f0e3b65638ea7673651db6e1
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/29/2020
ms.locfileid: "91449794"
---
# <a name="create-interactive-reports-azure-monitor-for-vms-with-workbooks"></a>使用活頁簿建立適用於 VM 的 Azure 監視器互動式報表

活頁簿會將文字、 [記錄查詢](../log-query/query-language.md)、計量和參數結合成豐富的互動式報表。 活頁簿可以由具有相同 Azure 資源存取權的其他小組成員編輯。

活頁簿在下列案例中很有用：

* 當您事先不知道感興趣的計量時，探索虛擬機器的使用量： CPU 使用率、磁碟空間、記憶體、網路相依性等。不同于其他流量分析工具，活頁簿可讓您合併多種類型的視覺效果和分析，使其非常適合這種自由形式的探索。
* 藉由顯示金鑰計數器和其他記錄事件的計量，向您的小組說明最近布建的 VM 如何執行。
* 將 VM 調整大小實驗的結果與小組的其他成員共用。 您可以使用文字來說明實驗的目標，然後顯示用來評估實驗的每個使用計量和分析查詢，以及每個度量是否高於或低於目標的明確呼叫。
* 報告您的 VM 使用量中斷的影響、結合資料、文字說明和後續步驟的討論，以防止未來發生中斷。

下表摘要說明適用於 VM 的 Azure 監視器包含的活頁簿，以協助您開始著手。

| 活頁簿 | 描述 | 影響範圍 |
|----------|-------------|-------|
| 效能 | 提供在單一活頁簿中使用您已啟用之所有 Log Analytics 效能計數器的可自訂版本的前 N 個清單和圖表。| 大規模 |
| 效能計數器 | 橫跨一組廣泛效能計數器的前 N 個圖表視圖。 | 大規模 |
| 連接 | 連線可讓您深入瞭解受監視 Vm 的輸入和輸出連線。 | 大規模 |
| 使用中的連接埠 | 提供在所選時間範圍內系結至受監視 Vm 上端口及其活動的處理常式清單。 | 大規模 |
| 開放連接埠 | 提供在受監視的 Vm 上開啟的埠數目，以及這些開啟埠的詳細資料。 | 大規模 |
| 失敗的連線 | 顯示受監視 Vm 上失敗的連線計數、失敗趨勢，以及如果失敗的百分比隨著時間而增加。 | 大規模 |
| 安全性和稽核 | 分析 TCP/IP 流量，以報告 IP 端點在全球的整體連線、惡意連接。  若要啟用所有功能，您將需要啟用安全性偵測。 | 大規模 |
| TCP 流量 | 受監視 Vm 的排名報告，以及其在方格中的已傳送、接收和總網路流量，並顯示為趨勢線。 | 大規模 |
| 流量比較 | 這份活頁簿可讓您比較單一電腦或一組電腦的網路流量趨勢。 | 大規模 |
| 效能 | 提供可自訂的效能視圖版本，以利用您已啟用的所有 Log Analytics 效能計數器。 | 單一 VM | 
| 連接 | 連線可讓您深入瞭解 VM 的輸入和輸出連線。 | 單一 VM |
 
## <a name="creating-a-new-workbook"></a>建立新的活頁簿

活頁簿由獨立可編輯的圖表、表格、文字及輸入控制項之區段組成。 若要進一步瞭解活頁簿，讓我們先開啟範本，並逐步解說如何建立自訂活頁簿。 

1. 登入 [Azure 入口網站](https://portal.azure.com)。

2. 選取 [ **虛擬機器**]。

3. 從清單中選取 VM。

4. 在 [VM] 頁面的 [ **監視** ] 區段中，選取 [ **見解**]。

5. 在 [VM insights] 頁面上，選取 [ **效能** ] 或 [ **對應** ] 索引標籤，然後從頁面上的連結選取 [ **View 活頁簿** ]。 從下拉式清單中，選取 [ **移至資源庫**]。

    ![活頁簿下拉式清單的螢幕擷取畫面](media/vminsights-workbooks/workbook-dropdown-gallery-01.png)

    這會以數個預建活頁簿啟動活頁簿圖庫，以協助您開始使用。

7. 選取 [ **新增**] 以建立新的活頁簿。

    ![活頁簿資源庫螢幕擷取畫面](media/vminsights-workbooks/workbook-gallery-01.png)

## <a name="editing-workbook-sections"></a>編輯活頁簿區段

活頁簿有兩種模式：**編輯模式**和**閱讀模式**。 當新的活頁簿初次開機時，它會在 **編輯模式**中開啟。 它會顯示活頁簿的所有內容，包括任何其他隱藏的步驟和參數。 **閱讀模式**呈現簡化的報告樣式檢視畫面。 [讀取] 模式可讓您抽象化建立報表的複雜度，同時仍會在需要進行修改時，只需按幾下滑鼠即可。

![Azure 監視器中的 [虛擬機器] 活頁簿區段的螢幕擷取畫面，其中顯示已醒目提示編輯控制項的編輯模式中新的活頁簿。](media/vminsights-workbooks/workbook-new-workbook-editor-01.png)

1. 當您完成編輯區段時，按一下區段左下角的 [ **完成編輯** ]。

2. 若要建立區段的複本，按一下 [複製此區段]**** 圖示。 建立重複的區段是逐一查看查詢而不會遺失先前反覆項目的絕佳方式。

3. 若要在活頁簿中將區段上移，按一下 [上移]**** 或 [下移]**** 圖示。

4. 若要永久移除區段，按一下 [移除]**** 圖示。

## <a name="adding-text-and-markdown-sections"></a>新增文字和 Markdown 區段

將標題、說明及註解新增至您的活頁簿，可協助將一組資料表和圖表變成敘述。 活頁簿中的文字區段支援 [Markdown 語法](https://daringfireball.net/projects/markdown/)以進行文字格式設定，例如標題、粗體、斜體和項目符號清單。

若要將文字區段新增至您的活頁簿，請使用活頁部底端或任何區段底端的 [新增文字]**** 按鈕。

## <a name="adding-query-sections"></a>加入查詢區段

![活頁簿中的查詢區段](media/vminsights-workbooks/005-workbook-query-section.png)

若要將查詢區段新增至您的活頁簿，請使用活頁部底端或任何區段底端的 [新增查詢]**** 按鈕。

查詢區段十分有彈性，可以用以回答下述問題：

* 在相同時間內，我的 CPU 使用率如何增加網路流量？
* 上個月的可用磁碟空間趨勢為何？
* 過去兩周的 VM 體驗有多少網路連線失敗？ 

您也不只限於從啟動活頁簿的虛擬機器內容進行查詢。 您可以跨多個虛擬機器及 Log Analytics 工作區進行查詢，前提是您具有這些資源的存取權限。

使用 **工作區** 識別碼，從其他 Log Analytics 工作區或特定 Application Insights 應用程式包含資料。 若要深入瞭解跨資源查詢，請參閱 [官方指引](../log-query/cross-workspace-query.md)。

### <a name="advanced-analytic-query-settings"></a>進階分析查詢設定

每個區段都有自己的 advanced 設定，可透過 [新增參數] 按鈕右邊的 [設定活頁 ![ 簿] 區段編輯控制項圖示來存取 ](media/vminsights-workbooks/006-settings.png) 。 **Add parameters**

![Azure 監視器之 [虛擬機器] 活頁簿區段中 [Advanced Settings] 對話方塊的螢幕擷取畫面。 會反白顯示開啟對話方塊的圖示。](media/vminsights-workbooks/007-settings-expanded.png)

|         |          |
| ---------------- |:-----|
| **自訂寬度**    | 將專案設為任意大小，讓您可以將多個專案放在同一行，讓您能夠更妥善地將圖表和資料表組織成豐富的互動式報表。  |
| **依條件顯示** | 指定可在閱讀模式中隱藏以參數為基礎的步驟。 |
| **匯出參數**| 允許方格或圖表中選取的資料列，使後續步驟變更值或變成可見。  |
| **在未編輯時顯示查詢** | 顯示圖表或資料表上方的查詢（即使處於讀取模式）。
| **在未進行編輯時顯示 [在分析中開啟] 按鈕** | 將藍色分析圖示新增至圖表的右手邊，以允許單鍵存取。|

大部分的設定項目都很直覺，但要了解**匯出參數**，最好檢視使用此一功能之活頁簿。

其中一個預先建立的活頁簿- **TCP 流量**，提供來自 VM 的連接計量資訊。

活頁簿的第一個區段是以記錄查詢資料為基礎。 第二個區段也是以記錄查詢資料為基礎，但在第一個資料表中選取資料列，將會以互動方式更新圖表的內容：

![Azure 監視器中的 [虛擬機器] 區段的螢幕擷取畫面，其中顯示預建的活頁簿 TCP 流量。](media/vminsights-workbooks/008-workbook-tcp-traffic.png)

您可以使用 [ **當選取專案時，匯出參數** 的 advanced settings] （在資料表的記錄查詢中啟用）來執行此行為。

![已核取 [當選取專案時，匯出參數] 選項之虛擬機器活頁簿 [Advanced Settings] 對話方塊的螢幕擷取畫面。](media/vminsights-workbooks/009-settings-export.png)

第二個記錄查詢會在選取資料列時，利用匯出的值來建立一組可供區段標題和圖表使用的值。 如果未選取任何資料列，則會隱藏區段標題和圖表。 

例如，第二個區段中的 hidden 參數會使用方格中所選取資料列的下列參考：

```
VMConnection
| where TimeGenerated {TimeRange}
| where Computer in ("{ComputerName}") or '*' in ("{ComputerName}") 
| summarize Sent = sum(BytesSent), Received = sum(BytesReceived) by bin(TimeGenerated, {TimeRange:grain})
```

## <a name="adding-metrics-sections"></a>新增計量區段

計量區段讓您能存取所有 Azure 監視器計量資料，納入您的互動式報表中。 在適用於 VM 的 Azure 監視器中，預先建立的活頁簿通常會包含分析查詢資料，而不是度量資料。  您可以選擇建立包含計量資料的活頁簿，讓您充分發揮這兩項功能的最大效益。 您也可以從任何可存取之訂閱的資源，提取計量資料。

以下是將虛擬機器資料提取到活頁簿中的範例，以提供 CPU 效能的方格視覺效果：

![Azure 監視器中虛擬機器活頁簿之 [計量] 區段的螢幕擷取畫面。 每部虛擬機器的 CPU 效能會以圖形方式顯示。](media/vminsights-workbooks/010-metrics-grid.png)

## <a name="adding-parameter-sections"></a>新增參數區段

活頁簿參數讓您不需要手動編輯查詢或文字區段，便能改變活頁簿的值。 這樣便不需要了解其中分析查詢的語言，大幅拓展以活頁簿為基礎之報表潛在的觀眾。

將參數的名稱放在括弧中，像是 ``{parameterName}``，來取代查詢、文字、或其他參數區段中參數的值。 參數名稱的限制為類似于 JavaScript 識別碼、字母字元或底線的規則，其後接著英數位元或底線。 舉例來說，**a1** 是可用的名稱，但 **1a** 則不被允許。

參數是線性的，從活頁簿最頂端往後面的步驟移動。  稍後在活頁簿中宣告的參數可以覆寫先前宣告的參數。 這也可讓使用查詢的參數存取稍早定義的參數值。 在單一參數步驟中，參數也是線性的，順序從左到右，右邊的參數可以仰賴同一步驟中已經宣告的參數。
 
有四種不同類型的參數，目前支援：

|                  |      |
| ---------------- |:-----|
| **Text**    | 允許使用者編輯文字方塊，您也可以選擇性地提供查詢以填入預設值。 |
| **下拉式清單** | 允許使用者從一組值中選擇。 |
| **時間範圍選擇器**| 可讓使用者從預先定義的時間範圍值集合中選擇，或從自訂的時間範圍內挑選。|
| **資源選擇器** | 可讓使用者從針對活頁簿選取的資源中選擇。|

### <a name="using-a-text-parameter"></a>使用文字參數

使用者在文字方塊中輸入的值會直接取代在查詢中，沒有任何轉義或引號。 如果您需要的值為字串，查詢中必須在參數前後加上引號 (像是 **'{parameter}'**)。

Text 參數允許在任何地方使用文字方塊中的值。 它可以是資料表名稱、資料行名稱、函數名稱、運算子等。 Text 參數類型具有 [ **從 analytics 查詢取得預設值**] 設定，可讓活頁簿作者使用查詢來填入該文字方塊的預設值。

使用記錄查詢的預設值時，只會使用第一個資料列的第一個值 (資料列0，資料行 0) 作為預設值。 因此建議您將查詢限制為只傳回一行一列。 查詢所傳回的任何其他資料會被忽略。 

查詢傳回的任何值都將會直接被取代為不含逃脫字元或引號的版本。 若查詢未傳回任何資料列，參數之結果將為空白字串 (若參數並非必須) 或未定義 (若參數為必須)。

### <a name="using-a-drop-down"></a>使用下拉式清單

下拉式參數類型可讓您建立下拉式控制項，讓您可以選取一或多個值。

下拉式清單會填入記錄查詢或 JSON。 如果查詢傳回一個資料行，則該資料行中的值會是下拉式控制項中的值和標籤。 如果查詢傳回兩個數據行，第一個資料行是值，而第二個數據行是下拉式清單中顯示的標籤。 如果查詢傳回三個數據行，則第三個數據行會用來指出該下拉式清單中的預設選項。 此一資料行可以為任何型別，最簡單的方式是使用布林或數字型別，0 為 false，1 為 true。

若資料行為字串型別，Null/空白字串將被視為 false，其他任何值都視為 true。 若為單一選取下拉式清單，則會使用具有 true 值的第一個值做為預設選取專案。  若為多重選取下拉式清單，則會使用具有 true 值的所有值做為預設選取的集合。 下拉式清單中的專案會以查詢傳回資料列的任何順序顯示。 

讓我們看看連接總覽報告中出現的參數。 按一下 [ **方向**] 旁的編輯符號。

![在 Azure 監視器中加入和編輯報表參數之區段的螢幕擷取畫面。 已選取 [方向] 參數的 [編輯] 圖示。](media/vminsights-workbooks/011-workbook-using-dropdown.png)

這將會啟動 [ **編輯參數** ] 功能表項目。

![[編輯參數] 對話方塊的螢幕擷取畫面。 參數名稱為 Direction、參數類型為下拉式清單，並已選取 [從 JSON 取得資料]。](media/vminsights-workbooks/012-workbook-edit-parameter.png)

JSON 可讓您產生以內容填入的任意資料表。 例如，下列 JSON 會在下拉式清單中產生兩個值：

```
[
    { "value": "inbound", "label": "Inbound"},
    { "value": "outbound", "label": "Outbound"}
]
```

更適用的範例是使用下拉式清單，依名稱來挑選一組效能計數器：

```
Perf
| summarize by CounterName, ObjectName
| order by ObjectName asc, CounterName asc
| project Counter = pack('counter', CounterName, 'object', ObjectName), CounterName, group = ObjectName
```

查詢如下顯示結果：

![效能計數器下拉式清單](media/vminsights-workbooks/013-workbook-edit-parameter-perf-counters.png)

下拉式清單是功能強大的工具，可用於自訂和建立互動式報表。

### <a name="time-range-parameters"></a>時間範圍參數

雖然您可以使用下拉式參數型別來建立您自己自訂的時間範圍參數，若您不需要自訂參數所提供的彈性，您也可以使用已經建立好的時間範圍參數型別。 

時間範圍參數型別有 15 種預設範圍，短至五分鐘，長至 90 天。 您還可以選擇允許自訂時間範圍選取，讓報表的操作者能指定時間範圍的起始值及終止值。

### <a name="resource-picker"></a>資源選擇器

資源選擇器參數型別讓您能根據特定資源類型設定報表範圍。 **效能**活頁簿是利用資源選擇器類型的預建活頁簿範例。

![工作區下拉式清單](media/vminsights-workbooks/014-workbook-edit-parameter-workspaces.png)

## <a name="saving-and-sharing-workbooks-with-your-team"></a>儲存活頁簿並且與小組共用

活頁簿會儲存在 Log Analytics 工作區或虛擬機器資源內，取決於您存取活頁簿資源庫的方式。 您可以將活頁簿儲存到您或 [**共用報表**] 區段中，您可以存取資源的每個人都可以存取的**我的報表**區段。 若要檢視資源中的所有活頁簿，請按一下動作列中的 [開啟]**** 按鈕。

若要共用目前在 [我的報表]**** 的活頁簿：

1. 按一下動作列中的 [開啟]****
2. 按一下您想要共用之活頁簿旁邊的 [...] 按鈕
3. 按一下 [移至共用報表]****。

若要使用連結或透過電子郵件共用活頁簿，請按一下動作列中的 [共用]****。 請注意，連結的收件者需要在 Azure 入口網站中存取此資源的存取權，才能檢視活頁簿。 若要進行編輯，收件者至少需要資源的參與者權限。

若要將活頁簿的連結釘選到 Azure 儀表板：

1. 按一下動作列中的 [開啟]****
2. 按一下您想要釘選之活頁簿旁邊的 [...] 按鈕
3. 按一下 [釘選到儀表板]****。

## <a name="next-steps"></a>後續步驟

- 若要識別限制和整體 VM 效能，請參閱 [View AZURE VM performance](vminsights-performance.md)。

- 若要了解探索到的應用程式相依性，請參閱[檢視適用於 VM 的 Azure 監視器對應](vminsights-maps.md)。
