---
title: 應用程式閘道的運作方式
description: 本文提供應用程式閘道如何接受傳入要求並將其路由傳送至後端的相關資訊。
services: application-gateway
author: abshamsft
ms.service: application-gateway
ms.topic: conceptual
ms.date: 11/16/2019
ms.author: absha
ms.openlocfilehash: 7622ac319929548dd50a3af763b1b65ea8a36d2b
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 07/02/2020
ms.locfileid: "85250225"
---
# <a name="how-an-application-gateway-works"></a>應用程式閘道的運作方式

本文說明應用程式閘道如何接受連入要求，並將其路由傳送至後端。

![應用程式閘道接受要求的方式](./media/how-application-gateway-works/how-application-gateway-works.png)

## <a name="how-an-application-gateway-accepts-a-request"></a>應用程式閘道接受要求的方式

1. 在用戶端將要求傳送至應用程式閘道之前，它會使用網域名稱系統（DNS）伺服器來解析應用程式閘道的功能變數名稱。 因為所有應用程式閘道都在 azure.com 網域中，所以 Azure 會控制 DNS 專案。

2. Azure DNS 會將 IP 位址傳回給用戶端，這是應用程式閘道的前端 IP 位址。

3. 應用程式閘道會接受一個或多個接聽項的連入流量。 接聽程式是檢查連接要求的邏輯實體。 它會針對從用戶端到應用程式閘道的連線，使用前端 IP 位址、通訊協定和埠號碼進行設定。

4. 如果 web 應用程式防火牆（WAF）正在使用中，應用程式閘道會針對 WAF 規則檢查要求標頭和主體（如果有的話）。 此動作會判斷要求是否為有效的要求或安全性威脅。 如果要求有效，它會路由傳送至後端。 如果要求無效，而 WAF 處於預防模式，則會被封鎖成為安全性威脅。 如果處於偵測模式，則會評估要求並加以記錄，但仍會轉送到後端伺服器。

Azure 應用程式閘道可做為內部應用程式負載平衡器，或作為網際網路面向的應用程式負載平衡器使用。 網際網路面向的應用程式閘道會使用公用 IP 位址。 網際網路對向應用程式閘道的 DNS 名稱可公開解析為其公用 IP 位址。 因此，網際網路面向的應用程式閘道可以將用戶端要求路由傳送至網際網路。

內部應用程式閘道僅使用私人 IP 位址。 如果您使用自訂或[私人 DNS 區域](https://docs.microsoft.com/azure/dns/private-dns-overview)，功能變數名稱應可內部解析為應用程式閘道的私人 IP 位址。 因此，內部負載平衡器只能將用戶端的要求路由至應用程式閘道的虛擬網路存取權。

## <a name="how-an-application-gateway-routes-a-request"></a>應用程式閘道如何路由傳送要求

如果要求有效，而且未被 WAF 封鎖，應用程式閘道會評估與接聽程式相關聯的要求路由規則。 此動作會決定要將要求路由至哪個後端集區。

根據要求路由規則，應用程式閘道會決定是否要將接聽程式上的所有要求路由傳送至特定後端集區、根據 URL 路徑將要求路由傳送至不同的後端集區，或是將要求重新導向至另一個埠或外部網站。
>[!NOTE]
>規則會依照它們列在 v1 SKU 入口網站中的順序進行處理。 

當應用程式閘道選取後端集區時，它會將要求傳送至集區中狀況良好的後端伺服器之一（y. y. y）。 伺服器的健全狀況取決於健康情況探查。 如果後端集區包含多部伺服器，應用程式閘道會使用迴圈配置資源演算法，在狀況良好的伺服器之間路由傳送要求。 這種負載會平衡伺服器上的要求。

應用程式閘道判斷後端伺服器之後，它會根據 HTTP 設定開啟與後端伺服器的新 TCP 會話。 HTTP 設定會指定與後端伺服器建立新會話所需的通訊協定、埠和其他路由相關設定。

HTTP 設定中使用的埠和通訊協定會決定應用程式閘道與後端伺服器之間的流量是否已加密（因而完成端對端 TLS）或未加密。

當應用程式閘道將原始要求傳送至後端伺服器時，它會接受在與覆寫主機名稱、路徑和通訊協定相關的 HTTP 設定中所做的任何自訂設定。 此動作會維護以 cookie 為基礎的會話親和性、連接清空、後端的主機名稱選取等等。

 >[!NOTE]
>如果後端集區：
> - **是公用端點**，應用程式閘道會使用其前端公用 IP 來連線到伺服器。 如果沒有前端公用 IP 位址，則會指派一個用於輸出外部連線。
> - **包含內部可解析的 FQDN 或私人 ip 位址**，應用程式閘道會使用其實例私人 IP 位址，將要求路由傳送至後端伺服器。
> - **包含外部端點或外部可解析的 FQDN**，應用程式閘道會使用其前端公用 IP 位址，將要求路由傳送至後端伺服器。 DNS 解析是以私人 DNS 區域或自訂 DNS 伺服器為基礎，如果已設定，則會使用預設的 Azure 提供的 DNS。 如果沒有前端公用 IP 位址，則會指派一個用於輸出外部連線。

### <a name="modifications-to-the-request"></a>對要求的修改

應用程式閘道會在所有要求中插入四個額外的標頭，然後再將要求轉送到後端。 這些標頭為 x 轉送-針對、x 轉送-proto、x 轉送埠和 x-原始主機。 X 轉送的格式是以逗號分隔的 IP： port 清單。

X 轉送-proto 的有效值為 HTTP 或 HTTPS。 [X-轉送-埠] 指定要求到達應用程式閘道的埠。 X-原始主機標頭包含要求抵達的原始主機標頭。 此標頭在 Azure 網站整合中很有用，其中內送主機標頭會在流量路由傳送至後端之前修改。 如果已啟用會話親和性做為選項，則會新增閘道管理的親和性 cookie。

您可以使用[重寫 HTTP 標頭](https://docs.microsoft.com/azure/application-gateway/rewrite-http-headers)，將應用程式閘道設定為修改標頭，或使用路徑覆寫設定來修改 URI 路徑。 不過，除非設定為這樣做，否則所有連入要求都會代理至後端。

## <a name="next-steps"></a>後續步驟

[瞭解應用程式閘道元件](application-gateway-components.md)
