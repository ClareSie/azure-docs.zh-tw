---
title: 裝置群組的自動部署 - Azure IoT Edge | Microsoft Docs
description: 使用 Azure IoT Edge 中的自動部署，根據共用標籤來管理裝置群組
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 01/30/2020
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: 8aaac6100ba980301ff3e85a3ac3959bfee89b49
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/27/2020
ms.locfileid: "76895959"
---
# <a name="understand-iot-edge-automatic-deployments-for-single-devices-or-at-scale"></a>了解單一裝置或大規模的 IoT Edge 自動部署

自動部署和分層部署可説明您在大量 IoT Edge 設備上管理和配置模組。

Azure IoT Edge 提供了兩種將模組配置為在 IoT 邊緣設備上運行的方法。 第一種方法是基於每個設備部署模組。 創建部署清單，然後按名稱將其應用於特定設備。 第二種方法是自動將模組部署到滿足一組定義條件的任何已註冊設備。 創建部署清單，然後根據設備孿生的[標記](../iot-edge/how-to-deploy-monitor.md#identify-devices-using-tags)定義它適用于哪些設備。

本文重點介紹和監視設備佇列，統稱為*IoT Edge 自動部署*。基本部署步驟如下：

1. 操作員定義描述一組模組和目標設備的部署。每個部署都含有反映此資訊的部署資訊清單。
2. IoT 中心服務與所有目標設備進行通信，以便使用聲明的模組配置它們。
3. IoT 中樞服務會從 IoT Edge 裝置擷取狀態，並使其供操作員使用。例如，操作員可以看到 Edge 設備何時未成功配置，或者模組在運行時失敗。
4. 隨時都可針對部署設定符合目標條件的新 IoT Edge 裝置。

本文說明用來設定及監視部署的每個相關元件。 如需建立和更新部署的逐步解說，請參閱[大規模部署和監視 IoT Edge 模組](how-to-deploy-monitor.md)。

## <a name="deployment"></a>部署

IoT Edge 自動部署會指派 IoT Edge 模組映像，在一組目標 IoT Edge 裝置上當成執行個體來執行。 其運作方式是設定 IoT Edge 部署資訊清單，以包含具有對應初始化參數的模組清單。您可以將部署指派到單一裝置 (根據裝置識別碼) 或裝置群組 (根據標記)。一旦 IoT Edge 裝置接收到部署資訊清單之後，就會從各自的容器存放庫下載並安裝容器映像，並據以設定它們。建立部署之後，操作員就能監視部署狀態，以查看是否已正確設定目標裝置。

只有 IoT Edge 裝置能使用部署進行設定。 裝置必須具備下列必要項目，才能接收部署：

* 基本作業系統
* 容器管理系統，例如 Moby 或 Docker
* 佈建 IoT Edge 執行階段

### <a name="deployment-manifest"></a>部署資訊清單

部署資訊清單是一份 JSON 文件，其中描述要在目標 IoT Edge 裝置上設定的模組。 其中包含所有模組的設定中繼資料，包括必要的系統模組 (特別是 IoT Edge 代理程式和 IoT Edge 中樞)。  

每個模組的設定中繼資料都會包括：

* 版本
* 類型
* 狀態 (例如執行中或已停止)
* 重新啟動原則
* 映像和容器登錄
* 資料輸入和輸出的路由

如果模組映像儲存在私人容器登錄中，則 IoT Edge 代理程式會保存登錄憑證。

### <a name="target-condition"></a>目標條件

在部署的整個生命週期中，持續評估目標條件。 任何符合需求的新裝置都會加入，並且任何不再符合需求的現有裝置都會遭到移除。 如果服務偵測到任何目標條件變更，部署將會重新啟動。

例如，您有一個具有目標條件標記的部署。 當您開始進行部署時，有 10 個生產裝置。 模組已成功安裝在這 10 個裝置中。 IoT Edge 代理狀態顯示 10 個總設備、10 個成功回應、0 個失敗回應和 0 個掛起的回應。 現在，您再新增五個具有 tags.environment = 'prod' 的裝置。 該服務檢測到更改，IoT Edge 代理狀態變為總共 15 個設備、10 個成功回應、0 個失敗回應和 5 個掛起回應，同時部署到 5 個新設備。

在設備孿生標記、設備孿生報告屬性或設備 Id 上使用任何布林條件來選擇目標設備。 如果想要使用具標籤的條件，您需要在與屬性相同的層級下，在裝置對應項中新增 "標籤":{} 區段。 [深入了解裝置對應項中的標籤](../iot-hub/iot-hub-devguide-device-twins.md)

目標條件的示例：

* deviceId ='linuxprod1'
* tags.environment ='prod'
* tags.environment = 'prod' AND tags.location = 'westus'
* tags.environment = 'prod' OR tags.location = 'westus'
* tags.operator = 'John' AND tags.environment = 'prod' NOT deviceId = 'linuxprod1'
* 屬性.報告.設備型號 = "4000x"

構造目標條件時請考慮以下約束：

* 在設備孿生中，只能使用標記、報告的屬性或設備 Id 生成目標條件。
* 目標條件的任何部分皆不允許雙引號。 使用單引號。
* 單引號代表目標條件的值。 因此，如果單引號是裝置名稱的一部分，您必須使用另一個單引號來避開使用單引號。 例如，若要瞄準稱為 `operator'sDevice` 的裝置，請撰寫 `deviceId='operator''sDevice'`。
* 在目標條件值中允許使用數字、字母和下列字元：`-:.+%_#*?!(),=@;$`。

### <a name="priority"></a>優先順序

優先順序會定義是否應將部署套用到相對於其他部署的目標裝置。 部署優先順序為正整數，以較大的數字表示較高的優先順序。 如果有多個部署將目標設為某個 IoT Edge 裝置，則會套用優先順序最高的部署。不會套用優先順序較低的部署，也不會將它們合併。如果有兩個以上具有相同優先順序的部署將目標設為某個裝置，則會套用最新建立的部署 (取決於建立時間戳記)。

### <a name="labels"></a>標籤

標籤是字串鍵/值對，可用於篩選和組部署。部署可能會有多個標籤。 標籤是可選的，不會影響 IoT 邊緣設備的實際配置。

### <a name="metrics"></a>計量

預設情況下，所有部署都報告四個指標：

* **目標**顯示與部署目標條件匹配的 IoT 邊緣設備。
* **已應用**顯示目標 IoT Edge 設備，這些設備不是其他更高優先順序部署的目標設備。
* **報告成功**顯示已報告模組已成功部署的 IoT Edge 設備。
* **報告失敗**顯示已報告一個或多個模組未成功部署的 IoT Edge 設備。 若要進一步調查此錯誤，請遠端連線到那些裝置並檢視記錄檔。

此外，您可以定義自己的自訂指標，以説明監視和管理部署。

指標提供設備在應用部署配置時可能報告回的各種狀態的匯總計數。 指標可以查詢[邊緣Hub模組孿生報告的屬性](module-edgeagent-edgehub.md#edgehub-reported-properties)，如*上次"希望狀態"* 或 *"上次連線時間*"。 例如：

```sql
SELECT deviceId FROM devices
  WHERE properties.reported.lastDesiredStatus.code = 200
```

添加您自己的指標是可選的，不會影響 IoT Edge 設備的實際配置。

## <a name="layered-deployment"></a>分層部署

分層部署是自動部署，可以組合在一起，以減少需要創建的唯一部署的數量。 分層部署在許多自動部署中以不同組合重用相同的模組時非常有用。

分層部署具有與任何自動部署相同的基本元件。 它們基於設備孿生中的標記定位設備，並在標籤、指標和狀態報表周圍提供相同的功能。 分層部署也為其分配了優先順序，但是優先順序不是使用優先順序來確定將哪個部署應用於設備，而是確定如何在設備上對多個部署進行排名。 例如，如果兩個分層部署具有一個模組或具有相同名稱的路由，則在覆蓋較低優先順序時將應用具有較高優先順序的分層部署。

系統運行時模組（邊緣代理模組和邊緣Hub）未配置為分層部署的一部分。 分層部署所針對的任何 IoT Edge 設備都需要首先應用於它的標準自動部署。 自動部署提供了可以在此基礎上添加分層部署的基礎。

IoT Edge 設備可以應用一個標準自動部署，但它可以應用多個分層自動部署。 任何針對設備的分層部署的優先順序必須高於該設備的自動部署。

例如，請考慮管理建築物的公司的以下方案。 他們開發了 IoT Edge 模組，用於從安全攝像機、動作感應器和電梯收集資料。 但是，並非所有的建築物都可以使用所有三個模組。 通過標準自動部署，公司需要為其建築物所需的所有模組組合創建單獨的部署。

![標準自動部署需要容納每個模組組合](./media/module-deployment-monitoring/standard-deployment.png)

但是，一旦公司切換到分層自動部署，他們發現他們可以為其建築物創建相同的模組組合，而要管理的部署更少。 每個模組都有自己的分層部署，設備標記標識將哪些模組添加到每個建築物中。

![分層自動部署簡化了以不同方式組合相同模組的方案](./media/module-deployment-monitoring/layered-deployment.png)

### <a name="module-twin-configuration"></a>模組孿生配置

當您使用分層部署時，您可能有意或無意地具有兩個部署，而同一模組針對設備。 在這些情況下，您可以決定優先順序較高的部署應覆蓋模組孿生或附加模組。 例如，您可能具有將同一模組應用於 100 個不同設備的部署。 但是，其中 10 個設備處於安全設施中，需要額外的配置才能通過代理伺服器進行通信。 您可以使用分層部署來添加模組孿生屬性，使這 10 台設備能夠安全地通信，而無需覆蓋基本部署中的現有模組孿生資訊。

您可以在部署清單中追加模組孿生所需屬性。 在標準部署中，您可以在模組孿生的**屬性.希望**部分中添加屬性，在分層部署中，可以聲明所需屬性的新子集。

例如，在標準部署中，您可以添加具有以下所需屬性的類比溫度感應器模組，這些屬性告訴它以 5 秒的間隔發送資料：

```json
"SimulatedTemperatureSensor": {
  "properties.desired": {
    "SendData": true,
    "SendInterval": 5
  }
}
```

在針對部分或全部相同設備的分層部署中，可以添加一個屬性，告訴類比感應器發送 1000 條消息，然後停止。 您不希望覆蓋現有屬性，因此在名為 的所需`layeredProperties`屬性中創建一個新節，其中包含新屬性：

```json
"SimulatedTemperatureSensor": {
  "properties.desired.layeredProperties": {
    "StopAfterCount": 1000
  }
}
```

應用了兩個部署的設備將反映類比溫度感應器的模組孿生中的以下屬性：

```json
"properties": {
  "desired": {
    "SendData": true,
    "SendInterval": 5,
    "layeredProperties": {
      "StopAfterCount": 1000
    }
  }
}
```

如果在分層部署中設置`properties.desired`模組孿生的欄位，它將覆蓋該模組在任何低優先順序部署中所需的屬性。

## <a name="phased-rollout"></a>階段式推出

階段式推出是一個整體程序，操作員可藉以將變更部署至一組範圍廣泛的 IoT Edge 裝置。 目標是逐漸進行變更，以降低進行大規模重大變更的風險。 自動部署有助於管理 IoT Edge 設備佇列中的分階段部署。

階段式推出會在下列階段和步驟中執行：

1. 建立 IoT Edge 裝置的測試環境，方法是佈建它們，並設定裝置對應項標記，例如 `tag.environment='test'`。測試環境應該鏡像處理部署最終將設為目標的生產環境。
2. 建立部署，其中包括所需的模組和設定。 目標條件應將目標設為測試 IoT Edge 裝置環境。
3. 在測試環境中驗證新的模組設定。
4. 更新部署，藉由將新標記新增至目標條件，來包括生產 IoT Edge 裝置子集。 此外，確定部署的優先順序高於目前將目標設為那些裝置的其他部署。
5. 藉由檢視部署狀態，來確認已在目標 IoT 裝置上成功部署。
6. 更新部署，將目標設為所有剩餘的生產 IoT Edge 裝置。

## <a name="rollback"></a>復原

部署可以在接收到錯誤或設定錯誤的情況下復原。由於部署會定義 IoT Edge 裝置的絕對模組設定，因此，即使目標是要移除所有模組，也必須以較低的優先順序將其他部署的目標設為同一個裝置。  

刪除部署不會從目標設備中刪除模組。 必須有另一個部署為裝置定義新配置，即使它是空部署也是如此。

依照以下順序執行復原：

1. 確認第二個部署也會在同一個裝置集合上設定目標。 如果復原的目標是要移除所有模組，則第二個部署不應包含任何模組。
2. 修改或移除您想要復原以使裝置不再符合目標條件之部署的目標條件運算式。
3. 藉由檢視部署狀態來確認已成功復原。
   * 已復原的部署應該不會再顯示已復原裝置的狀態。
   * 第二個部署現在應該會包含已復原裝置的部署狀態。

## <a name="next-steps"></a>後續步驟

* 逐步解說[大規模部署和監視 IoT Edge 模組](how-to-deploy-monitor.md)中，用來建立、更新或刪除部署的步驟。
* 深入了解其他 IoT Edge 概念，例如 [IoT Edge 執行階段](iot-edge-runtime.md)和 [IoT Edge 模組](iot-edge-modules.md)。
