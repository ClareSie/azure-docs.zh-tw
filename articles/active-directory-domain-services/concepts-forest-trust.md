---
title: Azure AD Domain Services 的信任如何運作 |Microsoft Docs
description: 深入瞭解樹系信任如何搭配 Azure AD Domain Services
services: active-directory-ds
author: MicrosoftGuyJFlo
manager: daveba
ms.service: active-directory
ms.subservice: domain-services
ms.workload: identity
ms.topic: conceptual
ms.date: 07/06/2020
ms.author: joflore
ms.openlocfilehash: 50b400ffa047d3865a9df77912da187de1ce9cc9
ms.sourcegitcommit: d103a93e7ef2dde1298f04e307920378a87e982a
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 10/13/2020
ms.locfileid: "91962610"
---
# <a name="how-trust-relationships-work-for-resource-forests-in-azure-active-directory-domain-services"></a>Azure Active Directory Domain Services 中資源樹系的信任關係如何運作

Active Directory Domain Services (AD DS) 透過網域和樹系信任關係，在多個網域或樹系之間提供安全性。 Windows 必須先檢查使用者、電腦或服務所要求的網域是否與要求帳戶的網域有信任關係，才能在信任之間進行驗證。

若要檢查此信任關係，Windows 安全性系統會針對接收要求的伺服器，以及要求的帳戶網域中的 DC，計算網域控制站 (DC) 之間的信任路徑。

AD DS 所提供的存取控制機制與 Windows 分散式安全性模型提供網域和樹系信任操作的環境。 為了讓這些信任正常運作，每個資源或電腦都必須具有其所在網域中的 DC 的直接信任路徑。

信任路徑是使用已驗證的遠端程序呼叫（ (RPC) 連線到信任的網域授權單位）來執行。 安全通道也會透過網域間信任關係，延伸至其他 AD DS 網域。 此安全通道可用來取得和驗證安全性資訊，包括使用者和群組 (Sid) 的安全識別碼。

如需如何將信任套用至 Azure AD DS 的總覽，請參閱 [資源樹系概念和功能][create-forest-trust]。

若要開始在 Azure AD DS 中使用信任，請 [建立使用樹系信任的受控網域][tutorial-create-advanced]。

## <a name="trust-relationship-flows"></a>信任關係流程

透過信任的安全通訊流程會決定信任的彈性。 您建立或設定信任的方式，會決定在樹系內或跨樹系之間的通訊延伸的程度。

透過信任的通訊流程是由信任的方向決定。 信任可以是單向或雙向的，而且可以是可轉移或不可轉移的。

下圖顯示 [ *樹狀結構 1* ] 和 [ *樹狀結構 2* ] 中的所有網域預設都有可轉移的信任關係。 如此一來，在資源上指派適當的許可權時， *樹系 1* 中的使用者就可以存取樹系中網域中的資源 *，而在* 樹狀結構 *1* 中的使用者可以存取 *樹狀結構 2*中的資源。

![兩個樹系之間的信任關係圖表](./media/concepts-forest-trust/trust-relationships.png)

### <a name="one-way-and-two-way-trusts"></a>單向和雙向信任

信任關係可讓您以單向或雙向方式存取資源。

單向信任是在兩個網域之間建立的單向驗證路徑。 在 *網域 a* 和 *網域 b*之間的單向信任中， *網域 a* 中的使用者可以存取 *網域 b*中的資源。不過， *網域 B* 中的使用者無法存取 *網域 A*中的資源。

根據所建立的信任類型而定，某些單向信任可能是不可轉移或可轉移的。

在雙向信任中， *網域 a* 信任 *網域 b* ，而 *網域 b* 信任 *網域 a*。這項設定表示可以在兩個網域之間雙向傳遞驗證要求。 根據所建立的信任類型而定，某些雙向關聯性可能是不可轉移或可轉移的。

AD DS 樹系中的所有網域信任都是雙向、可轉移的信任。 建立新的子網域時，會在新的子網域和父系網域之間自動建立雙向、可轉移信任。

### <a name="transitive-and-non-transitive-trusts"></a>可轉移和不可轉移的信任

轉移性可決定是否可以擴充信任，而這兩個網域的範圍是否可延伸。

* 可轉移的信任可用於擴充與其他網域之間的信任關係。
* 不可轉移的信任可以用來拒絕與其他網域的信任關係。

每次您在樹系中建立新網域時，會自動在新的網域和其父系網域之間建立雙向、可轉移的信任關係。 如果子域新增至新的網域，信任路徑會向上流向網域階層，以擴充在新網域和其父系網域之間建立的初始信任路徑。 可轉移的信任會沿著其形成的網域樹系上溯，在網域樹系中所有網域之間建立可轉移的信任。

驗證要求會遵循這些信任路徑，因此樹系中任何網域的帳戶都可以由樹系中的任何其他網域進行驗證。 透過單一登入精靈，具有適當許可權的帳戶可以存取樹系中任何網域的資源。

## <a name="forest-trusts"></a>樹系信任

樹系信任可協助您管理分段的 AD DS 基礎結構，並支援跨多個樹系存取資源和其他物件。 樹系信任適用于服務提供者、進行合併或收購的公司、共同作業的業務外部網路，以及尋求管理自主性解決方案的公司。

使用樹系信任時，您可以連結兩個不同的樹系，形成單向或雙向的可轉移信任關係。 樹系信任可讓系統管理員將兩個 AD DS 樹系與單一信任關係連接在一起，以提供跨樹系的流暢驗證和授權體驗。

樹系信任只能在一個樹系的樹系根域和另一個樹系的樹系根域之間建立。 樹系信任只能在兩個樹系之間建立，且無法隱含擴充至第三個樹系。 此行為表示，如果樹系信任建立于 *樹系 1* 和 *樹系 2*之間，而且樹系 *2* 和樹系 *3*之間建立另一個樹系信任，則樹系 *1* 與 *樹系 3*之間並沒有隱含信任。

下圖顯示單一組織中三個 AD DS 樹系之間的兩個不同樹系信任關係。

![單一組織內樹系信任關聯性的圖表](./media/concepts-forest-trust/forest-trusts-diagram.png)

此範例設定提供下列存取權：

* 樹系*2*中的使用者可以存取*樹系 1*或*樹系 3*中任何網域的資源
* 樹系*3*中的使用者可以存取*樹系 2*中任何網域的資源
* 樹系*1*中的使用者可以存取*樹系 2*中任何網域的資源

這項設定不允許 *樹系 1* 中的使用者存取 *樹系 3* 中的資源，反之亦然。 若要允許樹系 *1* 和 *樹系 3* 中的使用者共用資源，則必須在兩個樹系之間建立雙向的可轉移信任。

如果在兩個樹系之間建立單向樹系信任，受信任樹系的成員可以利用位於信任樹系中的資源。 但是，信任只能單方向運作。

例如，在 *樹系 1* 之間建立單向樹系信任時 (信任樹系) 和 *樹系 2* (信任樹系) ：

* 樹系 *1* 的成員可以存取位於 *樹系 2*中的資源。
* 樹系 *2* 的成員無法使用相同的信任存取位於 *樹系 1* 中的資源。

> [!IMPORTANT]
> Azure AD Domain Services 資源樹系僅支援對內部部署 Active Directory 的單向樹系信任。

### <a name="forest-trust-requirements"></a>樹系信任需求

在您可以建立樹系信任之前，您必須先確認您有正確的網域名稱系統 (DNS) 基礎結構。 只有在下列其中一個 DNS 設定可供使用時，才能建立樹系信任：

* 單一根 DNS 伺服器是兩個樹系 DNS 命名空間的根 DNS 伺服器-根區域包含每個 DNS 命名空間的委派，以及所有 DNS 伺服器的根提示，包括根 DNS 伺服器。
* 如果沒有共用的根 DNS 伺服器，且每個樹系 DNS 命名空間中的根 DNS 伺服器都使用每個 DNS 命名空間的 DNS 條件轉寄站，以路由傳送其他命名空間中的名稱查詢。

    > [!IMPORTANT]
    > Azure AD Domain Services 資源樹系必須使用此 DNS 設定。 裝載資源樹系 DNS 命名空間以外的 DNS 命名空間不是 Azure AD Domain Services 的功能。 條件轉寄站是正確的設定。

* 如果沒有共用的根 DNS 伺服器，且每個樹系 DNS 命名空間中的根 DNS 伺服器都使用 DNS 次要區域，則會在每個 DNS 命名空間中設定，以路由其他命名空間中的名稱查詢。

若要建立樹系信任，您必須是樹系根域中的 Domain Admins 群組 (成員，) 或 Active Directory 中的 Enterprise Admins 群組。 系統會將兩個樹系中的系統管理員都必須知道的密碼指派給每個信任。 這兩個樹系中的企業系統管理員成員都可以同時在這兩個樹系中建立信任，而在此案例中，會自動為這兩個樹系產生和寫入密碼編譯隨機的密碼。

Azure AD Domain Services 的輸出樹系信任是在 Azure 入口網站中建立。 您不會手動建立與受控網域本身的信任。 傳入樹系信任必須由具有先前在內部部署 Active Directory 中注明之許可權的使用者進行設定。

## <a name="trust-processes-and-interactions"></a>信任進程和互動

許多網域間和樹系間交易都需依賴網域或樹系信任，才能完成各種工作。 本節說明在跨信任存取資源時所發生的處理常式和互動，以及驗證參考的評估。

### <a name="overview-of-authentication-referral-processing"></a>驗證參考處理的總覽

當要求驗證的網域時，該網域中的網域控制站必須判斷是否存在與要求所在網域的信任關係。 信任方向以及信任是否可轉移或非轉移，必須在驗證使用者以存取網域中的資源之前，也必須先加以決定。 受信任網域之間發生的驗證程式會根據使用中的驗證通訊協定而有所不同。 Kerberos V5 和 NTLM 通訊協定會以不同的方式處理對網域進行驗證的參考

### <a name="kerberos-v5-referral-processing"></a>Kerberos V5 參考處理

Kerberos V5 驗證通訊協定相依于網域控制站上的 Net Logon 服務，以進行用戶端驗證和授權資訊。 Kerberos 通訊協定會連接到線上金鑰發佈中心 (KDC) 以及會話票證的 Active Directory 帳戶存放區。

Kerberos 通訊協定也會將信任用於跨領域的票證授與服務 (TGS) 以及驗證在安全通道 (Pac) 的許可權屬性憑證。 Kerberos 通訊協定只會使用非 Windows 品牌的作業系統 Kerberos 領域（例如 MIT Kerberos 領域）來執行跨領域驗證，而且不需要與 Net Logon 服務互動。

如果用戶端使用 Kerberos V5 進行驗證，它會向目標網域中的伺服器要求票證，並從其帳戶網域中的網域控制站要求票證。 Kerberos KDC 在用戶端和伺服器之間扮演受信任的媒介，並提供可讓雙方彼此驗證的工作階段金鑰。 如果目標網域與目前的網域不同，KDC 會遵循邏輯進程來判斷是否可以參考驗證要求：

1. 目前網域是否由所要求之伺服器的網域直接信任？
    * 如果是，請將參考傳送給用戶端要求的網域。
    * 如果沒有，請移至下一個步驟。

2. 目前網域與信任路徑上的下一個網域之間是否有可轉移的信任關係？
    * 如果是，請將用戶端的參考傳送至信任路徑上的下一個網域。
    * 如果不是，請將登入拒絕訊息傳送給用戶端。

### <a name="ntlm-referral-processing"></a>NTLM 參考處理

NTLM 驗證通訊協定相依于網域控制站上的 Net Logon 服務，以進行用戶端驗證和授權資訊。 此通訊協定會驗證未使用 Kerberos 驗證的用戶端。 NTLM 使用信任在網域之間傳遞驗證要求。

如果用戶端使用 NTLM 進行驗證，則驗證的初始要求會直接從用戶端傳送至目標網域中的資源伺服器。 此伺服器會建立用戶端回應的挑戰。 接著，伺服器會將使用者的回應傳送至其電腦帳戶網域中的網域控制站。 此網域控制站會檢查使用者帳戶是否與其安全性帳戶資料庫。

如果帳戶不存在於資料庫中，網域控制站會使用下列邏輯來判斷是否要執行傳遞驗證、轉寄要求或拒絕要求：

1. 目前網域是否與使用者網域具有直接信任關係？
    * 如果是，網域控制站會將用戶端的認證傳送至使用者網域中的網域控制站，以進行傳遞驗證。
    * 如果沒有，請移至下一個步驟。

2. 目前網域是否與使用者網域具有可轉移的信任關係？
    * 如果是，請將驗證要求傳遞至信任路徑中的下一個網域。 此網域控制站會針對自己的安全性帳戶資料庫檢查使用者的認證，以重複此程式。
    * 如果不是，請將登入拒絕的訊息傳送給用戶端。

### <a name="kerberos-based-processing-of-authentication-requests-over-forest-trusts"></a>以 Kerberos 為基礎的驗證要求透過樹系信任處理

當樹系信任連接兩個樹系時，使用 Kerberos V5 或 NTLM 通訊協定提出的驗證要求可以在樹系之間路由傳送，以提供這兩個樹系中資源的存取權。

第一次建立樹系信任時，每個樹系都會收集其夥伴樹系中所有信任的命名空間，並將資訊儲存在 [受信任的網域物件](#trusted-domain-object)中。 受信任的命名空間包括網域樹系名稱、使用者主體名稱 (UPN) 尾碼、服務主體名稱 (SPN) 尾碼，以及在其他樹系中使用的安全識別碼 (SID) 命名空間。 TDO 物件會複寫到通用類別目錄。

在驗證通訊協定可以遵循樹系信任路徑之前，必須將資源電腦的服務主體名稱 (SPN) 解析為另一個樹系中的位置。 SPN 可以是下列其中一個名稱：

* 主機的 DNS 名稱。
* 網域的 DNS 名稱。
* 服務連接點物件的分辨名稱。

當某個樹系中的工作站嘗試存取另一個樹系中的資源電腦上的資料時，Kerberos 驗證程式會將服務票證的網域控制站連線到資源電腦的 SPN。 一旦網域控制站查詢通用類別目錄，並判斷 SPN 不在與網域控制站相同的樹系中，網域控制站就會將其父系網域的參照傳送回工作站。 屆時，工作站會查詢父網域中的服務票證，並繼續追蹤參考鏈，直到到達資源所在的網域為止。

下圖和步驟提供在執行 Windows 的電腦嘗試從位於其他樹系的電腦存取資源時，所使用之 Kerberos 驗證程式的詳細描述。

![透過樹系信任的 Kerberos 進程圖表](media/concepts-forest-trust/kerberos-over-forest-trust-process-diagram.png)

1. *User1*使用*europe.tailspintoys.com*網域的認證登入*Workstation1* 。 然後，使用者會嘗試存取位於*usa.wingtiptoys.com*樹系中*FileServer1*上的共用資源。

2. *Workstation1* 會在其網域中的網域控制站上聯絡 Kerberos KDC、 *ChildDC1*，以及要求 *FileServer1* SPN 的服務票證。

3. *ChildDC1* 在其網域資料庫中找不到 SPN，並會查詢通用類別目錄，以查看 *tailspintoys.com* 樹系中的任何網域是否包含此 spn。 因為通用類別目錄受限於其本身的樹系，所以找不到 SPN。

    通用類別目錄接著會檢查其資料庫，以取得與其樹系建立之任何樹系信任的相關資訊。 如果找到，它會比較樹系信任信任網域物件中所列的名稱尾碼 (TDO) 至目標 SPN 的尾碼，以尋找相符項。 一旦找到相符的，通用類別目錄就會將路由提示提供回 *ChildDC1*。

    路由提示有助於將驗證要求導向目的地樹系。 只有在所有傳統驗證通道（例如本機網域控制站和通用類別目錄）找不到 SPN 時，才會使用提示。

4. *ChildDC1* 會將其父系網域的參考傳回 *Workstation1*。

5. *Workstation1*會將*ForestRootDC1*中的網域控制站 (其父網域) ，以供*樹系的樹*系根域中的網域控制站參考 (*ForestRootDC2*) 。

6. *Workstation1*會將服務票證的*wingtiptoys.com*樹系中*ForestRootDC2*的連絡人加入要求的服務。

7. *ForestRootDC2* 會聯絡其通用類別目錄以尋找 spn，且通用類別目錄會尋找符合 spn 的內容，並將其傳回至 *ForestRootDC2*。

8. *ForestRootDC2* 接著會將 *usa.wingtiptoys.com* 的參考傳送回 *Workstation1*。

9. *Workstation1* 會在 *CHILDDC2* 上聯繫 KDC，並協商 *User1* 的票證以取得 *FileServer1*的存取權。

10. 一旦 *Workstation1* 有服務票證，它就會將服務票證傳送至 *FileServer1*，以讀取 *User1*的安全性認證並據以建立存取權杖。

## <a name="trusted-domain-object"></a>受信任的網域物件

組織內的每個網域或樹系信任都是由受信任的網域物件代表 (TDO) 儲存在其網域內的 *系統* 容器中。

### <a name="tdo-contents"></a>TDO 內容

TDO 中包含的資訊會根據您是網域信任建立的 TDO 或由樹系信任而定。

建立網域信任時，會在 TDO 中表示 DNS 功能變數名稱、網域 SID、信任類型、信任轉移性及交互功能變數名稱等屬性。 樹系信任 Tdo 儲存其他屬性，以識別夥伴樹系中所有信任的命名空間。 這些屬性包括網域樹系名稱、使用者主體名稱 (UPN) 尾碼、服務主體名稱 (SPN) 尾碼，以及安全識別碼 (SID) 命名空間。

由於信任會以 Tdo 的形式儲存在 Active Directory 中，因此樹系中的所有網域都知道整個樹系中的信任關係。 同樣地，當兩個或多個樹系透過樹系信任聯結在一起時，每個樹系中的樹系根域都知道信任的樹系中所有網域的信任關係。

### <a name="tdo-password-changes"></a>TDO 密碼變更

信任關係中的兩個網域都會共用密碼，此密碼會儲存在 Active Directory 的 TDO 物件中。 在帳戶維護過程中，每隔30天，信任網域控制站會變更儲存在 TDO 中的密碼。 因為所有雙向信任 2 1 實際上都是以相反的方式進行，所以雙向信任的程式會發生兩次。

信任具有信任和信任的端。 在信任的端上，所有可寫入的網域控制站都可用於處理常式。 在信任端，PDC 模擬器會執行密碼變更。

若要變更密碼，網域控制站會完成下列程式：

1. 信任網域中 (PDC) 模擬器的主域控制站會建立新的密碼。 受信任網域中的網域控制站永遠不會起始密碼變更。 它一律由信任網域 PDC 模擬器起始。

2. 信任網域中的 PDC 模擬器會將 TDO 物件的 *OldPassword* 欄位設定為目前的 *NewPassword* 欄位。

3. 信任網域中的 PDC 模擬器會將 TDO 物件的 *NewPassword* 欄位設定為新的密碼。 如果信任網域中的網域控制站無法接收變更，或是在要求使用新的信任密碼之前未複寫變更，則保留先前密碼的複本可讓您還原為舊密碼。

4. 信任網域中的 PDC 模擬器會進行遠端呼叫信任網域中的網域控制站，要求它將信任帳戶的密碼設定為新的密碼。

5. 受信任網域中的網域控制站會將信任密碼變更為新密碼。

6. 在信任的每一端，更新都會複寫到網域中的其他網域控制站。 在信任網域中，變更會觸發受信任網域物件的緊急複寫。

這兩個網域控制站上的密碼現在都會變更。 一般複寫會將 TDO 物件分散至網域中的其他網域控制站。 不過，信任網域中的網域控制站可能會變更密碼，而不會成功更新受信任網域中的網域控制站。 發生此情況的原因可能是無法建立處理密碼變更所需的安全通道。 您也可能在此程式中的某個時間點無法使用受信任網域中的網域控制站，而且可能不會收到更新的密碼。

為了處理未成功傳達密碼變更的情況，信任網域中的網域控制站永遠不會變更新的密碼，除非已成功驗證 (使用新密碼) 設定安全通道。 此行為是因為舊密碼和新密碼會保留在信任網域的 TDO 物件中。

密碼變更在使用密碼驗證成功之前不會完成。 舊的預存密碼可透過安全通道使用，直到受信任網域中的網域控制站收到新密碼，進而啟用不中斷的服務。

如果使用新密碼進行驗證失敗，因為密碼無效，信任網域控制站會嘗試使用舊密碼進行驗證。 如果使用舊密碼成功驗證，則會在15分鐘內繼續進行密碼變更程式。

信任密碼更新必須在30天內複寫到信任雙方的網域控制站。 如果在30天后變更了信任密碼，且網域控制站只有 N-2 密碼，則無法使用信任端的信任，也無法在信任端建立安全通道。

## <a name="network-ports-used-by-trusts"></a>信任使用的網路埠

由於信任必須部署在不同的網路界限上，因此可能必須跨越一或多個防火牆。 當發生這種情況時，您可以透過通道來信任防火牆之間的流量，或在防火牆中開啟特定埠，以允許流量通過。

> [!IMPORTANT]
> Active Directory Domain Services 不支援將 Active Directory RPC 流量限制為特定埠。

閱讀 Microsoft 支援服務文章中的 **Windows Server 2008 和更新版本** 一節，以瞭解 [如何設定 Active Directory 網域和信任的防火牆](https://support.microsoft.com/help/179442/how-to-configure-a-firewall-for-domains-and-trusts) ，以瞭解樹系信任所需的埠。

## <a name="supporting-services-and-tools"></a>支援服務和工具

為了支援信任和驗證，會使用一些額外的功能和管理工具。

### <a name="net-logon"></a>Net Logon

Net Logon 服務會維護從 Windows 電腦到 DC 的安全通道。 它也會用於下列與信任相關的程式：

* 信任設定和管理-網路登入有助於維護信任密碼、收集信任資訊，以及藉由與 LSA 進程和 TDO 互動來驗證信任。

    針對樹系信任，信任資訊包括樹系信任資訊 (*FTInfo*) 記錄，其中包含受信任樹系宣告要管理的一組命名空間，並以指出信任樹系是否信任每個宣告的欄位批註。

* 驗證–透過安全通道提供使用者認證給網域控制站，並傳回使用者的網域 Sid 和使用者權限。

* 網域控制站位置–有助於尋找或尋找網域中或跨網域的網域控制站。

* 傳遞驗證–其他網域中的使用者認證會由 Net Logon 進行處理。 當信任網域需要驗證使用者的身分識別時，它會透過 Net Logon 將使用者的認證傳遞至受信任網域以進行驗證。

* 許可權屬性憑證 (PAC) 驗證：當使用 Kerberos 通訊協定進行驗證的伺服器需要驗證服務票證中的 PAC 時，它會將安全通道之間的 PAC 傳送到其網域控制站進行驗證。

### <a name="local-security-authority"></a>本機安全性授權

 (LSA) 的「本地安全機構」是受保護的子系統，可維護系統上本機安全性各層面的相關資訊。 LSA 統稱為「本機安全性原則」，可針對名稱與識別碼之間的轉譯提供各種服務。

LSA 安全性子系統提供核心模式和使用者模式的服務，以驗證物件的存取權、檢查使用者權限，以及產生審核訊息。 LSA 負責檢查受信任或不受信任網域中的服務所呈現的所有會話票證的有效性。

### <a name="management-tools"></a>管理工具

系統管理員可以使用 *Active Directory 網域和信任*、 *Netdom* 和 *Nltest* 來公開、建立、移除或修改信任。

* *Active Directory 網域和信任* 是用來管理網域信任、網域和樹系功能等級，以及使用者主體名稱尾碼的 MICROSOFT MANAGEMENT CONSOLE (MMC) 。
* *Netdom*和*Nltest*命令列工具可以用來尋找、顯示、建立和管理信任。 這些工具會直接與網域控制站上的 LSA 授權單位進行通訊。

## <a name="next-steps"></a>後續步驟

若要深入瞭解資源樹系，請參閱 [AZURE AD DS 中的樹系信任如何運作？][concepts-trust]

若要開始使用資源樹系建立受控網域，請參閱 [建立及設定 AZURE AD DS 受控網域][tutorial-create-advanced]。 然後，您可以 [建立內部部署網域的輸出樹系信任][create-forest-trust]。

<!-- LINKS - INTERNAL -->
[concepts-trust]: concepts-forest-trust.md
[tutorial-create-advanced]: tutorial-create-instance-advanced.md
[create-forest-trust]: tutorial-create-forest-trust.md
