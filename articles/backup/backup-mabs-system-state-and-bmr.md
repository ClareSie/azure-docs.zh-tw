---
title: 系統狀態和裸機復原保護
description: 使用 Azure 備份伺服器來備份系統狀態，並提供裸機復原（BMR）保護。
ms.topic: conceptual
ms.date: 05/15/2017
ms.openlocfilehash: c5096158ca0e76ca03577347d8dd3e1419a33ca0
ms.sourcegitcommit: 3543d3b4f6c6f496d22ea5f97d8cd2700ac9a481
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 07/20/2020
ms.locfileid: "86538695"
---
# <a name="back-up-system-state-and-restore-to-bare-metal-by-using-azure-backup-server"></a>使用 Azure 備份伺服器來備份系統狀態及還原為裸機

Azure 備份伺服器可備份系統狀態及提供裸機復原 (BMR) 保護。

* **系統狀態備份**：備份作業系統檔案。 此備份可讓您在電腦啟動時復原，但系統檔案和登錄會遺失。 系統狀態備份包含下列元素：
  * 網域成員：開機檔案、COM+ 類別註冊資料庫、登錄
  * 網域控制站：Windows Server Active Directory (NTDS)、開機檔案、 COM+ 類別註冊資料庫、登錄、系統磁碟區 (SYSVOL)
  * 執行叢集服務的電腦：叢集伺服器中繼資料
  * 執行憑證服務的電腦：憑證資料
* **裸機備份**：備份重要磁片區上的作業系統檔案和所有資料（使用者資料除外）。 根據定義，BMR 備份包括系統狀態備份。 當電腦無法啟動，而且您必須復原所有項目時，裸機備份便可提供保護。

下表摘要說明您可以備份及復原的項目。 如需系統狀態和 BMR 可以保護之應用程式版本的相關資訊，請參閱[Azure 備份伺服器備份的內容](backup-mabs-protection-matrix.md)。

|Backup|問題|從 Azure 備份伺服器的備份進行復原|從系統狀態的備份進行復原|BMR|
|----------|---------|---------------------------|------------------------------------|-------|
|**檔案資料**<br /><br />一般資料備份<br /><br />BMR/系統狀態備份|遺失檔案資料|Y|N|N|
|**檔案資料**<br /><br />Azure 備份伺服器的檔案資料備份<br /><br />BMR/系統狀態備份|作業系統遺失或損毀|N|Y|Y|
|**檔案資料**<br /><br />Azure 備份伺服器的檔案資料備份<br /><br />BMR/系統狀態備份|遺失伺服器 (資料磁碟區未受損)|N|N|Y|
|**檔案資料**<br /><br />Azure 備份伺服器的檔案資料備份<br /><br />BMR/系統狀態備份|遺失伺服器 (資料磁碟區也遺失)|Y|N|Y<br /><br />BMR，後面接著定期復原備份檔案資料|
|**SharePoint 資料**<br /><br />Azure 備份伺服器的伺服器陣列資料備份<br /><br />BMR/系統狀態備份|遺失網站、清單、清單項目、文件|Y|N|N|
|**SharePoint 資料**<br /><br />Azure 備份伺服器的伺服器陣列資料備份<br /><br />BMR/系統狀態備份|作業系統遺失或損毀|N|Y|Y|
|**SharePoint 資料**<br /><br />Azure 備份伺服器的伺服器陣列資料備份<br /><br />BMR/系統狀態備份|災害復原|N|N|N|
|Windows Server 2012 R2 Hyper-V<br /><br />Azure 備份伺服器的 Hyper-V 主機或客體備份<br /><br />主機的 BMR/系統狀態備份|遺失 VM|Y|N|N|
|Hyper-V<br /><br />Azure 備份伺服器的 Hyper-V 主機或客體備份<br /><br />主機的 BMR/系統狀態備份|作業系統遺失或損毀|N|Y|Y|
|Hyper-V<br /><br />Azure 備份伺服器的 Hyper-V 主機或客體備份<br /><br />主機的 BMR/系統狀態備份|遺失 Hyper-V 主機 (VM 未受損)|N|N|Y|
|Hyper-V<br /><br />Azure 備份伺服器的 Hyper-V 主機或客體備份<br /><br />主機的 BMR/系統狀態備份|遺失 Hyper-V 主機 (VM 也遺失)|N|N|Y<br /><br />先進行 BMR，接著進行 Azure 備份伺服器一般復原|
|SQL Server/Exchange<br /><br />Azure 備份伺服器應用程式備份<br /><br />BMR/系統狀態備份|遺失應用程式資料|Y|N|N|
|SQL Server/Exchange<br /><br />Azure 備份伺服器應用程式備份<br /><br />BMR/系統狀態備份|作業系統遺失或損毀|N|Y|Y|
|SQL Server/Exchange<br /><br />Azure 備份伺服器應用程式備份<br /><br />BMR/系統狀態備份|遺失伺服器 (資料庫/交易記錄未受損)|N|N|Y|
|SQL Server/Exchange<br /><br />Azure 備份伺服器應用程式備份<br /><br />BMR/系統狀態備份|遺失伺服器 (資料庫/交易記錄也遺失)|N|N|Y<br /><br />先進行 BMR 復原，接著進行 Azure 備份伺服器一般復原|

## <a name="how-system-state-backup-works"></a>系統狀態備份的運作方式

當系統狀態備份執行時，備份伺服器會與 Windows Server Backup 通訊以要求伺服器系統狀態的備份。 根據預設，備份伺服器和 Windows Server Backup 會使用擁有最多可用空間的磁碟機。 此磁片磁碟機的相關資訊會儲存在*PSDataSourceConfig.xml*檔案中。

您可以自訂備份伺服器用來進行系統狀態備份的磁片磁碟機：

1. 在受保護的伺服器上，移至*C:\Program Files\Microsoft Data Protection Manager\MABS\Datasources*。
1. 開啟*PSDataSourceConfig.xml*檔案進行編輯。
1. 變更磁碟機代號的 [] 值。
1. 儲存並關閉檔案。

如果保護群組設定為保護電腦的系統狀態，請執行一致性檢查。 如果產生警示，請選取警示中的 [**修改保護群組**]，然後完成嚮導中的頁面。 接著執行另一個一致性檢查。

如果保護伺服器是在叢集中，可能會選取叢集磁片磁碟機做為具有最多可用空間的磁片磁碟機。 如果該磁片磁碟機的擁有權切換到另一個節點，並執行系統狀態備份，則該磁片磁碟機將無法使用，且備份會失敗。 在此案例中，請將*PSDataSourceConfig.xml*修改為指向本機磁片磁碟機。

接下來，Windows Server Backup 會在 restore 資料夾的根目錄中建立名為*WindowsImageBackup*的資料夾。 當 Windows Server Backup 建立備份時，所有資料都會放在這個資料夾中。 當備份完成時，檔案就會傳輸到備份伺服器電腦。 請注意下列資訊︰

* 當備份或傳輸完成時，不會清除此資料夾及其內容。 最好的方法是將空間保留下來，以供下一次備份完成時使用。
* 會針對每個備份建立資料夾。 其日期和時間戳記會反映最後一次進行系統狀態備份的時間。

## <a name="how-bmr-backup-works"></a>BMR 備份的運作方式

在進行 BMR (包括系統狀態備份) 時，備份作業會直接儲存到備份伺服器電腦上的共用， 它不會儲存到受保護伺服器上的資料夾。

備份伺服器會呼叫 Windows Server Backup，並共用該 BMR 備份的複本磁碟區。 在此情況下，不需要 Windows Server Backup 使用具有最多可用空間的磁片磁碟機。 相反地，它會使用針對該作業所建立的共用。

當備份完成時，檔案就會傳輸到備份伺服器電腦。 記錄檔會儲存在*C:\Windows\Logs\WindowsServerBackup*中。

## <a name="prerequisites-and-limitations"></a>必要條件和限制

* 執行 Windows Server 2003 的電腦或執行用戶端作業系統的電腦皆不支援 BMR。

* 您無法針對位於不同保護群組的同一部電腦保護 BMR 和系統狀態。

* 備份伺服器電腦無法讓自己受到 BMR 保護。

* BMR 不支援磁帶的短期保護（磁片到磁帶或 D2T）。 支援將長期儲存到磁帶（磁片到磁片到磁帶，或 D2D2T）。

* 若要獲得 BMR 保護，您必須在受保護的電腦上安裝 Windows Server Backup。

* 對於 BMR 保護，與系統狀態保護不同的是，備份伺服器在受保護的電腦上沒有任何空間需求。 Windows Server Backup 會將備份直接傳輸到備份伺服器電腦。 備份傳輸作業不會出現在備份伺服器的 [作業]**** 檢視中。

* 備份伺服器會在複本磁碟區上保留 30 GB 的空間，以供執行 BMR。 您可以在 [修改保護組嚮導] 的 [**磁片配置**] 頁面上變更此空間配額。 或者，您可以使用 Get-datasourcediskallocation 和 Get-datasourcediskallocation PowerShell Cmdlet。 在復原點磁碟區上，BMR 保護需要大約 6 GB 的空間來將資料保留五天。
  * 您無法將複本磁片區大小降到 15 GB 以下。
  * 備份伺服器不會計算 BMR 資料來源的大小。 它會假設所有伺服器都有 30 GB。 請根據您預期環境中所具有的 BMR 備份大小來變更此值。 您可以大致計算 BMR 備份的大小，做為所有重要磁片區上已使用空間的總和。 重要磁碟區 = 開機磁碟區 + 系統磁碟區 + 裝載系統狀態資料的磁碟區，例如 Active Directory。

* 如果您從系統狀態保護變更為 BMR 保護，則 BMR 保護在*復原點磁片*區上需要較少的空間。 不過，磁片區上的額外空間並不會被回收。 您可以在 [修改保護組嚮導] 的 [**修改磁片配置**] 頁面上，手動縮小音量大小。 或者，您可以使用 Get-datasourcediskallocation 和 Get-datasourcediskallocation PowerShell Cmdlet。

    如果您從系統狀態保護變更為 BMR 保護，則 BMR 保護在*複本磁片*區上需要更多空間。 系統會自動擴充磁碟區。 如果您想要變更預設空間配置，請使用 Get-diskallocation PowerShell Cmdlet。

* 如果您從 BMR 保護變更為系統狀態保護，則在復原點磁片區上需要更多空間。 備份伺服器可能會嘗試自動增加磁碟區。 如果存放集區沒有足夠的空間，就會發生錯誤。

    如果您從 BMR 保護變更為系統狀態保護，則必須在受保護的電腦上有空間。 您需要空間，因為系統狀態保護會先將複本寫入至本機電腦，然後再將複本傳輸到備份伺服器電腦。

## <a name="before-you-begin"></a>開始之前

1. **部署 Azure 備份伺服器**。 請確認您是否已正確地部署備份伺服器。 如需詳細資訊，請參閱：
    * [Azure 備份伺服器的系統需求](/system-center/dpm/install-dpm#setup-prerequisites)
    * [備份伺服器保護對照表](backup-mabs-protection-matrix.md)

1. **設定存放裝置**。 您可以將備份資料儲存在磁碟上、磁帶上以及 Azure 雲端中。 如需詳細資訊，請參閱[準備資料儲存體](/system-center/dpm/plan-long-and-short-term-data-storage)。

1. **設定保護代理程式**。 在您要備份的電腦上安裝保護代理程式。 如需詳細資訊，請參閱[部署 DPM 保護代理程式](/system-center/dpm/deploy-dpm-protection-agent)。

## <a name="back-up-system-state-and-bare-metal"></a>備份系統狀態和裸機

若要備份系統狀態和裸機：

1. 若要開啟 [建立新增保護群組精靈，請在備份伺服器系統管理員主控台中，選取 [**保護**] [動作] [  >  **Actions**  >  **建立保護群組**]。

1. 在 [選取保護群組類型]**** 頁面上，選取 [伺服器]****，然後選取 [下一步]****。

1. 在 [選取群組成員]**** 頁面上展開電腦，然後選取 [BMR]**** 或 [系統狀態]****。

    請記住，您無法針對位於不同群組的同一部電腦同時保護 BMR 和系統狀態。 此外，當您選取 BMR 時，系統會自動啟用系統狀態。 如需詳細資訊，請參閱[部署保護群組](/system-center/dpm/create-dpm-protection-groups)。

1. 在 [**選擇資料保護方式**] 頁面上，選擇處理短期備份與長期備份的方式。

    短期備份一律會優先于磁片，並可選擇使用 Azure 備份（短期或長期）從磁片備份至 Azure。 若要以雲端作為目的地進行長期備份，替代方式為將長期備份的目的地設為獨立磁帶裝置或連線到備份伺服器的磁帶媒體櫃。

1. 在 [**選取短期目標**] 頁面上，選擇備份到磁片上短期儲存的方式：
    * 在 [**保留範圍**] 中，選擇要將資料保留在磁片上的時間長度。
    * 針對 **[同步處理頻率**]，選擇執行增量備份到磁片的頻率。 如果您不想設定備份間隔，可以選取 [**恰好在復原點之前**]。 備份伺服器會在排程每個復原點之前執行快速完整備份。

1. 如果您想要將資料儲存在磁帶上進行長期儲存，請在 [**指定長期目標**] 頁面上，選擇要保留磁帶資料的時間長度（1到99年）。
    1. 在 [**備份頻率**] 中，選擇執行備份至磁帶的頻率。 頻率是根據您選取的保留範圍而定：
        * 當保留範圍是1到99年時，您可以備份每日、每週、每兩周、每月、每季、每半年或每年。
        * 當保留範圍是1到11個月時，您可以每日、每週、每兩周或每月備份。
        * 當保留範圍是1到4周時，您可以每日或每週備份。

    1. 在 [**選取磁帶和媒體櫃詳細資料**] 頁面上，選取要使用的磁帶和媒體櫃。 同時選擇是否應該壓縮和加密資料。

1. 在 [**審查磁片配置**] 頁面上，檢查保護群組可用的存放集區磁碟空間。

    * [資料大小總計]**** 是您要備份的資料大小。
    * [要在 Azure 備份伺服器上佈建的磁碟空間]**** 是備份伺服器所建議的保護群組空間。 備份伺服器會使用這些設定來選擇理想的備份磁片區。 您可以在 [**磁片配置詳細資料**] 中編輯備份磁片區選項。
    * 針對工作負載，請在下拉式功能表中選取您偏好的儲存體。 您的編輯內容會變更 [可用磁碟儲存體] 窗格中 [儲存體總計] 和 [可用儲存體] 的值。 布建不足 space 是備份伺服器建議您新增到磁片區以確保備份順利的儲存體數量。

1. 在 [**選擇複本的建立方式**] 頁面上，選取如何處理初始的完整資料複寫。

    如果您選擇透過網路進行複寫，建議您選擇離峰時間。 如果資料量較大或網路狀況不理想，請考慮使用卸除式媒體來離線複寫資料。

1. 在 [**選擇一致性檢查選項**] 頁面上，選取自動執行一致性檢查的方式。

    您可以在複本資料變得不一致時或按照排程的時間執行檢查。 如果您不想設定自動一致性檢查，您可以隨時執行手動檢查。 若要執行手動檢查，請在備份伺服器管理員主控台的 [保護]**** 區域，以滑鼠右鍵按一下保護群組，然後選取 [執行一致性檢查]****。

1. 如果您選擇使用 Azure 備份備份到雲端，請在 [**指定線上保護資料**] 頁面上，選取您想要備份至 Azure 的工作負載。

1. 在 [**指定線上備份排程**] 頁面上，選取要以累加方式備份至 Azure 的頻率。

    您可以將備份排程為每日、每週、每月和每年執行。 您也可以選取執行備份的時間和日期。 一天最多可以備份兩次。 每次執行備份時，就會從備份伺服器磁片上儲存的備份資料複本，在 Azure 中建立資料復原點。

1. 在 [**指定線上保留原則**] 頁面上，選取從每日、每週、每月和每年備份建立的復原點在 Azure 中的保留方式。

1. 在 [選擇線上複寫]**** 頁面上，選取要如何進行首次的資料完整複寫。

    您可以透過網路進行複寫，或離線備份（離線植入）。 離線備份會使用 Azure 匯入功能。 如需詳細資訊，請參閱 [Azure Backup 中的離線備份工作流程](offline-backup-azure-data-box.md)。

1. 在 [摘要] 頁面上檢閱您的設定。 在選取 [建立群組]**** 後，系統就會開始進行首次的資料複寫。 當資料複寫完成時，[**狀態**] 頁面上的保護群組狀態為 **[確定]**。 接著會根據保護群組設定來進行備份。

## <a name="recover-system-state-or-bmr"></a>復原系統狀態或 BMR

您可以將 BMR 或系統狀態復原到網路位置。 如果您已備份 BMR，請使用 Windows 修復環境（WinRE）來啟動您的系統，並將它連線到網路。 然後使用 Windows Server Backup 從網路位置復原。 如果您已備份系統狀態，則只需使用 Windows Server Backup 從網路位置進行復原。

### <a name="restore-bmr"></a>還原 BMR

若要在備份伺服器電腦上執行復原：

1. 在 [**修復**] 窗格中，尋找您要復原的電腦。 然後選取 [**裸機**復原]。

1. 行事曆上會以粗體表示可用的復原點。 選取您要使用之復原點的日期和時間。

1. 在 [**選取復原類型**] 頁面上，選取 [**複製到網路資料夾**]。

1. 在 [**指定目的地**] 頁面上，選取複製資料的目的地。

    請記住，目的地必須要有足夠的空間來容納資料。 我們建議您為目的地建立新的資料夾。

1. 在 [**指定復原選項**] 頁面上，選取安全性設定。 然後，選取是否要使用存放區域網路（SAN）型硬體快照集，以進行更快速的復原。 只有在下列情況下，才可以使用此選項：
    * 您有提供這種功能的 SAN。
    * 您可以建立並分割複本，使其成為可寫入。
    * 受保護的電腦和備份伺服器電腦會連線到相同的網路。

1. 設定通知選項。
1. 在 [確認]**** 頁面上，選取 [復原]****。

若要設定共用位置：

1. 在還原位置中移至該備份的所在資料夾。

1. 在*WindowsImageBackup*上共用一個層級的資料夾，讓共用資料夾的根目錄是*WindowsImageBackup*資料夾。

    如果您未共用此資料夾，還原將找不到備份。 若要使用 WinRE 進行連線，您需要可在 WinRE 中使用正確的 IP 位址和認證來存取的共用。

若要還原系統：

1. 使用您要還原之系統的 Windows DVD，啟動您要還原映射的電腦。

1. 在第一頁上，確認 [語言] 和 [地區設定] 的設定。 在 [安裝]**** 頁面上，選取 [修復您的電腦]****。

1. 在 [系統修復選項]**** 頁面上，選取 [使用您先前建立的系統映像還原電腦]****。

1. 在 [選取系統映像備份]**** 頁面上，選取 [選取系統映像]**** > [進階]**** > [搜尋網路上的系統映像]****。 如果出現警告，請選取 [是]****。 移至共用路徑，輸入認證，然後選取復原點。 系統會掃描該復原點中可用的特定備份。 選取您要使用的復原點。

1. 在 [**選擇還原備份的方式**] 頁面上，選取 [**格式化並**重新分割磁片]。 在下一個頁面上，確認設定。

1. 若要開始還原，請選取 [完成]****。 系統需要重新啟動。

### <a name="restore-system-state"></a>還原系統狀態

若要在備份伺服器中執行復原：

1. 在 [復原]**** 窗格中找到您要復原的電腦，然後選取 [裸機復原]****。

1. 行事曆上會以粗體表示可用的復原點。 選取您要使用之復原點的日期和時間。

1. 在 [**選取復原類型**] 頁面上，選取 [**複製到網路資料夾**]。

1. 在 [**指定目的地**] 頁面上，選取要將資料複製到何處。

    請記住，您選取的目的地必須有足夠的空間來容納資料。 我們建議您為目的地建立新的資料夾。

1. 在 [**指定復原選項**] 頁面上，選取安全性設定。 然後選取是否要使用 SAN 型硬體快照集，以進行更快速的復原。 只有在下列情況下，才可以使用此選項：
    * 您有提供這種功能的 SAN。
    * 您可以建立並分割複本，使其成為可寫入。
    * 受保護的電腦和備份伺服器伺服器已連接到相同的網路。

1. 設定通知選項。
1. 在 [確認]**** 頁面上，選取 [復原]****。

若要執行 Windows Server Backup：

1. 選取 [**動作**  >  **Recover**  >  **This Server**  >  **] [** 復原這部伺服器]。

1. 選取 [其他伺服器]****，選取 [指定位置類型]**** 頁面，然後選取 [遠端共用資料夾]****。 輸入復原點所在資料夾的路徑。

1. 在 [選取復原類型]**** 頁面上，選取 [系統狀態]****。

1. 在 [選取系統狀態復原的位置]**** 頁面上，選取 [原始位置]****。

1. 在 [確認]**** 頁面上，選取 [復原]****。

1. 在還原之後，請重新啟動伺服器。

您也可以在命令提示字元中執行系統狀態還原：

1. 在您要復原的電腦上啟動 Windows Server Backup。

1. 若要取得版本識別碼，請在命令提示字元輸入：

   ```wbadmin get versions -backuptarget \<servername\sharename\>```

1. 使用版本識別碼來開始系統狀態還原。 在命令提示字元中，輸入：

    ```wbadmin start systemstaterecovery -version:<versionidentified> -backuptarget:<servername\sharename>```

1. 確認您想要開始復原。 您可以在 [命令提示字元] 視窗中看到復原程序。 系統會建立還原記錄。

1. 在還原之後，請重新啟動伺服器。
