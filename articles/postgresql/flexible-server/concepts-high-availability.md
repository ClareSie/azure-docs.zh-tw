---
title: 使用適用於 PostgreSQL 的 Azure 資料庫彈性的伺服器 (預覽) 的區域冗余高可用性總覽
description: 深入瞭解具有適用於 PostgreSQL 的 Azure 資料庫彈性伺服器的區域冗余高可用性概念
author: sr-msft
ms.author: srranga
ms.service: postgresql
ms.topic: conceptual
ms.date: 09/22/2020
ms.openlocfilehash: 7db9ac0eb624c2732295639d65e0311fcf459f71
ms.sourcegitcommit: 53acd9895a4a395efa6d7cd41d7f78e392b9cfbe
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/22/2020
ms.locfileid: "90933858"
---
# <a name="high-availability-concepts-in-azure-database-for-postgresql---flexible-server"></a>適用於 PostgreSQL 的 Azure 資料庫彈性的伺服器中的高可用性概念

> [!IMPORTANT]
> 適用於 PostgreSQL 的 Azure 資料庫 - 彈性伺服器為預覽狀態

適用於 PostgreSQL 的 Azure 資料庫彈性的伺服器會使用 **區域重複** 的伺服器部署，提供具有自動容錯移轉功能的高可用性設定。 在區域冗余設定中部署時，有彈性的伺服器會在不同的可用性區域中自動布建和管理待命複本。 使用於 postgresql 串流複寫時，資料會以 **同步** 模式複寫到待命複本伺服器。 

區域冗余設定可啟用自動容錯移轉功能，在規劃的事件（例如使用者起始的規模計算作業）期間，以及在未規劃的事件（例如基礎硬體和軟體錯誤、網路失敗和可用性區域失敗）期間遺失任何資料。 

:::image type="content" source="./media/business-continuity/concepts-zone-redundant-high-availability-architecture.png" alt-text="區域冗余高可用性"::: 

## <a name="zone-redundant-high-availability-architecture"></a>區域冗余高可用性架構

您可以選擇區域和可用性區域，以部署您的主資料庫伺服器。 待命複本伺服器布建在與主伺服器具有相同設定的不同可用性區域中，包括計算層、計算大小、儲存體大小和網路設定。 交易記錄會以同步模式複寫至使用於 postgresql 串流複寫的待命複本。 自動備份會從主資料庫伺服器定期執行，而交易記錄會持續封存至來自待命複本的備份儲存體。 

高可用性設定的健全狀況會持續受到監視，並在入口網站上報告。 區域冗余高可用性狀態如下所示：

| **狀態** | **描述** |
| ------- | ------ |
| <b> 初始 化 | 在建立新待命伺服器的過程中 |
| <b> 複寫資料 | 待命建立之後，就會跟上主資料庫。 |
| <b> 健康 | 複寫處於穩定狀態且狀況良好。 |
| <b> 容錯移轉 | 資料庫伺服器正在容錯移轉至待命的進程。 |
| <b> 正在移除待命 | 在刪除待命伺服器的過程中。 | 
| <b> 未啟用 | 區域冗余高可用性未啟用。  |

## <a name="steady-state-operations"></a>穩定狀態作業

于 postgresql 用戶端應用程式會使用資料庫伺服器名稱連接到主伺服器。 應用程式讀取會直接從主伺服器提供服務，而只有在主伺服器和待命複本上保存資料時，才會向應用程式確認認可和寫入。 由於這項額外的來回行程需求，應用程式可能會預期寫入和認可的延遲較高。 您可以在入口網站上監視高可用性的健全狀況。

:::image type="content" source="./media/business-continuity/concepts-high-availability-steady-state.png" alt-text="區域冗余高可用性-穩定狀態"::: 

1. 用戶端會連線到彈性的伺服器，並執行寫入作業。
2. 變更會複寫到待命網站。
3. 主要接收認可。
4. 認可寫入/認可。

## <a name="failover-process---planned-downtimes"></a>容錯移轉程式-已規劃的停機時間

規劃的停機事件包括 Azure 排程的定期軟體更新和次要版本升級。 當設定為高可用性時，這些作業會先套用至待命複本，而應用程式會繼續存取主伺服器。 一旦更新待命複本之後，就會清空主伺服器連線，並觸發容錯移轉，以使用相同的資料庫伺服器名稱將待命複本啟用為主要複本。 用戶端應用程式必須將相同的資料庫伺服器名稱重新連接到新的主伺服器，而且可以繼續其作業。 新的待命伺服器將會在與舊的主資料庫相同的區域中建立。 

針對其他使用者起始的作業（例如調整規模計算或調整規模儲存體），會先在待命套用變更，然後再套用至主資料庫。 目前，連接不會容錯移轉到待命，因此在主伺服器上執行作業時，會造成停機時間。

### <a name="reducing-planned-downtime-with-managed-maintenance-window"></a>使用受管理的維護時段減少計畫的停機時間

 您可以在喜好設定的一天內選擇30分鐘的時間範圍，將資料庫上的活動預計低，以排程 Azure 起始的維護活動。 Azure 維護工作（例如修補或次要版本升級）會在該時段內發生。  針對以高可用性設定的彈性伺服器，這些維護活動會先在待命複本上執行，然後才會啟用。 然後，應用程式會重新連接到新的主伺服器，並在新的待命布建時繼續其作業。

## <a name="failover-process---unplanned-downtimes"></a>容錯移轉程式-未計畫的停機時間

未計畫的中斷包括軟體錯誤或基礎結構元件失敗會影響資料庫的可用性。 當監視系統偵測到伺服器無法使用時，就會中斷對待命複本的複寫，並啟用待命複本作為主資料庫伺服器。 用戶端可以使用相同的連接字串重新連接至資料庫伺服器，並繼續其作業。 整體容錯移轉時間預期會需要 60-120s。 不過，根據主資料庫伺服器在容錯移轉時的活動（例如大型交易和復原時間），容錯移轉可能需要較長的時間。

:::image type="content" source="./media/business-continuity/concepts-high-availability-failover-state.png" alt-text="區域冗余高可用性-容錯移轉"::: 

1. 主資料庫伺服器已關閉，且用戶端失去資料庫連線能力。 
2. 待命伺服器會啟用成為新的主伺服器。 用戶端會使用相同的連接字串連接到新的主伺服器。 將用戶端應用程式放在與主資料庫伺服器相同的區域中，可減少延遲並改善效能。
3. 待命伺服器會與舊的主伺服器建立在相同的區域中，並起始串流複寫。 
4. 一旦建立穩定狀態複寫，在兩個網站上保存資料後，就會認可用戶端應用程式認可和寫入。

## <a name="point-in-time-restore"></a>時間點還原 

以高可用性設定的彈性伺服器，會即時將資料複寫到待命伺服器，以保持最新狀態。 主伺服器上的任何使用者錯誤（例如，資料表意外卸載或資料更新不正確）都會忠實地複寫到待命複本。 因此，您無法使用待命來從這類邏輯錯誤中復原。 若要從這類錯誤中復原，您必須從備份執行時間點還原。  您可以使用彈性伺服器的時間點還原功能，還原至發生錯誤之前的時間。 針對設定為高可用性的資料庫，新的資料庫伺服器將會以具有使用者提供名稱的單一區域彈性伺服器形式還原。 然後，您可以從資料庫伺服器匯出物件，並將它匯入實際執行的資料庫伺服器。 同樣地，如果您想要複製您的資料庫伺服器以供測試和開發之用，或想要針對任何其他用途進行還原，您可以執行時間點還原。

## <a name="zone-redundant-high-availability---features"></a>區域冗余高可用性-功能

-   待命複本將會部署在與主伺服器相同的 VM 設定中，包括虛擬核心、存放裝置、網路設定 (VNET、防火牆) 等等。

-   能夠為現有的資料庫伺服器增加高可用性。

-   藉由停用高可用性來移除待命複本的能力。

-   為您的主資料庫伺服器選擇可用性區域的能力。

-   能夠停止、啟動及重新開機主要和待命資料庫伺服器。

-   自動備份會從主資料庫伺服器執行，並儲存在區域多餘的儲存體中。

-   用戶端一律會連接到主資料庫伺服器。

-   重新開機伺服器以挑選任何靜態伺服器參數變更的能力。
  
-   定期維護活動（例如次要版本升級）會先在待命進行，且服務會容錯移轉，以縮短停機時間。  

## <a name="zone-redundant-high-availability---limitations"></a>區域冗余高可用性-限制

-   高載計算層級不支援高可用性。
-   只有在有多個區域可供使用的區域中才支援高可用性。
-   由於同步複寫至另一個可用性區域，因此應用程式可能會遇到較高的寫入和認可延遲。

-   待命複本無法用於唯讀查詢。

-   根據主伺服器上的活動在容錯移轉時，最多可能需要兩分鐘或更長的時間才能完成容錯移轉。

-   重新開機主資料庫伺服器來挑選靜態參數變更也會重新開機待命複本。

-   不支援設定額外的讀取複本。

-   無法在受管理的維護期間排程設定客戶起始的管理工作。

-   已規劃的事件（例如調整計算和調整規模儲存體）會先在待命中，然後在主伺服器上進行。 服務未進行容錯移轉。 

## <a name="next-steps"></a>下一步

-   瞭解 [商務持續性](./concepts-business-continuity.md)
-   瞭解如何 [管理高可用性](./how-to-manage-high-availability-portal.md)
-   瞭解[備份和](./concepts-backup-restore.md)復原