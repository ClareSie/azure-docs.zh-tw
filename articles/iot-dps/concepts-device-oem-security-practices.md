---
title: 製造商的安全實作 - Azure IoT 裝置配置服務
description: 概述 OEM 和設備製造商的常見安全做法,這些製造商準備設備註冊 Azure IoT 設備配置服務 (DPS)。
author: timlt
ms.author: timlt
ms.date: 3/02/2020
ms.topic: conceptual
ms.service: iot-dps
ms.custom: iot-p0-scenario, iot-devices-deviceOEM
ms.reviewer: nberdy
ms.openlocfilehash: 3854f353e4ea0b78c0162681e0b89d37419105d8
ms.sourcegitcommit: c5661c5cab5f6f13b19ce5203ac2159883b30c0e
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 04/01/2020
ms.locfileid: "80529530"
---
# <a name="security-practices-for-azure-iot-device-manufacturers"></a>Azure IoT 裝置製造商的安全實務
隨著更多製造商發佈IoT設備,確定有關常見做法的指導會很有説明。 本文總結了在製造用於 Azure IoT 設備配置服務 (DPS) 的設備時要考慮的建議安全實踐。  

> [!div class="checklist"]
> * 選擇裝置身份驗證選項
> * 在 IoT 裝置上安裝憑證
> * 將受信任的平台模組 (TPM) 整合到製造流程中

## <a name="selecting-device-authentication-options"></a>選擇裝置身份驗證選項
任何 IoT 設備安全措施的最終目的是創建安全的 IoT 解決方案。 但是,硬體限制、成本和安全專業知識級別等問題都會影響您選擇的選項。 此外,您的安全方法會影響IoT設備連接到雲端的方式。 雖然要考慮[IoT 安全性的幾個元素](https://www.microsoft.com/research/publication/seven-properties-highly-secure-devices/),但每個客戶遇到的一個關鍵元素是要使用的身份驗證類型。 

三種廣泛使用的身份驗證類型是 X.509 證書、可信平臺模組 (TPM) 和對稱密鑰。 儘管存在其他身份驗證類型,但大多數在 Azure IoT 上建構解決方案的客戶使用這三種類型之一。 本文的其餘部分將調查使用每種身份驗證類型的優缺點。

### <a name="x509-certificate"></a>X.509 憑證
X.509 憑證是可用於身份驗證的數位標識類型。 X.509 證書標準記錄在[IETF RFC 5280](https://tools.ietf.org/html/rfc5280)中。 在 Azure IoT 中,有兩種方法可以對憑證進行身份驗證:
- 指紋。 指紋演演演算法在證書上運行以生成十六進位元字串。 生成的字串是證書的唯一標識器。 
- 基於完整鏈的 CA 身份驗證。 憑證鏈是驗證最終實體 (EE) 證書所需的所有證書的分層清單。 要對 EE 證書進行身份驗證,必須對鏈中每個證書(包括受信任的根 CA)進行身份驗證。 

X.509 的優點:
- X.509 是 Azure IoT 中支援的最安全身份驗證類型。
- X.509 允許為證書管理目的進行高級別控制。
- 許多供應商都提供基於 X.509 的身份驗證解決方案。

X.509 的輔音:
- 許多客戶可能需要依賴外部供應商獲得證書。
- 證書管理可能成本高昂,並會增加總解決方案成本。
- 如果物流沒有經過深思熟慮,證書生命週期管理可能很困難。 

### <a name="trusted-platform-module-tpm"></a>信賴平台模組 (TPM)
TPM 也稱為[ISO/IEC 11889,](https://www.iso.org/standard/66510.html)是安全生成和存儲加密密鑰的標準。 TPM 還指與實現標準的模組交互的虛擬或物理 I/O 設備。 TPM 設備可以作為離散硬體、集成硬體、基於固件的模組或基於軟體的模組存在。 

TM 和對稱鍵之間有兩個關鍵區別: 
- TPM 晶元還可以存儲 X.509 證書。
- DPS 中的 TPM 認證使用 TPM 背書密鑰 (EK),這是一種非對稱身份驗證形式。 使用非對稱身份驗證時,公鑰用於加密,並且單獨的私鑰用於解密。 相反,對稱密鑰使用對稱身份驗證,其中私鑰用於加密和解密。 

TPM 的優點:
- TM 作為標準硬體包含在許多 Windows 設備上,並且對作業系統具有內置支援。 
- TPM 認證比基於權杖的共享存取簽名 (SAS) 更容易安全。
- 您可以輕鬆地過期和續訂或滾動設備憑據。 每當 TPM 設備需要重新預配時,DPS 都會自動滾動 IoT 中心認證。

TPM 輔因: 
- TM 很複雜,可能難以使用。 
- 除非您有物理 TPM 或高品質的模擬器,否則使用TM的應用程式開發將非常困難。
- 您可能需要重新設計設備的主機板,才能在硬體中包括 TPM。 
- 如果在 TPM 上滾動 EK,它將破壞 TPM 的標識並創建新的。 儘管物理晶片保持不變,但它在IoT解決方案中具有新的標識。

### <a name="symmetric-key"></a>對稱金鑰
使用對稱密鑰時,相同的密鑰用於加密和解密消息。 因此,設備和對其進行身份驗證的服務都知道同一密鑰。 Azure IoT 支援基於 SAS 的對稱密鑰連接。 對稱密鑰身份驗證需要大量所有者責任來保護密鑰,並借助 X.509 身份驗證實現同等級別的安全性。 如果使用對稱鍵,建議的做法是使用硬體安全模組 (HSM) 保護密鑰。

對稱鍵的優點:
- 使用對稱鍵是開始使用身份驗證的最簡單、成本最低的方法。
- 使用對稱鍵可以簡化過程,因為沒有什麼額外的要生成。 

對稱鍵的缺點: 
- 對稱鍵需要大量努力來保護密鑰。 同一密鑰在設備和雲之間共用,這意味著密鑰必須在兩個位置受到保護。 相比之下,TPM 和 X.509 證書的挑戰是在不洩露私鑰的情況下證明公鑰的擁有。
- 對稱密鑰便於遵循較差的安全實踐。 對稱密鑰的一個常見趨勢是在設備上硬編碼未加密的密鑰。 雖然這種做法很方便,但它使密鑰容易受到攻擊。 通過將對稱密鑰安全地存儲在設備上,可以減輕某些風險。 但是,如果您的優先順序最終是安全性而不是便利性,請使用 X.509 證書或 TPM 進行身份驗證。 

### <a name="shared-symmetric-key"></a>共用對稱鍵
對稱密鑰身份驗證稱為共享對稱密鑰有一種變體。 此方法涉及在所有設備中使用同一對稱密鑰。 建議是避免在設備上使用共享對稱鍵。 

分享對稱鍵:
- 易於實施,生產成本低。 

共用對稱鍵的缺點: 
- 極易受到攻擊。 輕鬆實施的好處遠遠大於風險。 
- 任何人都可以類比您的設備,如果他們獲得共用密鑰。
- 如果您依賴於被洩露的共享對稱密鑰,則可能會失去對設備的控制。 

### <a name="making-the-right-choice-for-your-devices"></a>為您的裝置做出正確的選擇
要選擇身份驗證方法,請確保考慮每種方法對獨特製造流程的好處和成本。  對於設備身份驗證,給定方法的安全性與其方便程度之間通常存在相反的關係。  

## <a name="installing-certificates-on-iot-devices"></a>在 IoT 裝置上安裝憑證
如果使用 X.509 證書對 IoT 設備進行身份驗證,本節提供有關如何將證書集成到製造流程中的指南。 您需要做出幾個決定。  其中包括有關常見證書變數、何時生成證書以及何時安裝它們的決定。 

如果您習慣於使用密碼,您可能會問為什麼不能在所有設備中使用同一證書,就像所有設備都使用相同的密碼一樣。 首先,在任何地方使用相同的密碼是危險的。 這種做法使公司面臨重大 DDoS 攻擊,包括幾年前在美國東海岸關閉 DNS 的攻擊。 切勿在任何地方使用相同的密碼,即使是個人帳戶也是如此。 其次,證書不是密碼,它是一個唯一的身份。 密碼就像一個秘密代碼,任何人都可以用它來在安全的建築物打開門。  這是你知道的,你可以給任何人密碼,以獲得入口。  證書就像帶有照片和其他詳細資訊的駕照,您可以向警衛出示這些許可證以進入安全的建築物。 這與你是誰有關。  如果防護裝置與駕照精確匹配人員,則只有您可以使用您的駕照(身份)獲得入口。 

### <a name="variables-involved-in-certificate-decisions"></a>憑證決策中涉及的變數
請考慮以下變數,以及每個變數如何影響整個製造流程。 

#### <a name="where-the-certificate-root-of-trust-comes-from"></a>信任憑證根來自
管理公鑰基礎結構 (PKI) 可能成本高昂且複雜。  特別是如果您的公司沒有任何管理 PKI 的經驗。 您的選項如下：
- 使用第三方 PKI。 您可以從第三方證書供應商處購買中間簽名證書。 或者,您可以使用專用證書頒發機構 (CA)。 
- 使用自管理的 PKI。 您可以維護自己的 PKI 系統並產生自己的憑證。
- 使用[Azure 球體](https://azure.microsoft.com/services/azure-sphere/)安全服務。 此選項僅適用於 Azure 球體設備。 

#### <a name="where-certificates-are-stored"></a>憑證的儲存位置
有幾個因素會影響證書存儲位置的決策。 這些因素包括設備類型、預期獲利率(是否負擔得起安全存儲)、設備功能以及設備上可能可以使用的現有安全技術。 請考慮下列選項：
- 在硬體安全模組 (HSM) 中。 強烈建議使用HSM。 檢查設備的控制板是否已安裝 HSM。 如果您知道沒有 HSM,請與您的硬體製造商合作,確定滿足您需求的 HSM。
- 在磁碟上的安全位置,如受信任的執行環境 (TEE)。
- 在本地檔案系統或憑證儲存中。 例如,Windows 憑證存儲。 

#### <a name="connectivity-at-the-factory"></a>工廠的連線
工廠的連接決定了如何以及何時獲得要在設備上安裝的證書。 連線選項如下:
- 連接。 具有連接性是最佳的,它簡化了在本地生成證書的過程。 
- 無連接。 在這種情況下,您可以使用來自 CA 的已簽署證書在本地和離線生成設備證書。 
- 無連接。 在這種情況下,您可以獲取提前生成的證書。 或者,您可以使用離線 PKI 在本地生成證書。

#### <a name="audit-requirement"></a>審計要求
根據所生產的設備類型,您可能有法規要求來創建設備上設備標識的審計跟蹤。 審核會增加大量生產成本。 因此,在大多數情況下,只有在必要時才這樣做。 如果您不確定是否需要審核,請諮詢公司的法律部門。 稽核選項包括: 
- 不是一個敏感的行業。 無需審核。
- 敏感行業。 證書應根據合規性認證要求安裝在安全房間中。 如果需要安全的房間來安裝證書,您可能已經知道證書是如何在您的設備中安裝的。 您可能已經有了一個審計系統。 

#### <a name="length-of-certificate-validity"></a>憑證有效期
與駕駛執照一樣,證書具有創建證書時設置的到期日期。 以下是憑證有效期的選項:
- 不需要續訂。  此方法使用很長的續訂期,因此您無需在設備的生存期內續訂證書。 雖然這種方法很方便,但也很危險。  您可以通過在設備上使用像 HSM 這樣的安全存儲來降低風險。 但是,建議的做法是避免使用長壽命證書。
- 需要續訂。  您需要在設備的生存期內續訂證書。 憑證有效期取決於上下文,您需要續訂策略。  該策略應包括獲取證書的位置,以及設備在續訂過程中必須使用哪些類型的空中功能。 

### <a name="when-to-generate-certificates"></a>何時產生憑證
工廠中的互聯網連接功能將影響您生成證書的過程。 對何時產生憑證,有幾個選項: 

- 預載入的證書。  某些 HSM 供應商提供進階服務,其中 HSM 供應商為客戶安裝證書。 首先,客戶授予 HSM 供應商對簽名證書的訪問許可權。 然後,HSM 供應商將由該簽名證書簽名的證書安裝到客戶購買的每個 HSM 上。 客戶所要做的就是在設備上安裝 HSM。 雖然這項服務增加了成本,但它有助於簡化您的製造流程。  它解決了何時安裝證書的問題。
- 設備生成的證書。  如果設備在內部生成證書,則必須從設備中提取公共 X.509 證書才能將其註冊到 DPS 中。 
- 連接工廠。  如果您的工廠具有連接,您可以隨時生成設備證書。
- 離線工廠與您自己的PKI。 如果您的工廠沒有連接,並且您使用自己的 PKI 與離線支援,則可以在需要時產生證書。
- 具有第三方 PKI 的離線工廠。 如果工廠沒有連接,並且正在使用第三方 PKI,則必須提前生成證書。 並且有必要從具有連接的位置生成證書。 

### <a name="when-to-install-certificates"></a>何時安裝憑證
為 IoT 設備產生證書後,可以在設備中安裝它們。 

如果使用預載入的證書與 HSM,該過程將簡化。 在設備中安裝 HSM 後,設備代碼可以訪問它。 然後,您將調用 HSM API 來存取儲存在 HSM 中的證書。 這種方法對您的製造過程最方便。 

如果不使用預載入的證書,則必須將證書安裝為生產過程的一部分。 最簡單的方法是在快閃記憶體初始韌體映像的同時在 HSM 中安裝證書。 您的進程必須添加一個步驟才能在每個設備上安裝映射。 完成此步驟後,您可以在打包和裝運設備之前運行最終品質檢查和任何其他步驟。 

有可用的軟體工具,允許您在單個步驟中運行安裝過程和最終品質檢查。 您可以修改這些工具以產生證書,或從預生成的憑證儲存中提取證書。 然後,軟體可以在需要安裝證書的地方安裝證書。 這種類型的軟體工具使您能夠大規模運行生產品質製造。 

在設備上安裝證書後,下一步是瞭解如何使用[DPS](about-iot-dps.md)註冊設備。 

## <a name="integrating-a-tpm-into-the-manufacturing-process"></a>將 TPM 整合到製造流程中
如果您使用 TPM 對 IoT 設備進行身份驗證,本節將提供指導。 本指南涵蓋廣泛使用的 TPM 2.0 設備,這些設備具有基於哈希的消息身份驗證代碼 (HMAC) 密鑰支援。 TPM 晶片的 TPM 規範是由可信計算組維護的 ISO 標準。 有關 TPM 的更多,請參閱[TPM 2.0](https://trustedcomputinggroup.org/tpm-library-specification/)和[ISO/IEC 11889](https://www.iso.org/standard/66510.html)的規格。 

### <a name="taking-ownership-of-the-tpm"></a>取得 TPM 的擁有權
製造帶有 TPM 晶片的設備的一個關鍵步驟是擁有 TPM 的擁有權。 此步驟是必需的,以便您可以向設備擁有者提供密鑰。 第一步是從設備中提取背書密鑰 (EK)。 下一步是實際聲明擁有權。 如何做到這一點取決於您使用的 TPM 和作業系統。 如果需要,請與 TPM 製造商或設備作業系統的開發人員聯繫,以確定如何聲明擁有權。 

在製造過程中,您可以在不同時間提取 EK 並聲明擁有權,從而增加靈活性。 許多製造商透過添加硬體安全模組(HSM)來利用這種靈活性來增強其設備的安全性。 本節提供有關何時提取 EK、何時聲明 TPM 擁有權以及將這些步驟集成到製造時間線中的注意事項的指導。 

> [!IMPORTANT]
> 以下指南假定您使用離散、固件或集成的 TPM。 在適用的地方,本指南添加了有關使用非離散或軟體 TPM 的說明。 如果您使用軟體 TPM,則可能還包括本指南不包括的其他步驟。 軟體 TM 具有超出本文範圍的各種實現。  通常,可以將軟體 TPM 集成到以下常規製造時間線中。 但是,雖然類比 TPM 的軟體適合原型設計和測試,但它無法提供與離散、固件或集成 TPM 相同的安全級別。 作為一般做法,避免在生產中使用軟體 TPM。

### <a name="general-manufacturing-timeline"></a>一般製造時程表
以下時間線顯示 TPM 如何通過生產過程,最終進入設備。 每個製造過程都是唯一的,並且此時間線顯示最常見的模式。 時間線提供有關何時對鍵執行某些操作的指導。 

#### <a name="step-1-tpm-is-manufactured"></a>第 1 步:製造 TPM
- 如果您從製造商購買 TVM 供設備使用,請查看它們是否會為您提取公共背書密鑰(EK_pubs)。 如果製造商提供帶有已發貨設備的EK_pubs清單,則非常有用。 
    > [!NOTE]
    > 您可以通過在預配服務中使用共享存取策略,向 TPM 製造商提供對註冊清單的寫入存取許可權。  此方法允許他們將TM添加到您的註冊清單中。  但是,這是製造過程的早期,它需要TPM製造商的信任。 風險自擔。 

- 如果您製造 TM 以銷售給設備製造商,請考慮向客戶提供EK_pubs清單及其物理 TM。  為客戶提供EK_pubs可節省其流程中的一個步驟。 
- 如果您製造 TM 以與您自己的設備一起使用,則確定流程中的哪個點最方便地提取EK_pub。 您可以在時間線中的任何剩餘點提取EK_pub。 

#### <a name="step-2-tpm-is-installed-into-a-device"></a>第二步:TPM 已安裝到設備中
在生產過程中的此時,您應該知道設備將使用哪個 DPS 實例。 因此,您可以將設備添加到自動預配的註冊清單中。 關於自動裝置預先設定的詳細資訊,請參考[DPS 文件](about-iot-dps.md)。
- 如果你還沒有提取EK_pub,現在是這樣做的好時機。 
- 根據 TPM 的安裝過程,此步驟也是獲得 TPM 擁有權的好時機。 

#### <a name="step-3-device-has-firmware-and-software-installed"></a>第三步:裝置已安裝韌體和軟體
在此過程中的此時,安裝 DPS 用戶端以及用於預配的 ID 範圍和全域網址。
- 現在是提取EK_pub的最後機會。 如果第三方將在您的設備上安裝該軟體,最好先提取EK_pub。
- 製造過程中的這一點是取得 TPM 擁有權的理想選擇。  
    > [!NOTE]
    > 如果您使用的是軟體 TPM,則可以立即安裝它。  同時提取EK_pub。

#### <a name="step-4-device-is-packaged-and-sent-to-the-warehouse"></a>第四步:裝置打包並傳送到主目錄
設備可以在部署之前在倉庫中存放 6-12 個月。 

#### <a name="step-5-device-is-installed-into-the-location"></a>步驟 5:裝置安裝到該位置
設備到達其最終位置后,它將通過 DPS 的自動預配。

有關詳細資訊,請參閱[自動預配概念](concepts-auto-provisioning.md)和[TPM 認證](concepts-tpm-attestation.md)。 

## <a name="resources"></a>資源

除了本文中推薦的安全實踐外,Azure IoT 還提供資源來幫助選擇安全硬體和創建安全的 IoT 部署: 
- Azure IoT[安全建議](../iot-fundamentals/security-recommendations.md),用於指導部署過程。 
- [Azure 安全中心](https://azure.microsoft.com/services/security-center/)提供一項服務來幫助創建安全的IoT部署。 
- 有關評估硬體環境的説明,請參閱[評估IoT安全性](https://download.microsoft.com/download/D/3/9/D3948E3C-D5DC-474E-B22F-81BA8ED7A446/Evaluating_Your_IOT_Security_whitepaper_EN_US.pdf)的白皮書。 
- 有關選擇安全硬體的説明,請參閱[IoT 部署的正確安全硬體](https://download.microsoft.com/download/C/0/5/C05276D6-E602-4BB1-98A4-C29C88E57566/The_right_secure_hardware_for_your_IoT_deployment_EN_US.pdf)。 