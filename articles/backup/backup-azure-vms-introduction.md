---
title: 關於 Azure VM 備份
description: 在本文中，您將瞭解 Azure 備份服務如何備份 Azure 虛擬機器，以及如何遵循最佳作法。
ms.topic: conceptual
ms.date: 09/13/2019
ms.openlocfilehash: f4b36f57362607a13c09896cd7109596aba0a852
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 04/28/2020
ms.locfileid: "79415971"
---
# <a name="an-overview-of-azure-vm-backup"></a>Azure VM 備份總覽

本文說明[Azure 備份服務](backup-introduction-to-azure-backup.md)如何備份 Azure 虛擬機器（vm）。

Azure 備份提供獨立和隔離的備份，以防止非預期的資料在您的 Vm 上損毀。 備份會儲存在復原服務保存庫中，並進行內建的復原點管理。 設定和調整很簡單，備份已優化，您可以視需要輕鬆地還原。

做為備份程式的一部分，[會建立快照](#snapshot-creation)集，並將資料傳輸至復原服務保存庫，而不會影響生產工作負載。 快照集會提供不同層級的一致性，如[這裡](#snapshot-consistency)所述。

Azure 備份也有適用于資料庫工作負載的特製化供應專案，例如可感知工作負載的[SQL Server](backup-azure-sql-database.md)和[SAP Hana](sap-hana-db-about.md) 、提供15分鐘的 RPO （復原點目標），以及允許備份和還原個別的資料庫。

## <a name="backup-process"></a>備份程序

以下是 Azure 備份完成 Azure Vm 備份的方式：

1. 針對選取要備份的 Azure Vm，Azure 備份根據您指定的備份排程來啟動備份作業。
1. 第一次備份時，如果 VM 正在執行，則會在 VM 上安裝備份擴充功能。
    - 針對 Windows Vm，會安裝[VMSnapshot 擴充](https://docs.microsoft.com/azure/virtual-machines/extensions/vmsnapshot-windows)功能。
    - 針對 Linux Vm，會安裝[VMSnapshotLinux 擴充](https://docs.microsoft.com/azure/virtual-machines/extensions/vmsnapshot-linux)功能。
1. 針對執行的 Windows Vm，備份會與 Windows 磁碟區陰影複製服務（VSS）協調，以取得 VM 的應用程式一致快照集。
    - 根據預設，備份會進行完整的 VSS 備份。
    - 如果備份無法取得應用程式一致的快照集，則會取得基礎儲存體的檔案一致快照集（因為 VM 停止時不會進行任何應用程式寫入）。
1. 針對 Linux Vm，備份會建立檔案一致備份。 針對應用程式一致快照集，您必須手動自訂前置/後置腳本。
1. 備份取得快照之後，它會將資料傳輸到保存庫。
    - 備份會藉由平行備份每個 VM 磁片來進行優化。
    - 針對每個要備份的磁片，Azure 備份會讀取磁片上的區塊，並只識別並傳輸自上次備份之後變更的資料區塊（delta）。
    - 快照集資料可能不會立即複製到保存庫。 這在尖峰時間可能需耗費數小時。 針對每日備份原則，VM 的總備份時間會小於24小時。
1. 在啟用 Azure 備份之後對 Windows VM 所做的變更為：
    - Microsoft Visual C++ 2013 可轉散發套件（x64）-12.0.40660 已安裝在 VM 中
    - 磁片區陰影複製服務（VSS）的啟動類型已從手動變更為自動
    - 已新增 IaaSVmProvider Windows 服務

1. 當資料傳輸完成時，就會移除快照集，並建立復原點。

![Azure 虛擬機器備份架構](./media/backup-azure-vms-introduction/vmbackup-architecture.png)

## <a name="encryption-of-azure-vm-backups"></a>Azure VM 備份的加密

當您使用 Azure 備份來備份 Azure VM 時，VM 會透過儲存體服務加密 (SSE) 來執行待用加密。 Azure 備份也可以使用 Azure 磁碟加密來備份已加密的 Azure Vm。

[加密]**** | **詳細資料** | **支援**
--- | --- | ---
**Azure 磁碟加密** | Azure 磁碟加密會加密 Azure Vm 的 OS 和資料磁片。<br/><br/> Azure 磁碟加密與 BitLocker 加密金鑰（Bek）整合，其在金鑰保存庫中受到保護以作為秘密。 Azure 磁碟加密也會與 Azure Key Vault 金鑰加密金鑰（Kek）整合。 | Azure 備份支援僅以 Bek 加密的受管理和非受控 Azure Vm 備份，或搭配 Kek 使用 Bek。<br/><br/> Bek 和 Kek 都會進行備份和加密。<br/><br/> 因為已備份 Kek 和 Bek，所以具有必要許可權的使用者可以視需要將金鑰和密碼還原回金鑰保存庫。 這些使用者也可以復原已加密的 VM。<br/><br/> 未經授權的使用者或 Azure 無法讀取加密金鑰和秘密。
**SSE** | 使用 SSE，Azure 儲存體會在儲存資料前自動加密，藉以提供待用加密。 Azure 儲存體也會先將資料解密，然後再加以抓取。 | Azure 備份使用 SSE 來進行 Azure Vm 的靜態加密。

對於受管理和非受控的 Azure Vm，備份支援使用僅 Bek 加密的 Vm，或使用 Bek 加密的 Vm 搭配 Kek。

備份的 Bek （秘密）和 Kek （金鑰）已加密。 只有當授權的使用者將其還原回金鑰保存庫時，才可以讀取和使用它們。 未經授權的使用者（或 Azure）都不能讀取或使用備份金鑰或密碼。

Bek 也會一併備份。 因此，如果 Bek 遺失，授權的使用者就可以將 Bek 還原至金鑰保存庫，並復原已加密的 Vm。 只有具備必要許可權層級的使用者，才能備份和還原已加密的 Vm 或金鑰和密碼。

## <a name="snapshot-creation"></a>建立快照集

Azure 備份會根據備份排程來取得快照集。

- **Windows vm：** 對於 Windows Vm，備份服務會與 VSS 協調，以取得 VM 磁片的應用程式一致快照集。  根據預設，Azure 備份會進行完整的 VSS 備份（它會截斷應用程式的記錄，例如備份時的 SQL Server，以取得應用層級一致的備份）。  如果您在 Azure VM 備份上使用 SQL Server 資料庫，則可以修改設定以進行 VSS 複本備份（以保留記錄）。 如需詳細資訊，請參閱 [本篇文章](https://docs.microsoft.com/azure/backup/backup-azure-vms-troubleshoot#troubleshoot-vm-snapshot-issues)。

- **Linux vm：** 若要採用 Linux Vm 的應用程式一致快照集，請使用 Linux 前置腳本和後置腳本架構來撰寫您自己的自訂腳本，以確保一致性。

  - Azure 備份只會叫用您撰寫的前置/後置腳本。
  - 如果前置腳本和後置腳本執行成功，Azure 備份會將復原點標記為應用程式一致。 不過，當您使用自訂腳本時，您最終會負責應用程式的一致性。
  - [深入瞭解](backup-azure-linux-app-consistent.md)如何設定腳本。

## <a name="snapshot-consistency"></a>快照集一致性

下表說明不同類型的快照集一致性：

**快照式** | **詳細資料** | **復原** | **考量**
--- | --- | --- | ---
**應用程式一致** | 應用程式一致的備份會擷取記憶體內容和擱置 I/O 作業。 應用程式一致快照集會使用 VSS 寫入器（或適用于 Linux 的前置/後置腳本）來確保應用程式資料的一致性，然後才進行備份。 | 當您使用應用程式一致的快照集復原 VM 時，VM 會啟動。 沒有任何資料損毀或遺失。 應用程式會以一致的狀態開始。 | Windows：所有 VSS 寫入器都成功<br/><br/> Linux：已設定且成功的前置/後置腳本
**檔案系統一致** | 檔案系統一致備份會同時取得所有檔案的快照集，以提供一致性。<br/><br/> | 當您使用檔案系統一致快照集復原 VM 時，VM 就會開機。 沒有任何資料損毀或遺失。 應用程式必須實作自己的「修正」機制，以確保還原的資料一致。 | Windows：部分 VSS 寫入器失敗 <br/><br/> Linux：預設值（如果未設定或失敗的前置/後置腳本）
**絕對一致** | 當 Azure VM 在備份時關閉時，通常會發生損毀一致快照集。 只會擷取備份時已存在磁碟上的資料，並加以備份。 | 從 VM 開機程式開始，然後再進行磁片檢查，以修正損毀錯誤。 在損毀之前未傳輸到磁片的任何記憶體中資料或寫入作業都會遺失。 應用程式會實作本身的資料驗證。 例如，資料庫應用程式可以使用其交易記錄來進行驗證。 如果交易記錄中有不在資料庫中的專案，則資料庫軟體會將交易向前復原，直到資料一致為止。 | VM 處於關機（已停止/已解除配置）狀態。

## <a name="backup-and-restore-considerations"></a>備份與還原考慮

**考量** | **詳細資料**
--- | ---
**磁碟** | VM 磁片的備份是平行的。 例如，如果 VM 有四個磁片，備份服務會嘗試平行備份全部四個磁片。 備份是累進的 (僅備份已變更的資料)。
**排程** |  若要減少備份流量，請在一天的不同時間備份不同的 Vm，並確定時間不會重迭。 同時間備份多個 VM 會導致流量壅塞。
**準備備份** | 請記住準備備份所需的時間。 準備時間包括安裝或更新備份延伸模組，並根據備份排程觸發快照集。
**資料傳輸** | 請考慮 Azure 備份從先前的備份識別增量變更所需的時間。<br/><br/> 在增量備份中，Azure 備份會藉由計算區塊的總和檢查碼來決定變更。 如果區塊已變更，則會將其標示為傳送至保存庫。 服務會分析識別的區塊，以嘗試進一步減少要傳輸的資料量。 評估所有已變更的區塊之後，Azure 備份將變更傳輸到保存庫。<br/><br/> 擷取快照集和將其複製到保存庫之間可能會有延遲。<br/><br/> 在尖峰時間，最多可能需要八小時的時間來處理備份。 若每日備份，則 VM 的備份時間會小於 24 小時。
**初始備份** | 雖然增量備份的總備份時間小於24小時，但可能不是第一次備份的情況。 初始備份所需的時間取決於資料的大小，以及處理備份的時間。
**還原佇列** | Azure 備份會同時處理多個儲存體帳戶的還原作業，並將還原要求放入佇列中。
**還原複本** | 進行還原時，資料會從保存庫複製到儲存體帳戶。<br/><br/> 還原時間總計取決於每秒的 i/o 作業數（IOPS）和儲存體帳戶的輸送量。<br/><br/> 若要減少複製時間，請選取未使用其他應用程式寫入或讀取載入的儲存體帳戶。

### <a name="backup-performance"></a>備份效能

這些常見的案例可能會影響備份時間總計：

- **將新磁片新增至受保護的 AZURE VM：** 如果 VM 正在進行增量備份，並新增了新的磁片，備份時間將會增加。 總備份時間可能會超過24小時，因為新磁片的初始複寫，以及現有磁片的差異複寫。
- **分割的磁片：** 當磁片變更連續時，備份作業的速度會更快。 如果變更分散在磁碟中，則備份會必較慢。
- **磁片變換：** 如果正在進行增量備份的受保護磁片具有超過 200 GB 的每日變換，則備份可能需要很長一段時間（超過八小時）才能完成。
- **備份版本：** 最新版本的備份（也稱為「立即還原」版本）使用比「總和檢查碼比較」更優化的進程來識別變更。 但是，如果您使用「立即還原」並已刪除備份快照集，則備份會切換為總和檢查碼比較。 在此情況下，備份作業將會超過24小時（或失敗）。

## <a name="best-practices"></a>最佳作法

當您要設定 VM 備份時，我們建議您遵循下列做法：

- 修改在原則中設定的預設排程時間。 例如，如果原則中的預設時間是上午12:00，請將計時增加數分鐘，以便以最佳方式使用資源。
- 如果您要從單一保存庫還原 Vm，強烈建議您使用不同[的一般用途 v2 儲存體帳戶](https://docs.microsoft.com/azure/storage/common/storage-account-upgrade)，以確保目標儲存體帳戶不會受到節流。 例如，每個 VM 都必須有不同的儲存體帳戶。 例如，如果還原10個 Vm，請使用10個不同的儲存體帳戶。
- 若要備份使用高階儲存體的 Vm，請使用立即還原，建議您配置*50%* 的可用空間（已配置的儲存空間總計，只有在第一次備份時**才**需要）。 第一次備份完成後，備份不需要50% 的可用空間
- 每個儲存體帳戶的磁片數目限制相對於基礎結構即服務（IaaS） VM 上執行的應用程式所存取的磁片數量。 一般的作法是，如果單一儲存體帳戶上有5到10個磁片（或更多），請將一些磁片移至不同的儲存體帳戶來平衡負載。

## <a name="backup-costs"></a>備份成本

使用 Azure 備份所備份的 Azure VM 適用 [Azure 備份定價](https://azure.microsoft.com/pricing/details/backup/)。

第一次成功備份完成後，才會開始計費。 儲存體和受保護的 VM 也會在此同時開始計費。 只要 VM 的任何備份資料儲存在保存庫中，就會繼續計費。 如果您停止保護 VM，但 VM 的備份資料仍在保存庫中，則還是會繼續計費。

只有在停止保護且刪除全部備份資料時，才會對指定的虛擬機器停止計費。 當保護停止且沒有任何作用中的備份作業時，最後一個成功 VM 備份的大小會成為每月帳單所使用的受保護執行個體大小。

受保護的實例大小計算是根據 VM 的*實際*大小。 VM 的大小是 VM 中所有資料的總和，但不包括暫存儲存體。 定價是根據儲存在資料磁片上的實際資料，而不是連接至 VM 的每個資料磁片的最大支援大小。

同樣地，備份儲存體帳單會以儲存在 Azure 備份中的資料量為基礎，這是每個復原點中實際資料的總和。

例如，採用 A2 標準大小的 VM，其中有兩個額外的資料磁片，每個大小上限為 32 TB。 下表顯示每個磁片上儲存的實際資料：

**磁碟** | **大小上限** | **實際儲存的資料**
--- | --- | ---
作業系統磁碟 | 32 TB | 17 GB
本機/暫存磁碟 | 135 GB | 5 GB (未包含備份)
資料磁碟 1 | 32 TB| 30 GB
資料磁碟 2 | 32 TB | 0 GB

在此案例中，VM 的實際容量為 17 GB + 30 GB + 0 GB = 47 GB。 這個受保護的實例大小（47 GB）會成為每月帳單的基礎。 當 VM 中的資料量增加時，用於計費變更的受保護實例大小會符合。

## <a name="next-steps"></a>後續步驟

現在，[準備進行 AZURE VM 備份](backup-azure-arm-vms-prepare.md)。
